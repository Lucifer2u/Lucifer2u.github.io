

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/bat.png">
  <link rel="icon" href="/img/bat.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Lucifer">
  <meta name="keywords" content="">
  
  <title>MySQL - Lucifer&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.6.0/styles/monokai.min.css" />
    
  

  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"lucifer2u.github.io","root":"/","version":"1.8.10","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":false,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"Q8utolFFXQsi71pQY6bCltkI-gzGzoHsz","app_key":"x4RAlPOpmFX9HdGyI6MLoCGn","server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 80vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Lucifer</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于我
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/Flower.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="MySQL">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-07-26 23:17" pubdate>
        2021年7月26日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      29k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      384
       分钟
    </span>
  

  
  
    
      <!-- LeanCloud 统计文章PV -->
      <span id="leancloud-page-views-container" class="post-meta" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="leancloud-page-views"></span> 次
      </span>
    
  
</div>

            
          </div>

          
            <div class="scroll-down-bar">
              <i class="iconfont icon-arrowdown"></i>
            </div>
          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">MySQL</h1>
            
            <div class="markdown-body">
              <h1 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h1><ul>
<li>DQL（Data Query Language）：数据查询语言<br>select </li>
<li>DML(Data Manipulate Language):数据操作语言<br>insert 、update、delete</li>
<li>DDL（Data Define Languge）：数据定义语言<br>create、drop、alter</li>
<li>TCL（Transaction Control Language）：事务控制语言<br>commit、rollback</li>
</ul>
<h1 id="一、基本知识"><a href="#一、基本知识" class="headerlink" title="一、基本知识"></a>一、基本知识</h1><h2 id="DDL"><a href="#DDL" class="headerlink" title="DDL"></a>DDL</h2><h4 id="对库的操作"><a href="#对库的操作" class="headerlink" title="对库的操作"></a>对库的操作</h4><p><strong>创建数据库</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> book;</code></pre></div>

<p><strong>修改数据库</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#修改字符集
<span class="hljs-keyword">ALTER</span> DATABASE books <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> gbk;</code></pre></div>

<p><strong>展示数据库</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> DATABASES;</code></pre></div>

<p><strong>删除指定数据库</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> database_xx;</code></pre></div>

<p><strong>使用指定数据库</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">USE database_xx;</code></pre></div>

<h4 id="对表的操作"><a href="#对表的操作" class="headerlink" title="对表的操作"></a>对表的操作</h4><p><strong>创建表</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> student(
    s_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">PRIMARY</span> KEY COMMENT<span class="hljs-string">&#x27;学生学号&#x27;</span>,
    s_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT<span class="hljs-string">&#x27;学生姓名 不能为空&#x27;</span>,
    s_sex <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT<span class="hljs-string">&#x27;学生性别&#x27;</span>,
    s_birthday DATETIME COMMENT<span class="hljs-string">&#x27;学生生日&#x27;</span>,
    s_class <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT<span class="hljs-string">&#x27;学生所在的班级&#x27;</span>
);</code></pre></div>

<p><strong>展示表</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">DESCRIBE</span> table_xx;
<span class="hljs-keyword">DESC</span> table_xx;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200807154719.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200807154719.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>修改表</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> 表名 <span class="hljs-keyword">add</span><span class="hljs-operator">|</span><span class="hljs-keyword">drop</span><span class="hljs-operator">|</span>modify<span class="hljs-operator">|</span>change <span class="hljs-keyword">column</span> 列名 【列类型 约束】;

#①修改列名
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> book CHANGE <span class="hljs-keyword">COLUMN</span> publishdate pubDate DATETIME;

#②修改列的类型或约束
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> book MODIFY <span class="hljs-keyword">COLUMN</span> pubdate <span class="hljs-type">TIMESTAMP</span>;

#③添加新列
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> author <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> annual <span class="hljs-keyword">DOUBLE</span>; 

#④删除列
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> book_author <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">COLUMN</span>  annual;

#⑤修改表名
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> author RENAME <span class="hljs-keyword">TO</span> book_author;</code></pre></div>

<p><strong>删除表</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> 旧表名;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span>  表名();</code></pre></div>

<p><strong>复制表</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#<span class="hljs-number">1.</span>仅仅复制表的结构
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">copy</span> <span class="hljs-keyword">LIKE</span> author;

#<span class="hljs-number">2.</span>复制表的结构<span class="hljs-operator">+</span>数据
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> copy2 
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> author;

#只复制部分数据
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> copy3
<span class="hljs-keyword">SELECT</span> id,au_name
<span class="hljs-keyword">FROM</span> author 
<span class="hljs-keyword">WHERE</span> nation<span class="hljs-operator">=</span><span class="hljs-string">&#x27;中国&#x27;</span>;

#仅仅复制某些字段
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> copy4 
<span class="hljs-keyword">SELECT</span> id,au_name
<span class="hljs-keyword">FROM</span> author
<span class="hljs-keyword">WHERE</span> <span class="hljs-number">0</span>;</code></pre></div>



<p><strong>查看版本</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> version();</code></pre></div>



<h2 id="DQL"><a href="#DQL" class="headerlink" title="DQL"></a>DQL</h2><h4 id="基础查询"><a href="#基础查询" class="headerlink" title="基础查询"></a>基础查询</h4><div class="hljs code-wrapper"><pre><code class="hljs sql">#从表中查询所有
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> table_name; 

#从表中指定查询
<span class="hljs-keyword">SELECT</span> `last_name`,
			 `first_name` 
<span class="hljs-keyword">FROM</span> table_name;

#起别名
<span class="hljs-keyword">SELECT</span> last_name <span class="hljs-keyword">AS</span> &quot;别名1&quot;,
       first_name <span class="hljs-keyword">AS</span> &quot;别名2&quot;
<span class="hljs-keyword">FROM</span> employees;

#或者用空格
<span class="hljs-keyword">SELECT</span> last_name 别名<span class="hljs-number">1</span>,
       first_name 别名<span class="hljs-number">2</span>
<span class="hljs-keyword">FROM</span> employees;

#去重<span class="hljs-keyword">DISTINCT</span>查询
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> department_id <span class="hljs-keyword">FROM</span> employees;

#拼接
<span class="hljs-keyword">SELECT</span> CONCAT(first_name,last_name ) oo
<span class="hljs-keyword">FROM</span> employees;

#如果为<span class="hljs-keyword">NULL</span>，返回<span class="hljs-number">0</span>或者指定的数字
<span class="hljs-keyword">SELECT</span> IFNULL(last_name,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> xx <span class="hljs-keyword">FROM</span> employees;

#字母字符统一转为<span class="hljs-number">0</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">0</span> <span class="hljs-operator">=</span> ‘a’; <span class="hljs-comment">---1</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">0</span> <span class="hljs-operator">=</span> ‘abc’; <span class="hljs-comment">---1</span>

#数字字符统一转为数字
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-operator">=</span> ‘<span class="hljs-number">1</span>’; <span class="hljs-comment">---1</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">2</span> <span class="hljs-operator">=</span> ‘<span class="hljs-number">2</span>’; <span class="hljs-comment">---1</span></code></pre></div>

<h4 id="进阶查询"><a href="#进阶查询" class="headerlink" title="进阶查询"></a><strong>进阶查询</strong></h4><blockquote>
<p>select<br>        要查询的字段|表达式|常量值|函数<br>from<br>        表<br>where<br>        条件 ;</p>
</blockquote>
<p>分类：</p>
<ul>
<li><p>条件表达式</p>
<ul>
<li><code>&gt;</code>   <code> &lt;</code>   <code>=</code>    <code>&lt;=</code>   <code>&lt;&gt;是不等于</code></li>
<li>安全等于<code>&lt;=&gt;</code>既可以判断NULL，又可以判断普通值</li>
</ul>
</li>
<li><p>逻辑表达式<br>示例：<code>salary&gt;10000 &amp;&amp; salary&lt;20000</code></p>
<p>  AND（&amp;&amp;）:两个条件如果同时成立，结果为true，否则为false<br>  OR(||)：两个条件只要有一个成立，结果为true，否则为false<br>  NOT(!)：如果条件成立，则not后为false，否则为true<br>  IS NULL：不能用 xx=NULL</p>
</li>
<li><p>模糊查询</p>
<ul>
<li>%任意多个字符，如包含a的信息：<code>last_name LIKE &#39;%a%&#39;</code></li>
<li>_任意单个字符，如第三个e，第五个为a： <code>last_name LIKE &#39;___e_a%&#39;</code></li>
<li>在100-200之间，包含：<code>BETWEEN 100 AND 200 </code></li>
<li>在包含某些条件的信息：<code>last_name IN (&#39;Lucifer&#39; , &#39;Melrose&#39; , &#39;Xiaowei&#39;)</code>等价于<code>last_name = lucifer OR last_name = melrose OR ....</code></li>
</ul>
</li>
</ul>
<h4 id="排序查询"><a href="#排序查询" class="headerlink" title="排序查询"></a><strong>排序查询</strong></h4><blockquote>
<p>select<br>   要查询的东西<br>from<br>   表<br>where<br>   条件</p>
<p>order by 排序的字段|表达式|函数|别名 【asc|desc】</p>
</blockquote>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#降序
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>;
#升序
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">ASC</span>;</code></pre></div>

<h4 id="常见函数✨"><a href="#常见函数✨" class="headerlink" title="常见函数✨"></a>常见函数✨</h4><blockquote>
<p>SELECT 函数名(实参列表) FROM 表</p>
</blockquote>
<p><strong>单行函数</strong></p>
<ol>
<li>字符函数<ul>
<li>concat拼接</li>
<li>substr截取子串(MySQL中索引从1开始)</li>
<li>upper转换成大写</li>
<li>lower转换成小写</li>
<li>trim去前后指定的空格和字符</li>
<li>ltrim去左边空格</li>
<li>rtrim去右边空格</li>
<li>replace替换</li>
<li>lpad左填充</li>
<li>rpad右填充</li>
<li>instr返回子串第一次出现的索引</li>
<li>length 获取字节个数</li>
</ul>
</li>
<li>数学函数<ul>
<li>round 四舍五入</li>
<li>rand 随机数</li>
<li>floor向下取整</li>
<li>ceil向上取整</li>
<li>mod取余</li>
<li>truncate截断</li>
</ul>
</li>
<li>日期函数<ul>
<li>now当前系统日期+时间</li>
<li>curdate当前系统日期</li>
<li>curtime当前系统时间</li>
<li>str_to_date 将字符转换成日期</li>
<li>date_format将日期转换成字符</li>
<li>datedief两个日期相隔的天数</li>
</ul>
</li>
<li>流程控制函数<ul>
<li>if 处理双分支</li>
<li>case语句 处理多分支<ul>
<li>情况1：处理等值判断</li>
<li>情况2：处理条件判断</li>
</ul>
</li>
</ul>
</li>
<li>其他函数<ul>
<li>version版本</li>
<li>database当前库</li>
<li>user当前连接用户</li>
</ul>
</li>
</ol>
<p><strong>分组函数</strong></p>
<ul>
<li><p>sum 求和</p>
</li>
<li><p>max 最大值</p>
</li>
<li><p>min 最小值</p>
</li>
<li><p>avg 平均值</p>
</li>
<li><p>count 计数</p>
<blockquote>
<p>特点：</p>
<ul>
<li>以上五个分组函数都忽略null值，除了count(<em>)</em></li>
<li><em>sum和avg一般用于处理数值型</em></li>
<li><em>max、min、count可以处理任何数据类型</em></li>
<li><em>都可以搭配distinct使用，用于统计去重后的结果</em></li>
<li><em>count的参数可以支持：字段、</em>常量值，一般放1，建议使用 count(*)，效果都一样</li>
</ul>
</blockquote>
</li>
</ul>
<h4 id="分组查询"><a href="#分组查询" class="headerlink" title="分组查询"></a><strong>分组查询</strong></h4><blockquote>
<p>select<br>        查询的字段，分组函数<br>from<br>        表</p>
<p>where 筛选条件</p>
<p>group by<br>        分组的字段</p>
<p>order by 子句</p>
</blockquote>
<p>1、可以按单个字段分组<br>2、和分组函数一同查询的字段最好是分组后的字段<br>3、分组筛选</p>
<blockquote>
<p>​        针对的表    位置            关键字<br>分组前筛选：    原始表        group by的前面        where<br>分组后筛选：    分组后的结果集    group by的后面        having</p>
</blockquote>
<p>4、可以按多个字段分组，字段之间用逗号隔开<br>5、可以支持排序<br>6、having后可以支持别名</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#查询邮箱中包含a字符，每个部门的平均工资
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(salary),department_id
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> email <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%a%&#x27;</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_id

#查询那个部门的员工个数<span class="hljs-operator">&gt;</span><span class="hljs-number">2</span>
#首先查询每个部门的员工个数
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>),department_id
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_id;
#然后根据结果筛选，查询那个部门的员工个数<span class="hljs-operator">&gt;</span><span class="hljs-number">2</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>),department_id
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_id
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>)<span class="hljs-operator">&gt;</span><span class="hljs-number">2</span>;

#每个工种有奖金的员工的最高工资<span class="hljs-operator">&gt;</span><span class="hljs-number">12000</span>的工种编号和最高工资
<span class="hljs-keyword">SELECT</span> job_id,<span class="hljs-built_in">MAX</span>(salary)
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> commission_pct <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> job_id
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">MAX</span>(salary)<span class="hljs-operator">&gt;</span><span class="hljs-number">12000</span>;</code></pre></div>

<h4 id="多表连接查询"><a href="#多表连接查询" class="headerlink" title="多表连接查询"></a>多表连接查询</h4><p>笛卡尔乘积：如果连接条件省略或无效则会出现<br>解决办法：添加上连接条件</p>
<p><strong>一、传统模式下的连接 ：等值连接——非等值连接</strong></p>
<ul>
<li>等值连接的结果 = 多个表的交集</li>
<li>n表连接，至少需要n-1个连接条件</li>
<li>多个表不分主次，没有顺序要求</li>
<li>一般为表起别名，提高阅读性和性能</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#<span class="hljs-number">1.</span>显示所有员工的姓名，部门号和部门名称。
USE myemployees;

<span class="hljs-keyword">SELECT</span> last_name,d.department_id,department_name
<span class="hljs-keyword">FROM</span> employees e,departments d
<span class="hljs-keyword">WHERE</span> e.`department_id` <span class="hljs-operator">=</span> d.`department_id`;


#<span class="hljs-number">2.</span>查询<span class="hljs-number">90</span>号部门员工的job_id和<span class="hljs-number">90</span>号部门的location_id
<span class="hljs-keyword">SELECT</span> job_id,location_id
<span class="hljs-keyword">FROM</span> employees e,departments d
<span class="hljs-keyword">WHERE</span> e.`department_id`<span class="hljs-operator">=</span>d.`department_id`
<span class="hljs-keyword">AND</span> e.`department_id`<span class="hljs-operator">=</span><span class="hljs-number">90</span>;



#<span class="hljs-number">3.</span>	选择所有有奖金的员工的
last_name , department_name , location_id , city

<span class="hljs-keyword">SELECT</span> last_name , department_name , l.location_id , city
<span class="hljs-keyword">FROM</span> employees e,departments d,locations l
<span class="hljs-keyword">WHERE</span> e.department_id <span class="hljs-operator">=</span> d.department_id
<span class="hljs-keyword">AND</span> d.location_id<span class="hljs-operator">=</span>l.location_id
<span class="hljs-keyword">AND</span> e.commission_pct <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>;


#<span class="hljs-number">4.</span>选择city在Toronto工作的员工的
last_name , job_id , department_id , department_name 

<span class="hljs-keyword">SELECT</span> last_name , job_id , d.department_id , department_name 
<span class="hljs-keyword">FROM</span> employees e,departments d ,locations l
<span class="hljs-keyword">WHERE</span> e.department_id <span class="hljs-operator">=</span> d.department_id
<span class="hljs-keyword">AND</span> d.location_id<span class="hljs-operator">=</span>l.location_id
<span class="hljs-keyword">AND</span> city <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Toronto&#x27;</span>;


#<span class="hljs-number">5.</span>查询每个工种、每个部门的部门名、工种名和最低工资
<span class="hljs-keyword">SELECT</span> department_name,job_title,<span class="hljs-built_in">MIN</span>(salary) 最低工资
<span class="hljs-keyword">FROM</span> employees e,departments d,jobs j
<span class="hljs-keyword">WHERE</span> e.`department_id`<span class="hljs-operator">=</span>d.`department_id`
<span class="hljs-keyword">AND</span> e.`job_id`<span class="hljs-operator">=</span>j.`job_id`
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_name,job_title;


#<span class="hljs-number">6.</span>查询每个国家下的部门个数大于<span class="hljs-number">2</span>的国家编号
<span class="hljs-keyword">SELECT</span> country_id,<span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) 部门个数
<span class="hljs-keyword">FROM</span> departments d,locations l
<span class="hljs-keyword">WHERE</span> d.`location_id`<span class="hljs-operator">=</span>l.`location_id`
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> country_id
<span class="hljs-keyword">HAVING</span> 部门个数<span class="hljs-operator">&gt;</span><span class="hljs-number">2</span>;


#<span class="hljs-number">7</span>、选择指定员工的姓名，员工号，以及他的管理者的姓名和员工号，结果类似于下面的格式
employees	Emp#	manager	Mgr#
kochhar		<span class="hljs-number">101</span>	king	<span class="hljs-number">100</span>

<span class="hljs-keyword">SELECT</span> e.last_name employees,e.employee_id &quot;Emp#&quot;,m.last_name manager,m.employee_id &quot;Mgr#&quot;
<span class="hljs-keyword">FROM</span> employees e,employees m
<span class="hljs-keyword">WHERE</span> e.manager_id <span class="hljs-operator">=</span> m.employee_id
<span class="hljs-keyword">AND</span> e.last_name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;kochhar&#x27;</span>;</code></pre></div>

<p><strong>二、sql99语法：通过join关键字实现连接</strong></p>
<ul>
<li>内连接（inner）<ul>
<li>等值连接</li>
<li>非等值连接 </li>
<li>自连接</li>
</ul>
</li>
<li>外连接<ul>
<li>左外连接（left 【outer】)</li>
<li>右外连接（right 【outer】）</li>
<li>全外连接（full【outer】）</li>
</ul>
</li>
<li>交叉连接 cross</li>
</ul>
<p><strong>语法</strong></p>
<blockquote>
<p>select 字段，…<br>from 表1<br>【inner|left outer|right outer|cross】join 表2<br>【on  连接条件】<br>【inner|left outer|right outer|cross】join 表3<br>【on  连接条件】<br>【where 筛选条件】<br>【group by 分组字段】<br>【having 分组后的筛选条件】<br>【order by 排序的字段或表达式】</p>
</blockquote>
<p>好处：语句上，连接条件和筛选条件实现了分离，简洁明了</p>
<p><strong>没有创建外键时，可以使用内外查询将两个表的内容合并在一起查询</strong></p>
<blockquote>
<p><strong>内连接</strong></p>
</blockquote>
<p><strong>内联查询：两张表通过某个字段合并起来，查询出相关数据</strong></p>
<p><strong>等值连接</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例<span class="hljs-number">1.</span>查询员工名、部门名
<span class="hljs-keyword">SELECT</span> last_name,department_name
<span class="hljs-keyword">FROM</span> departments d
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span>  employees e
<span class="hljs-keyword">ON</span> e.`department_id` <span class="hljs-operator">=</span> d.`department_id`;

#案例<span class="hljs-number">2.</span>查询名字中包含e的员工名和工种名（添加筛选）
<span class="hljs-keyword">SELECT</span> last_name,job_title
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> jobs j
<span class="hljs-keyword">ON</span> e.`job_id`<span class="hljs-operator">=</span>  j.`job_id`
<span class="hljs-keyword">WHERE</span> e.`last_name` <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%e%&#x27;</span>;

#<span class="hljs-number">3.</span> 查询部门个数<span class="hljs-operator">&gt;</span><span class="hljs-number">3</span>的城市名和部门个数，（添加分组<span class="hljs-operator">+</span>筛选）
#①查询每个城市的部门个数
#②在①结果上筛选满足条件的
<span class="hljs-keyword">SELECT</span> city,<span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) 部门个数
<span class="hljs-keyword">FROM</span> departments d
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> locations l
<span class="hljs-keyword">ON</span> d.`location_id`<span class="hljs-operator">=</span>l.`location_id`
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> city
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>)<span class="hljs-operator">&gt;</span><span class="hljs-number">3</span>;

#案例<span class="hljs-number">4.</span>查询哪个部门的员工个数<span class="hljs-operator">&gt;</span><span class="hljs-number">3</span>的部门名和员工个数，并按个数降序（添加排序）
#①查询每个部门的员工个数
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>),department_name
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> departments d
<span class="hljs-keyword">ON</span> e.`department_id`<span class="hljs-operator">=</span>d.`department_id`
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_name

#② 在①结果上筛选员工个数<span class="hljs-operator">&gt;</span><span class="hljs-number">3</span>的记录，并排序
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) 个数,department_name
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> departments d
<span class="hljs-keyword">ON</span> e.`department_id`<span class="hljs-operator">=</span>d.`department_id`
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_name
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>)<span class="hljs-operator">&gt;</span><span class="hljs-number">3</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">DESC</span>;

#<span class="hljs-number">5.</span>查询员工名、部门名、工种名，并按部门名降序（添加三表连接）
<span class="hljs-keyword">SELECT</span> last_name,department_name,job_title
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> departments d <span class="hljs-keyword">ON</span> e.`department_id`<span class="hljs-operator">=</span>d.`department_id`
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> jobs j <span class="hljs-keyword">ON</span> e.`job_id` <span class="hljs-operator">=</span> j.`job_id`
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> department_name <span class="hljs-keyword">DESC</span>;</code></pre></div>

<p><strong>非等值连接</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#查询员工的工资级别
<span class="hljs-keyword">SELECT</span> salary,grade_level
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">JOIN</span> job_grades g
<span class="hljs-keyword">ON</span> e.`salary` <span class="hljs-keyword">BETWEEN</span> g.`lowest_sal` <span class="hljs-keyword">AND</span> g.`highest_sal`;
 
 
#查询工资级别的个数<span class="hljs-operator">&gt;</span><span class="hljs-number">20</span>的个数，并且按工资级别降序
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>),grade_level
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">JOIN</span> job_grades g
<span class="hljs-keyword">ON</span> e.`salary` <span class="hljs-keyword">BETWEEN</span> g.`lowest_sal` <span class="hljs-keyword">AND</span> g.`highest_sal`
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> grade_level
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>)<span class="hljs-operator">&gt;</span><span class="hljs-number">20</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> grade_level <span class="hljs-keyword">DESC</span>;</code></pre></div>

<blockquote>
<p><strong>自连接</strong></p>
</blockquote>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#查询员工名和直接上级的名称，从自己的表中查询两次
#sql99
<span class="hljs-keyword">SELECT</span> e.last_name,m.last_name
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">JOIN</span> employees m <span class="hljs-keyword">ON</span> e.`manager_id`<span class="hljs-operator">=</span>m.`employee_id`;
#sql92
<span class="hljs-keyword">SELECT</span> e.last_name,m.last_name
<span class="hljs-keyword">FROM</span> employees e,employees m 
<span class="hljs-keyword">WHERE</span> e.`manager_id`<span class="hljs-operator">=</span>m.`employee_id`;

#查询员工的名字、上级的名字
<span class="hljs-keyword">SELECT</span> e.last_name,m.last_name
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">JOIN</span> employees m
<span class="hljs-keyword">ON</span> e.`manager_id`<span class="hljs-operator">=</span> m.`employee_id`;

#查询姓名中包含字符k的员工的名字、上级的名字
<span class="hljs-keyword">SELECT</span> e.last_name,m.last_name
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">JOIN</span> employees m
<span class="hljs-keyword">ON</span> e.`manager_id`<span class="hljs-operator">=</span> m.`employee_id`
<span class="hljs-keyword">WHERE</span> e.`last_name` <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%k%&#x27;</span>;</code></pre></div>

<blockquote>
<p><strong>外连接</strong></p>
</blockquote>
<p><strong>应用场景：用于查询一个表中有，另一个表没有的记录</strong></p>
<ul>
<li>特点：</li>
<li>外连接的查询结果为主表中的所有记录<ul>
<li>如果从表中有和它匹配的，则显示匹配的值</li>
<li>如果从表中没有和它匹配的，则显示null</li>
<li><strong>外连接查询结果=内连接结果+主表中有而从表没有的记录</strong></li>
</ul>
</li>
<li>左外连接，left join左边的是主表</li>
<li>右外连接，right join右边的是主表</li>
<li>左外和右外交换两个表的顺序，可以实现同样的效果 </li>
<li>全外连接=内连接的结果+表1中有但表2没有的+表2中有但表1没有的</li>
</ul>
<p><strong>左外连接</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> ... <span class="hljs-keyword">ON</span> ...
或
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> ... <span class="hljs-keyword">ON</span> ...</code></pre></div>

<p>举例：</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#引入：查询男朋友 不在男神表的的女神名
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> beauty;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> boys;

#bo<span class="hljs-operator">=</span>boys b<span class="hljs-operator">=</span>beauty
#左外连接
<span class="hljs-keyword">SELECT</span> b.name,bo.<span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> beauty b
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> boys bo
<span class="hljs-keyword">ON</span> b.`boyfriend_id` <span class="hljs-operator">=</span> bo.`id`
<span class="hljs-keyword">WHERE</span> bo.`id` <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;

#案例<span class="hljs-number">1</span>：查询哪个部门没有员工
#左外
<span class="hljs-keyword">SELECT</span> d.<span class="hljs-operator">*</span>,e.employee_id
<span class="hljs-keyword">FROM</span> departments d
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> employees e
<span class="hljs-keyword">ON</span> d.`department_id` <span class="hljs-operator">=</span> e.`department_id`
<span class="hljs-keyword">WHERE</span> e.`employee_id` <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;</code></pre></div>

<p><strong>右外连接</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">JOIN</span> ... <span class="hljs-keyword">ON</span> ...
或
<span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> ... <span class="hljs-keyword">ON</span> ...</code></pre></div>

<p>举例：</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#右外
<span class="hljs-keyword">SELECT</span> d.<span class="hljs-operator">*</span>,e.employee_id
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> departments d
<span class="hljs-keyword">ON</span> d.`department_id` <span class="hljs-operator">=</span> e.`department_id`
<span class="hljs-keyword">WHERE</span> e.`employee_id` <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;](MySQL.assets<span class="hljs-operator">/</span><span class="hljs-number">20200810195526.</span>png)](https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>nyimapicture.oss<span class="hljs-operator">-</span>cn<span class="hljs-operator">-</span>beijing.aliyuncs.com<span class="hljs-operator">/</span>img<span class="hljs-operator">/</span><span class="hljs-number">20200810195526.</span>png)</code></pre></div>

<p><strong>PS：全外连接<code>FULL</code>是两者的并集，全外连接<code>CROSS</code>是所有的排列组合，是一个笛卡尔乘积</strong></p>
<p><strong>三种连接的图解</strong></p>
<p><strong>内连接</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200810200025.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200810200025.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>左连接</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200810200040.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200810200040.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>右连接</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200810200104.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200810200104.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>额外情况</strong></p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210428161509573.png" srcset="/img/loading.gif" lazyload alt="image-20210428161509573"></p>
<h4 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h4><p>含义：</p>
<ul>
<li>一条查询语句中又嵌套了另一条完整的select语句，其中被嵌套的select语句，称为子查询或内查询</li>
<li>在外面的查询语句，称为主查询或外查询</li>
</ul>
<p>特点：</p>
<ul>
<li>子查询都放在小括号内</li>
<li>子查询可以放在from后面、select后面、where后面、having后面，但一般放在条件的右侧</li>
<li>子查询优先于主查询执行，主查询使用了子查询的执行结果</li>
<li>子查询根据查询结果的行数不同分为以下两类：<ul>
<li>标量子查询<ul>
<li>结果集只有一行</li>
<li>一般搭配单行操作符使用：&gt; &lt; = &lt;&gt; &gt;= &lt;= </li>
<li>非法使用子查询的情况：<div class="hljs code-wrapper"><pre><code>a、子查询的结果为一组值
b、子查询的结果为空
</code></pre></div>
</li>
</ul>
</li>
<li>列子查询<ul>
<li>结果集有多行 </li>
<li>一般搭配多行操作符使用：any、all、in、not in </li>
<li>in： 属于子查询结果中的任意一个就行 </li>
<li>any：和子查询的某一个比较（可代替）</li>
<li>all：和子查询的所有比较（可代替）</li>
</ul>
</li>
</ul>
</li>
<li><strong>按结果集的行列数不同：</strong><ul>
<li>标量子查询（结果集只有一行一列）</li>
<li>列子查询（结果集只有一列多行）</li>
<li>行子查询（结果集有一行多列）</li>
<li>表子查询（结果集一般为多行多列）</li>
</ul>
</li>
</ul>
<blockquote>
<p>select后面：<br>  仅仅支持标量子查询</p>
<p>from后面：<br>  支持表子查询<br>where或having后面：★<br>  标量子查询（单行） √<br>  列子查询  （多行） √<br>   行子查询</p>
<p>exists后面（相关子查询）<br>  表子查询</p>
</blockquote>
<p><strong>标量子查询举例：</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例<span class="hljs-number">1</span>：谁的工资比 Abel 高?
#①查询Abel的工资
<span class="hljs-keyword">SELECT</span> salary
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> last_name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Abel&#x27;</span>

#②查询员工的信息，满足 salary<span class="hljs-operator">&gt;</span>①结果
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> salary<span class="hljs-operator">&gt;</span>(

	<span class="hljs-keyword">SELECT</span> salary
	<span class="hljs-keyword">FROM</span> employees
	<span class="hljs-keyword">WHERE</span> last_name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Abel&#x27;</span>
);

#案例<span class="hljs-number">2</span>：返回job_id与<span class="hljs-number">141</span>号员工相同，salary比<span class="hljs-number">143</span>号员工多的员工 姓名，job_id 和工资
#①查询<span class="hljs-number">141</span>号员工的job_id
<span class="hljs-keyword">SELECT</span> job_id
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> employee_id <span class="hljs-operator">=</span> <span class="hljs-number">141</span>

#②查询<span class="hljs-number">143</span>号员工的salary
<span class="hljs-keyword">SELECT</span> salary
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> employee_id <span class="hljs-operator">=</span> <span class="hljs-number">143</span>

#③查询员工的姓名，job_id 和工资，要求job_id<span class="hljs-operator">=</span>①并且salary<span class="hljs-operator">&gt;</span>②
<span class="hljs-keyword">SELECT</span> last_name,job_id,salary
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> job_id <span class="hljs-operator">=</span> (
	<span class="hljs-keyword">SELECT</span> job_id
	<span class="hljs-keyword">FROM</span> employees
	<span class="hljs-keyword">WHERE</span> employee_id <span class="hljs-operator">=</span> <span class="hljs-number">141</span>
) <span class="hljs-keyword">AND</span> salary<span class="hljs-operator">&gt;</span>(
	<span class="hljs-keyword">SELECT</span> salary
	<span class="hljs-keyword">FROM</span> employees
	<span class="hljs-keyword">WHERE</span> employee_id <span class="hljs-operator">=</span> <span class="hljs-number">143</span>
);

#案例<span class="hljs-number">3</span>：返回公司工资最少的员工的last_name,job_id和salary
#①查询公司的最低工资
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MIN</span>(salary)
<span class="hljs-keyword">FROM</span> employees

#②查询last_name,job_id和salary，要求salary<span class="hljs-operator">=</span>①
<span class="hljs-keyword">SELECT</span> last_name,job_id,salary
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> salary<span class="hljs-operator">=</span>(
	<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MIN</span>(salary)
	<span class="hljs-keyword">FROM</span> employees
);

#案例<span class="hljs-number">4</span>：查询最低工资大于<span class="hljs-number">50</span>号部门最低工资的部门id和其最低工资
#①查询<span class="hljs-number">50</span>号部门的最低工资
<span class="hljs-keyword">SELECT</span>  <span class="hljs-built_in">MIN</span>(salary)
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> department_id <span class="hljs-operator">=</span> <span class="hljs-number">50</span>

#②查询每个部门的最低工资

<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MIN</span>(salary),department_id
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_id

#③ 在②基础上筛选，满足<span class="hljs-built_in">min</span>(salary)<span class="hljs-operator">&gt;</span>①
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MIN</span>(salary),department_id
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_id
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">MIN</span>(salary)<span class="hljs-operator">&gt;</span>(
	<span class="hljs-keyword">SELECT</span>  <span class="hljs-built_in">MIN</span>(salary)
	<span class="hljs-keyword">FROM</span> employees
	<span class="hljs-keyword">WHERE</span> department_id <span class="hljs-operator">=</span> <span class="hljs-number">50</span>
);</code></pre></div>

<p><strong>列子查询举例：</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例<span class="hljs-number">1</span>：返回location_id是<span class="hljs-number">1400</span>或<span class="hljs-number">1700</span>的部门中的所有员工姓名
#①查询location_id是<span class="hljs-number">1400</span>或<span class="hljs-number">1700</span>的部门编号
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> department_id
<span class="hljs-keyword">FROM</span> departments
<span class="hljs-keyword">WHERE</span> location_id <span class="hljs-keyword">IN</span>(<span class="hljs-number">1400</span>,<span class="hljs-number">1700</span>)

#②查询员工姓名，要求部门号是①列表中的某一个
<span class="hljs-keyword">SELECT</span> last_name
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> department_id <span class="hljs-keyword">IN</span>( #<span class="hljs-operator">&lt;&gt;</span><span class="hljs-keyword">ALL</span>
	<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> department_id
	<span class="hljs-keyword">FROM</span> departments
	<span class="hljs-keyword">WHERE</span> location_id <span class="hljs-keyword">IN</span>(<span class="hljs-number">1400</span>,<span class="hljs-number">1700</span>)
);

#案例<span class="hljs-number">2</span>：返回其它工种中比job_id为‘IT_PROG’工种任一工资低的员工的员工号、姓名、job_id 以及salary
#①查询job_id为‘IT_PROG’部门任一工资
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> salary
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> job_id <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;IT_PROG&#x27;</span>

#②查询员工号、姓名、job_id 以及salary，salary<span class="hljs-operator">&lt;</span>(①)的任意一个
<span class="hljs-keyword">SELECT</span> last_name,employee_id,job_id,salary
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> salary<span class="hljs-operator">&lt;</span>(
	<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MAX</span>(salary)
	<span class="hljs-keyword">FROM</span> employees
	<span class="hljs-keyword">WHERE</span> job_id <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;IT_PROG&#x27;</span>

) <span class="hljs-keyword">AND</span> job_id<span class="hljs-operator">&lt;&gt;</span><span class="hljs-string">&#x27;IT_PROG&#x27;</span>;</code></pre></div>

<p><strong>行子查询距离</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例：查询员工编号最小并且工资最高的员工信息
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> 
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> (employee_id,salary)<span class="hljs-operator">=</span>(
	<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MIN</span>(employee_id),<span class="hljs-built_in">MAX</span>(salary)
	<span class="hljs-keyword">FROM</span> employees
);
#等同于
#①查询最小的员工编号
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MIN</span>(employee_id)
<span class="hljs-keyword">FROM</span> employees

#②查询最高工资
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MAX</span>(salary)
<span class="hljs-keyword">FROM</span> employees

#③查询员工信息
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> employee_id<span class="hljs-operator">=</span>(
	<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MIN</span>(employee_id)
	<span class="hljs-keyword">FROM</span> employees
)<span class="hljs-keyword">AND</span> salary<span class="hljs-operator">=</span>(
	<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MAX</span>(salary)
	<span class="hljs-keyword">FROM</span> employees
);</code></pre></div>

<p><strong>select后面的标量子查询</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例：查询每个部门的员工个数
<span class="hljs-keyword">SELECT</span> d.<span class="hljs-operator">*</span>,(

	<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>)
	<span class="hljs-keyword">FROM</span> employees e
	<span class="hljs-keyword">WHERE</span> e.department_id <span class="hljs-operator">=</span> d.`department_id`
 ) 个数
 <span class="hljs-keyword">FROM</span> departments d;
 
 #案例<span class="hljs-number">2</span>：查询员工号<span class="hljs-operator">=</span><span class="hljs-number">102</span>的部门名
<span class="hljs-keyword">SELECT</span> (
	<span class="hljs-keyword">SELECT</span> department_name
	<span class="hljs-keyword">FROM</span> departments d
	<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> employees e
	<span class="hljs-keyword">ON</span> d.department_id<span class="hljs-operator">=</span>e.department_id
	<span class="hljs-keyword">WHERE</span> e.employee_id<span class="hljs-operator">=</span><span class="hljs-number">102</span>
) 部门名;</code></pre></div>

<p><strong>from后面将子查询结果充当一张表，要求必须起别名</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例：查询每个部门的平均工资的工资等级
#①查询每个部门的平均工资
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(salary),department_id
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_id


<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> job_grades;


#②连接①的结果集和job_grades表，筛选条件平均工资 <span class="hljs-keyword">between</span> lowest_sal <span class="hljs-keyword">and</span> highest_sal

<span class="hljs-keyword">SELECT</span>  ag_dep.<span class="hljs-operator">*</span>,g.`grade_level`
<span class="hljs-keyword">FROM</span> (
   <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(salary) ag,department_id
   <span class="hljs-keyword">FROM</span> employees
   <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_id
) ag_dep
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> job_grades g
<span class="hljs-keyword">ON</span> ag_dep.ag <span class="hljs-keyword">BETWEEN</span> lowest_sal <span class="hljs-keyword">AND</span> highest_sal;</code></pre></div>

<p><strong>exists后面（相关子查询）</strong></p>
<p>exists(完整的查询语句)，结果：<code>1或0</code></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例<span class="hljs-number">1</span>：查询有员工的部门名
#<span class="hljs-keyword">in</span>
<span class="hljs-keyword">SELECT</span> department_name
<span class="hljs-keyword">FROM</span> departments d
<span class="hljs-keyword">WHERE</span> d.`department_id` <span class="hljs-keyword">IN</span>(
   <span class="hljs-keyword">SELECT</span> department_id
   <span class="hljs-keyword">FROM</span> employees

);

#<span class="hljs-keyword">exists</span>
<span class="hljs-keyword">SELECT</span> department_name
<span class="hljs-keyword">FROM</span> departments d
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span>(
   <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
   <span class="hljs-keyword">FROM</span> employees e
   <span class="hljs-keyword">WHERE</span> d.`department_id`<span class="hljs-operator">=</span>e.`department_id`
);

#案例<span class="hljs-number">2</span>：查询没有女朋友的男神信息
#<span class="hljs-keyword">in</span>
<span class="hljs-keyword">SELECT</span> bo.<span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> boys bo
<span class="hljs-keyword">WHERE</span> bo.id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span>(
	<span class="hljs-keyword">SELECT</span> boyfriend_id
	<span class="hljs-keyword">FROM</span> beauty
);

#<span class="hljs-keyword">exists</span>
<span class="hljs-keyword">SELECT</span> bo.<span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> boys bo
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(
	<span class="hljs-keyword">SELECT</span> boyfriend_id
	<span class="hljs-keyword">FROM</span> beauty b
	<span class="hljs-keyword">WHERE</span> bo.`id`<span class="hljs-operator">=</span>b.`boyfriend_id`

);</code></pre></div>

<h4 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a><strong>分页查询</strong></h4><p>应用场景：</p>
<p>实际的web项目中需要根据用户的需求提交对应的分页查询的sql语句</p>
<p>语法：</p>
<blockquote>
<p>select 字段|表达式,…<br>from 表<br>【where 条件】<br>【group by 分组字段】<br>【having 条件】<br>【order by 排序的字段】<br>limit 【起始的条目索引offset】条目数size;</p>
</blockquote>
<p>特点：</p>
<ul>
<li><strong>起始条目索引从0开始</strong></li>
<li>limit子句放在查询语句的最后</li>
<li>公式：<code>select * from  表 limit （page-1）*sizePerPage,sizePerPage</code><ul>
<li>假如:<br>每页显示条目数sizePerPage<br>要显示的页数 page</li>
</ul>
</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例<span class="hljs-number">1</span>：查询前五条员工信息
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span>  employees LIMIT <span class="hljs-number">0</span>,<span class="hljs-number">5</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span>  employees LIMIT <span class="hljs-number">5</span>;

#案例<span class="hljs-number">2</span>：查询第<span class="hljs-number">11</span>条——第<span class="hljs-number">25</span>条
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> employees
LIMIT <span class="hljs-number">10</span>,<span class="hljs-number">15</span>;

#案例<span class="hljs-number">3</span>：有奖金的员工信息，并且工资较高的前<span class="hljs-number">10</span>名显示出来
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> commission_pct <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">10</span>;</code></pre></div>

<h4 id="联合查询"><a href="#联合查询" class="headerlink" title="联合查询"></a>联合查询</h4><p><strong>引入</strong><br>union 联合、合并</p>
<p><strong>语法</strong></p>
<blockquote>
<p>select 字段|常量|表达式|函数 【from 表】 【where 条件】 union 【all】<br>select 字段|常量|表达式|函数 【from 表】 【where 条件】 union 【all】<br>select 字段|常量|表达式|函数 【from 表】 【where 条件】 union  【all】<br>…..<br>select 字段|常量|表达式|函数 【from 表】 【where 条件】</p>
</blockquote>
<p><strong>特点</strong></p>
<ul>
<li>多条查询语句的查询的列数必须是一致的</li>
<li>多条查询语句的查询的列的类型几乎相同</li>
<li>union代表去重，union all代表不去重</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#引入的案例：查询部门编号<span class="hljs-operator">&gt;</span><span class="hljs-number">90</span>或邮箱包含a的员工信息
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> email <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%a%&#x27;</span>
   <span class="hljs-keyword">OR</span> department_id <span class="hljs-operator">&gt;</span> <span class="hljs-number">90</span>;;

<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> email <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%a%&#x27;</span>
<span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> department_id <span class="hljs-operator">&gt;</span> <span class="hljs-number">90</span>;

#案例：查询中国用户中男性的信息以及外国用户中年男性的用户信息
<span class="hljs-keyword">SELECT</span> id,cname <span class="hljs-keyword">FROM</span> t_ca <span class="hljs-keyword">WHERE</span> csex<span class="hljs-operator">=</span><span class="hljs-string">&#x27;男&#x27;</span>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
<span class="hljs-keyword">SELECT</span> t_id,tname <span class="hljs-keyword">FROM</span> t_ua <span class="hljs-keyword">WHERE</span> tGender<span class="hljs-operator">=</span><span class="hljs-string">&#x27;male&#x27;</span>;</code></pre></div>

<h4 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h4><p>建表语句及插入语句</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> student(
    s_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">PRIMARY</span> KEY COMMENT<span class="hljs-string">&#x27;学生学号&#x27;</span>,
    s_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT<span class="hljs-string">&#x27;学生姓名 不能为空&#x27;</span>,
    s_sex <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT<span class="hljs-string">&#x27;学生性别&#x27;</span>,
    s_birthday DATETIME COMMENT<span class="hljs-string">&#x27;学生生日&#x27;</span>,
    s_class <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT<span class="hljs-string">&#x27;学生所在的班级&#x27;</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> teacher(
    t_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">PRIMARY</span> KEY COMMENT<span class="hljs-string">&#x27;教师编号&#x27;</span>,
    t_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT<span class="hljs-string">&#x27;教师姓名&#x27;</span>,
    t_sex <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT<span class="hljs-string">&#x27;教师性别&#x27;</span>,
    t_birthday DATETIME COMMENT<span class="hljs-string">&#x27;教师生日&#x27;</span>,
    t_rof <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT<span class="hljs-string">&#x27;教师职称&#x27;</span>,
    t_depart <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT<span class="hljs-string">&#x27;教师所在的部门&#x27;</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> course(
    c_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">PRIMARY</span> KEY COMMENT<span class="hljs-string">&#x27;课程号&#x27;</span>,
    c_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT<span class="hljs-string">&#x27;课程名称&#x27;</span>,
    t_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT<span class="hljs-string">&#x27;教师编号 外键关联teacher表&#x27;</span>,
    <span class="hljs-keyword">FOREIGN</span> KEY(t_no) <span class="hljs-keyword">references</span> teacher(t_no)
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> score (
    s_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT<span class="hljs-string">&#x27;成绩表的编号 依赖学生学号&#x27;</span>,
        c_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT<span class="hljs-string">&#x27;课程号 依赖于课程表中的c_id&#x27;</span>,
    sc_degree <span class="hljs-type">decimal</span>,
    <span class="hljs-keyword">foreign</span> key(s_no) <span class="hljs-keyword">references</span> student(s_no),
    <span class="hljs-keyword">foreign</span> key(c_no) <span class="hljs-keyword">references</span> course(c_no),
    <span class="hljs-keyword">PRIMARY</span> KEY(s_no,c_no)
); 
<span class="hljs-comment">--学生表数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> student <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;101&#x27;</span>,<span class="hljs-string">&#x27;曾华&#x27;</span>,<span class="hljs-string">&#x27;男&#x27;</span>,<span class="hljs-string">&#x27;1977-09-01&#x27;</span>,<span class="hljs-string">&#x27;95033&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> student <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;102&#x27;</span>,<span class="hljs-string">&#x27;匡明&#x27;</span>,<span class="hljs-string">&#x27;男&#x27;</span>,<span class="hljs-string">&#x27;1975-10-02&#x27;</span>,<span class="hljs-string">&#x27;95031&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> student <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;103&#x27;</span>,<span class="hljs-string">&#x27;王丽&#x27;</span>,<span class="hljs-string">&#x27;女&#x27;</span>,<span class="hljs-string">&#x27;1976-01-23&#x27;</span>,<span class="hljs-string">&#x27;95033&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> student <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;104&#x27;</span>,<span class="hljs-string">&#x27;李军&#x27;</span>,<span class="hljs-string">&#x27;男&#x27;</span>,<span class="hljs-string">&#x27;1976-02-20&#x27;</span>,<span class="hljs-string">&#x27;95033&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> student <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;105&#x27;</span>,<span class="hljs-string">&#x27;王芳&#x27;</span>,<span class="hljs-string">&#x27;女&#x27;</span>,<span class="hljs-string">&#x27;1975-02-10&#x27;</span>,<span class="hljs-string">&#x27;95031&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> student <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;106&#x27;</span>,<span class="hljs-string">&#x27;陆军&#x27;</span>,<span class="hljs-string">&#x27;男&#x27;</span>,<span class="hljs-string">&#x27;1974-06-03&#x27;</span>,<span class="hljs-string">&#x27;95031&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> student <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;107&#x27;</span>,<span class="hljs-string">&#x27;王尼玛&#x27;</span>,<span class="hljs-string">&#x27;男&#x27;</span>,<span class="hljs-string">&#x27;1976-02-20&#x27;</span>,<span class="hljs-string">&#x27;95033&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> student <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;108&#x27;</span>,<span class="hljs-string">&#x27;张全蛋&#x27;</span>,<span class="hljs-string">&#x27;男&#x27;</span>,<span class="hljs-string">&#x27;1975-02-10&#x27;</span>,<span class="hljs-string">&#x27;95031&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> student <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;109&#x27;</span>,<span class="hljs-string">&#x27;赵铁柱&#x27;</span>,<span class="hljs-string">&#x27;男&#x27;</span>,<span class="hljs-string">&#x27;1974-06-03&#x27;</span>,<span class="hljs-string">&#x27;95031&#x27;</span>);

<span class="hljs-comment">--教师表数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> teacher <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;804&#x27;</span>,<span class="hljs-string">&#x27;李诚&#x27;</span>,<span class="hljs-string">&#x27;男&#x27;</span>,<span class="hljs-string">&#x27;1958-12-02&#x27;</span>,<span class="hljs-string">&#x27;副教授&#x27;</span>,<span class="hljs-string">&#x27;计算机系&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> teacher <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;856&#x27;</span>,<span class="hljs-string">&#x27;张旭&#x27;</span>,<span class="hljs-string">&#x27;男&#x27;</span>,<span class="hljs-string">&#x27;1969-03-12&#x27;</span>,<span class="hljs-string">&#x27;讲师&#x27;</span>,<span class="hljs-string">&#x27;电子工程系&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> teacher <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;825&#x27;</span>,<span class="hljs-string">&#x27;王萍&#x27;</span>,<span class="hljs-string">&#x27;女&#x27;</span>,<span class="hljs-string">&#x27;1972-05-05&#x27;</span>,<span class="hljs-string">&#x27;助教&#x27;</span>,<span class="hljs-string">&#x27;计算机系&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> teacher <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;831&#x27;</span>,<span class="hljs-string">&#x27;刘冰&#x27;</span>,<span class="hljs-string">&#x27;女&#x27;</span>,<span class="hljs-string">&#x27;1977-08-14&#x27;</span>,<span class="hljs-string">&#x27;助教&#x27;</span>,<span class="hljs-string">&#x27;电子工程系&#x27;</span>);

<span class="hljs-comment">--添加课程表</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> course <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;3-105&#x27;</span>,<span class="hljs-string">&#x27;计算机导论&#x27;</span>,<span class="hljs-string">&#x27;825&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> course <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;3-245&#x27;</span>,<span class="hljs-string">&#x27;操作系统&#x27;</span>,<span class="hljs-string">&#x27;804&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> course <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;6-166&#x27;</span>,<span class="hljs-string">&#x27;数字电路&#x27;</span>,<span class="hljs-string">&#x27;856&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> course <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;9-888&#x27;</span>,<span class="hljs-string">&#x27;高等数学&#x27;</span>,<span class="hljs-string">&#x27;831&#x27;</span>);

<span class="hljs-comment">--添加成绩表</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> score <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;103&#x27;</span>,<span class="hljs-string">&#x27;3-245&#x27;</span>,<span class="hljs-string">&#x27;86&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> score <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;105&#x27;</span>,<span class="hljs-string">&#x27;3-245&#x27;</span>,<span class="hljs-string">&#x27;75&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> score <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;109&#x27;</span>,<span class="hljs-string">&#x27;3-245&#x27;</span>,<span class="hljs-string">&#x27;68&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> score <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;103&#x27;</span>,<span class="hljs-string">&#x27;3-105&#x27;</span>,<span class="hljs-string">&#x27;92&#x27;</span>);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> score <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;105&#x27;</span>,<span class="hljs-string">&#x27;3-105&#x27;</span>,<span class="hljs-string">&#x27;88&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> score <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;109&#x27;</span>,<span class="hljs-string">&#x27;3-105&#x27;</span>,<span class="hljs-string">&#x27;76&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> score <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;103&#x27;</span>,<span class="hljs-string">&#x27;6-166&#x27;</span>,<span class="hljs-string">&#x27;85&#x27;</span>);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> score <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;105&#x27;</span>,<span class="hljs-string">&#x27;6-166&#x27;</span>,<span class="hljs-string">&#x27;79&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> score <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;109&#x27;</span>,<span class="hljs-string">&#x27;6-166&#x27;</span>,<span class="hljs-string">&#x27;81&#x27;</span>);</code></pre></div>

<ul>
<li>查询student表中所有记录的s_name,s_sex和s_class列</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s_no,s_name,s_class <span class="hljs-keyword">FROM</span>  student;</code></pre></div>

<ul>
<li>查询教师所有的单位但是不重复的t_depart列</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span>(t_depart) <span class="hljs-keyword">FROM</span> teacher;</code></pre></div>

<ul>
<li>查询score表中成绩在60-80之间所有的记录(sc_degree)</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s_no, sc_degree <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">WHERE</span> sc_degree <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">60</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">80</span>;
<span class="hljs-keyword">SELECT</span> s_no, sc_degree <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">WHERE</span> sc_degree <span class="hljs-operator">&gt;</span> <span class="hljs-number">60</span> <span class="hljs-keyword">AND</span> sc_degree <span class="hljs-operator">&lt;</span> <span class="hljs-number">80</span>;</code></pre></div>

<ul>
<li>查询score表中成绩为85, 86, 或者88的记录(sc_degree)</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s_no, sc_degree <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">WHERE</span> sc_degree <span class="hljs-keyword">IN</span>(<span class="hljs-number">85</span>, <span class="hljs-number">86</span>, <span class="hljs-number">88</span>);</code></pre></div>

<ul>
<li>查询student表中’95031’班或者性别为’女’的同学记录</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> s_class <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;95031&#x27;</span> <span class="hljs-keyword">OR</span> s_sex <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;女&#x27;</span>;</code></pre></div>

<ul>
<li>以sc_degree降序查询score表中所有的记录</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s_no, sc_degree <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sc_degree <span class="hljs-keyword">DESC</span>;</code></pre></div>

<ul>
<li>查询’95031’班的学生人数</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> s_class <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;95031&#x27;</span>;</code></pre></div>

<ul>
<li>查询score表中的最高分数的学生号和课程号</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s_no, c_no <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">WHERE</span> sc_degree <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MAX</span>(sc_degree) <span class="hljs-keyword">FROM</span> score);</code></pre></div>

<ul>
<li>查询每门课的平均成绩</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> c_no, <span class="hljs-built_in">AVG</span>(sc_degree) <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c_no;</code></pre></div>

<ul>
<li>查询score表中至少有2名学生选修的,并且以3开头的课程的平均分</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> c_no, <span class="hljs-built_in">AVG</span>(sc_degree) <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c_no <span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(c_no) <span class="hljs-operator">&gt;=</span><span class="hljs-number">2</span> <span class="hljs-keyword">AND</span> c_no <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;3%&#x27;</span>;</code></pre></div>

<ul>
<li>查询所有的学生 s_name , c_no, sc_degree列</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s_name, c_no, sc_degree <span class="hljs-keyword">FROM</span> student, score <span class="hljs-keyword">WHERE</span> student.s_no <span class="hljs-operator">=</span> score.s_no;</code></pre></div>

<ul>
<li>查询所有学生的s_no, c_name, sc_degree列</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s_no, c_name, sc_degree <span class="hljs-keyword">FROM</span> student, score, course <span class="hljs-keyword">WHERE</span> student.s_no <span class="hljs-operator">=</span> score.s_no <span class="hljs-keyword">AND</span> score.c_no <span class="hljs-operator">=</span> course.c_no;</code></pre></div>

<ul>
<li>查询所有的学生 s_name , c_name, sc_degree列</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s_name, c_name, sc_degree <span class="hljs-keyword">FROM</span> student, score, course <span class="hljs-keyword">WHERE</span> student.s_no <span class="hljs-operator">=</span> score.s_no <span class="hljs-keyword">AND</span> score.c_no <span class="hljs-operator">=</span> course.c_no;</code></pre></div>

<ul>
<li>查询班级是’95031’班学生每门课的平均分</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> c_no, <span class="hljs-built_in">AVG</span>(sc_degree) <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">WHERE</span> s_no <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> s_no <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> s_class <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;95031&#x27;</span>) <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>(c_no);

<span class="hljs-keyword">SELECT</span> c_no, <span class="hljs-built_in">AVG</span>(sc_degree) <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">AS</span> s <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> score <span class="hljs-keyword">AS</span> sc <span class="hljs-keyword">ON</span> s.s_no <span class="hljs-operator">=</span> sc.s_no <span class="hljs-keyword">WHERE</span> s_class <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;95031&#x27;</span> <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c_no;

<span class="hljs-comment">--查询内容包含课程名（c_name）</span>
<span class="hljs-keyword">SELECT</span> c.c_no, c.c_name, <span class="hljs-built_in">AVG</span>(sc.sc_degree) <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">AS</span> s, course <span class="hljs-keyword">AS</span> c, score <span class="hljs-keyword">AS</span> sc <span class="hljs-keyword">WHERE</span> s.s_no <span class="hljs-operator">=</span> sc.s_no <span class="hljs-keyword">AND</span> sc.c_no <span class="hljs-operator">=</span> c.c_no <span class="hljs-keyword">AND</span> s.s_class <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;95031&#x27;</span>  <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.c_no;</code></pre></div>

<ul>
<li>查询选修”3-105”课程的成绩高于’109’号同学’3-105’成绩 的所有同学的记录</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">AS</span> s, score <span class="hljs-keyword">AS</span> sc <span class="hljs-keyword">WHERE</span> sc.sc_degree <span class="hljs-operator">&gt;</span> (<span class="hljs-keyword">SELECT</span> sc_degree <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">WHERE</span> s_no <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;109&#x27;</span> <span class="hljs-keyword">AND</span> c_no <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;3-105&#x27;</span>) <span class="hljs-keyword">AND</span> sc.c_no <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;3-105&#x27;</span> <span class="hljs-keyword">AND</span> s.s_no <span class="hljs-operator">=</span> sc.s_no;</code></pre></div>

<ul>
<li>查询所有与学号为108.101的同学同年出生的所有学生的s_no,s_name和s_birthday</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">YEAR</span>(s_birthday) <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">YEAR</span>(s_birthday) <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> s_no <span class="hljs-keyword">IN</span> (<span class="hljs-string">&#x27;101&#x27;</span>, <span class="hljs-string">&#x27;108&#x27;</span>));</code></pre></div>

<ul>
<li>查询 张旭 教师任课的学生的成绩</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s.s_name, sc.sc_degree <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">AS</span> sc, student <span class="hljs-keyword">AS</span> s <span class="hljs-keyword">WHERE</span> c_no <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> c_no <span class="hljs-keyword">FROM</span> course <span class="hljs-keyword">WHERE</span> t_no <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> t_no <span class="hljs-keyword">FROM</span> teacher <span class="hljs-keyword">WHERE</span> t_name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;张旭&#x27;</span>)) <span class="hljs-keyword">AND</span> s.s_no <span class="hljs-operator">=</span> sc.s_no;</code></pre></div>

<ul>
<li>查询95033班和95031班全体学生的记录</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> s_class <span class="hljs-keyword">IN</span> (<span class="hljs-string">&#x27;95033&#x27;</span>, <span class="hljs-string">&#x27;95031&#x27;</span>) <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> s_class;</code></pre></div>

<ul>
<li>查询存在85分以上成绩的c_name和对应的老师</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> t_name, c_name <span class="hljs-keyword">FROM</span> course <span class="hljs-keyword">AS</span> c, teacher <span class="hljs-keyword">AS</span> t <span class="hljs-keyword">WHERE</span> c_no <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> c_no <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">WHERE</span> sc_degree <span class="hljs-operator">&gt;</span> <span class="hljs-number">85</span>) <span class="hljs-keyword">AND</span> c.t_no <span class="hljs-operator">=</span> t.t_no;</code></pre></div>

<ul>
<li>查出所有’计算机系’ 教师所教课程的教师信息、课程信息及学生信息</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span>  <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> teacher <span class="hljs-keyword">AS</span> t, course <span class="hljs-keyword">AS</span> c, student <span class="hljs-keyword">AS</span> s, score <span class="hljs-keyword">AS</span> sc 
<span class="hljs-keyword">WHERE</span> s.s_no <span class="hljs-operator">=</span> sc.s_no 
<span class="hljs-keyword">AND</span> c.t_no <span class="hljs-operator">=</span> t.t_no 
<span class="hljs-keyword">AND</span> sc.c_no <span class="hljs-operator">=</span> c.c_no 
<span class="hljs-keyword">AND</span> t.t_no <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> t_no <span class="hljs-keyword">FROM</span> teacher <span class="hljs-keyword">WHERE</span> t_depart <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;计算机系&#x27;</span>);</code></pre></div>

<ul>
<li>查询’计算机系’与’电子工程系’ 不同职称的教师的name和rof</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> teacher <span class="hljs-keyword">WHERE</span> t_depart <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;计算机系&#x27;</span> 
<span class="hljs-keyword">AND</span> t_rof <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> t_rof <span class="hljs-keyword">FROM</span> teacher <span class="hljs-keyword">WHERE</span> t_depart <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;电子工程系&#x27;</span>)
<span class="hljs-keyword">UNION</span> 
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> teacher <span class="hljs-keyword">WHERE</span> t_depart <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;电子工程系&#x27;</span> 
<span class="hljs-keyword">AND</span> t_rof <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> t_rof <span class="hljs-keyword">FROM</span> teacher <span class="hljs-keyword">WHERE</span> t_depart <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;计算机系&#x27;</span>);</code></pre></div>

<ul>
<li>查询选修编号为”3-105”课程且成绩<strong>至少</strong>高于选修编号为’3-245’同学的c_no,s_no和sc_degree,并且按照sc_degree从高到地次序排序</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">WHERE</span> c_no <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;3-105&#x27;</span> <span class="hljs-keyword">AND</span> sc_degree <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ANY</span>(<span class="hljs-keyword">SELECT</span> sc_degree <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">WHERE</span> c_no <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;3-245&#x27;</span>) <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sc_degree <span class="hljs-keyword">DESC</span>;</code></pre></div>

<ul>
<li>查询选修编号为”3-105”且成绩高于选修编号为”3-245”课程的同学c_no.s_no和sc_degree</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">WHERE</span> c_no <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;3-105&#x27;</span> 
<span class="hljs-keyword">AND</span> sc_degree <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALL</span>(<span class="hljs-keyword">SELECT</span> sc_degree <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">WHERE</span> c_no <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;3-245&#x27;</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sc_degree <span class="hljs-keyword">DESC</span>;</code></pre></div>

<ul>
<li>查出学生的信息,课程名称,分数(s_name c_name,sc_degree)</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s.s_name, c.c_name, sc.sc_degree <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">AS</span> s, course <span class="hljs-keyword">AS</span> c, score <span class="hljs-keyword">AS</span> sc
<span class="hljs-keyword">WHERE</span> s.s_no <span class="hljs-operator">=</span> sc.s_no
<span class="hljs-keyword">AND</span> c.c_no <span class="hljs-operator">=</span> sc.c_no
<span class="hljs-keyword">AND</span> sc.sc_degree <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALL</span>(<span class="hljs-keyword">SELECT</span> sc_degree <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">WHERE</span> c_no <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;3-245&#x27;</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sc_degree <span class="hljs-keyword">DESC</span>;</code></pre></div>

<p>总结:</p>
<ul>
<li><p>ANY 和 ALL</p>
<ul>
<li>ANY:表示任何一个就行了,如;数组A中的值比数组B中任何一个都要大,那么只要A和B中最小的比较就行了</li>
<li>ALL:表示所有都要比较,如:数组A中的值比数组B中所有的数都要大,那么A要和B中最大的值比较才行</li>
</ul>
</li>
<li><p>查询所有教师和同学的 name ,sex, birthday</p>
</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s_name, s_sex, s_birthday <span class="hljs-keyword">FROM</span> student
<span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> t_name, t_sex, t_birthday <span class="hljs-keyword">FROM</span> teacher;</code></pre></div>

<ul>
<li>查询所有’女’教师和’女’学生的name,sex,birthday</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s_name, s_sex, s_birthday <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> s_sex <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;女&#x27;</span>
<span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> t_name, t_sex, t_birthday <span class="hljs-keyword">FROM</span> teacher <span class="hljs-keyword">WHERE</span> t_sex <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;女&#x27;</span>;</code></pre></div>

<ul>
<li>查询成绩比该课程平均成绩低的同学的成绩表</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">AS</span> a <span class="hljs-keyword">WHERE</span> sc_degree <span class="hljs-operator">&lt;</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(sc_degree) <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">AS</span> b <span class="hljs-keyword">WHERE</span> a.c_no <span class="hljs-operator">=</span> b.c_no);</code></pre></div>

<ul>
<li>查询成绩比该课程平均成绩低的同学的成绩表，并显示出学生name,课程name以及分数</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s.s_name <span class="hljs-keyword">AS</span> 学生姓名, c.c_name <span class="hljs-keyword">AS</span> 课程名, a.sc_degree <span class="hljs-keyword">AS</span> 成绩  <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">AS</span> a, student <span class="hljs-keyword">AS</span> s, course <span class="hljs-keyword">AS</span> c 
<span class="hljs-keyword">WHERE</span> sc_degree <span class="hljs-operator">&lt;</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(sc_degree) <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">AS</span> b <span class="hljs-keyword">WHERE</span> a.c_no <span class="hljs-operator">=</span> b.c_no)
<span class="hljs-keyword">AND</span> s.s_no <span class="hljs-operator">=</span> a.s_no
<span class="hljs-keyword">AND</span> c.c_no <span class="hljs-operator">=</span> a.c_no;</code></pre></div>

<ul>
<li>查询所有任课教师的t_name 和 t_depart(要在分数表中可以查得到)</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> teacher <span class="hljs-keyword">WHERE</span> t_no <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> t_no <span class="hljs-keyword">FROM</span> course <span class="hljs-keyword">WHERE</span> c_no <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> c_no <span class="hljs-keyword">FROM</span> score));</code></pre></div>

<ul>
<li>查出至少有2名男生的班号</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s_class <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> s_sex <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;男&#x27;</span> 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> s_class <span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(s_no) <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>;</code></pre></div>

<ul>
<li>查询student 表中 不姓”王”的同学的记录</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> s_name <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;王%&#x27;</span>;</code></pre></div>

<ul>
<li>查询student 中每个学生的姓名和年龄(当前时间 - 出生年份)</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s_name <span class="hljs-keyword">AS</span> 姓名, (<span class="hljs-keyword">YEAR</span>(NOW())<span class="hljs-operator">-</span><span class="hljs-keyword">YEAR</span>(s_birthday)) <span class="hljs-keyword">AS</span> 年龄 <span class="hljs-keyword">FROM</span> student;</code></pre></div>

<ul>
<li>查询student中最大和最小的 s_birthday的值</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MAX</span>(s_birthday), <span class="hljs-built_in">MIN</span>(s_birthday) <span class="hljs-keyword">FROM</span> student;</code></pre></div>

<ul>
<li>以班级号和年龄从大到小的顺序查询student表中的全部记录</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> s_class <span class="hljs-keyword">DESC</span>, (<span class="hljs-keyword">YEAR</span>(NOW()) <span class="hljs-operator">-</span> <span class="hljs-keyword">YEAR</span>(s_birthday)) <span class="hljs-keyword">DESC</span>;</code></pre></div>

<ul>
<li>查询”男”教师 及其所上的课</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> t.t_name, c.c_name <span class="hljs-keyword">FROM</span> teacher <span class="hljs-keyword">AS</span> t, course <span class="hljs-keyword">AS</span> c <span class="hljs-keyword">WHERE</span> t.t_sex <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;男&#x27;</span>  <span class="hljs-keyword">AND</span> t.t_no <span class="hljs-operator">=</span> c.t_no;</code></pre></div>

<ul>
<li>查询最高分同学的s_no c_no 和 sc_degree;</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> s_no <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> s_no <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">WHERE</span> sc_degree  <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MAX</span>(sc_degree) <span class="hljs-keyword">FROM</span> score));</code></pre></div>

<ul>
<li>查询和”李军”同性别的所有同学的s_name</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s_name <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> s_sex <span class="hljs-operator">=</span>  (<span class="hljs-keyword">SELECT</span> s_sex <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> s_name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;李军&#x27;</span>);</code></pre></div>

<ul>
<li>查询和”李军”同性别并且同班的所有同学的s_name</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s_name <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> s_sex <span class="hljs-operator">=</span>  (<span class="hljs-keyword">SELECT</span> s_sex <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> s_name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;李军&#x27;</span>)
<span class="hljs-keyword">AND</span> s_class <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> s_class <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> s_name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;李军&#x27;</span>);</code></pre></div>

<ul>
<li>查询所有选修’计算机导论’课程的’男’同学的成绩表，并显示出s_name,c_name</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> s.s_name, c.c_name, sc.sc_degree <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">AS</span> s, score <span class="hljs-keyword">AS</span> sc, course <span class="hljs-keyword">AS</span> c 
<span class="hljs-keyword">WHERE</span> s.s_no <span class="hljs-operator">=</span> sc.s_no <span class="hljs-keyword">AND</span> c.c_no <span class="hljs-operator">=</span> sc.c_no 
<span class="hljs-keyword">AND</span> c.c_name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;计算机导论&#x27;</span>
<span class="hljs-keyword">AND</span> s.s_sex <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;男&#x27;</span>;</code></pre></div>

<h2 id="DML"><a href="#DML" class="headerlink" title="DML"></a>DML</h2><h4 id="插入操作"><a href="#插入操作" class="headerlink" title="插入操作"></a>插入操作</h4><p><strong>方式一</strong></p>
<blockquote>
<p>INSERT INTO table<br>VALUES (‘’, ‘’…); </p>
</blockquote>
<p><strong>举例</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#<span class="hljs-number">1.</span>插入的值的类型要与列的类型一致或兼容
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> beauty(id,NAME,sex,borndate,phone,photo,boyfriend_id)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">13</span>,<span class="hljs-string">&#x27;唐艺昕&#x27;</span>,<span class="hljs-string">&#x27;女&#x27;</span>,<span class="hljs-string">&#x27;1990-4-23&#x27;</span>,<span class="hljs-string">&#x27;1898888888&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">2</span>);

#<span class="hljs-number">2.</span>不可以为<span class="hljs-keyword">null</span>的列必须插入值。可以为<span class="hljs-keyword">null</span>的列如何插入值？
#方式一：
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> beauty(id,NAME,sex,borndate,phone,photo,boyfriend_id)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">13</span>,<span class="hljs-string">&#x27;唐艺昕&#x27;</span>,<span class="hljs-string">&#x27;女&#x27;</span>,<span class="hljs-string">&#x27;1990-4-23&#x27;</span>,<span class="hljs-string">&#x27;1898888888&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">2</span>);
#方式二：
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> beauty(id,NAME,sex,phone)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">15</span>,<span class="hljs-string">&#x27;娜扎&#x27;</span>,<span class="hljs-string">&#x27;女&#x27;</span>,<span class="hljs-string">&#x27;1388888888&#x27;</span>);

#<span class="hljs-number">4.</span>列数和值的个数必须一致
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> beauty(NAME,sex,id,phone)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;关晓彤&#x27;</span>,<span class="hljs-string">&#x27;女&#x27;</span>,<span class="hljs-number">17</span>,<span class="hljs-string">&#x27;110&#x27;</span>);

#<span class="hljs-number">5.</span>可以省略列名，默认所有列，而且列的顺序和表中列的顺序一致
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> beauty
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">18</span>,<span class="hljs-string">&#x27;张飞&#x27;</span>,<span class="hljs-string">&#x27;男&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;119&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>);</code></pre></div>

<p><strong>方式二</strong></p>
<blockquote>
<p>insert into 表名<br>set 列名=值,列名=值,…</p>
</blockquote>
<p><strong>举例</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> beauty
<span class="hljs-keyword">SET</span> id<span class="hljs-operator">=</span><span class="hljs-number">19</span>,NAME<span class="hljs-operator">=</span><span class="hljs-string">&#x27;刘涛&#x27;</span>,phone<span class="hljs-operator">=</span><span class="hljs-string">&#x27;999&#x27;</span>;</code></pre></div>

<p><strong>两种方式的比较</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#<span class="hljs-number">1</span>、方式一支持插入多行,方式二不支持

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> beauty
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">23</span>,<span class="hljs-string">&#x27;唐艺昕1&#x27;</span>,<span class="hljs-string">&#x27;女&#x27;</span>,<span class="hljs-string">&#x27;1990-4-23&#x27;</span>,<span class="hljs-string">&#x27;1898888888&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">2</span>)
,(<span class="hljs-number">24</span>,<span class="hljs-string">&#x27;唐艺昕2&#x27;</span>,<span class="hljs-string">&#x27;女&#x27;</span>,<span class="hljs-string">&#x27;1990-4-23&#x27;</span>,<span class="hljs-string">&#x27;1898888888&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">2</span>)
,(<span class="hljs-number">25</span>,<span class="hljs-string">&#x27;唐艺昕3&#x27;</span>,<span class="hljs-string">&#x27;女&#x27;</span>,<span class="hljs-string">&#x27;1990-4-23&#x27;</span>,<span class="hljs-string">&#x27;1898888888&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">2</span>);

#<span class="hljs-number">2</span>、方式一支持子查询，方式二不支持

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> beauty(id,NAME,phone)
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">26</span>,<span class="hljs-string">&#x27;宋茜&#x27;</span>,<span class="hljs-string">&#x27;11809866&#x27;</span>;

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> beauty(id,NAME,phone)
<span class="hljs-keyword">SELECT</span> id,boyname,<span class="hljs-string">&#x27;1234567&#x27;</span>
<span class="hljs-keyword">FROM</span> boys <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">&lt;</span><span class="hljs-number">3</span>;</code></pre></div>

<p><strong>练习</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#方式一：
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> my_employees
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;patel&#x27;</span>,<span class="hljs-string">&#x27;Ralph&#x27;</span>,<span class="hljs-string">&#x27;Rpatel&#x27;</span>,<span class="hljs-number">895</span>),
(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;Dancs&#x27;</span>,<span class="hljs-string">&#x27;Betty&#x27;</span>,<span class="hljs-string">&#x27;Bdancs&#x27;</span>,<span class="hljs-number">860</span>),
(<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;Biri&#x27;</span>,<span class="hljs-string">&#x27;Ben&#x27;</span>,<span class="hljs-string">&#x27;Bbiri&#x27;</span>,<span class="hljs-number">1100</span>),
(<span class="hljs-number">4</span>,<span class="hljs-string">&#x27;Newman&#x27;</span>,<span class="hljs-string">&#x27;Chad&#x27;</span>,<span class="hljs-string">&#x27;Cnewman&#x27;</span>,<span class="hljs-number">750</span>),
(<span class="hljs-number">5</span>,<span class="hljs-string">&#x27;Ropeburn&#x27;</span>,<span class="hljs-string">&#x27;Audrey&#x27;</span>,<span class="hljs-string">&#x27;Aropebur&#x27;</span>,<span class="hljs-number">1550</span>);
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> my_employees;

#方式二：
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> my_employees
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,<span class="hljs-string">&#x27;patel&#x27;</span>,<span class="hljs-string">&#x27;Ralph&#x27;</span>,<span class="hljs-string">&#x27;Rpatel&#x27;</span>,<span class="hljs-number">895</span> <span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">2</span>,<span class="hljs-string">&#x27;Dancs&#x27;</span>,<span class="hljs-string">&#x27;Betty&#x27;</span>,<span class="hljs-string">&#x27;Bdancs&#x27;</span>,<span class="hljs-number">860</span> <span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">3</span>,<span class="hljs-string">&#x27;Biri&#x27;</span>,<span class="hljs-string">&#x27;Ben&#x27;</span>,<span class="hljs-string">&#x27;Bbiri&#x27;</span>,<span class="hljs-number">1100</span> <span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">4</span>,<span class="hljs-string">&#x27;Newman&#x27;</span>,<span class="hljs-string">&#x27;Chad&#x27;</span>,<span class="hljs-string">&#x27;Cnewman&#x27;</span>,<span class="hljs-number">750</span> <span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">5</span>,<span class="hljs-string">&#x27;Ropeburn&#x27;</span>,<span class="hljs-string">&#x27;Audrey&#x27;</span>,<span class="hljs-string">&#x27;Aropebur&#x27;</span>,<span class="hljs-number">1550</span>;</code></pre></div>

<h4 id="删除操作"><a href="#删除操作" class="headerlink" title="删除操作"></a><strong>删除操作</strong></h4><p><strong>方式一：DELETE</strong></p>
<p><strong>单表的删除★</strong></p>
<blockquote>
<p>DELETE FROM table<br>WHERE cow = ‘’; </p>
</blockquote>
<p><strong>举例</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例：删除手机号以<span class="hljs-number">9</span>结尾的女神信息

<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> beauty <span class="hljs-keyword">WHERE</span> phone <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%9&#x27;</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> beauty;</code></pre></div>

<p><strong>多表的删除</strong></p>
<blockquote>
<p>#sql92语法：<br>delete 表1的别名,表2的别名<br>from 表1 别名,表2 别名<br>where 连接条件<br>and 筛选条件;</p>
<p>#sql99语法：</p>
<p>delete 表1的别名,表2的别名<br>from 表1 别名<br>inner|left|right join 表2 别名 on 连接条件<br>where 筛选条件;</p>
</blockquote>
<p><strong>举例</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例：删除张无忌的女朋友的信息

<span class="hljs-keyword">DELETE</span> b
<span class="hljs-keyword">FROM</span> beauty b
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> boys bo <span class="hljs-keyword">ON</span> b.`boyfriend_id` <span class="hljs-operator">=</span> bo.`id`
<span class="hljs-keyword">WHERE</span> bo.`boyName`<span class="hljs-operator">=</span><span class="hljs-string">&#x27;张无忌&#x27;</span>;


#案例：删除黄晓明的信息以及他女朋友的信息
<span class="hljs-keyword">DELETE</span> b,bo
<span class="hljs-keyword">FROM</span> beauty b
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> boys bo <span class="hljs-keyword">ON</span> b.`boyfriend_id`<span class="hljs-operator">=</span>bo.`id`
<span class="hljs-keyword">WHERE</span> bo.`boyName`<span class="hljs-operator">=</span><span class="hljs-string">&#x27;黄晓明&#x27;</span>;</code></pre></div>

<p><strong>方式二：truncate语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例：将魅力值<span class="hljs-operator">&gt;</span><span class="hljs-number">100</span>的男神信息删除
<span class="hljs-keyword">TRUNCATE</span> <span class="hljs-keyword">TABLE</span> boys ;</code></pre></div>

<p><strong>比较</strong></p>
<ul>
<li>delete 可以加where 条件，truncate不能加</li>
<li>truncate删除，效率高一丢丢</li>
<li>假如要删除的表中有自增长列，如果用delete删除后，再插入数据，自增长列的值从断点开始，而truncate删除后，再插入数据，自增长列的值从1开始。</li>
<li>truncate删除没有返回值，delete删除有返回值</li>
<li>truncate删除不能回滚，delete删除可以回滚.</li>
</ul>
<h4 id="修改数据"><a href="#修改数据" class="headerlink" title="修改数据"></a><strong>修改数据</strong></h4><p><strong>修改单表的记录★</strong></p>
<blockquote>
<p>update 表名<br>set 列=新值,列=新值,…<br>where 筛选条件;</p>
</blockquote>
<p><strong>举例</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例<span class="hljs-number">1</span>：修改beauty表中姓唐的女神的电话为<span class="hljs-number">13899888899</span>
UPDATE beauty <span class="hljs-keyword">SET</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;13899888899&#x27;</span>
<span class="hljs-keyword">WHERE</span> NAME <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;唐%&#x27;</span>;

#案例<span class="hljs-number">2</span>：修改boys表中id好为<span class="hljs-number">2</span>的名称为张飞，魅力值 <span class="hljs-number">10</span>
UPDATE boys <span class="hljs-keyword">SET</span> boyname<span class="hljs-operator">=</span><span class="hljs-string">&#x27;张飞&#x27;</span>,usercp<span class="hljs-operator">=</span><span class="hljs-number">10</span>
<span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">2</span>;</code></pre></div>

<p><strong>修改多表的记录</strong></p>
<blockquote>
<p>#sql92语法：<br>update 表1 别名,表2 别名<br>set 列=值,…<br>where 连接条件<br>and 筛选条件;</p>
<p>#sql99语法：<br>update 表1 别名<br>inner|left|right join 表2 别名<br>on 连接条件<br>set 列=值,…<br>where 筛选条件;</p>
</blockquote>
<p><strong>举例</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例 <span class="hljs-number">1</span>：修改张无忌的女朋友的手机号为<span class="hljs-number">114</span>
UPDATE boys bo
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> beauty b <span class="hljs-keyword">ON</span> bo.`id`<span class="hljs-operator">=</span>b.`boyfriend_id`
<span class="hljs-keyword">SET</span> b.`phone`<span class="hljs-operator">=</span><span class="hljs-string">&#x27;119&#x27;</span>,bo.`userCP`<span class="hljs-operator">=</span><span class="hljs-number">1000</span>
<span class="hljs-keyword">WHERE</span> bo.`boyName`<span class="hljs-operator">=</span><span class="hljs-string">&#x27;张无忌&#x27;</span>;

#案例<span class="hljs-number">2</span>：修改没有男朋友的女神的男朋友编号都为<span class="hljs-number">2</span>号
UPDATE boys bo
<span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">JOIN</span> beauty b <span class="hljs-keyword">ON</span> bo.`id`<span class="hljs-operator">=</span>b.`boyfriend_id`
<span class="hljs-keyword">SET</span> b.`boyfriend_id`<span class="hljs-operator">=</span><span class="hljs-number">2</span>
<span class="hljs-keyword">WHERE</span> bo.`id` <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;

<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> boys;</code></pre></div>

<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><h4 id="系统变量"><a href="#系统变量" class="headerlink" title="系统变量"></a>系统变量</h4><blockquote>
<p>说明：变量由系统定义，不是用户定义，属于服务器层面<br>注意：全局变量需要添加global关键字，会话变量需要添加session关键字，如果不写，默认会话级别<br>使用步骤：<br>1、查看所有系统变量<br>show global|【session】variables;<br>2、查看满足条件的部分系统变量<br>show global|【session】 variables like ‘%char%’;<br>3、查看指定的系统变量的值<br>select @@global|【session】系统变量名;<br>4、为某个系统变量赋值<br>方式一：<br>set global|【session】系统变量名=值;<br>方式二：<br>set @@global|【session】系统变量名=值;</p>
</blockquote>
<p><strong>全局变量</strong></p>
<p>作用域：针对于所有会话（连接）有效，但不能跨重启</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#①查看所有全局变量
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">GLOBAL</span> VARIABLES;
#②查看满足条件的部分系统变量
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">GLOBAL</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%char%&#x27;</span>;
#③查看指定的系统变量的值
<span class="hljs-keyword">SELECT</span> @<span class="hljs-variable">@global</span>.autocommit;
#④为某个系统变量赋值
<span class="hljs-keyword">SET</span> @<span class="hljs-variable">@global</span>.autocommit<span class="hljs-operator">=</span><span class="hljs-number">0</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> autocommit<span class="hljs-operator">=</span><span class="hljs-number">0</span>;</code></pre></div>

<p><strong>会话变量</strong></p>
<p>作用域：针对于当前会话（连接）有效</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#①查看所有会话变量
<span class="hljs-keyword">SHOW</span> SESSION VARIABLES;
#②查看满足条件的部分会话变量
<span class="hljs-keyword">SHOW</span> SESSION VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%char%&#x27;</span>;
#③查看指定的会话变量的值
<span class="hljs-keyword">SELECT</span> @<span class="hljs-variable">@autocommit</span>;
<span class="hljs-keyword">SELECT</span> @<span class="hljs-variable">@session</span>.tx_isolation;
#④为某个会话变量赋值
<span class="hljs-keyword">SET</span> @<span class="hljs-variable">@session</span>.tx_isolation<span class="hljs-operator">=</span><span class="hljs-string">&#x27;read-uncommitted&#x27;</span>;
<span class="hljs-keyword">SET</span> SESSION tx_isolation<span class="hljs-operator">=</span><span class="hljs-string">&#x27;read-committed&#x27;</span>;</code></pre></div>

<h4 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h4><blockquote>
<p>说明：变量由用户自定义，而不是系统提供的<br>使用步骤：<br>1、声明<br>2、赋值<br>3、使用（查看、比较、运算等）</p>
</blockquote>
<p><strong>用户变量</strong></p>
<p>作用域：针对于当前会话（连接）有效，作用域同于会话变量</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#①声明并初始化,<span class="hljs-operator">=</span>或:<span class="hljs-operator">=</span>
<span class="hljs-keyword">SET</span> @变量名<span class="hljs-operator">=</span>值;
<span class="hljs-keyword">SET</span> @变量名:<span class="hljs-operator">=</span>值;
<span class="hljs-keyword">SELECT</span> @变量名:<span class="hljs-operator">=</span>值;

#②赋值（更新变量的值）
#方式一：
   <span class="hljs-keyword">SET</span> @变量名<span class="hljs-operator">=</span>值;
   <span class="hljs-keyword">SET</span> @变量名:<span class="hljs-operator">=</span>值;
   <span class="hljs-keyword">SELECT</span> @变量名:<span class="hljs-operator">=</span>值;
#方式二：
   <span class="hljs-keyword">SELECT</span> 字段 <span class="hljs-keyword">INTO</span> @变量名
   <span class="hljs-keyword">FROM</span> 表;
#③使用（查看变量的值）
<span class="hljs-keyword">SELECT</span> @变量名;</code></pre></div>

<p><strong>局部变量</strong></p>
<p>作用域：仅仅在定义它的begin end块中有效<br>应用在 begin end中的第一句话</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#①声明
<span class="hljs-keyword">DECLARE</span> 变量名 类型;
<span class="hljs-keyword">DECLARE</span> 变量名 类型 【<span class="hljs-keyword">DEFAULT</span> 值】;

#②赋值（更新变量的值）
#方式一：
   <span class="hljs-keyword">SET</span> 局部变量名<span class="hljs-operator">=</span>值;
   <span class="hljs-keyword">SET</span> 局部变量名:<span class="hljs-operator">=</span>值;
   <span class="hljs-keyword">SELECT</span> @局部变量名:<span class="hljs-operator">=</span>值;
#方式二：
   <span class="hljs-keyword">SELECT</span> 字段 <span class="hljs-keyword">INTO</span> 具备变量名
   <span class="hljs-keyword">FROM</span> 表;
   
#③使用（查看变量的值）
<span class="hljs-keyword">SELECT</span> 局部变量名;</code></pre></div>

<p><strong>举例</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例：声明两个变量，求和并打印

#用户变量
<span class="hljs-keyword">SET</span> <span class="hljs-variable">@m</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-variable">@n</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-variable">@sum</span><span class="hljs-operator">=</span><span class="hljs-variable">@m</span><span class="hljs-operator">+</span><span class="hljs-variable">@n</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@sum</span>;

#局部变量
<span class="hljs-keyword">DECLARE</span> m <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">DECLARE</span> n <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">DECLARE</span> SUM <span class="hljs-type">INT</span>;
<span class="hljs-keyword">SET</span> SUM<span class="hljs-operator">=</span>m<span class="hljs-operator">+</span>n;
<span class="hljs-keyword">SELECT</span> SUM;</code></pre></div>

<blockquote>
<div class="hljs code-wrapper"><pre><code class="hljs ada">			       作用域    	      		定义位置     							 语法
用户变量   当前会话      						会话的任何地方      		 加@符号，不用指定类型
局部变量   定义它的<span class="hljs-keyword">BEGIN</span> <span class="hljs-keyword">END</span>中     <span class="hljs-keyword">BEGIN</span> <span class="hljs-keyword">END</span>的第一句话 		一般不用加@,需要指定类型</code></pre></div>
</blockquote>
<h2 id="存储过程和函数"><a href="#存储过程和函数" class="headerlink" title="存储过程和函数"></a>存储过程和函数</h2><p>提高代码的重用性，简化操作</p>
<h4 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h4><blockquote>
<p>含义：一组预先编译好的SQL语句的集合，理解成批处理语句<br>1、提高代码的重用性<br>2、简化操作<br>3、减少了编译次数并且减少了和数据库服务器的连接次数，提高了效率</p>
</blockquote>
<p><strong>语法</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> 存储过程名(参数列表)
<span class="hljs-keyword">BEGIN</span>

   存储过程体（一组合法的<span class="hljs-keyword">SQL</span>语句）
<span class="hljs-keyword">END</span></code></pre></div>

<p><strong>参数列表包含三部分</strong></p>
<ul>
<li>参数模式  </li>
<li>参数名  </li>
<li>参数类型</li>
</ul>
<p>例如：<code>in stuname varchar(20)</code></p>
<p><strong>参数模式：</strong></p>
<ul>
<li>in：该参数可以作为输入，也就是该参数需要调用方传入值</li>
<li>out：该参数可以作为输出，也就是该参数可以作为返回值</li>
<li>inout：该参数既可以作为输入又可以作为输出，也就是该参数既需要传入值，又可以返回值</li>
</ul>
<p><strong>特别需要注意的是：</strong></p>
<ul>
<li>如果存储过程体仅仅只有一句话，begin end可以省略</li>
<li>存储过程体中的每条sql语句的结尾要求必须加分号</li>
<li>存储过程的结尾可以使用 delimiter 重新设置<br>语法：<br>delimiter 结束标记<br>案例：<br>delimiter $</li>
</ul>
<h4 id="调用过程"><a href="#调用过程" class="headerlink" title="调用过程"></a>调用过程</h4><div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CALL</span> 存储过程名(实参列表);</code></pre></div>

<p><strong>空参列表</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例：插入到admin表中五条记录
DELIMITER $
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> myp1()
<span class="hljs-keyword">BEGIN</span>
   <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> admin(username,`password`) 
   <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;john1&#x27;</span>,<span class="hljs-string">&#x27;0000&#x27;</span>),(<span class="hljs-string">&#x27;lily&#x27;</span>,<span class="hljs-string">&#x27;0000&#x27;</span>),(<span class="hljs-string">&#x27;rose&#x27;</span>,<span class="hljs-string">&#x27;0000&#x27;</span>),(<span class="hljs-string">&#x27;jack&#x27;</span>,<span class="hljs-string">&#x27;0000&#x27;</span>),(<span class="hljs-string">&#x27;tom&#x27;</span>,<span class="hljs-string">&#x27;0000&#x27;</span>);
<span class="hljs-keyword">END</span> $

<span class="hljs-keyword">CALL</span> myp1()$</code></pre></div>

<p><strong>创建带in模式参数的存储过程</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例<span class="hljs-number">1</span>：创建存储过程实现 根据女神名，查询对应的男神信息
DELIMITER $
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> myp2(<span class="hljs-keyword">IN</span> beautyName <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>))
<span class="hljs-keyword">BEGIN</span>
   <span class="hljs-keyword">SELECT</span> bo.<span class="hljs-operator">*</span>
   <span class="hljs-keyword">FROM</span> boys bo
   <span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">JOIN</span> beauty b <span class="hljs-keyword">ON</span> bo.id <span class="hljs-operator">=</span> b.boyfriend_id
   <span class="hljs-keyword">WHERE</span> b.name<span class="hljs-operator">=</span>beautyName;
   
<span class="hljs-keyword">END</span> $

#调用
<span class="hljs-keyword">CALL</span> myp2(<span class="hljs-string">&#x27;柳岩&#x27;</span>)$

#案例<span class="hljs-number">2</span> ：创建存储过程实现，用户是否登录成功
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> myp4(<span class="hljs-keyword">IN</span> username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),<span class="hljs-keyword">IN</span> PASSWORD <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>))
<span class="hljs-keyword">BEGIN</span>
	<span class="hljs-keyword">DECLARE</span> <span class="hljs-keyword">result</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;#声明并初始化
	
	<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">result</span>#赋值
	<span class="hljs-keyword">FROM</span> admin
	<span class="hljs-keyword">WHERE</span> admin.username <span class="hljs-operator">=</span> username
	<span class="hljs-keyword">AND</span> admin.password <span class="hljs-operator">=</span> PASSWORD;
	
	<span class="hljs-keyword">SELECT</span> IF(<span class="hljs-keyword">result</span><span class="hljs-operator">&gt;</span><span class="hljs-number">0</span>,<span class="hljs-string">&#x27;成功&#x27;</span>,<span class="hljs-string">&#x27;失败&#x27;</span>);#使用
<span class="hljs-keyword">END</span> $

#调用
<span class="hljs-keyword">CALL</span> myp3(<span class="hljs-string">&#x27;张飞&#x27;</span>,<span class="hljs-string">&#x27;8888&#x27;</span>)$</code></pre></div>

<p><strong>创建out模式参数的存储过程</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例<span class="hljs-number">1</span>：根据输入的女神名，返回对应的男神名
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> myp6(<span class="hljs-keyword">IN</span> beautyName <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),<span class="hljs-keyword">OUT</span> boyName <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>))
<span class="hljs-keyword">BEGIN</span>
   <span class="hljs-keyword">SELECT</span> bo.boyname <span class="hljs-keyword">INTO</span> boyname
   <span class="hljs-keyword">FROM</span> boys bo
   <span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">JOIN</span>
   beauty b <span class="hljs-keyword">ON</span> b.boyfriend_id <span class="hljs-operator">=</span> bo.id
   <span class="hljs-keyword">WHERE</span> b.name<span class="hljs-operator">=</span>beautyName ;
   
<span class="hljs-keyword">END</span> $

<span class="hljs-keyword">CALL</span> myp6(<span class="hljs-string">&#x27;Luci&#x27;</span>,<span class="hljs-variable">@bname</span>)$
<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@bname</span>$

#案例<span class="hljs-number">2</span>：根据输入的女神名，返回对应的男神名和魅力值
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> myp7(<span class="hljs-keyword">IN</span> beautyName <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),<span class="hljs-keyword">OUT</span> boyName <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),<span class="hljs-keyword">OUT</span> usercp <span class="hljs-type">INT</span>) 
<span class="hljs-keyword">BEGIN</span>
	<span class="hljs-keyword">SELECT</span> boys.boyname ,boys.usercp <span class="hljs-keyword">INTO</span> boyname,usercp
	<span class="hljs-keyword">FROM</span> boys 
	<span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">JOIN</span>
	beauty b <span class="hljs-keyword">ON</span> b.boyfriend_id <span class="hljs-operator">=</span> boys.id
	<span class="hljs-keyword">WHERE</span> b.name<span class="hljs-operator">=</span>beautyName ;
	
<span class="hljs-keyword">END</span> $


#调用
<span class="hljs-keyword">CALL</span> myp7(<span class="hljs-string">&#x27;小昭&#x27;</span>,<span class="hljs-variable">@name</span>,<span class="hljs-variable">@cp</span>)$
<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@name</span>,<span class="hljs-variable">@cp</span>$</code></pre></div>

<p><strong>创建带inout模式参数的存储过程</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例<span class="hljs-number">1</span>：传入a和b两个值，最终a和b都翻倍并返回
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> myp8(<span class="hljs-keyword">INOUT</span> a <span class="hljs-type">INT</span> ,<span class="hljs-keyword">INOUT</span> b <span class="hljs-type">INT</span>)
<span class="hljs-keyword">BEGIN</span>
   <span class="hljs-keyword">SET</span> a<span class="hljs-operator">=</span>a<span class="hljs-operator">*</span><span class="hljs-number">2</span>;
   <span class="hljs-keyword">SET</span> b<span class="hljs-operator">=</span>b<span class="hljs-operator">*</span><span class="hljs-number">2</span>;
<span class="hljs-keyword">END</span> $

#调用
<span class="hljs-keyword">SET</span> <span class="hljs-variable">@m</span><span class="hljs-operator">=</span><span class="hljs-number">10</span>$
<span class="hljs-keyword">SET</span> <span class="hljs-variable">@n</span><span class="hljs-operator">=</span><span class="hljs-number">20</span>$
<span class="hljs-keyword">CALL</span> myp8(<span class="hljs-variable">@m</span>,<span class="hljs-variable">@n</span>)$
<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@m</span>,<span class="hljs-variable">@n</span>$</code></pre></div>

<p><strong>删除存储过程</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">PROCEDURE</span> p1;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">PROCEDURE</span> p2,p3;#不支持删除多个</code></pre></div>

<p><strong>查看存储过程的信息</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span>  myp2;</code></pre></div>

<h4 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h4><blockquote>
<p>含义：一组预先编译好的SQL语句的集合，理解成批处理语句<br>1、提高代码的重用性<br>2、简化操作<br>3、减少了编译次数并且减少了和数据库服务器的连接次数，提高了效率</p>
</blockquote>
<p><strong>区别</strong></p>
<p>存储过程：可以有0个返回，也可以有多个返回，适合做批量插入、批量更新<br>函数：有且仅有1 个返回，适合做处理数据后返回一个结果</p>
<p><strong>语法</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> 函数名(参数列表) <span class="hljs-keyword">RETURNS</span> 返回类型
<span class="hljs-keyword">BEGIN</span>
   函数体
<span class="hljs-keyword">END</span></code></pre></div>

<p><strong>注意</strong></p>
<blockquote>
<p>1.参数列表 包含两部分： 参数名 参数类型</p>
<p>2.函数体：肯定会有return语句，如果没有会报错 如果return语句没有放在函数体的最后也不报错，但不建议</p>
<p>3.函数体中仅有一句话，则可以省略begin end 4.使用 delimiter语句设置结束标记</p>
</blockquote>
<h4 id="调用函数"><a href="#调用函数" class="headerlink" title="调用函数"></a>调用函数</h4><div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> 函数名(参数列表)</code></pre></div>

<p><strong>无参有返回</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例：返回公司的员工个数
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> myf1() <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">INT</span>
<span class="hljs-keyword">BEGIN</span>

   <span class="hljs-keyword">DECLARE</span> c <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;#定义局部变量
   <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">INTO</span> c#赋值
   <span class="hljs-keyword">FROM</span> employees;
   <span class="hljs-keyword">RETURN</span> c;
   
<span class="hljs-keyword">END</span> $

<span class="hljs-keyword">SELECT</span> myf1()$</code></pre></div>

<p><strong>有参有返回</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例<span class="hljs-number">1</span>：根据员工名，返回它的工资

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> myf2(empName <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)) <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">DOUBLE</span>
<span class="hljs-keyword">BEGIN</span>
   <span class="hljs-keyword">SET</span> <span class="hljs-variable">@sal</span><span class="hljs-operator">=</span><span class="hljs-number">0</span>;#定义用户变量 
   <span class="hljs-keyword">SELECT</span> salary <span class="hljs-keyword">INTO</span> <span class="hljs-variable">@sal</span>   #赋值
   <span class="hljs-keyword">FROM</span> employees
   <span class="hljs-keyword">WHERE</span> last_name <span class="hljs-operator">=</span> empName;
   
   <span class="hljs-keyword">RETURN</span> <span class="hljs-variable">@sal</span>;
<span class="hljs-keyword">END</span> $

<span class="hljs-keyword">SELECT</span> myf2(<span class="hljs-string">&#x27;k_ing&#x27;</span>) $

#案例<span class="hljs-number">2</span>：根据部门名，返回该部门的平均工资

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> myf3(deptName <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)) <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">DOUBLE</span>
<span class="hljs-keyword">BEGIN</span>
   <span class="hljs-keyword">DECLARE</span> sal <span class="hljs-keyword">DOUBLE</span> ;
   <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(salary) <span class="hljs-keyword">INTO</span> sal
   <span class="hljs-keyword">FROM</span> employees e
   <span class="hljs-keyword">JOIN</span> departments d <span class="hljs-keyword">ON</span> e.department_id <span class="hljs-operator">=</span> d.department_id
   <span class="hljs-keyword">WHERE</span> d.department_name<span class="hljs-operator">=</span>deptName;
   <span class="hljs-keyword">RETURN</span> sal;
<span class="hljs-keyword">END</span> $

<span class="hljs-keyword">SELECT</span> myf3(<span class="hljs-string">&#x27;IT&#x27;</span>)$</code></pre></div>

<p><strong>查看函数</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> myf3;</code></pre></div>

<p><strong>删除函数</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">FUNCTION</span> myf3;</code></pre></div>

<p><strong>案例</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#一、创建函数，实现传入两个<span class="hljs-type">float</span>，返回二者之和
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> test_fun1(num1 <span class="hljs-type">FLOAT</span>,num2 <span class="hljs-type">FLOAT</span>) <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">FLOAT</span>
<span class="hljs-keyword">BEGIN</span>
   <span class="hljs-keyword">DECLARE</span> SUM <span class="hljs-type">FLOAT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;
   <span class="hljs-keyword">SET</span> SUM<span class="hljs-operator">=</span>num1<span class="hljs-operator">+</span>num2;
   <span class="hljs-keyword">RETURN</span> SUM;
<span class="hljs-keyword">END</span> $

<span class="hljs-keyword">SELECT</span> test_fun1(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)$</code></pre></div>

<h2 id="流程控制结构"><a href="#流程控制结构" class="headerlink" title="流程控制结构"></a>流程控制结构</h2><h4 id="if函数"><a href="#if函数" class="headerlink" title="if函数"></a>if函数</h4><blockquote>
<p>语法：if(条件,值1，值2)<br>功能：实现双分支<br>应用在begin end中或外面</p>
</blockquote>
<h4 id="case函数"><a href="#case函数" class="headerlink" title="case函数"></a>case函数</h4><blockquote>
<p>情况1：类似于switch<br>case 变量或表达式<br>when 判断的值1 then 返回的值1或语句;<br>when 判断的值2 then 返回的值2或语句;<br>…<br>else 返回的值n或语句;<br>end </p>
<p>情况2：<br>case<br>when 判断的值1 then 返回的值1或语句;<br>when 判断的值2 then 返回的值2或语句;<br>…<br>else 返回的值n或语句;<br>end </p>
<p>应用在begin end 中或外面</p>
<p>ps:如果是语句，只能放在begin end中</p>
</blockquote>
<h4 id="if结构"><a href="#if结构" class="headerlink" title="if结构"></a>if结构</h4><blockquote>
<p>if 条件1 then 语句1;<br>elseif 条件2 then 语句2;<br>….<br>else 语句n;<br>end if;<br>功能：类似于多重if</p>
<p>只能应用在begin end 中</p>
</blockquote>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例<span class="hljs-number">1</span>：创建函数，实现传入成绩，如果成绩<span class="hljs-operator">&gt;</span><span class="hljs-number">90</span>,返回A，如果成绩<span class="hljs-operator">&gt;</span><span class="hljs-number">80</span>,返回B，如果成绩<span class="hljs-operator">&gt;</span><span class="hljs-number">60</span>,返回C，否则返回D
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> test_if(score <span class="hljs-type">FLOAT</span>) <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">CHAR</span>
<span class="hljs-keyword">BEGIN</span>
   <span class="hljs-keyword">DECLARE</span> ch <span class="hljs-type">CHAR</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;A&#x27;</span>;
   IF score<span class="hljs-operator">&gt;</span><span class="hljs-number">90</span> <span class="hljs-keyword">THEN</span> <span class="hljs-keyword">SET</span> ch<span class="hljs-operator">=</span><span class="hljs-string">&#x27;A&#x27;</span>;
   ELSEIF score<span class="hljs-operator">&gt;</span><span class="hljs-number">80</span> <span class="hljs-keyword">THEN</span> <span class="hljs-keyword">SET</span> ch<span class="hljs-operator">=</span><span class="hljs-string">&#x27;B&#x27;</span>;
   ELSEIF score<span class="hljs-operator">&gt;</span><span class="hljs-number">60</span> <span class="hljs-keyword">THEN</span> <span class="hljs-keyword">SET</span> ch<span class="hljs-operator">=</span><span class="hljs-string">&#x27;C&#x27;</span>;
   <span class="hljs-keyword">ELSE</span> <span class="hljs-keyword">SET</span> ch<span class="hljs-operator">=</span><span class="hljs-string">&#x27;D&#x27;</span>;
   <span class="hljs-keyword">END</span> IF;
   <span class="hljs-keyword">RETURN</span> ch;
   
   
<span class="hljs-keyword">END</span> $

<span class="hljs-keyword">SELECT</span> test_if(<span class="hljs-number">87</span>)$


#案例<span class="hljs-number">2</span>：创建存储过程，如果工资<span class="hljs-operator">&lt;</span><span class="hljs-number">2000</span>,则删除，如果<span class="hljs-number">5000</span><span class="hljs-operator">&gt;</span>工资<span class="hljs-operator">&gt;</span><span class="hljs-number">2000</span>,则涨工资<span class="hljs-number">1000</span>，否则涨工资<span class="hljs-number">500</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> test_if_pro(<span class="hljs-keyword">IN</span> sal <span class="hljs-keyword">DOUBLE</span>)
<span class="hljs-keyword">BEGIN</span>
   IF sal<span class="hljs-operator">&lt;</span><span class="hljs-number">2000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> employees.salary<span class="hljs-operator">=</span>sal;
   ELSEIF sal<span class="hljs-operator">&gt;=</span><span class="hljs-number">2000</span> <span class="hljs-keyword">AND</span> sal<span class="hljs-operator">&lt;</span><span class="hljs-number">5000</span> <span class="hljs-keyword">THEN</span> UPDATE employees <span class="hljs-keyword">SET</span> salary<span class="hljs-operator">=</span>salary<span class="hljs-operator">+</span><span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> employees.`salary`<span class="hljs-operator">=</span>sal;
   <span class="hljs-keyword">ELSE</span> UPDATE employees <span class="hljs-keyword">SET</span> salary<span class="hljs-operator">=</span>salary<span class="hljs-operator">+</span><span class="hljs-number">500</span> <span class="hljs-keyword">WHERE</span> employees.`salary`<span class="hljs-operator">=</span>sal;
   <span class="hljs-keyword">END</span> IF;
   
<span class="hljs-keyword">END</span> $

<span class="hljs-keyword">CALL</span> test_if_pro(<span class="hljs-number">2100</span>)$

#案例<span class="hljs-number">3</span>：创建函数，实现传入成绩，如果成绩<span class="hljs-operator">&gt;</span><span class="hljs-number">90</span>,返回A，如果成绩<span class="hljs-operator">&gt;</span><span class="hljs-number">80</span>,返回B，如果成绩<span class="hljs-operator">&gt;</span><span class="hljs-number">60</span>,返回C，否则返回D
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> test_case(score <span class="hljs-type">FLOAT</span>) <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">CHAR</span>
<span class="hljs-keyword">BEGIN</span> 
   <span class="hljs-keyword">DECLARE</span> ch <span class="hljs-type">CHAR</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;A&#x27;</span>;
   
   <span class="hljs-keyword">CASE</span> 
   <span class="hljs-keyword">WHEN</span> score<span class="hljs-operator">&gt;</span><span class="hljs-number">90</span> <span class="hljs-keyword">THEN</span> <span class="hljs-keyword">SET</span> ch<span class="hljs-operator">=</span><span class="hljs-string">&#x27;A&#x27;</span>;
   <span class="hljs-keyword">WHEN</span> score<span class="hljs-operator">&gt;</span><span class="hljs-number">80</span> <span class="hljs-keyword">THEN</span> <span class="hljs-keyword">SET</span> ch<span class="hljs-operator">=</span><span class="hljs-string">&#x27;B&#x27;</span>;
   <span class="hljs-keyword">WHEN</span> score<span class="hljs-operator">&gt;</span><span class="hljs-number">60</span> <span class="hljs-keyword">THEN</span> <span class="hljs-keyword">SET</span> ch<span class="hljs-operator">=</span><span class="hljs-string">&#x27;C&#x27;</span>;
   <span class="hljs-keyword">ELSE</span> <span class="hljs-keyword">SET</span> ch<span class="hljs-operator">=</span><span class="hljs-string">&#x27;D&#x27;</span>;
   <span class="hljs-keyword">END</span> <span class="hljs-keyword">CASE</span>;
   
   <span class="hljs-keyword">RETURN</span> ch;
<span class="hljs-keyword">END</span> $

<span class="hljs-keyword">SELECT</span> test_case(<span class="hljs-number">56</span>)$</code></pre></div>

<h4 id="while"><a href="#while" class="headerlink" title="while"></a>while</h4><blockquote>
<p>【标签:】while 循环条件 do<br>   循环体;<br>end while【 标签】;</p>
<p>联想：</p>
<p>while(循环条件){</p>
<p>   循环体;<br>}</p>
</blockquote>
<h4 id="loop"><a href="#loop" class="headerlink" title="loop"></a>loop</h4><blockquote>
<p>【标签:】loop<br>   循环体;<br>end loop 【标签】;</p>
<p>可以用来模拟简单的死循环</p>
</blockquote>
<h4 id="repeat"><a href="#repeat" class="headerlink" title="repeat"></a>repeat</h4><blockquote>
<p>【标签：】repeat<br>   循环体;<br>until 结束循环的条件<br>end repeat 【标签】;</p>
</blockquote>
<p><strong>没有添加循环控制语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例：批量插入，根据次数插入到admin表中多条记录
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">PROCEDURE</span> pro_while1$
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> pro_while1(<span class="hljs-keyword">IN</span> insertCount <span class="hljs-type">INT</span>)
<span class="hljs-keyword">BEGIN</span>
   <span class="hljs-keyword">DECLARE</span> i <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>;
   WHILE i<span class="hljs-operator">&lt;=</span>insertCount DO
      <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> admin(username,`password`) <span class="hljs-keyword">VALUES</span>(CONCAT(<span class="hljs-string">&#x27;Rose&#x27;</span>,i),<span class="hljs-string">&#x27;666&#x27;</span>);
      <span class="hljs-keyword">SET</span> i<span class="hljs-operator">=</span>i<span class="hljs-operator">+</span><span class="hljs-number">1</span>;
   <span class="hljs-keyword">END</span> WHILE;
   
<span class="hljs-keyword">END</span> $

<span class="hljs-keyword">CALL</span> pro_while1(<span class="hljs-number">100</span>)$</code></pre></div>

<p>iterate类似于 continue，继续，结束本次循环，继续下一次<br>leave 类似于  break，跳出，结束当前所在的循环</p>
<p><strong>添加leave语句</strong>（此时必须加名称）</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例：批量插入，根据次数插入到admin表中多条记录，如果次数<span class="hljs-operator">&gt;</span><span class="hljs-number">20</span>则停止
<span class="hljs-keyword">TRUNCATE</span> <span class="hljs-keyword">TABLE</span> admin$
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">PROCEDURE</span> test_while1$
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> test_while1(<span class="hljs-keyword">IN</span> insertCount <span class="hljs-type">INT</span>)
<span class="hljs-keyword">BEGIN</span>
   <span class="hljs-keyword">DECLARE</span> i <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>;
   a:WHILE i<span class="hljs-operator">&lt;=</span>insertCount DO
      <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> admin(username,`password`) <span class="hljs-keyword">VALUES</span>(CONCAT(<span class="hljs-string">&#x27;xiaohua&#x27;</span>,i),<span class="hljs-string">&#x27;0000&#x27;</span>);
      IF i<span class="hljs-operator">&gt;=</span><span class="hljs-number">20</span> <span class="hljs-keyword">THEN</span> LEAVE a;
      <span class="hljs-keyword">END</span> IF;
      <span class="hljs-keyword">SET</span> i<span class="hljs-operator">=</span>i<span class="hljs-operator">+</span><span class="hljs-number">1</span>;
   <span class="hljs-keyword">END</span> WHILE a;
<span class="hljs-keyword">END</span> $


<span class="hljs-keyword">CALL</span> test_while1(<span class="hljs-number">100</span>)$</code></pre></div>

<p><strong>添加iterate语句</strong>（此时必须加名称）</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例：批量插入，根据次数插入到admin表中多条记录，只插入偶数次
<span class="hljs-keyword">TRUNCATE</span> <span class="hljs-keyword">TABLE</span> admin$
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">PROCEDURE</span> test_while1$
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> test_while1(<span class="hljs-keyword">IN</span> insertCount <span class="hljs-type">INT</span>)
<span class="hljs-keyword">BEGIN</span>
   <span class="hljs-keyword">DECLARE</span> i <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;
   a:WHILE i<span class="hljs-operator">&lt;=</span>insertCount DO
      <span class="hljs-keyword">SET</span> i<span class="hljs-operator">=</span>i<span class="hljs-operator">+</span><span class="hljs-number">1</span>;
      IF <span class="hljs-built_in">MOD</span>(i,<span class="hljs-number">2</span>)<span class="hljs-operator">!=</span><span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> ITERATE a;
      <span class="hljs-keyword">END</span> IF;
      
      <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> admin(username,`password`) <span class="hljs-keyword">VALUES</span>(CONCAT(<span class="hljs-string">&#x27;xiaohua&#x27;</span>,i),<span class="hljs-string">&#x27;0000&#x27;</span>);
      
   <span class="hljs-keyword">END</span> WHILE a;
<span class="hljs-keyword">END</span> $


<span class="hljs-keyword">CALL</span> test_while1(<span class="hljs-number">100</span>)$</code></pre></div>

<p><strong>案例</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">/*已知表stringcontent</span>
<span class="hljs-comment">其中字段：</span>
<span class="hljs-comment">id 自增长</span>
<span class="hljs-comment">content varchar(20)</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">向该表插入指定个数的，随机的字符串</span>
<span class="hljs-comment">*/</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> stringcontent;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> stringcontent(
   id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
   content <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)
   
);
DELIMITER $
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> test_randstr_insert(<span class="hljs-keyword">IN</span> insertCount <span class="hljs-type">INT</span>)
<span class="hljs-keyword">BEGIN</span>
   <span class="hljs-keyword">DECLARE</span> i <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>;
   <span class="hljs-keyword">DECLARE</span> str <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">26</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span>;
   <span class="hljs-keyword">DECLARE</span> startIndex <span class="hljs-type">INT</span>;#代表初始索引
   <span class="hljs-keyword">DECLARE</span> len <span class="hljs-type">INT</span>;#代表截取的字符长度
   WHILE i<span class="hljs-operator">&lt;=</span>insertcount DO
      <span class="hljs-keyword">SET</span> startIndex<span class="hljs-operator">=</span><span class="hljs-built_in">FLOOR</span>(RAND()<span class="hljs-operator">*</span><span class="hljs-number">26</span><span class="hljs-operator">+</span><span class="hljs-number">1</span>);#代表初始索引，随机范围<span class="hljs-number">1</span><span class="hljs-number">-26</span>
      <span class="hljs-keyword">SET</span> len<span class="hljs-operator">=</span><span class="hljs-built_in">FLOOR</span>(RAND()<span class="hljs-operator">*</span>(<span class="hljs-number">20</span><span class="hljs-operator">-</span>startIndex<span class="hljs-operator">+</span><span class="hljs-number">1</span>)<span class="hljs-operator">+</span><span class="hljs-number">1</span>);#代表截取长度，随机范围<span class="hljs-number">1</span><span class="hljs-operator">-</span>（<span class="hljs-number">20</span><span class="hljs-operator">-</span>startIndex<span class="hljs-operator">+</span><span class="hljs-number">1</span>）,content<span class="hljs-number">-20</span>
      <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> stringcontent(content) <span class="hljs-keyword">VALUES</span>(SUBSTR(str,startIndex,len));
      <span class="hljs-keyword">SET</span> i<span class="hljs-operator">=</span>i<span class="hljs-operator">+</span><span class="hljs-number">1</span>;
   <span class="hljs-keyword">END</span> WHILE;

<span class="hljs-keyword">END</span> $

<span class="hljs-keyword">CALL</span> test_randstr_insert(<span class="hljs-number">10</span>)$</code></pre></div>



<h1 id="二、约束"><a href="#二、约束" class="headerlink" title="二、约束"></a>二、约束</h1><h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><blockquote>
<ul>
<li>数值型：<br>   整型<br>   小数：<div class="hljs code-wrapper"><pre><code>  定点数
  浮点数
</code></pre></div>
</li>
<li>字符型：<br>   较短的文本：char、varchar<br>   较长的文本：text、blob（较长的二进制数据）</li>
<li>日期型：</li>
</ul>
</blockquote>
<h4 id="整型"><a href="#整型" class="headerlink" title="整型"></a>整型</h4><p><strong>分类</strong></p>
<blockquote>
<p>tinyint、smallint、mediumint、int/integer、bigint<br>1               2                3                  4                 8         (字节)</p>
</blockquote>
<p><strong>特点</strong></p>
<p>① 如果不设置无符号还是有符号，默认是有符号，如果想设置无符号，需要添加<code>unsigned</code>关键字<br>② 如果插入的数值超出了整型的范围,会报out of range异常，并且插入临界值<br>③ 如果不设置长度，会有默认的长度<br>长度代表了显示的最大宽度，如果不够会用0在左边填充，但必须搭配<code>zerofill</code>使用！</p>
<p><strong>如何设置无符号和有符号</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> tab_int;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tab_int(
   t1 <span class="hljs-type">INT</span>(<span class="hljs-number">7</span>) unsigned,
   t2 <span class="hljs-type">INT</span>(<span class="hljs-number">7</span>) ZEROFILL 

);

<span class="hljs-keyword">DESC</span> tab_int;


<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> tab_int <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">-123456</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> tab_int <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">-123456</span>,<span class="hljs-number">-123456</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> tab_int <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">2147483648</span>,<span class="hljs-number">4294967296</span>);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> tab_int <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">123</span>,<span class="hljs-number">123</span>);


<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> tab_int;</code></pre></div>

<h4 id="小数"><a href="#小数" class="headerlink" title="小数"></a>小数</h4><p><strong>分类</strong></p>
<blockquote>
<ul>
<li>浮点型<br>float(M,D)<br>double(M,D)</li>
<li>定点型<br>dec(M，D)<br>decimal(M,D)</li>
</ul>
</blockquote>
<p><strong>特点</strong></p>
<ul>
<li>M：整数部位+小数部位，D：小数部位<ul>
<li>如果超过范围，则插入临界值</li>
</ul>
</li>
<li>M和D都可以省略<ul>
<li>如果是decimal，则M默认为10，D默认为0</li>
<li>如果是float和double，则会根据插入的数值的精度来决定精度</li>
</ul>
</li>
<li>定点型的精确度较高，如果要求插入数值的精度较高如货币运算等则考虑使用</li>
</ul>
<p><strong>原则</strong></p>
<p>所选择的类型越简单越好，能保存数值的类型越小越好</p>
<h4 id="字符型"><a href="#字符型" class="headerlink" title="字符型"></a>字符型</h4><p><strong>分类</strong></p>
<blockquote>
<ul>
<li>较短的文本：<ul>
<li>char</li>
<li>varchar</li>
</ul>
</li>
<li>其他：<ul>
<li>binary和varbinary用于保存较短的二进制</li>
<li>enum用于保存枚举</li>
<li>set用于保存集合</li>
</ul>
</li>
<li>较长的文本：<ul>
<li>text</li>
<li>blob(较大的二进制)</li>
</ul>
</li>
</ul>
</blockquote>
<p><strong>特点</strong></p>
<blockquote>
<p>写法                                            M的意思                                       特点                   空间的耗费              效率<br>char   char(M)               最大的字符数，可以省略，默认为1       固定长度的字符       比较耗费               高</p>
<p>varchar varchar(M)         最大的字符数，不可以省略                  可变长度的字符       比较节省               低</p>
</blockquote>
<h4 id="日期型"><a href="#日期型" class="headerlink" title="日期型"></a>日期型</h4><p><strong>分类</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;time_zone&#x27;</span>;

<span class="hljs-keyword">SET</span> time_zone<span class="hljs-operator">=</span><span class="hljs-string">&#x27;+9:00&#x27;</span>;</code></pre></div>

<blockquote>
<ul>
<li>date只保存日期</li>
<li>time 只保存时间</li>
<li>year只保存年</li>
<li>datetime保存日期+时间</li>
<li>timestamp保存日期+时间 （用得多）</li>
</ul>
</blockquote>
<p><strong>特点</strong></p>
<blockquote>
<div class="hljs code-wrapper"><pre><code>                         字节                范围                            时区等的影响
</code></pre></div>
<p>datetime                  8          1000——9999                          不受 </p>
<p>timestamp              4               1970-2038                              受</p>
</blockquote>
<p><strong>更改时区</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;time_zone&#x27;</span>;

<span class="hljs-keyword">SET</span> time_zone<span class="hljs-operator">=</span><span class="hljs-string">&#x27;+9:00&#x27;</span>;</code></pre></div>

<h2 id="主键约束"><a href="#主键约束" class="headerlink" title="主键约束"></a>主键约束</h2><blockquote>
<p>PRIMARY KEY:主键，用于保证该字段的值具有唯一性，并且非空<br>比如学号、员工编号等<br>能够唯一确定表中的一条记录。我们通过给某个字段添加该约束，就可以使得该字段不重复且不为空。</p>
</blockquote>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">user</span> (
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
	name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)
);</code></pre></div>

<p><strong>联合主键</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user2 (
	id <span class="hljs-type">INT</span>,
	name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    <span class="hljs-keyword">PRIMARY</span> KEY(id, name)
);</code></pre></div>

<p>此处字段id和name一同作为主键，联合主键要求每个字段<strong>加起来不同即可</strong>（无需每个字段都不同）</p>
<p><strong>建表后添加主键</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">ALERT <span class="hljs-keyword">TABLE</span> user2 <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">PRIMARY</span> KEY (id);</code></pre></div>

<p>或者通过<strong>修改字段</strong>的方式来添加主键</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">ALERT <span class="hljs-keyword">TABLE</span> user2 MODIFY id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY;</code></pre></div>

<p><strong>建表后删除主键</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">ALERT <span class="hljs-keyword">TABLE</span> user2 <span class="hljs-keyword">DROP</span>  <span class="hljs-keyword">PRIMARY</span> KEY (id);</code></pre></div>

<h2 id="自增约束"><a href="#自增约束" class="headerlink" title="自增约束"></a>自增约束</h2><blockquote>
<p>1、标识列必须和主键搭配吗？不一定，但要求是一个key<br>2、一个表可以有几个标识列？至多一个！<br>3、标识列的类型只能是数值型<br>4、标识列可以通过 SET auto_increment_increment=3;设置步长<br>可以通过手动插入值，设置起始值</p>
</blockquote>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user3 (
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREAMENT,
	name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> user3 (name) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;name&#x27;</span>); <span class="hljs-operator">/</span><span class="hljs-operator">/</span>插入成功，自动生成了id 

#设置自增
<span class="hljs-keyword">SET</span> auto_increment_increment<span class="hljs-operator">=</span><span class="hljs-number">3</span>;</code></pre></div>

<p>自增约束一般<strong>与主键搭配使用</strong></p>
<h2 id="唯一约束"><a href="#唯一约束" class="headerlink" title="唯一约束"></a>唯一约束</h2><blockquote>
<p>UNIQUE:唯一，用于保证该字段的值具有唯一性，可以为空<br>比如座位号<br>约束修饰的字段不可以重复</p>
</blockquote>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user4 (
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREAMENT <span class="hljs-keyword">UNIQUE</span>,
	name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)
);</code></pre></div>

<p>或者</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user4 (
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREAMENT,
	name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
	<span class="hljs-keyword">UNIQUE</span>(id, name)
);</code></pre></div>

<h2 id="非空约束"><a href="#非空约束" class="headerlink" title="非空约束"></a>非空约束</h2><blockquote>
<p>NOT NULL：非空，用于保证该字段的值不能为空<br>比如姓名、学号等</p>
</blockquote>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user4 (
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
	name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
);</code></pre></div>

<h2 id="默认约束"><a href="#默认约束" class="headerlink" title="默认约束"></a>默认约束</h2><blockquote>
<p>DEFAULT:默认，用于保证该字段有默认值<br>比如性别</p>
</blockquote>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user4 (
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">10</span>,
	name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
);</code></pre></div>

<p>如果我们插入字段时没有传值，就会<strong>使用默认值</strong></p>
<h2 id="外键约束"><a href="#外键约束" class="headerlink" title="外键约束"></a>外键约束</h2><blockquote>
<p>FOREIGN KEY:外键，用于限制两个表的关系，用于保证该字段的值必须来自于主表的关联列的值<br>在从表添加外键约束，用于引用主表中某列的值<br>比如学生表的专业编号，员工表的部门编号，员工表的工种编号</p>
</blockquote>
<p>主表</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> master(
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
	name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)
);</code></pre></div>

<p>从表</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> pet(
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
	name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
	master_id <span class="hljs-type">int</span>,
	<span class="hljs-keyword">FOREIGN</span> KEY(master_id) <span class="hljs-keyword">REFERENCES</span> master(id)
);</code></pre></div>

<ul>
<li>主表中没有的数据，在副表中是不可以使用的</li>
<li>主表中的数据被副标引用时，是不可以删除的</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> 表名(
   字段名 字段类型 列级约束,
   字段名 字段类型,
   表级约束
)</code></pre></div>

<p>约束的添加分类：</p>
<ul>
<li>列级约束：<ul>
<li>六大约束语法上都支持，但外键约束没有效果</li>
</ul>
</li>
<li>表级约束：<ul>
<li>除了非空、默认，其他的都支持</li>
</ul>
</li>
</ul>
<p><strong>列级约束</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> stuinfo(
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,#主键
	stuName <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span>,#非空
	gender <span class="hljs-type">CHAR</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">CHECK</span>(gender<span class="hljs-operator">=</span><span class="hljs-string">&#x27;男&#x27;</span> <span class="hljs-keyword">OR</span> gender <span class="hljs-operator">=</span><span class="hljs-string">&#x27;女&#x27;</span>),#检查,mysql中不支持
	seat <span class="hljs-type">INT</span> <span class="hljs-keyword">UNIQUE</span>,#唯一
	age <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span>  <span class="hljs-number">18</span>,#默认约束
	majorId <span class="hljs-type">INT</span> <span class="hljs-keyword">REFERENCES</span> major(id)#外键
);

#查看stuinfo中的所有索引，包括主键、外键、唯一
<span class="hljs-keyword">SHOW</span> INDEX <span class="hljs-keyword">FROM</span> stuinfo;</code></pre></div>

<p><strong>表级约束</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> stuinfo(
   id <span class="hljs-type">INT</span>,
   stuname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
   gender <span class="hljs-type">CHAR</span>(<span class="hljs-number">1</span>),
   seat <span class="hljs-type">INT</span>,
   age <span class="hljs-type">INT</span>,
   majorid <span class="hljs-type">INT</span>,
   
  #【<span class="hljs-keyword">constraint</span> 约束名】 约束类型(字段名) .
   <span class="hljs-keyword">CONSTRAINT</span> pk <span class="hljs-keyword">PRIMARY</span> KEY(id),#主键
   <span class="hljs-keyword">CONSTRAINT</span> uq <span class="hljs-keyword">UNIQUE</span>(seat),#唯一键
   <span class="hljs-keyword">CONSTRAINT</span> ck <span class="hljs-keyword">CHECK</span>(gender <span class="hljs-operator">=</span><span class="hljs-string">&#x27;男&#x27;</span> <span class="hljs-keyword">OR</span> gender  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;女&#x27;</span>),#检查,mysql中不支持
   <span class="hljs-keyword">CONSTRAINT</span> fk_stuinfo_major <span class="hljs-keyword">FOREIGN</span> KEY(majorid) <span class="hljs-keyword">REFERENCES</span> major(id)#外键</code></pre></div>

<blockquote>
<p>   位置                        支持的约束类型                                      是否可以起约束名</p>
<p>列级约束：  列的后面   语法都支持，但外键没有效果                  不可以<br>表级约束：  所有列的下面 默认和非空不支持，其他支持              可以（主键没有效果）</p>
</blockquote>
<p><strong>主键和唯一的大对比</strong></p>
<blockquote>
<p>保证唯一性  是否允许为空    一个表中可以有多少个   是否允许组合(有一个满足就成立)</p>
<p>主键 √                  ×                     至多有1个                   √，但不推荐<br>唯一 √                  √                     可以有多个                  √，但不推荐</p>
</blockquote>
<p><strong>外键</strong></p>
<p>1、要求在从表设置外键关系<br>2、从表的外键列的类型和主表的关联列的类型要求一致或兼容，名称无要求<br>3、主表的关联列必须是一个key（一般是主键或唯一）<br>4、插入数据时，先插入主表，再插入从表</p>
<p><strong>删除数据时，先删除从表，再删除主表</strong></p>
<p>可以通过以下两种方法删除主表中的记录</p>
<p><strong>级联删除</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> stu <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> fk_stu_major <span class="hljs-keyword">FOREIGN</span> KEY (majorid) <span class="hljs-keyword">REFERENCES</span> major(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE;</code></pre></div>

<p><strong>级联置空</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> stu <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> fk_stu_major <span class="hljs-keyword">FOREIGN</span> KEY (majorid) <span class="hljs-keyword">REFERENCES</span> major(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">SET</span> <span class="hljs-keyword">NULL</span>;</code></pre></div>

<h2 id="修改表的约束"><a href="#修改表的约束" class="headerlink" title="修改表的约束"></a>修改表的约束</h2><div class="hljs code-wrapper"><pre><code class="hljs sql">#添加列级约束
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> 表名 modify <span class="hljs-keyword">column</span> 字段名 字段类型 新约束;

#添加表级约束
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> 表名 <span class="hljs-keyword">add</span> 【<span class="hljs-keyword">constraint</span> 约束名】 约束类型(字段名) 【外键的引用】;</code></pre></div>

<p><strong>举例</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#<span class="hljs-number">1.</span>添加非空约束
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> stuinfo MODIFY <span class="hljs-keyword">COLUMN</span> stuname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>;
#<span class="hljs-number">2.</span>添加默认约束
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> stuinfo MODIFY <span class="hljs-keyword">COLUMN</span> age <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">18</span>;
#<span class="hljs-number">3.</span>添加主键
#①列级约束
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> stuinfo MODIFY <span class="hljs-keyword">COLUMN</span> id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY;
#②表级约束
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> stuinfo <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">PRIMARY</span> KEY(id);

#<span class="hljs-number">4.</span>添加唯一
#①列级约束
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> stuinfo MODIFY <span class="hljs-keyword">COLUMN</span> seat <span class="hljs-type">INT</span> <span class="hljs-keyword">UNIQUE</span>;
#②表级约束
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> stuinfo <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">UNIQUE</span>(seat);
#<span class="hljs-number">5.</span>添加外键
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> stuinfo <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> fk_stuinfo_major <span class="hljs-keyword">FOREIGN</span> KEY(majorid) <span class="hljs-keyword">REFERENCES</span> major(id); 


#<span class="hljs-number">1.</span>删除非空约束
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> stuinfo MODIFY <span class="hljs-keyword">COLUMN</span> stuname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NULL</span>;

#<span class="hljs-number">2.</span>删除默认约束
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> stuinfo MODIFY <span class="hljs-keyword">COLUMN</span> age <span class="hljs-type">INT</span> ;

#<span class="hljs-number">3.</span>删除主键
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> stuinfo <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">PRIMARY</span> KEY;

#<span class="hljs-number">4.</span>删除唯一
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> stuinfo <span class="hljs-keyword">DROP</span> INDEX seat;

#<span class="hljs-number">5.</span>删除外键
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> stuinfo <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">FOREIGN</span> KEY fk_stuinfo_major;</code></pre></div>

<h1 id="三、数据库的三大范式"><a href="#三、数据库的三大范式" class="headerlink" title="三、数据库的三大范式"></a>三、数据库的三大范式</h1><h2 id="第一范式"><a href="#第一范式" class="headerlink" title="第一范式"></a>第一范式</h2><p><strong>字段还可以拆分的，就不满足第一范式</strong></p>
<p>比如地址如果写为</p>
<div class="hljs code-wrapper"><pre><code class="hljs plain">地址：四川省成都市高新区天府一街</code></pre></div>

<p>就是可以被拆分的</p>
<p>如果字段写为</p>
<div class="hljs code-wrapper"><pre><code class="hljs plain">省份：四川省
城市：成都市
区域：高新区
街名：天府一街</code></pre></div>

<p>就是不可拆分的</p>
<p>建表如下</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> student(
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCRAEMENT,
	name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
	province <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
	city <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
	area <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
	street: <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)
);</code></pre></div>

<p>就是<strong>符合第一范式</strong>的，但<strong>并不是拆分的越详细越好</strong></p>
<h2 id="第二范式"><a href="#第二范式" class="headerlink" title="第二范式"></a>第二范式</h2><ul>
<li>满足第一范式的条件下，第二范式要求：<strong>除主键外的每一列，都必须完全依赖于主键</strong></li>
<li>如果出现不完全依赖，则只可能发生在<strong>联合主键</strong>的情况下</li>
</ul>
<p><strong>不满足第二范式的例子</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">order</span>(
	product_id <span class="hljs-type">INT</span>,
	customer_id <span class="hljs-type">INT</span>,
	product_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
	customer_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    <span class="hljs-keyword">PRIMARY</span> KEY(product_id, customer_id)
);</code></pre></div>

<p>此处product_name只依赖于product_id，customer_name只依赖于customer_id，是完全依赖</p>
<p><strong>满足第二范式的例子</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">order</span>(
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
	product_id <span class="hljs-type">INT</span>,
	customer_id <span class="hljs-type">INT</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> product(
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
	name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customer(
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)
);</code></pre></div>

<h2 id="第三范式"><a href="#第三范式" class="headerlink" title="第三范式"></a>第三范式</h2><ul>
<li>满足第二范式，除主键外的其他列之间不能有传递依赖关系</li>
</ul>
<p><strong>不满足第三范式的例子</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">order</span>(
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
	product_id <span class="hljs-type">INT</span>,
	customer_id <span class="hljs-type">INT</span>,
	customer_phone <span class="hljs-type">INT</span>
);</code></pre></div>

<p>此处customer_phone又依赖于customer_id，存在传递依赖关系，不满足第三范式</p>
<p><strong>满足第三范式的例子</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">order</span>(
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
	product_id <span class="hljs-type">INT</span>,
	customer_id <span class="hljs-type">INT</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customer(
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    phone <span class="hljs-type">INT</span>
);</code></pre></div>

<h1 id="四、视图"><a href="#四、视图" class="headerlink" title="四、视图"></a>四、视图</h1><p>是一种虚拟表，和普通表一样使用<br>mysql5.1版本出现的新特性，是通过表动态生成的数据</p>
<blockquote>
<p>​                创建语法的关键字            是否实际占用物理空间                                         使用</p>
<p>视图          create view                           只是保存了sql逻辑                         增删改查，只是一般不能增删改</p>
<p>表               create table                              保存了数据                                                     增删改查</p>
</blockquote>
<h3 id="创建视图"><a href="#创建视图" class="headerlink" title="创建视图"></a>创建视图</h3><p>利用<code>CREATE VIEW xx AS</code>封装</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#案例：查询姓张的学生名和专业名
<span class="hljs-keyword">SELECT</span> stuname,majorname
<span class="hljs-keyword">FROM</span> stuinfo s
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> major m <span class="hljs-keyword">ON</span> s.`majorid`<span class="hljs-operator">=</span> m.`id`
<span class="hljs-keyword">WHERE</span> s.`stuname` <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;张%&#x27;</span>;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> v1
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> stuname,majorname
<span class="hljs-keyword">FROM</span> stuinfo s
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> major m <span class="hljs-keyword">ON</span> s.`majorid`<span class="hljs-operator">=</span> m.`id`;

<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> v1 <span class="hljs-keyword">WHERE</span> stuname <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;张%&#x27;</span>;

#<span class="hljs-number">2.</span>查询各部门的平均工资级别
#①创建视图查看每个部门的平均工资
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> myv2
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(salary) ag,department_id
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_id;

#②使用
<span class="hljs-keyword">SELECT</span> myv2.`ag`,g.grade_level
<span class="hljs-keyword">FROM</span> myv2
<span class="hljs-keyword">JOIN</span> job_grades g
<span class="hljs-keyword">ON</span> myv2.`ag` <span class="hljs-keyword">BETWEEN</span> g.`lowest_sal` <span class="hljs-keyword">AND</span> g.`highest_sal`;</code></pre></div>

<h3 id="修改视图"><a href="#修改视图" class="headerlink" title="修改视图"></a>修改视图</h3><blockquote>
<p>create or replace view  视图名<br>as</p>
<p>查询语句;</p>
<p>或者</p>
<p>alter view 视图名<br>as<br>查询语句;</p>
</blockquote>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#<span class="hljs-number">1</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">VIEW</span> myv3
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(salary),job_id
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> job_id;

#<span class="hljs-number">2</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">VIEW</span> myv3
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees;</code></pre></div>

<h3 id="删除视图"><a href="#删除视图" class="headerlink" title="删除视图"></a>删除视图</h3><div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">VIEW</span> emp_v1,emp_v2,myv3;</code></pre></div>

<h3 id="查看视图"><a href="#查看视图" class="headerlink" title="查看视图"></a>查看视图</h3><div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">DESC</span> myv3;

<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> myv3;</code></pre></div>

<h3 id="更新视图"><a href="#更新视图" class="headerlink" title="更新视图"></a>更新视图</h3><div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">VIEW</span> myv1
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> last_name,email
<span class="hljs-keyword">FROM</span> employees;


#<span class="hljs-number">1.</span>插入
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> myv1 <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;张飞&#x27;</span>,<span class="hljs-string">&#x27;zf@qq.com&#x27;</span>);

#<span class="hljs-number">2.</span>修改
UPDATE myv1 <span class="hljs-keyword">SET</span> last_name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;张无忌&#x27;</span> <span class="hljs-keyword">WHERE</span> last_name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;张飞&#x27;</span>;

#<span class="hljs-number">3.</span>删除
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> myv1 <span class="hljs-keyword">WHERE</span> last_name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;张无忌&#x27;</span>;</code></pre></div>

<p><strong>具备以下特点的视图不允许更新</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#①包含以下关键字的<span class="hljs-keyword">sql</span>语句：分组函数、<span class="hljs-keyword">distinct</span>、<span class="hljs-keyword">group</span>  <span class="hljs-keyword">by</span>、<span class="hljs-keyword">having</span>、<span class="hljs-keyword">union</span>或者<span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">VIEW</span> myv1
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MAX</span>(salary) m,department_id
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_id;

#更新失败
UPDATE myv1 <span class="hljs-keyword">SET</span> m<span class="hljs-operator">=</span><span class="hljs-number">9000</span> <span class="hljs-keyword">WHERE</span> department_id<span class="hljs-operator">=</span><span class="hljs-number">10</span>;

#②常量视图
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">VIEW</span> myv2
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-string">&#x27;john&#x27;</span> NAME;

#更新失败
UPDATE myv2 <span class="hljs-keyword">SET</span> NAME<span class="hljs-operator">=</span><span class="hljs-string">&#x27;lucy&#x27;</span>;

#③<span class="hljs-keyword">Select</span>中包含子查询
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">VIEW</span> myv3
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> department_id,(<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MAX</span>(salary) <span class="hljs-keyword">FROM</span> employees) 最高工资
<span class="hljs-keyword">FROM</span> departments;

#更新失败
UPDATE myv3 <span class="hljs-keyword">SET</span> 最高工资<span class="hljs-operator">=</span><span class="hljs-number">100000</span>;

#④<span class="hljs-keyword">join</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">VIEW</span> myv4
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> last_name,department_name
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">JOIN</span> departments d
<span class="hljs-keyword">ON</span> e.department_id  <span class="hljs-operator">=</span> d.department_id;

#更新成功，插入失败
UPDATE myv4 <span class="hljs-keyword">SET</span> last_name  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;张飞&#x27;</span> <span class="hljs-keyword">WHERE</span> last_name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;Whalen&#x27;</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> myv4 <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;陈真&#x27;</span>,<span class="hljs-string">&#x27;xxxx&#x27;</span>);

#⑤<span class="hljs-keyword">from</span>一个不能更新的视图
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">VIEW</span> myv5
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> myv3;

#更新失败
UPDATE myv5 <span class="hljs-keyword">SET</span> 最高工资<span class="hljs-operator">=</span><span class="hljs-number">10000</span> <span class="hljs-keyword">WHERE</span> department_id<span class="hljs-operator">=</span><span class="hljs-number">60</span>;

#⑥<span class="hljs-keyword">where</span>子句的子查询引用了<span class="hljs-keyword">from</span>子句中的表
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">VIEW</span> myv6
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> last_name,email,salary
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> employee_id <span class="hljs-keyword">IN</span>(
	<span class="hljs-keyword">SELECT</span>  manager_id
	<span class="hljs-keyword">FROM</span> employees
	<span class="hljs-keyword">WHERE</span> manager_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
);

#更新失败
UPDATE myv6 <span class="hljs-keyword">SET</span> salary<span class="hljs-operator">=</span><span class="hljs-number">10000</span> <span class="hljs-keyword">WHERE</span> last_name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;k_ing&#x27;</span>;</code></pre></div>



<h1 id="五、事务"><a href="#五、事务" class="headerlink" title="五、事务"></a>五、事务</h1><p>事务是一个最小的不可分割的单元，事务能够保证一个业务的完整性</p>
<p>多条sql语句<strong>要么同时成功，要么同时失败</strong>，这时就要用到事务，即TCL</p>
<h2 id="自动提交、手动提交和回滚"><a href="#自动提交、手动提交和回滚" class="headerlink" title="自动提交、手动提交和回滚"></a>自动提交、手动提交和回滚</h2><p>通过<code>ROLLBACK; </code>指令可以回滚，但需要<strong>关闭自动提交</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">#关闭一次，也等于开启事务
<span class="hljs-keyword">SET</span> autocommit <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
#查看自动提交状态
<span class="hljs-keyword">SELECT</span> @<span class="hljs-variable">@autocommit</span>;</code></pre></div>

<p>但如果在进行操作之后，执行<code>COMMIT; </code>则无法再进行回滚（持久化）</p>
<p><strong>同时delete可以回滚，而truncate不能回滚</strong></p>
<p><strong>SAVEPOINT设置保存点</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SET</span> autocommit<span class="hljs-operator">=</span><span class="hljs-number">0</span>;
<span class="hljs-keyword">START</span> TRANSACTION;
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> account <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">25</span>;
<span class="hljs-keyword">SAVEPOINT</span> a;#设置保存点
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> account <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">28</span>;
<span class="hljs-keyword">ROLLBACK</span> <span class="hljs-keyword">TO</span> a;#回滚到保存点</code></pre></div>

<h2 id="手动开启事务"><a href="#手动开启事务" class="headerlink" title="手动开启事务"></a>手动开启事务</h2><p>通过</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">BEGIN</span>;
或者
<span class="hljs-keyword">START</span> TRANSACTION;</code></pre></div>

<p>可以手动开启事务</p>
<p><strong>插入数据前</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200810204606.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200810204606.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>插入数据后</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> person <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;老六&#x27;</span>, <span class="hljs-number">7</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> person <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">5</span>, <span class="hljs-string">&#x27;老七&#x27;</span>, <span class="hljs-number">9</span>);
或者
<span class="hljs-keyword">START</span> TRANSACTION;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> person <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;老六&#x27;</span>, <span class="hljs-number">7</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> person <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">5</span>, <span class="hljs-string">&#x27;老七&#x27;</span>, <span class="hljs-number">9</span>);</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200810204849.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200810204849.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>回滚后</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">ROLLBACK</span>;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200810204930.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200810204930.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>即</p>
<blockquote>
<p>步骤1：开启事务<br>set autocommit=0;<br>start transaction;可选的<br>步骤2：编写事务中的sql语句(select insert update delete)<br>语句1;<br>语句2;<br>…</p>
<p>步骤3：结束事务<br>commit;提交事务<br>rollback;回滚事务</p>
</blockquote>
<h2 id="四大特征-ACID"><a href="#四大特征-ACID" class="headerlink" title="四大特征 ACID"></a>四大特征 ACID</h2><ul>
<li>原子性：事务是最小的单位，<strong>不可再分</strong>，要么都执行要么都不执行</li>
<li>一致性：一个事务执行会使数据从一个一致状态切换到另外一个一致状态</li>
<li>隔离性：一个事务的执行不受其他事务的干扰</li>
<li>持久性：事物<strong>一旦结束</strong>（commit），就<strong>不可返回</strong>（rollback）</li>
</ul>
<p><strong>隔离性</strong></p>
<ul>
<li>事务的隔离级别<ul>
<li>读未提交 read uncommitted</li>
<li>读已提交 read committed</li>
<li>可以重复读 repeatable read</li>
<li>串行化 serializable</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200811132934.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200811132934.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<ul>
<li>事务的并发问题<ul>
<li>脏读：事务A读取了事务B更新的数据，然后<strong>B回滚操作</strong>，那么<strong>A读取到的数据是脏数据</strong></li>
<li>不可重复读：事务 A 多次读取同一数据，事务B在事务A多次读取的过程中，对数据作了<strong>更新并提交</strong>，<strong>导致事务A多次读取同一数据时，结果不一致</strong></li>
<li>幻读：系统管理员A将数据库中所有学生的成绩从具体分数改为ABCDE等级，但是系统管理员B就在这个时候插入了一条具体分数的记录，当系统管理员A改结束后发现还有一条记录没有改过来，就好像发生了幻觉一样，这就叫幻读</li>
</ul>
</li>
</ul>
<p><strong>总结</strong>：不可重复读的和幻读很容易混淆，<strong>不可重复读侧重于修改，幻读侧重于新增或删除</strong></p>
<p> 解决不可重复读的问题只需锁住满足条件的行，解决幻读需要锁表</p>
<ul>
<li>查看数据库的隔离级别</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql">版本 <span class="hljs-number">5.</span>x
<span class="hljs-keyword">SELECT</span> @<span class="hljs-variable">@global</span>.tx_isolation;

版本 <span class="hljs-number">8.0</span>
<span class="hljs-keyword">SELECT</span> @<span class="hljs-variable">@global</span>.transaction_isolation;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200811132716.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200811132716.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<ul>
<li>修改数据库的隔离级别</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">set</span> <span class="hljs-keyword">global</span> transaction isolation level read committed;</code></pre></div>

<h1 id="六、MySQL逻辑架构"><a href="#六、MySQL逻辑架构" class="headerlink" title="六、MySQL逻辑架构"></a>六、MySQL逻辑架构</h1><h2 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h2><p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200813170808.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200813170808.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h2 id="连接层"><a href="#连接层" class="headerlink" title="连接层"></a>连接层</h2><p>最上层是一些客服端和连接服务，包括socket通信和大多数基于客服端/服务端工具实现的类似于tcp/ip的通信，主要完成一些类似于连接处理、授权认证及相关安全的方案，在该层上引入了线程池的概念，为通过认证安全接入的客服端提供线程，同样在该层上可以实现基于SSL的安全的连接，服务器也会为安全接入的每个客户端验证它所具有的操作权限</p>
<h2 id="服务层"><a href="#服务层" class="headerlink" title="服务层"></a>服务层</h2><p>第二层架构主要完成大多数的核心服务功能，如SQL接口，并完成缓存的查询，SQL的分析以及优化部分内置函数的执行，所有跨存储引擎的功能也在这一层实现，如过程、函数等，服务器会解析查询并创建相应的内部解析树，并对其完成相应的优化如确定查询的顺序是否利用索引，最后生成相应的执行操作</p>
<table>
<thead>
<tr>
<th>Management Serveices &amp; Utilities</th>
<th>系统管理和控制工具</th>
</tr>
</thead>
<tbody><tr>
<td>SQL Interface</td>
<td>SQL 接口。接受用户的 SQL 命令，并且返回用户需要查询的结果。比如 select from 就是调用 SQL Interface</td>
</tr>
<tr>
<td>Parser</td>
<td>解析器。 SQL 命令传递到解析器的时候会被解析器验证和解析</td>
</tr>
<tr>
<td>Optimizer</td>
<td>查询优化器。 SQL 语句在查询之前会使用查询优化器对查询进行优化，比如有 where 条件时，优化器来决定先投影还是先过滤。</td>
</tr>
<tr>
<td>Cache 和 Buffer</td>
<td>查询缓存。如果查询缓存有命中的查询结果，查询语句就可以直接去查询缓存中取数据。这个缓存机制是由一系列小缓存组成的。比如表缓存，记录缓存，key 缓存， 权限缓存等</td>
</tr>
</tbody></table>
<h2 id="引擎层"><a href="#引擎层" class="headerlink" title="引擎层"></a>引擎层</h2><p>存储引擎层，存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API与存储引擎进行通信，不同的存储引擎具有功能不同</p>
<table>
<thead>
<tr>
<th>对比项</th>
<th>MylSAM</th>
<th>InnoDB</th>
</tr>
</thead>
<tbody><tr>
<td>主外键</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>事务</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>行表锁</td>
<td>[表锁](# 表锁)（不适合高并发）</td>
<td>[行锁](# 行锁)（适合高并发操作）</td>
</tr>
<tr>
<td>缓存</td>
<td>只缓存索引，不缓存真实数据</td>
<td>不仅缓存索引，还缓存真实数据。对内存要求较高</td>
</tr>
<tr>
<td>表空间</td>
<td>小</td>
<td>大</td>
</tr>
<tr>
<td>关注点</td>
<td>性能</td>
<td>事务</td>
</tr>
<tr>
<td>默认安装</td>
<td>是</td>
<td>是</td>
</tr>
</tbody></table>
<h2 id="存储层"><a href="#存储层" class="headerlink" title="存储层"></a>存储层</h2><p>数据存储层，主要是将数据存储在运行于裸设备的文件系统之上，并完成与存储引擎的交互</p>
<h1 id="七、性能与JOIN"><a href="#七、性能与JOIN" class="headerlink" title="七、性能与JOIN"></a>七、性能与JOIN</h1><h2 id="性能下降原因"><a href="#性能下降原因" class="headerlink" title="性能下降原因"></a>性能下降原因</h2><p><strong>索引失效</strong></p>
<p><strong>单值索引</strong></p>
<p>创建语句</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> INDEX idx_表名_字段名 <span class="hljs-keyword">ON</span> 表名(字段名);</code></pre></div>

<p><strong>复合索引</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> INDEX idx_表名_字段名<span class="hljs-number">1</span>字段名<span class="hljs-number">2.</span>.. <span class="hljs-keyword">ON</span> 表名(字段名<span class="hljs-number">1</span>, 字段名<span class="hljs-number">2</span> ...);</code></pre></div>

<p><strong>关联太多JOIN</strong></p>
<p>内连接、外连接的表不要过多</p>
<p><strong>服务器调优及参数设置</strong></p>
<h2 id="SQL执行加载顺序"><a href="#SQL执行加载顺序" class="headerlink" title="SQL执行加载顺序"></a>SQL执行加载顺序</h2><p><strong>手写顺序</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200814112248.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200814112248.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>随着 Mysql 版本的更新换代，其优化器也在不断的升级，优化器会分析不同执行顺序产生的性能消耗不同而<strong>动态调整执行顺序</strong></p>
<p>下面是经常出现的查询顺序：</p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200814112330.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200814112330.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200814112343.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200814112343.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200814191644.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200814191644.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h2 id="7种JOIN"><a href="#7种JOIN" class="headerlink" title="7种JOIN"></a>7种JOIN</h2><p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200814150926.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200814150926.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>建表语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_dept` (
`id` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT, 
  `deptName` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>, 
  `address` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">40</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>INNODB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_emp` (
`id` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT, 
  `name` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>, 
  `age` <span class="hljs-type">INT</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>, 
  `deptId` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>, 
  `empno` <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, 
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`), KEY `idx_dept_id` (`deptId`)
#<span class="hljs-keyword">CONSTRAINT</span> `fk_dept_id` <span class="hljs-keyword">FOREIGN</span> KEY (`deptId`) <span class="hljs-keyword">REFERENCES</span> `t_dept` (`id`)
) ENGINE<span class="hljs-operator">=</span>INNODB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_dept(deptName,address) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;华山&#x27;</span>,<span class="hljs-string">&#x27;华山&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_dept(deptName,address) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;丐帮&#x27;</span>,<span class="hljs-string">&#x27;洛阳&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_dept(deptName,address) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;峨眉&#x27;</span>,<span class="hljs-string">&#x27;峨眉山&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_dept(deptName,address) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;武当&#x27;</span>,<span class="hljs-string">&#x27;武当山&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_dept(deptName,address) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;明教&#x27;</span>,<span class="hljs-string">&#x27;光明顶&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_dept(deptName,address) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;少林&#x27;</span>,<span class="hljs-string">&#x27;少林寺&#x27;</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp(NAME,age,deptId,empno) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;风清扬&#x27;</span>,<span class="hljs-number">90</span>,<span class="hljs-number">1</span>,<span class="hljs-number">100001</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp(NAME,age,deptId,empno) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;岳不群&#x27;</span>,<span class="hljs-number">50</span>,<span class="hljs-number">1</span>,<span class="hljs-number">100002</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp(NAME,age,deptId,empno) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;令狐冲&#x27;</span>,<span class="hljs-number">24</span>,<span class="hljs-number">1</span>,<span class="hljs-number">100003</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp(NAME,age,deptId,empno) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;洪七公&#x27;</span>,<span class="hljs-number">70</span>,<span class="hljs-number">2</span>,<span class="hljs-number">100004</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp(NAME,age,deptId,empno) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;乔峰&#x27;</span>,<span class="hljs-number">35</span>,<span class="hljs-number">2</span>,<span class="hljs-number">100005</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp(NAME,age,deptId,empno) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;灭绝师太&#x27;</span>,<span class="hljs-number">70</span>,<span class="hljs-number">3</span>,<span class="hljs-number">100006</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp(NAME,age,deptId,empno) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;周芷若&#x27;</span>,<span class="hljs-number">20</span>,<span class="hljs-number">3</span>,<span class="hljs-number">100007</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp(NAME,age,deptId,empno) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;张三丰&#x27;</span>,<span class="hljs-number">100</span>,<span class="hljs-number">4</span>,<span class="hljs-number">100008</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp(NAME,age,deptId,empno) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;张无忌&#x27;</span>,<span class="hljs-number">25</span>,<span class="hljs-number">5</span>,<span class="hljs-number">100009</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp(NAME,age,deptId,empno) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;韦小宝&#x27;</span>,<span class="hljs-number">18</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">100010</span>);</code></pre></div>

<p><strong>JOIN查询</strong></p>
<ul>
<li>笛卡尔积</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_dept, t_emp;</code></pre></div>

<p>t_dept共20条记录，t_emp共6条记录。两表共同查询后共120条记录</p>
<ul>
<li>内连接</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp a <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> t_dept b <span class="hljs-keyword">ON</span>  a.deptId <span class="hljs-operator">=</span> b.id;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200814153140.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200814153140.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<ul>
<li>左外连接</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp a <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> t_dept b <span class="hljs-keyword">ON</span>  a.deptId <span class="hljs-operator">=</span> b.id;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200814153254.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200814153254.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<ul>
<li>右外连接</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp a <span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">JOIN</span> t_dept b <span class="hljs-keyword">ON</span>  a.deptId <span class="hljs-operator">=</span> b.id;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200814153413.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200814153413.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<ul>
<li>左外连接<strong>取左表的独有部分</strong></li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp a <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> t_dept b <span class="hljs-keyword">ON</span>  a.deptId <span class="hljs-operator">=</span> b.id <span class="hljs-keyword">WHERE</span> a.deptId <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200814153909.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200814153909.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<ul>
<li>右外连接<strong>取右表的独有部分</strong></li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp a <span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">JOIN</span> t_dept b <span class="hljs-keyword">ON</span> a.deptId <span class="hljs-operator">=</span> b.id <span class="hljs-keyword">WHERE</span> a.deptId <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200814153844.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200814153844.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>注意</strong>：判断字段是否为NULL时，<strong>不能使用’=’</strong></p>
<p>因为<code>= NULL</code> 的结果不会报错，但是<strong>结果永远为false</strong>。所以必须使用<code>IS NULL </code>来进行判空</p>
<ul>
<li>全外连接</li>
</ul>
<p>MySQL不支持全外连接，要查询两个表的全集，需要合并两个查询结果，所以要使用 <strong>UNION</strong> 关键字</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp a <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> t_dept b <span class="hljs-keyword">ON</span> a.deptId <span class="hljs-operator">=</span> b.id
<span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp a <span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">JOIN</span> t_dept b <span class="hljs-keyword">ON</span> a.deptId <span class="hljs-operator">=</span> b.id;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200814154554.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200814154554.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<ul>
<li>查询两表独有内容</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp a <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> t_dept b <span class="hljs-keyword">ON</span> a.deptId <span class="hljs-operator">=</span> b.id <span class="hljs-keyword">WHERE</span> b.id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>
<span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp a <span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">JOIN</span> t_dept b <span class="hljs-keyword">ON</span> a.deptId <span class="hljs-operator">=</span> b.id <span class="hljs-keyword">WHERE</span> a.deptId <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200814155138.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200814155138.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h1 id="八、索引优化"><a href="#八、索引优化" class="headerlink" title="八、索引优化"></a>八、索引优化</h1><h2 id="什么是索引"><a href="#什么是索引" class="headerlink" title="什么是索引"></a>什么是索引</h2><ul>
<li><p>MySQL 官方对索引的定义为：<strong>索引（Index）是帮助 MySQL 高效获取数据的数据结构</strong>。可以得到索引的本质： <strong>索引是数据结构</strong>。</p>
<p>可以简单理解为：<strong>排好序的快速查找数据结构</strong></p>
</li>
<li><p>在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据， 这样就可以在这些数据结构上实现高级查找算法。这种数据结构，就是索引。下图就是一种可能的索引方式示例：</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200814173647.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200814173647.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<ul>
<li>左边是数据表，一共有两列七条记录，最左边的是数据记录的物理地址。为了加快 Col2 的查找，可以维护一个右边所示的二叉查找树，每个节点分别包含索引键值和一个指向对应数据记录物理地址的指针，这样就可以运用 二叉查找在一定的复杂度内获取到相应数据，从而快速的检索出符合条件的记录 </li>
<li>一般来说索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储的磁盘上</li>
</ul>
<h2 id="索引的优缺点"><a href="#索引的优缺点" class="headerlink" title="索引的优缺点"></a>索引的优缺点</h2><p><strong>优点</strong></p>
<ul>
<li><strong>提高数据检索的效率</strong>，降低数据库的IO成本</li>
<li>通过索引列对数据进行排序，<strong>降低数据排序的成本</strong>，降低了CPU的消耗</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>虽然索引大大提高了查询速度，同时却<strong>会降低更新表的速度</strong>，如对表进行INSERT、UPDATE和DELETE。因为更新表时，MySQL不仅要保存数据，还要保存一下索引文件每次更新添加了索引列的字段，都会调整因为更新所带来的键值变化后的索引信息</li>
<li>实际上索引也是一张表，该表保存了主键与索引字段，并指向实体表的记录，所以<strong>索引列也是要占用空间的</strong></li>
</ul>
<h2 id="索引的分类"><a href="#索引的分类" class="headerlink" title="索引的分类"></a>索引的分类</h2><p><strong>基本语法</strong></p>
<ul>
<li><p>创建</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> [<span class="hljs-keyword">UNIQUE</span>] INDEX [indexName] <span class="hljs-keyword">ON</span> table_name(<span class="hljs-keyword">column</span>);</code></pre></div></li>
<li><p>删除</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> INDEX [indexName] <span class="hljs-keyword">ON</span> table_name;</code></pre></div></li>
<li><p>查看</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> INDEX <span class="hljs-keyword">FROM</span> table_name;</code></pre></div></li>
</ul>
<p><strong>分类</strong></p>
<ul>
<li><p>单值索引</p>
<ul>
<li><p>定义：即一个索引只包含单个列，一个表可以有多个单列索引</p>
</li>
<li><p>语法：</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--和表一起创建</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customer (
id <span class="hljs-type">INT</span>(<span class="hljs-number">10</span>) UNSIGNED AUTO_INCREMENT,
customer_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>),
customer_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>), 
<span class="hljs-keyword">PRIMARY</span> KEY(id), 
KEY (customer_name) <span class="hljs-comment">--单值索引</span>
);

<span class="hljs-comment">--单独创建单值索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_customer_name <span class="hljs-keyword">ON</span> customer(customer_name);</code></pre></div></li>
</ul>
</li>
<li><p>唯一索引</p>
<ul>
<li><p>定义：索引列的值必须唯一，但允许有空值</p>
</li>
<li><p>语法：</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--和表一起创建</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customer (
id <span class="hljs-type">INT</span>(<span class="hljs-number">10</span>) UNSIGNED AUTO_INCREMENT,
customer_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>),
customer_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>), 
<span class="hljs-keyword">PRIMARY</span> KEY(id), 
KEY (customer_name), <span class="hljs-comment">--单值索引</span>
<span class="hljs-keyword">UNIQUE</span> (customer_no) <span class="hljs-comment">--唯一索引</span>
);

<span class="hljs-comment">--单独创建唯一索引</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX idx_customer_no <span class="hljs-keyword">ON</span> customer(customer_no);</code></pre></div></li>
</ul>
</li>
<li><p>主键索引</p>
<ul>
<li><p>定义：设定为主键后数据库会<strong>自动建立索引</strong>，innodb为聚簇索引</p>
</li>
<li><p>语法：</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--和表一起创建</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customer (
id <span class="hljs-type">INT</span>(<span class="hljs-number">10</span>) UNSIGNED AUTO_INCREMENT,
customer_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>),
customer_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>), 
<span class="hljs-keyword">PRIMARY</span> KEY(id) <span class="hljs-comment">--主键索引</span>
);

<span class="hljs-comment">--单独创建主键索引</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> customer <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">PRIMARY</span> KEY customer(customer_no);

<span class="hljs-comment">--删除主键索引</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> customer <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">PRIMARY</span> KEY;

<span class="hljs-comment">--修改建主键索引</span>
必须先删除掉(<span class="hljs-keyword">drop</span>)原索引，再新建(<span class="hljs-keyword">add</span>)索引</code></pre></div></li>
</ul>
</li>
<li><p>复合索引</p>
<ul>
<li><p>定义：即一个索引包含多个列</p>
</li>
<li><p>语法：</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--和表一起创建</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customer (
id <span class="hljs-type">INT</span>(<span class="hljs-number">10</span>) UNSIGNED AUTO_INCREMENT,
customer_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>),
customer_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>), 
<span class="hljs-keyword">PRIMARY</span> KEY(id), 
KEY (customer_name), <span class="hljs-comment">--单值索引</span>
<span class="hljs-keyword">UNIQUE</span> (customer_no), <span class="hljs-comment">--唯一索引</span>
KEY (customer_no,customer_name) <span class="hljs-comment">--复合索引</span>
);

<span class="hljs-comment">--单独创建复合索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_no_name <span class="hljs-keyword">ON</span> customer(customer_no,customer_name);</code></pre></div></li>
</ul>
</li>
</ul>
<h2 id="MySQL的索引"><a href="#MySQL的索引" class="headerlink" title="MySQL的索引"></a>MySQL的索引</h2><p><strong>B树</strong></p>
<ul>
<li>B树的阶：节点的<strong>最多子节点个数</strong>。比如 2-3树的阶是3，2-3-4树的阶是4</li>
<li>B树的搜索，从根结点开始，对结点内的关键字（有序）序列进行二分查找，如果命中则结束，否则进入查询关键字所属范围的儿子结点；重复，直到所对应的儿子指针为空，或已经是叶子结点</li>
<li>关键字集合分布在整颗树中, 即叶子节点和非叶子节点都存放数据</li>
<li>搜索<strong>有可能在非叶子结点结束</strong></li>
<li>其搜索性能等价于在关键字全集内做一次二分查找</li>
</ul>
<p><strong>B+树</strong></p>
<ul>
<li>B+树是B树的变体，也是一种多路搜索树</li>
<li>B+树的搜索与 B树也基本相同，区别是 B+树只有达到叶子结点才命中（B树可以在非叶子结点命中），其性能也等价于在关键字全集做一次二分查找</li>
<li><strong>所有关键字都出现在叶子结点的链表中</strong>（即数据只能在叶子节点【也叫<strong>稠密索引</strong>】），且链表中的关键字(数据)恰好是有序的</li>
<li><strong>不可能在非叶子结点命中</strong></li>
<li><strong>非叶子结点</strong>相当于是叶子结点的<strong>索引</strong>（稀疏索引），<strong>叶子结点</strong>相当于是存储（关键字）<strong>数据</strong>的数据层</li>
<li>更适合文件索引系统</li>
<li>B树和 B+树各有自己的应用场景，不能说 B+树完全比 B树好，反之亦然</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200815153029.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200815153029.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200815153043.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200815153043.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>区别</strong></p>
<ul>
<li>B树的<strong>关键字和记录是放在一起的</strong>，叶子节点可以看作外部节点，不包含任何信息；B+树的非叶子节点中只有关键字和指向下一个节点的索引，<strong>记录只放在叶子节点中</strong></li>
<li>在B树中，越靠近根节点的记录查找时间越快，只要找到关键字即可确定记录的存在；而 B+树中每个记录的查找时间基本是一样的，都需要从根节点走到叶子节点，而且在叶子节点中还要再比较关键字。从这个角度看B树的性能好像要比 B+树好，而在实际应用中却是 B+树的性能要好些。因为 B+树的非叶子节点不存放实际的数据， 这样每个节点可容纳的元素个数比B树多，树高比B树小，这样带来的好处是减少磁盘访问次数。尽管 B+树找到 一个记录所需的比较次数要比 B树多，但是一次磁盘访问的时间相当于成百上千次内存比较的时间，因此实际中 B+树的性能可能还会好些，而且 B+树的叶子节点使用指针连接在一起，方便顺序遍历（例如查看一个目录下的所有文件，一个表中的所有记录等），这也是很多数据库和文件系统使用 B+树的缘故</li>
</ul>
<p><strong>为什么说 B+树比 B-树更适合实际应用中操作系统的文件索引和数据库索引？</strong></p>
<ul>
<li>B+树的磁盘读写代价更低<ul>
<li>B+树的内部结点并没有指向关键字具体信息的指针。因此其内部结点相对 B 树更小。如果把所有同一内部结点的关键字存放在同一盘块中，那么盘块所能容纳的关键字数量也越多。一次性读入内存中的需要查找的关键字也就越多。相对来说 IO 读写次数也就降低了</li>
</ul>
</li>
<li>B+树的查询效率更加稳定<ul>
<li>由于非终结点并不是最终指向文件内容的结点，而只是叶子结点中关键字的索引。所以任何关键字的查找必须走一条从根结点到叶子结点的路。所有关键字查询的路径长度相同，导致每一个数据的查询效率相当</li>
</ul>
</li>
</ul>
<h2 id="MySQL中的B-树"><a href="#MySQL中的B-树" class="headerlink" title="MySQL中的B+树"></a>MySQL中的B+树</h2><p><strong>业的概念</strong></p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210510203700441.png" srcset="/img/loading.gif" lazyload alt="image-20210510203700441"></p>
<p><strong>主键索引</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200822173605.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200822173605.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>MySQL在创建表时，会根据主键来创建主键索引（如果没有主键，会用一个隐藏值来作为主键）。主键索引所构建的B+树，表中所有的记录都存放在了树的最后一层。<strong>且与一般的B+树不同的是：叶子节点间的指针是双向的</strong></p>
<p><strong>复合索引</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200822185520.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200822185520.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>创建复合索引时，会将作为<strong>复合索引字段的值</strong>进行排序并放在B+树的最后一层中，同时还会将其<strong>对应的主键值</strong>放在其后。如：</p>
<table>
<thead>
<tr>
<th>a（主键）</th>
<th>b</th>
<th>c</th>
<th>d</th>
<th>e</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>a</td>
</tr>
</tbody></table>
<p>其中字段a为主键，字段bcd共同作为复合索引，此时存放在最后一层的数据就是：111（复合索引） 2（主键索引）</p>
<p>根据这个特点，可以看出复合索引具有以下使用方法</p>
<ul>
<li><p>最佳左前缀：使用复合索引的顺序必须和创建的<strong>顺序一致</strong></p>
</li>
<li><p>覆盖索引的同时，可以带上主键字段，如</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> a, b, c, d <span class="hljs-keyword">FROM</span> t_emp;</code></pre></div>

<p>因为<strong>主键字段和复合索引一起存放在了复合索引说产生的B+树的最后一层</strong>。如果需要a字段，无需进行全表扫描</p>
</li>
<li><p>如果进行范围查找，可能会进行全表扫描，这取决于处在范围内记录的多少</p>
<ul>
<li><p><strong>记录多</strong>，从复合索引映射到主键索引的次数过多，成本过高，<strong>会直接进行全表扫描</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200822175336.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200822175336.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
<li><p><strong>记录少</strong>，先<strong>使用复合索引</strong>，然后<strong>映射到全表</strong>中的对应记录上</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">80</span>;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200822175403.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200822175403.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
<li><p>但是使用<strong>覆盖索引</strong>，无论记录多少，都会用到索引</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">SELECT</span> age, name <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200822175611.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200822175611.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
<li><p>不带WHERE也可以通过复合索引查找到主键+复合索引的记录</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">SELECT</span> id, age, name, deptId <span class="hljs-keyword">FROM</span> t_emp ;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200822175746.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200822175746.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
</ul>
</li>
</ul>
<h2 id="索引的使用场景"><a href="#索引的使用场景" class="headerlink" title="索引的使用场景"></a>索引的使用场景</h2><p><strong>适合索引的场景</strong></p>
<ul>
<li>主键自动建立唯一索引</li>
<li>频繁作为<strong>查询条件</strong>的字段应该创建索引 </li>
<li>查询中与其它表关联的字段，<strong>外键关系</strong>建立索引 </li>
<li>单键/组合索引的选择问题，<strong>组合索引性价比更高</strong></li>
<li>查询中<strong>排序的字段</strong>，排序字段若通过索引去访问将大大提高排序速度 </li>
<li>查询中<strong>统计</strong>或者<strong>分组</strong>字段</li>
</ul>
<p><strong>不适合索引的场景</strong></p>
<ul>
<li>表<strong>记录太少</strong>（有无索引差别不大）</li>
<li>经常<strong>增删改</strong>的表或者字段</li>
<li>Where 条件里用不到的字段不创建索引</li>
<li><strong>过滤性不好</strong>的不适合建索引（重复性较高，比如国籍、性别之类的字段）</li>
</ul>
<h1 id="九、Explain-性能分析"><a href="#九、Explain-性能分析" class="headerlink" title="九、Explain 性能分析"></a>九、Explain 性能分析</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>使用 <strong>EXPLAIN</strong> 关键字可以模拟优化器执行 SQL 查询语句，从而知道 MySQL 是如何处理你的 SQL 语句的。<strong>分析</strong>你的查询语句或是表结构的<strong>性能瓶颈</strong></p>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--EXPLAIN + SQL语句，如：</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> person;</code></pre></div>

<p><strong>Explain 执行后返回的信息：</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200815171636.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200815171636.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h2 id="表头字段介绍"><a href="#表头字段介绍" class="headerlink" title="表头字段介绍"></a>表头字段介绍</h2><p><strong>准备工作</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t1(id <span class="hljs-type">INT</span>(<span class="hljs-number">10</span>) AUTO_INCREMENT,content <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NULL</span> , <span class="hljs-keyword">PRIMARY</span> KEY (id));
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t2(id <span class="hljs-type">INT</span>(<span class="hljs-number">10</span>) AUTO_INCREMENT,content <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NULL</span> , <span class="hljs-keyword">PRIMARY</span> KEY (id));
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t3(id <span class="hljs-type">INT</span>(<span class="hljs-number">10</span>) AUTO_INCREMENT,content <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NULL</span> , <span class="hljs-keyword">PRIMARY</span> KEY (id));
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t4(id <span class="hljs-type">INT</span>(<span class="hljs-number">10</span>) AUTO_INCREMENT,content <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NULL</span> , <span class="hljs-keyword">PRIMARY</span> KEY (id));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t1(content) <span class="hljs-keyword">VALUES</span>(CONCAT(<span class="hljs-string">&#x27;t1_&#x27;</span>,<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span><span class="hljs-operator">+</span>RAND()<span class="hljs-operator">*</span><span class="hljs-number">1000</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t2(content) <span class="hljs-keyword">VALUES</span>(CONCAT(<span class="hljs-string">&#x27;t2_&#x27;</span>,<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span><span class="hljs-operator">+</span>RAND()<span class="hljs-operator">*</span><span class="hljs-number">1000</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t3(content) <span class="hljs-keyword">VALUES</span>(CONCAT(<span class="hljs-string">&#x27;t3_&#x27;</span>,<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span><span class="hljs-operator">+</span>RAND()<span class="hljs-operator">*</span><span class="hljs-number">1000</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t4(content) <span class="hljs-keyword">VALUES</span>(CONCAT(<span class="hljs-string">&#x27;t4_&#x27;</span>,<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span><span class="hljs-operator">+</span>RAND()<span class="hljs-operator">*</span><span class="hljs-number">1000</span>)));</code></pre></div>

<h3 id="id：表的读取顺序"><a href="#id：表的读取顺序" class="headerlink" title="id：表的读取顺序"></a><strong>id：表的读取顺序</strong></h3><p>id是select查询的序列号，包含一组数字，表示查询中执行select子句或操作表的顺序</p>
<ul>
<li><p><strong>id相同</strong>：执行顺序为 <strong>从上至下执行</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t1, t2, t3 <span class="hljs-keyword">WHERE</span> t1.id <span class="hljs-operator">=</span> t2.id <span class="hljs-keyword">AND</span> t2.id <span class="hljs-operator">=</span> t3.id;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200815173157.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200815173157.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>查询时，表的加载<strong>顺序为t1, t2, t3</strong></p>
</li>
<li><p><strong>id不同</strong>：执行顺序为 <strong>id大的先执行</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">SELECT</span> t2.id <span class="hljs-keyword">FROM</span> t2 <span class="hljs-keyword">WHERE</span> t2.id <span class="hljs-operator">=</span> 
(<span class="hljs-keyword">SELECT</span> t1.id <span class="hljs-keyword">FROM</span> t1 <span class="hljs-keyword">WHERE</span> t1.id <span class="hljs-operator">=</span> 
(<span class="hljs-keyword">SELECT</span> t3.id <span class="hljs-keyword">FROM</span> t3)
);</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200815174216.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200815174216.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>查询时，表的加载<strong>顺序为t3, t1, t2</strong></p>
</li>
<li><p><strong>id相同又不同</strong>： 执行顺序为 </p>
<ul>
<li>id不同时，值较大的先执行</li>
<li>id相同时，从上至下执行</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">SELECT</span> t2.<span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> t3.id
    <span class="hljs-keyword">FROM</span> t3
    <span class="hljs-keyword">WHERE</span> t3.content <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;&#x27;</span>) s1, t2
<span class="hljs-keyword">WHERE</span> s1.id <span class="hljs-operator">=</span> t2.id;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200815174740.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200815174740.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>查询时，表的<strong>加载顺序为t3, t2, 虚表dervied2</strong></p>
<ul>
<li>其中dervied<strong>2</strong> 的 2，为 id = 2</li>
</ul>
</li>
</ul>
<h3 id="select-type：查询操作类型"><a href="#select-type：查询操作类型" class="headerlink" title="select_type：查询操作类型"></a><strong>select_type：查询操作类型</strong></h3><p>select_type代表<strong>查询的类型</strong>，主要是用于区别<strong>普通查询、联合查询、子查询等</strong>的复杂查询</p>
<table>
<thead>
<tr>
<th>select_type 属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>SIMPLE</td>
<td>简单的 select 查询,查询中<strong>不包含子查询或者 UNION</strong></td>
</tr>
<tr>
<td>PRIMARY</td>
<td>查询中若包含任何复杂的子部分，<strong>最外层</strong>查询则被标记为 Primary</td>
</tr>
<tr>
<td>DERIVED</td>
<td>在 FROM 列表中包含的子查询被标记为 DERIVED(衍生) MySQL 会递归执行这些子查询, 把结果放在临时表里</td>
</tr>
<tr>
<td>SUBQUERY</td>
<td>在SELECT或WHERE列表中包含了<strong>子查询</strong></td>
</tr>
<tr>
<td>DEPEDENT SUBQUERY</td>
<td>在SELECT或WHERE列表中包含了子查询,<strong>子查询基于外层</strong></td>
</tr>
<tr>
<td>UNCACHEABLE SUBQUERY</td>
<td><strong>无法使用缓存</strong>的子查询</td>
</tr>
<tr>
<td>UNION</td>
<td>若第二个SELECT出现在UNION之后，则被标记为UNION； 若UNION包含在FROM子句的子查询中,外层SELECT将被标记为：DERIVED</td>
</tr>
<tr>
<td>UNION RESULT</td>
<td>从UNION表<strong>获取结果</strong>的SELECT</td>
</tr>
</tbody></table>
<ul>
<li><p>SUBQUERY 和 DEPEDENT SUBQUERY</p>
</li>
<li><p>都是 WHERE 后面的条件，SUBQUERY 是单个值（=），DEPEDENT SUBQUERY 是一组值（IN）</p>
</li>
<li><p>UNCACHEABLE SUBQUERY</p>
</li>
<li><p>当使用了**@@来引用系统变量**的时候，不会使用缓存</p>
</li>
<li><p>UNION 和 UNION RESULT </p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp a <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span>  t_dept b <span class="hljs-keyword">ON</span> a.deptId <span class="hljs-operator">=</span> b.id <span class="hljs-keyword">WHERE</span> b.id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>
<span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp a <span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">JOIN</span>  t_dept b <span class="hljs-keyword">ON</span> a.deptId <span class="hljs-operator">=</span> b.id <span class="hljs-keyword">WHERE</span> a.deptId <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816135453.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816135453.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
</ul>
<h3 id="table：表的来源"><a href="#table：表的来源" class="headerlink" title="table：表的来源"></a><strong>table：表的来源</strong></h3><p>table表示这个数据是基于哪张表的</p>
<h3 id="type：访问类型"><a href="#type：访问类型" class="headerlink" title="type：访问类型"></a><strong>type：访问类型</strong></h3><p>type 是查询的访问类型。<strong>是较为重要的一个指标</strong>，结果值从最好到最坏依次是：</p>
<div class="hljs code-wrapper"><pre><code class="hljs css">system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; all

--常见的顺序为
system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; all</code></pre></div>

<p>一般来说，得保证查询<strong>至少达到 range 级别</strong>，最好能达到 ref</p>
<table>
<thead>
<tr>
<th>类型名</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>SYSTEM</td>
<td>表只有一行记录（等于系统表），这是 const 类型的特列，平时不会出现，这个也<strong>可以忽略不计</strong></td>
</tr>
<tr>
<td>CONST</td>
<td>表示<strong>通过索引一次就找到了</strong>,const 用于比较 primary key 或者 unique 索引。因为只匹配一行数据，所以很快。如将主键置于 where 列表中，MySQL 就能将该查询转换为一个常量</td>
</tr>
<tr>
<td>EQ_REF</td>
<td>唯一性索引扫描，对于每个索引键，<strong>表中只有一条记录与之匹配</strong>。常见于主键或唯一索引扫描</td>
</tr>
<tr>
<td>REF</td>
<td>非唯一性索引扫描，返回匹配某个单独值的所有行。本质上也是一种索引访问，它返回所有匹配某个单独值的行， 然而，它<strong>可能会找到多个符合条件的行</strong>，所以他应该属于查找和扫描的混合体</td>
</tr>
<tr>
<td>RANGE</td>
<td>只检索给定<strong>范围</strong>的行,使用一个索引来选择行。key 列显示使用了哪个索引一般就是在你的 where 语句中出现 了 between、&lt;、&gt;、in 等的查询这种范围扫描索引扫描比全表扫描要好，因为它只需要开始于索引的某一点，而 结束语另一点，不用扫描全部索引</td>
</tr>
<tr>
<td>INDEX</td>
<td>出现index是sql使用了索引但是没用通过索引进行过滤，一般是使用了覆盖索引或者是利用索引进行了排序分组</td>
</tr>
<tr>
<td>ALL</td>
<td>Full Table Scan，将遍历全表以找到匹配的行</td>
</tr>
</tbody></table>
<ul>
<li><p>REF</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--其中deptId为索引，且用到了&#x27; = &#x27;</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> deptId <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816165420.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816165420.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
<li><p>RANGE</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--其中deptId为索引，用到了 BETWEEN...AND... , IN , &gt; , &lt; 等范围查询</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> deptId <span class="hljs-operator">&gt;</span> <span class="hljs-number">3</span>;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816213631.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816213631.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
<li><p>INDEX</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--其中deptId为索引，查找了整张表时，用到了索引</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> deptId <span class="hljs-keyword">FROM</span> t_emp;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816165651.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816165651.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
<li><p>ALL</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--其中name为非索引</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> t_emp;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816165722.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816165722.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
</ul>
<h3 id="possible-key：可能用到的索引"><a href="#possible-key：可能用到的索引" class="headerlink" title="possible_key：可能用到的索引"></a><strong>possible_key：可能用到的索引</strong></h3><p>显示<strong>可能</strong>应用在这张表中的索引，一个或多个。查询涉及到的字段上若存在索引，则该索引将被列出，但<strong>不一 定被查询实际使用</strong></p>
<h3 id="key：实际使用的索引"><a href="#key：实际使用的索引" class="headerlink" title="key：实际使用的索引"></a><strong>key：实际使用的索引</strong></h3><p><strong>实际使用的索引</strong>。如果为NULL，则没有使用索引</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> deptId <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816172950.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816172950.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>MySQL推测可能用到主键索引和idx_dept_id索引，实际上用到的是主键索引</p>
<h4 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a><strong>覆盖索引</strong></h4><p>当查找的字段与建立的索引的匹配（查询的字段都是索引，但不需要全是索引）时，会发生覆盖索引。MySQL推测使用的索引为NULL，而实际上会使用索引</p>
<p>有以下两种解释</p>
<ul>
<li>select的数据列<strong>只用从索引中就能够取得</strong>，不必从数据表中读取，换句话说<strong>查询列要被所使用的索引覆盖</strong></li>
<li>索引是高效找到行的一个方法，当能通过检索索引就可以读取想要的数据，那就不需要再到数据表中读取行了。如果一个索引包含了（或覆盖了）满足查询语句中字段与条件的数据就叫做覆盖索引</li>
</ul>
<p>注意：要使用覆盖索引，则<strong>只取出需要的列</strong>（被令为索引），<strong>不要</strong>使用 SELECT *</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--其中id和deptId都为索引</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> id, deptId <span class="hljs-keyword">FROM</span> t_emp;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816173253.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816173253.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816173228.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816173228.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h3 id="key-len：索引使用字节数"><a href="#key-len：索引使用字节数" class="headerlink" title="key_len：索引使用字节数"></a><strong>key_len：索引使用字节数</strong></h3><p>表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度。 key_len 字段能够帮你检查是否充分的利用上了索引</p>
<p><strong>ken_len 越长，说明索引使用的越充分</strong></p>
<h3 id="ref：显示被使用的索引的具体信息"><a href="#ref：显示被使用的索引的具体信息" class="headerlink" title="ref：显示被使用的索引的具体信息"></a><strong>ref：显示被使用的索引的具体信息</strong></h3><p>ref显示索引的哪一列被使用了，如果可能的话，可以是一个常数。哪些列或常量被用于查找索引列上的值</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_dept, t_emp <span class="hljs-keyword">WHERE</span> t_emp.deptId <span class="hljs-operator">=</span> t_dept.id;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816194305.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816194305.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>ref中如果有const就代表在where条件中加上了<code>t_emp.xx = &#39;xxx&#39;</code>匹配了常量</p>
<h3 id="rows：被查询的行数"><a href="#rows：被查询的行数" class="headerlink" title="rows：被查询的行数"></a><strong>rows：被查询的行数</strong></h3><p>rows 列显示 MySQL 认为它执行查询时必须检查的行数。<strong>越少越好！</strong></p>
<p><strong>验证</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--先删除索引</span>
<span class="hljs-keyword">DROP</span> INDEX idx_dept_id <span class="hljs-keyword">ON</span> t_emp;

<span class="hljs-comment">--查找</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_dept, t_emp <span class="hljs-keyword">WHERE</span> t_emp.deptId <span class="hljs-operator">=</span> t_dept.id;

<span class="hljs-comment">--再创建索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_dept_id <span class="hljs-keyword">ON</span> t_emp(deptId);

<span class="hljs-comment">--查找</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_dept, t_emp <span class="hljs-keyword">WHERE</span> t_emp.deptId <span class="hljs-operator">=</span> t_dept.id;</code></pre></div>

<p><strong>结果如下</strong></p>
<ul>
<li><p>未使用索引时，一共需要查询26行</p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816195241.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816195241.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
<li><p>使用索引后，一共需要查询6行</p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816195401.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816195401.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
</ul>
<h3 id="Extra：额外重要信息"><a href="#Extra：额外重要信息" class="headerlink" title="Extra：额外重要信息"></a><strong>Extra：额外重要信息</strong></h3><p>其他的额外<strong>重要</strong>的信息</p>
<h4 id="Using-filesort"><a href="#Using-filesort" class="headerlink" title="Using filesort"></a><strong>Using filesort</strong></h4><ul>
<li>使用外部索引排序（未使用用户创建的索引）</li>
<li>说明 mysql 会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。MySQL 中无法利用索引 完成的排序操作称为“文件排序”</li>
<li>出现 Using filesort <strong>说明SQL语句设计的不好</strong>，<strong>没有按照创建的索引进行排序</strong>，或者<strong>未按照索引指定的顺序进行排序</strong></li>
</ul>
<p><strong>演示</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--创建符合索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_emp_empno_age <span class="hljs-keyword">ON</span> t_emp(empno, age);

<span class="hljs-comment">--进行查询操作，通过 age 字段进行排序（未按照复合索引顺序进行排序查询）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> empno <span class="hljs-operator">&gt;</span><span class="hljs-number">100002</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> age;

<span class="hljs-comment">--进行查询操作，通过 empno 或者 empno + age 字段进行排序（按照复合索引顺序进行排序查询）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> empno <span class="hljs-operator">&gt;</span><span class="hljs-number">100002</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> empno;
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> empno <span class="hljs-operator">&gt;</span><span class="hljs-number">100002</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> empno, age;</code></pre></div>

<p><strong>结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816205145.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816205145.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816205226.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816205226.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816205112.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816205112.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h4 id="Using-temporary"><a href="#Using-temporary" class="headerlink" title="Using temporary"></a><strong>Using temporary</strong></h4><ul>
<li>使了用临时表保存中间结果,MySQL 在对查询结果排序时使用临时表。<strong>常见于排序 order by 和分组查询 group by</strong></li>
<li>出现 Using temporary <strong>说明SQL语句设计的非常不好</strong>，可能是因为没有按照顺序使用复合索引</li>
</ul>
<p><strong>演示</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--进行查询操作， 通过 age 字段进行分组（未按照复合索引顺序进行排序查询）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> empno <span class="hljs-operator">&gt;</span><span class="hljs-number">100002</span> <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> age;

<span class="hljs-comment">----进行查询操作，通过 empno 或者 empno + age 字段进行分组（按照复合索引顺序进行排序查询）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> empno <span class="hljs-operator">&gt;</span><span class="hljs-number">100002</span> <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> empno;
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> empno <span class="hljs-operator">&gt;</span><span class="hljs-number">100002</span> <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> empno, age;</code></pre></div>

<p><strong>结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816210843.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816210843.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816210908.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816210908.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>重要结论</strong></p>
<p>如果创建了<strong>复合索引</strong>，一定要<strong>按照复合索引的顺序来使用</strong>，否则会使得性能大幅下降。</p>
<p>filesort只能应用在单个表上，如果有多个表的数据需要排序，那么MySQL会先使用using temporary保存临时数据，然后再在临时表上使用filesort进行排序，最后输出结果。</p>
<h4 id="Using-index"><a href="#Using-index" class="headerlink" title="Using index"></a><strong>Using index</strong></h4><ul>
<li>Using index 代表表示相应的 select 操作中使用了<strong>覆盖索引</strong>(Covering Index)，详见[key：实际用到的索引——覆盖索引](# 覆盖索引)，避免访问了表的数据行，<strong>效率不错</strong>！ </li>
<li>如果同时出现 using where，表明<strong>索引被用来执行索引键值的查找</strong></li>
<li>如果没有同时出现 using where，表明<strong>索引只是用来读取数据</strong>而非利用索引执行查找。</li>
</ul>
<p><strong>演示</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--查询 age 字段，使用了WHERE</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> age <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span><span class="hljs-number">100000</span>;

<span class="hljs-comment">--查询 empno 和 age 字段，未使用WHERE</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> empno, age <span class="hljs-keyword">FROM</span> t_emp;

<span class="hljs-comment">--查询 empno 和 name 字段 （name字段不是索引）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> empno, name <span class="hljs-keyword">FROM</span> t_emp;</code></pre></div>

<p><strong>结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816212055.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816212055.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816212129.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816212129.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200816212243.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200816212243.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h4 id="Using-where"><a href="#Using-where" class="headerlink" title="Using where"></a>Using where</h4><ul>
<li>表明使用了 where 过滤</li>
</ul>
<h4 id="Using-join-buffer"><a href="#Using-join-buffer" class="headerlink" title="Using join buffer"></a>Using join buffer</h4><ul>
<li>使用了连接缓存</li>
</ul>
<h4 id="impossible-where"><a href="#impossible-where" class="headerlink" title="impossible where"></a>impossible where</h4><ul>
<li>where 子句的值总是 false，不能用来获取任何元组</li>
</ul>
<h4 id="select-tables-optimized-away"><a href="#select-tables-optimized-away" class="headerlink" title="select tables optimized away"></a>select tables optimized away</h4><ul>
<li>在没有 GROUP BY 子句的情况下，基于索引优化 MIN/MAX 操作或者对于 MyISAM 存储引擎优化 COUNT(*)操 作，不必等到执行阶段再进行计算，查询执行计划生成的阶段即完成优化</li>
</ul>
<h1 id="十、单表查询优化"><a href="#十、单表查询优化" class="headerlink" title="十、单表查询优化"></a>十、单表查询优化</h1><h2 id="全值匹配我最爱"><a href="#全值匹配我最爱" class="headerlink" title="全值匹配我最爱"></a>全值匹配我最爱</h2><p><strong>SQL语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--建立符合索引（age, deptId, name）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_emp_ade <span class="hljs-keyword">ON</span> t_emp(age, deptId, NAME);

<span class="hljs-comment">--查找</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">90</span>;
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">90</span> <span class="hljs-keyword">AND</span> deptId <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">90</span> <span class="hljs-keyword">AND</span> deptId <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;风清扬&#x27;</span>;

<span class="hljs-comment">--和上一条SQL语句中WHERE后字段的顺序不同，但是不影响查询结果</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> deptId <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;风清扬&#x27;</span> <span class="hljs-keyword">AND</span> age <span class="hljs-operator">=</span> <span class="hljs-number">90</span>;</code></pre></div>

<p><strong>对应结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817164200.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817164200.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817164226.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817164226.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817164241.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817164241.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817164506.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817164506.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>可以看到，<strong>复合索引都被用到了，并且SQL中查询字段的顺序，跟使用索引中字段的顺序，没有关系</strong>。优化器会在不影响 SQL 执行结果的前提下，自动地优化</p>
<p><strong>结论：全职匹配我最爱指的是，查询的字段按照顺序在索引中都可以匹配到</strong></p>
<h2 id="最佳左前缀法则"><a href="#最佳左前缀法则" class="headerlink" title="最佳左前缀法则"></a><strong>最佳左前缀法则</strong></h2><p><strong>SQL语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--先删除之前创建的单值索引</span>
<span class="hljs-keyword">DROP</span> INDEX idx_dept_id <span class="hljs-keyword">ON</span> t_emp; 

<span class="hljs-comment">--查询，未按照最佳左前缀法则</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> deptId <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> deptId <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;风清扬&#x27;</span>;

<span class="hljs-comment">--查询，部分按照最佳左前缀法则（age字段和复合索引匹配，但name没有）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span>  age <span class="hljs-operator">=</span> <span class="hljs-number">90</span> <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;风清扬&#x27;</span>;

<span class="hljs-comment">--查询，完全按照最佳左前缀法则</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">90</span> <span class="hljs-keyword">AND</span> deptId <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">90</span> <span class="hljs-keyword">AND</span> deptId <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;风清扬&#x27;</span>;</code></pre></div>

<p><strong>对应结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817164932.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817164932.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817164948.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817164948.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817165100.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817165100.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817164226.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817164226.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817164506.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817164506.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>可以看到，查询<strong>字段与索引字段顺序的不同会导致，索引无法充分使用，甚至索引失效</strong></p>
<p><strong>原因</strong>：使用复合索引，需要<strong>遵循最佳左前缀法则</strong>，即如果索引了多列，要遵守最左前缀法则。指的是查询从索引的<strong>最左前列开始并且不跳过索引中的列</strong>，俗称中间兄弟不能断</p>
<p><strong>结论：过滤条件要使用索引必须按照索引建立时的顺序，依次满足，一旦跳过某个字段，索引后面的字段都无法被使用</strong></p>
<h2 id="索引列上不计算"><a href="#索引列上不计算" class="headerlink" title="索引列上不计算"></a><strong>索引列上不计算</strong></h2><p>不在索引列上做任何操作（计算、函数、(自动 or 手动)类型转换），<strong>可能会导致索引失效而转向全表扫描</strong></p>
<p><strong>SQL语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--直接查询</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">90</span> <span class="hljs-keyword">AND</span> deptId <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> NAME <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;风清扬&#x27;</span>;

<span class="hljs-comment">--使用MySQL函数查询</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">LEFT</span>(age,<span class="hljs-number">2</span>) <span class="hljs-operator">=</span> <span class="hljs-number">90</span> <span class="hljs-keyword">AND</span> deptId <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;风清扬&#x27;</span>;</code></pre></div>

<p><strong>对应结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817170139.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817170139.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817170522.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817170522.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>可以看出，当age字段使用了left函数以后，<strong>导致索引完全失效</strong></p>
<p><strong>结论：等号左边无计算</strong></p>
<h2 id="范围之后全失效"><a href="#范围之后全失效" class="headerlink" title="范围之后全失效"></a>范围之后全失效</h2><p><strong>SQL语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--范围查询</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">50</span> <span class="hljs-keyword">AND</span> deptId <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;风清扬&#x27;</span>;
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">50</span> <span class="hljs-keyword">AND</span> deptId <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> NAME <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;风清扬&#x27;</span>;

<span class="hljs-comment">--未使用范围查询</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">50</span> <span class="hljs-keyword">AND</span> deptId <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;风清扬&#x27;</span>;</code></pre></div>

<p><strong>对应结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817171833.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817171833.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817172159.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817172159.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817171903.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817171903.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>可以看出，当对age字段使用范围查询后，使得范围后面的索引失效了</p>
<p><strong>建议：</strong>将可能做范围查询的字段的索引顺序<strong>放在最后</strong></p>
<p><strong>结论：使用范围查询后，如果范围内的记录过多，会导致索引失效</strong>，因为从自定义索引映射到主键索引需要耗费太多的时间，反而不如全表扫描来得快</p>
<h2 id="覆盖索引多使用"><a href="#覆盖索引多使用" class="headerlink" title="覆盖索引多使用"></a>覆盖索引多使用</h2><p><strong>SQL语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--查询所有字段</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_dept <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">--查询索引字段</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> t_dept <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;</code></pre></div>

<p><strong>对应结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817173338.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817173338.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817173314.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817173314.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>结论：使用覆盖索引（Using index）会提高检索效率</strong></p>
<h2 id="使用不等会失效"><a href="#使用不等会失效" class="headerlink" title="使用不等会失效"></a>使用不等会失效</h2><p>在使用<strong>不等于(!= 或者&lt;&gt;)时</strong>，有时会无法使用索引会导致全表扫描</p>
<p><strong>SQL语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--SQL语句中有不等于</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">!=</span> <span class="hljs-number">90</span>;
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-number">90</span>;

<span class="hljs-comment">--SQL语句中没有不等于</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">90</span>;</code></pre></div>

<p><strong>对应结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817180448.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817180448.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817180505.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817180505.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817180521.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817180521.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>结论：尽量不要使用不等于</strong></p>
<h2 id="使用NULL值要小心"><a href="#使用NULL值要小心" class="headerlink" title="使用NULL值要小心"></a>使用NULL值要小心</h2><p>在使用</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>
或者
<span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span></code></pre></div>

<p>时，可能会导致索引失效</p>
<p>但是如果<strong>允许字段为空</strong>，则</p>
<ul>
<li>IS NULL 不会导致索引失效</li>
<li>IS NOT NULL 会导致索引失效</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817181044.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817181044.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>SQL语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;

EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>;</code></pre></div>

<p><strong>对应结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817181116.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817181116.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817181137.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817181137.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h2 id="模糊查询加右边"><a href="#模糊查询加右边" class="headerlink" title="模糊查询加右边"></a>模糊查询加右边</h2><p>要使用模糊查询时，<strong>百分号最好加在右边，而且进行模糊查询的字段必须是单值索引</strong></p>
<p><strong>SQL语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--创建单值索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_emp_name <span class="hljs-keyword">ON</span> t_emp(NAME);

<span class="hljs-comment">--进行模糊查询</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%风&#x27;</span>;
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;风%&#x27;</span>;
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%风%&#x27;</span>;</code></pre></div>

<p><strong>对应结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817183416.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817183416.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817183401.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817183401.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817183416.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817183416.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>可以看出，对索引使用模糊查询时，<strong>只有当百分号在右边，索引为单值索引且模糊查询语句在最右边时，索引才会生效</strong></p>
<p>其他情况均失效了</p>
<p><strong>但是</strong>有时必须使用其他类型的模糊查询，这时就需要用<strong>覆盖索引</strong>来解决索引失效的问题</p>
<p><strong>SQL语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%风&#x27;</span>;
EXPLAIN <span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;风%&#x27;</span>;

EXPLAIN <span class="hljs-keyword">SELECT</span> NAME <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%风%&#x27;</span>;</code></pre></div>

<p><strong>对应结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817183741.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817183741.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817183801.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817183801.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817183741.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817183741.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>结论：对索引进行模糊查询时，最好在右边加百分号。必须在左边或左右加百分号时，需要用到覆盖索引来提升查询效率</strong></p>
<h2 id="字符串加单引号"><a href="#字符串加单引号" class="headerlink" title="字符串加单引号"></a>字符串加单引号</h2><p>当字段为字符串时，查询时必须带上单引号。否则<strong>会发生自动的类型转换</strong>，从而发生全表扫描</p>
<p><strong>用于查询的表</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817203952.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817203952.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>其中card_id字段为varchar类型，且设置了单值索引</strong></p>
<p><strong>SQL语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--使用了单引号</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> card_id <span class="hljs-keyword">FROM</span> person <span class="hljs-keyword">WHERE</span> card_id <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;1&#x27;</span>;

<span class="hljs-comment">--未使用单引号，发生自动类型转换</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> card_id <span class="hljs-keyword">FROM</span> person <span class="hljs-keyword">WHERE</span> card_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;</code></pre></div>

<p><strong>对应结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817204047.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817204047.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817204027.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817204027.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h2 id="尽量不用or查询"><a href="#尽量不用or查询" class="headerlink" title="尽量不用or查询"></a><strong>尽量不用or查询</strong></h2><p>如果使用or，可能导致索引失效。所以要减少or的使用，可以<strong>使用 union all 或者 union 来替代：</strong></p>
<p><strong>SQL语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--使用or进行查询</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">90</span> <span class="hljs-keyword">OR</span> NAME <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;风清扬&#x27;</span>;</code></pre></div>

<p><strong>对应结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200817204307.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200817204307.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h2 id="口诀"><a href="#口诀" class="headerlink" title="口诀"></a>口诀</h2><p>全职匹配我最爱，最左前缀要遵守</p>
<p>带头大哥不能死，中间兄弟不能断</p>
<p>索引列上少计算，范围之后全失效</p>
<p>LIKE 百分写最右，覆盖索引不写</p>
<p>不等空值还有 OR，索引影响要注意</p>
<p>VARCHAR 引号不可丢，SQL 优化有诀窍</p>
<h1 id="十一、关联查询优化"><a href="#十一、关联查询优化" class="headerlink" title="十一、关联查询优化"></a>十一、关联查询优化</h1><p><strong>建表语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> `class` (
`id` <span class="hljs-type">INT</span>(<span class="hljs-number">10</span>) UNSIGNED <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT, `card` <span class="hljs-type">INT</span>(<span class="hljs-number">10</span>) UNSIGNED <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> `book` (
`bookid` <span class="hljs-type">INT</span>(<span class="hljs-number">10</span>) UNSIGNED <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT, `card` <span class="hljs-type">INT</span>(<span class="hljs-number">10</span>) UNSIGNED <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-keyword">PRIMARY</span> KEY (`bookid`)
);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> class(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> book(card) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (RAND() <span class="hljs-operator">*</span> <span class="hljs-number">20</span>)));</code></pre></div>

<h2 id="LEFT-JOIN优化"><a href="#LEFT-JOIN优化" class="headerlink" title="LEFT JOIN优化"></a>LEFT JOIN优化</h2><p><strong>SQL语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--未建立索引时的左外连接查询</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> class <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> book <span class="hljs-keyword">ON</span> class.card <span class="hljs-operator">=</span> book.card;

<span class="hljs-comment">--左表（class）建立索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_class_card <span class="hljs-keyword">ON</span> class(card);

<span class="hljs-comment">--再次执行查询</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> class <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> book <span class="hljs-keyword">ON</span> class.card <span class="hljs-operator">=</span> book.card;

<span class="hljs-comment">--去掉左表索引</span>
<span class="hljs-keyword">DROP</span> INDEX idx_class_card <span class="hljs-keyword">ON</span> class;

<span class="hljs-comment">--右表建立索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_book_card <span class="hljs-keyword">ON</span> book(card);

<span class="hljs-comment">--再次执行查询</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> class <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> book <span class="hljs-keyword">ON</span> class.card <span class="hljs-operator">=</span> book.card;</code></pre></div>

<p><strong>对应结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200818170458.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200818170458.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200818170402.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200818170402.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200818170547.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200818170547.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>结论</strong></p>
<ul>
<li>在优化关联查询时，只有在<strong>被驱动表上建立索引才有效</strong></li>
<li>left join 时，左侧的为驱动表，<strong>右侧为被驱动表</strong></li>
</ul>
<h2 id="INNER-JOIN优化"><a href="#INNER-JOIN优化" class="headerlink" title="INNER JOIN优化"></a>INNER JOIN优化</h2><p><strong>SQL语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--查询操作，目前索引在book表的card上，class表和book表的位置不会改变查询结果</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> class <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> book <span class="hljs-keyword">ON</span> class.card <span class="hljs-operator">=</span> book.card;
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> book <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> class <span class="hljs-keyword">ON</span> book.card <span class="hljs-operator">=</span> class.card;

<span class="hljs-comment">--删除book表中的几条记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> book <span class="hljs-keyword">WHERE</span> bookid<span class="hljs-operator">&lt;</span><span class="hljs-number">10</span>;

<span class="hljs-comment">--再次查询</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> class <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> book <span class="hljs-keyword">ON</span> class.card <span class="hljs-operator">=</span> book.card;

<span class="hljs-comment">--删除book表card字段索引，给class表的card字段添加索引</span>
<span class="hljs-keyword">DROP</span> INDEX idx_book_card <span class="hljs-keyword">ON</span> book;
<span class="hljs-keyword">CREATE</span> INDEX idx_class_card <span class="hljs-keyword">ON</span> class(card);

<span class="hljs-comment">--再次查询</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> class <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> book <span class="hljs-keyword">ON</span> class.card <span class="hljs-operator">=</span> book.card;</code></pre></div>

<p><strong>对应结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200818171341.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200818171341.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200818171538.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200818171538.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200818171625.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200818171625.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>结论</strong>：inner join 时，<strong>mysql 会把小结果集的表选为驱动表</strong>（小表驱动大表）</p>
<p><strong>所以最好把索引建立在大表（数据较多的表）上</strong></p>
<h2 id="RIGHT-JOIN优化"><a href="#RIGHT-JOIN优化" class="headerlink" title="RIGHT JOIN优化"></a>RIGHT JOIN优化</h2><p>优化类型和LEFT JOIN类似，只不过<strong>被驱动表变成了左表</strong></p>
<h2 id="IN与EXISTS"><a href="#IN与EXISTS" class="headerlink" title="IN与EXISTS"></a>IN与EXISTS</h2><p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210510115846960.png" srcset="/img/loading.gif" lazyload alt="image-20210510115846960"></p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210510120010710.png" srcset="/img/loading.gif" lazyload alt="image-20210510120010710"></p>
<h1 id="十二、排序分组优化"><a href="#十二、排序分组优化" class="headerlink" title="十二、排序分组优化"></a>十二、排序分组优化</h1><p>在查询中难免会对查询结果进行排序操作。进行排序操作时要<strong>避免出现 Using filesort</strong>，应使用索引给排序带来的方便</p>
<p><strong>索引信息</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200819160428.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200819160428.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h2 id="ORDER-BY-优化"><a href="#ORDER-BY-优化" class="headerlink" title="ORDER BY 优化"></a>ORDER BY 优化</h2><p>以下查询都是在<strong>索引覆盖</strong>的条件下进行的</p>
<p><strong>SQL语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--不满足索引覆盖时进行排序查询</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> empno <span class="hljs-keyword">FROM</span> t_emp  <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">50</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> age, deptId;

<span class="hljs-comment">--按照复合索引顺序进行排序</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> age, deptId <span class="hljs-keyword">FROM</span> t_emp  <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">50</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> age;
EXPLAIN <span class="hljs-keyword">SELECT</span> age, deptId <span class="hljs-keyword">FROM</span> t_emp  <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">50</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> age, deptId;
EXPLAIN <span class="hljs-keyword">SELECT</span> age, deptId <span class="hljs-keyword">FROM</span> t_emp  <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">50</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> age, deptId, name;

<span class="hljs-comment">--不按照复合索引顺序进行排序（无 age 字段），发生Using filesort</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> age, deptId <span class="hljs-keyword">FROM</span> t_emp  <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">50</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> deptId, name;

<span class="hljs-comment">--不按照复合索引顺序进行排序（索引顺序打乱），发生Using filesort</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> age, deptId <span class="hljs-keyword">FROM</span> t_emp  <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">50</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> deptId, name, age;

<span class="hljs-comment">--排序时部分(age)升序，部分(deptId)降序，发生Using filesort</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> age, deptId <span class="hljs-keyword">FROM</span> t_emp  <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">50</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> age <span class="hljs-keyword">ASC</span>, deptId <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">--排序时都为降序</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> age, deptId <span class="hljs-keyword">FROM</span> t_emp  <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">50</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> age <span class="hljs-keyword">DESC</span>, deptId <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">--排序时，在前面的字段为常量时（非范围）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> age, deptId <span class="hljs-keyword">FROM</span> t_emp  <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">50</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> deptId, name;
EXPLAIN <span class="hljs-keyword">SELECT</span> age, deptId <span class="hljs-keyword">FROM</span> t_emp  <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">50</span> <span class="hljs-keyword">AND</span> deptId<span class="hljs-operator">&gt;</span><span class="hljs-number">10000</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> deptId, name;</code></pre></div>

<p><strong>对应结果</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200819162506.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200819162506.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200819162240.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200819162240.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200819162240.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200819162240.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200819162240.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200819162240.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200819162314.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200819162314.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200907210532.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200907210532.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200819162429.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200819162429.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200819162901.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200819162901.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200819164020.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200819164020.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200819164317.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200819164317.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>结论</strong>：</p>
<p>要想在排序时使用索引，避免 Using filesort，首先需要发生<strong>索引覆盖</strong>，其次</p>
<ul>
<li>ORDER BY 后面字段的顺序要和复合索引的<strong>顺序完全一致</strong></li>
<li>ORDER BY 后面的索引必须按照顺序出现，<strong>排在后面的可以不出现</strong></li>
<li>要进行升序或者降序时，<strong>字段的排序顺序必须一致</strong>。不能一部分升序，一部分降序，可以都升序或者都降序</li>
<li>如果复合索引前面的<strong>字段作为常量</strong>出现在过滤条件中，<strong>排序字段可以为紧跟其后的字段</strong></li>
</ul>
<h2 id="MySQL的排序算法"><a href="#MySQL的排序算法" class="headerlink" title="MySQL的排序算法"></a>MySQL的排序算法</h2><p>当发生 Using filesort 时，MySQL会根据自己的算法对查询结果进行排序</p>
<ul>
<li>双路排序<ul>
<li>MySQL 4.1 之前是使用双路排序,字面意思就是<strong>两次扫描磁盘</strong>，最终得到数据，读取行指针和 order by 列，对他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读取对应的数据输出</li>
<li>从磁盘取排序字段，在 buffer 进行排序，再从磁盘取其他字段</li>
<li>简单来说，<strong>取一批数据，要对磁盘进行了两次扫描</strong>，众所周知，I\O 是很耗时的，所以在 mysql4.1 之后，出现了第二种改进的算法，就是单路排序</li>
</ul>
</li>
<li>单路排序<ul>
<li>从磁盘读取查询需要的所有列，按照 order by 列<strong>在 buffer 对它们进行排序</strong>，然后扫描排序后的列表进行输出， 它的效率更快一些，避免了第二次读取数据。并且把随机 IO 变成了顺序 IO,但是它会使用更多的空间， 因为它把每一行都保存在内存中了</li>
<li><strong>存在的问题</strong>：在 sort_buffer 中，方法 B 比方法 A 要多占用很多空间，因为方法 B 是把所有字段都取出, 所以有可能<strong>取出的数据的总大小超出了 sort_buffer 的容量</strong>，导致每次只能取 sort_buffer 容量大小的数据，进行排序（创建 tmp 文件，多路合并），排完再取取 sort_buffer 容量大小，再排……从而多次 I/O。也就是<strong>本来想省一次 I/O 操作，反而导致了大量的 I/O 操作，反而得不偿失</strong></li>
</ul>
</li>
<li>优化Using filesort<ul>
<li>增大 sort_butter_size 参数的设置<ul>
<li>不管用哪种算法，提高这个参数都会提高效率，当然，要根据系统的能力去提高，因为这个参数是针对<strong>每个进程的 1M-8M 之间调整</strong></li>
</ul>
</li>
<li>增大 max_length_for_sort_data 参数的设置<ul>
<li>mysql 使用单路排序的前提是<strong>排序的字段大小要小于 max_length_for_sort_data</strong></li>
<li>提高这个参数，会增加用改进算法的概率。但是如果设的太高，数据总容量超出 sort_buffer_size 的概率就增大， 明显症状是高的磁盘 I/O 活动和低的处理器使用率。（1024-8192 之间调整）</li>
</ul>
</li>
<li>减少 select 后面的查询的字段<ul>
<li>查询的字段减少了，缓冲里就能容纳更多的内容了，<strong>间接增大了sort_buffer_size</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>总结</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200819164341.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200819164341.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h2 id="GROUP-BY-优化"><a href="#GROUP-BY-优化" class="headerlink" title="GROUP BY 优化"></a>GROUP BY 优化</h2><p>优化方式和 ORDER BY 类似，参考ORDER BY 的优化方式即可</p>
<h1 id="十三、截取查询分析"><a href="#十三、截取查询分析" class="headerlink" title="十三、截取查询分析"></a>十三、截取查询分析</h1><h2 id="慢日志查询"><a href="#慢日志查询" class="headerlink" title="慢日志查询"></a>慢日志查询</h2><p><strong>概念</strong></p>
<ul>
<li>MySQL的慢查询日志是MySQL提供的一种日志记录，<strong>它用来记录在MySQL中响应时间超过阀值的语句</strong>，具体指运行时间超过<strong>long_query_time</strong>值的SQL，则会被记录到慢查询日志中</li>
<li>具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。long_query_time的默认值为 10，意思是运行10秒以上的语句</li>
<li>由他来查看哪些SQL超出了我们的最大忍耐时间值，比如一条sql执行超过5秒钟，我们就算慢SQL，希望能 收集超过5秒的sql，结合之前explain进行全面分析</li>
</ul>
<p><strong>使用</strong></p>
<p>默认情况下，MySQL 数据库没有开启慢查询日志，需要我们<strong>手动</strong>来设置这个参数</p>
<p>如果不是调优需要的话，<strong>一般不建议启动该参数</strong>，因为开启慢查询日志会或多或少带来一定的性能影响。 慢查询日志支持将日志记录写入文件</p>
<table>
<thead>
<tr>
<th>SQL 语句</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>SHOW VARIABLES LIKE ‘%slow_query_log%’</td>
<td>查看慢查询日志是否开启</td>
<td>默认情况下 slow_query_log 的值为 OFF</td>
</tr>
<tr>
<td>set global slow_query_log=1</td>
<td>开启慢查询日志</td>
<td></td>
</tr>
<tr>
<td>SHOW VARIABLES LIKE ‘long_query_time%’</td>
<td>查看慢查询设定阈值</td>
<td>单位：秒</td>
</tr>
<tr>
<td>set long_query_time=1</td>
<td>设定慢查询阈值</td>
<td>单位：秒</td>
</tr>
</tbody></table>
<p>运行查询时间长的 sql，<strong>可以打开慢查询日志查看</strong></p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210510150321742.png" srcset="/img/loading.gif" lazyload alt="image-20210510150321742"></p>
<h2 id="批量数据脚本"><a href="#批量数据脚本" class="headerlink" title="批量数据脚本"></a>批量数据脚本</h2><p><strong>建表语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--dept 部门表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `dept` (
`id` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT, `deptName` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>, `address` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">40</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>, ceo <span class="hljs-type">INT</span> <span class="hljs-keyword">NULL</span> , <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>INNODB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;

<span class="hljs-comment">--emp 员工表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `emp` (
`id` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT, `empno` <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> , `name` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>, `age` <span class="hljs-type">INT</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>, `deptId` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
#<span class="hljs-keyword">CONSTRAINT</span> `fk_dept_id` <span class="hljs-keyword">FOREIGN</span> KEY (`deptId`) <span class="hljs-keyword">REFERENCES</span> `t_dept` (`id`)
) ENGINE<span class="hljs-operator">=</span>INNODB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;</code></pre></div>

<p><strong>设置参数</strong></p>
<p>在执行创建函数之前，首先请保证 log_bin_trust_function_creators 参数为 1，即 on 开启状态。 否则会报错</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--查询</span>
<span class="hljs-keyword">SHOW</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;log_bin_trust_function_creators&#x27;</span>;

<span class="hljs-comment">--设置</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> log_bin_trust_function_creators<span class="hljs-operator">=</span><span class="hljs-number">1</span>;</code></pre></div>

<h2 id="编写随机函数"><a href="#编写随机函数" class="headerlink" title="编写随机函数"></a>编写随机函数</h2><p><strong>随机产生字符串</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--DELIMITER 是用于改变结束的标志的，一般以分号结尾，但这里改为了以 $$ 结尾</span>
DELIMITER $$
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> rand_string(n <span class="hljs-type">INT</span>) <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-keyword">DECLARE</span> chars_str <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#x27;</span>;
<span class="hljs-keyword">DECLARE</span> return_str <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;&#x27;</span>;
<span class="hljs-keyword">DECLARE</span> i <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;
WHILE i <span class="hljs-operator">&lt;</span> n DO
<span class="hljs-keyword">SET</span> return_str <span class="hljs-operator">=</span>CONCAT(return_str,<span class="hljs-built_in">SUBSTRING</span>(chars_str,<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span><span class="hljs-operator">+</span>RAND()<span class="hljs-operator">*</span><span class="hljs-number">52</span>),<span class="hljs-number">1</span>));
<span class="hljs-keyword">SET</span> i <span class="hljs-operator">=</span> i <span class="hljs-operator">+</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">END</span> WHILE;
<span class="hljs-keyword">RETURN</span> return_str;
<span class="hljs-keyword">END</span> $$</code></pre></div>

<p>如果要<strong>删除函数</strong>，则执行：</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">FUNCTION</span> rand_string;</code></pre></div>

<p><strong>随机产生部门编号</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">DELIMITER $$
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> rand_num (from_num <span class="hljs-type">INT</span> ,to_num <span class="hljs-type">INT</span>) <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>)
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-keyword">DECLARE</span> i <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">SET</span> i <span class="hljs-operator">=</span> <span class="hljs-built_in">FLOOR</span>(from_num <span class="hljs-operator">+</span>RAND()<span class="hljs-operator">*</span>(to_num <span class="hljs-operator">-</span>from_num<span class="hljs-operator">+</span><span class="hljs-number">1</span>)) ;
<span class="hljs-keyword">RETURN</span> i;
<span class="hljs-keyword">END</span>$$</code></pre></div>

<p>如果要<strong>删除函数</strong>，则执行：</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">drop</span> <span class="hljs-keyword">function</span> rand_num;</code></pre></div>

<h2 id="创建存储过程"><a href="#创建存储过程" class="headerlink" title="创建存储过程"></a>创建存储过程</h2><p><strong>创建往 emp 表中插入数据的存储过程</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">DELIMITER $$
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> insert_emp( <span class="hljs-keyword">START</span> <span class="hljs-type">INT</span> , max_num <span class="hljs-type">INT</span> )
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-keyword">DECLARE</span> i <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;
#<span class="hljs-keyword">set</span> autocommit <span class="hljs-operator">=</span><span class="hljs-number">0</span> 把 autocommit 设置成 <span class="hljs-number">0</span>
<span class="hljs-keyword">SET</span> autocommit <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
REPEAT
<span class="hljs-keyword">SET</span> i <span class="hljs-operator">=</span> i <span class="hljs-operator">+</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> emp (empno, NAME ,age ,deptid ) <span class="hljs-keyword">VALUES</span> ((<span class="hljs-keyword">START</span><span class="hljs-operator">+</span>i) ,rand_string(<span class="hljs-number">6</span>) , rand_num(<span class="hljs-number">30</span>,<span class="hljs-number">50</span>),rand_num(<span class="hljs-number">1</span>,<span class="hljs-number">10000</span>));
UNTIL i <span class="hljs-operator">=</span> max_num
<span class="hljs-keyword">END</span> REPEAT;
<span class="hljs-keyword">COMMIT</span>;
<span class="hljs-keyword">END</span>$$

<span class="hljs-comment">--删除</span>
<span class="hljs-comment">-- DELIMITER ;</span>
<span class="hljs-comment">-- drop PROCEDURE insert_emp; </span></code></pre></div>

<p><strong>创建往 dept 表中插入数据的存储过程</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--执行存储过程，往 dept 表添加随机数据</span>
DELIMITER $$
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> `insert_dept`( max_num <span class="hljs-type">INT</span> )
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-keyword">DECLARE</span> i <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">SET</span> autocommit <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
REPEAT
<span class="hljs-keyword">SET</span> i <span class="hljs-operator">=</span> i <span class="hljs-operator">+</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> dept ( deptname,address,ceo ) <span class="hljs-keyword">VALUES</span> (rand_string(<span class="hljs-number">8</span>),rand_string(<span class="hljs-number">10</span>),rand_num(<span class="hljs-number">1</span>,<span class="hljs-number">500000</span>));
UNTIL i <span class="hljs-operator">=</span> max_num
<span class="hljs-keyword">END</span> REPEAT;
<span class="hljs-keyword">COMMIT</span>;
<span class="hljs-keyword">END</span>$$

<span class="hljs-comment">--删除</span>
<span class="hljs-comment">-- DELIMITER ;</span>
<span class="hljs-comment">-- drop PROCEDURE insert_dept; </span></code></pre></div>

<h2 id="调用存储过程"><a href="#调用存储过程" class="headerlink" title="调用存储过程"></a>调用存储过程</h2><p><strong>添加数据到部门表</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--执行存储过程，往 dept 表添加 1 万条数据</span>
DELIMITER ;
<span class="hljs-keyword">CALL</span> insert_dept(<span class="hljs-number">10000</span>);</code></pre></div>

<p><strong>添加数据到员工表</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--执行存储过程，往 emp 表添加 50 万条数据</span>
DELIMITER ;
<span class="hljs-keyword">CALL</span> insert_emp(<span class="hljs-number">100000</span>,<span class="hljs-number">500000</span>);</code></pre></div>

<h2 id="批量删除某个表上的所有索引"><a href="#批量删除某个表上的所有索引" class="headerlink" title="批量删除某个表上的所有索引"></a>批量删除某个表上的所有索引</h2><p><strong>删除索引的存储过程</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">DELIMITER $$
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> `proc_drop_index`(dbname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>),tablename <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>))
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-keyword">DECLARE</span> done <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">DECLARE</span> ct <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">DECLARE</span> _index <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;&#x27;</span>;
<span class="hljs-keyword">DECLARE</span> _cur <span class="hljs-keyword">CURSOR</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> index_name <span class="hljs-keyword">FROM</span> information_schema.STATISTICS <span class="hljs-keyword">WHERE</span>
table_schema<span class="hljs-operator">=</span>dbname <span class="hljs-keyword">AND</span> table_name<span class="hljs-operator">=</span>tablename <span class="hljs-keyword">AND</span> seq_in_index<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> index_name <span class="hljs-operator">&lt;&gt;</span><span class="hljs-string">&#x27;PRIMARY&#x27;</span> ;
<span class="hljs-keyword">DECLARE</span> CONTINUE HANDLER <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">NOT</span> FOUND <span class="hljs-keyword">set</span> done<span class="hljs-operator">=</span><span class="hljs-number">2</span> ;
<span class="hljs-keyword">OPEN</span> _cur;
<span class="hljs-keyword">FETCH</span> _cur <span class="hljs-keyword">INTO</span> _index;
WHILE _index<span class="hljs-operator">&lt;&gt;</span><span class="hljs-string">&#x27;&#x27;</span> DO
<span class="hljs-keyword">SET</span> <span class="hljs-variable">@str</span> <span class="hljs-operator">=</span> CONCAT(&quot;drop index &quot;,_index,&quot; on &quot;,tablename );
<span class="hljs-keyword">PREPARE</span> sql_str <span class="hljs-keyword">FROM</span> <span class="hljs-variable">@str</span> ;
<span class="hljs-keyword">EXECUTE</span> sql_str;
<span class="hljs-keyword">DEALLOCATE</span> <span class="hljs-keyword">PREPARE</span> sql_str;
<span class="hljs-keyword">SET</span> _index<span class="hljs-operator">=</span><span class="hljs-string">&#x27;&#x27;</span>;
<span class="hljs-keyword">FETCH</span> _cur <span class="hljs-keyword">INTO</span> _index;
<span class="hljs-keyword">END</span> WHILE;
<span class="hljs-keyword">CLOSE</span> _cur;
<span class="hljs-keyword">END</span>$$</code></pre></div>

<p><strong>执行存储过程</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CALL</span> proc_drop_index(&quot;dbname&quot;,&quot;tablename&quot;);</code></pre></div>

<h1 id="十四、Profiles分析"><a href="#十四、Profiles分析" class="headerlink" title="十四、Profiles分析"></a>十四、Profiles分析</h1><p>查看是否开启</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;profiling&#x27;</span>;</code></pre></div>

<p>开启</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SET</span> profiling <span class="hljs-operator">=</span> <span class="hljs-keyword">ON</span> ;</code></pre></div>

<p>查看结果</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> PROFILES ;</code></pre></div>

<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210510153815959.png" srcset="/img/loading.gif" lazyload alt="image-20210510153815959"></p>
<p>查看具体语句的分析</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> PROFILE cpu,block io <span class="hljs-keyword">FOR</span> QUERY id;</code></pre></div>

<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210510153834309.png" srcset="/img/loading.gif" lazyload alt="image-20210510153834309"></p>
<p>出现以下结果危险</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210510153359372.png" srcset="/img/loading.gif" lazyload alt="image-20210510153359372"></p>
<h1 id="十五、MySQL锁机制"><a href="#十五、MySQL锁机制" class="headerlink" title="十五、MySQL锁机制"></a>十五、MySQL锁机制</h1><h2 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h2><p><strong>[MylSAM](# 引擎层 )引擎使用表锁，并且不支持事务</strong></p>
<p><strong>SQL语句</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--展示表是否加锁</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">OPEN</span> TABLES;

<span class="hljs-comment">--加锁 read (读锁) write (写锁)</span>
LOCK <span class="hljs-keyword">TABLE</span> table1 read(write), table2 read(write)...

<span class="hljs-comment">--全部解锁</span>
UNLOCK TABLES;</code></pre></div>

<h2 id="读锁"><a href="#读锁" class="headerlink" title="读锁"></a>读锁</h2><ul>
<li>主机A给表加上<strong>表锁（读锁）</strong>以后<ul>
<li>主机A和其他主机都可以读取<strong>该表</strong>的信息</li>
<li><strong>主机A不能读取库中其他表的信息</strong>，但其他主机可以读取库中所有表的信息</li>
<li>如果要修改被锁表的信息<ul>
<li>主机A如果对表进行修改，<strong>会修改失败</strong></li>
<li>其他主机对表进行修改，<strong>会被阻塞，直到锁被释放</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>演示</strong></p>
<ul>
<li><p>给dept表加锁并查询状态</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">LOCK <span class="hljs-keyword">TABLE</span> dept READ;

<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">OPEN</span> TABLES;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820151441.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820151441.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
</ul>
<p><strong>读取</strong></p>
<ul>
<li><p>两个客户端分别读取dept表的信息，都能读出来</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> dept <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;</code></pre></div></li>
<li><p>客户端A（加锁端）A<strong>读取其他表</strong>信息，<strong>读取失败</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820152614.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820152614.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
<li><p>其他客户端读取度其他表信息，读取成功</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820152714.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820152714.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
</ul>
<p><strong>修改</strong></p>
<ul>
<li><p>客户端A对表中内容进行修改，<strong>修改失败</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> dept <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820151654.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820151654.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
<li><p>客户端B对表中内容进行修改，进入阻塞状态</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> dept <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;</code></pre></div></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820151737.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820151737.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<ul>
<li><p>从客户端A解锁后，客户端B修改成功</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">UNLOCK TABLES;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820151818.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820151818.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
</ul>
<h2 id="写锁"><a href="#写锁" class="headerlink" title="写锁"></a>写锁</h2><p>主机A给表加上<strong>表锁（写锁）</strong>以后</p>
<ul>
<li>主机A可以读取该表信息，但<strong>其他主机读取时，会进入阻塞状态，直到锁被释放</strong></li>
<li><strong>主机A不能读取库中其他表的信息</strong>，但其他主机可以读取库中<strong>除该表以外所有表</strong>的信息</li>
<li>如果要修改被锁表的信息<ul>
<li>主机A如果对表进行修改，修改成功</li>
<li>其他主机对表进行修改，<strong>会被阻塞，直到锁被释放</strong></li>
</ul>
</li>
</ul>
<p><strong>演示</strong></p>
<ul>
<li><p>给dept表加上写锁并查看</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">LOCK <span class="hljs-keyword">TABLE</span> dept WRITE;

<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">OPEN</span> TABLES;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820153259.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820153259.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
</ul>
<p><strong>读取</strong></p>
<ul>
<li><p>客户端A查询该表内容，查询成功；读取其他表，读取失败</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> dept;

<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820153403.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820153403.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820153437.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820153437.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<ul>
<li><p>其他表读取该表信息，进入阻塞状态</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> dept;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820153517.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820153517.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
<li><p>释放后，读取成功</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql">UNLOCK TABLES;</code></pre></div></li>
</ul>
<p><strong>修改</strong></p>
<ul>
<li><p>客户端A修改<strong>该表</strong>内容，修改成功</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">DELETE</span> dept <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820153637.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820153637.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
<li><p>客户端A修改<strong>其他表</strong>内容，修改失败</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820153710.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820153710.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
</li>
<li><p>其他客户端修改<strong>该表</strong>内容，进入阻塞状态</p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;</code></pre></div></li>
</ul>
<p><strong>总结</strong></p>
<p><strong>读锁不会阻塞读，只会阻塞写。但是写锁会阻塞读和写。</strong></p>
<h2 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h2><p><strong>InnoDB使用行锁，并且支持事务</strong>，事务相关可参考 <a href="#%E4%BA%94%E3%80%81%E4%BA%8B%E5%8A%A1"><strong>MySQL基础事务</strong></a></p>
<p><strong>特点</strong></p>
<p>如果两个客户端<strong>对同一条记录进行修改</strong></p>
<ul>
<li>客户端A修改后，未提交（未commit），此时客户端B修改，则会阻塞</li>
<li>客户端A修改后，提交后，客户端B再修改，则不会阻塞</li>
</ul>
<p>如果两个客户端分别<strong>对不同的记录进行修改</strong>，则不会被阻塞</p>
<p><strong>修改同一条记录</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--关闭自动提交</span>
<span class="hljs-keyword">SET</span> autocommit <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

<span class="hljs-comment">--客户端A、B查询id=2的记录</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

<span class="hljs-comment">--客户端A进行修改操作（将年龄改为了80），但未提交</span>
UPDATE t_emp <span class="hljs-keyword">SET</span> age <span class="hljs-operator">=</span> <span class="hljs-number">80</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

<span class="hljs-comment">--客户端A进行查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

<span class="hljs-comment">--客户端B进行查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

<span class="hljs-comment">--客户端B进行修改（客户端A未提交）</span>
UPDATE t_emp <span class="hljs-keyword">SET</span> age <span class="hljs-operator">=</span> <span class="hljs-number">90</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

<span class="hljs-comment">--客户端A提交</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">--客户端B提交</span>
<span class="hljs-keyword">COMMIT</span>;</code></pre></div>

<p><strong>对应结果</strong></p>
<p>客户端A查询结果</p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820163718.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820163718.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>客户端B查询结果</p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820163718.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820163718.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>客户端A修改后A查询</p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820163847.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820163847.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>客户端A修改后B查询</p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820163718.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820163718.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>客户端A修改，未提交，此时B进行修改，<strong>被阻塞</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820163957.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820163957.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>客户端A提交后，B修改成功</p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820164036.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820164036.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>修改不同记录</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--客户端A对id=2的年龄进行修改</span>
UPDATE t_emp <span class="hljs-keyword">SET</span> age <span class="hljs-operator">=</span> <span class="hljs-number">90</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

<span class="hljs-comment">--客户端B对id=3的年龄进行修改</span>
UPDATE t_emp <span class="hljs-keyword">SET</span> age <span class="hljs-operator">=</span> <span class="hljs-number">30</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;

<span class="hljs-comment">--客户端A，B分别提交</span>
<span class="hljs-keyword">COMMIT</span>;
<span class="hljs-keyword">COMMIT</span>;</code></pre></div>

<p>因为InnoDB使用行锁，对于不同行的操作，不会出现阻塞现象</p>
<p><strong>索引失效</strong></p>
<p>索引失效，<strong>行锁变表锁</strong></p>
<p>当<strong>索引失效</strong>后，即使多个客户端操作的不是同一条记录，<strong>如果未提交，其他客户端也会进入阻塞状态</strong></p>
<p>所以要<strong>避免索引失效</strong></p>
<h2 id="间隙锁危害"><a href="#间隙锁危害" class="headerlink" title="间隙锁危害"></a>间隙锁危害</h2><p><strong>概念</strong></p>
<p>当我们用<strong>范围条件</strong>而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁</p>
<p>对于键值<strong>在条件范围内但并不存在的记录</strong>，叫做<strong>“间隙(GAP)<strong>” ，</strong>InnoDB也会对这个“间隙”加锁</strong>，这种锁机制就是所谓的间隙锁(Next-Key锁)。</p>
<p><strong>危害</strong></p>
<p>因为Query执行过程中通过过范围查找的话，他会锁定整个范围内所有的索引键值，即使这个键值并不存在。<br>间隙锁有一个比较致命的弱点，就是当锁定一个范围键值之后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定键值范围内的任何数据。在某些场景下这可能会对性能造成很大的危害</p>
<p><strong>演示</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">--查询表记录，此处没有id=2的记录</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp;

<span class="hljs-comment">--客户端A进行范围查询，但是范围内没有id=2的记录</span>
UPDATE t_emp <span class="hljs-keyword">SET</span> deptId <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">&gt;</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> id <span class="hljs-operator">&lt;</span> <span class="hljs-number">6</span>;

<span class="hljs-comment">--客户端B进行插入数据，插入一条id=2的记录</span>
<span class="hljs-keyword">INSERT</span> t_emp <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;岳不群&#x27;</span>, <span class="hljs-number">11</span>, <span class="hljs-number">2</span>, <span class="hljs-number">100002</span>); 

<span class="hljs-comment">--客户端A提交</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">--客户端B提交</span>
<span class="hljs-keyword">COMMIT</span>;</code></pre></div>

<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820170126.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820170126.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>客户端B进入阻塞状态</strong></p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820170617.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820170617.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>提交后，插入成功</p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200820170654.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200820170654.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>结论</strong>：可以看到表中本来<strong>没有id=2的记录</strong>，但是在客户端A进行<strong>范围修改</strong>时，客户端B对<strong>在范围内但不存在的数据进行插入时，客户端B进入了阻塞状态</strong></p>
<p><strong>查看行锁的争夺情况</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> STATUS <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;innodb_row_lock%&#x27;</span>;</code></pre></div>

<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210510163712985.png" srcset="/img/loading.gif" lazyload alt="image-20210510163712985"></p>
<ul>
<li>1表示正在等待锁定的数量</li>
<li>2表示等待总时长</li>
<li>3表示等待平均时长</li>
<li>5表示系统启动后到现在总共等待的次数</li>
</ul>
<h2 id="锁住指定的一行"><a href="#锁住指定的一行" class="headerlink" title="锁住指定的一行"></a><strong>锁住指定的一行</strong></h2><div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">BEGIN</span>;

<span class="hljs-comment">--锁住指定的一行，如果进行更新操作就是 ... FOR UPDATE，删除操作就是 ... FOR DELETE 以此类推</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_emp <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> UPDATE;

<span class="hljs-comment">--进行修改操作</span>
UPDATE t_emp <span class="hljs-keyword">SET</span> NAME <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;风车车&#x27;</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">--提交</span>
<span class="hljs-keyword">COMMIT</span>;</code></pre></div>

<p>如果当某一行被锁住后，其他客户端对改行进行操作，会被<strong>阻塞</strong></p>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>Innodb存储引擎由于实现了<strong>行级锁定</strong>，虽然在锁定机制的实现方面所带来的性能损耗可能比表级锁定会要更高一些， 但是在整体<strong>并发处理能力方面要远远优于MyISAM的表级锁定的</strong>。当系统并发量较高的时候，Innodb的整体性能和MyISAM相比就会有比较明显的优势了。<br>但是，Innodb的行级锁定同样也有其脆弱的一面，当我们<strong>使用不当的时候</strong>，可能会让Innodb的整体性能表现不仅不能比MylSAM高，甚至可能会更差。</p>
<h1 id="十六、复制"><a href="#十六、复制" class="headerlink" title="十六、复制"></a>十六、复制</h1><h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h2><p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/12.mysql%E4%B8%AD%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%9E%B6%E6%9E%84.jpg" srcset="/img/loading.gif" lazyload alt="12.mysql中主从复制架构"></p>
<p>主要涉及三个线程：binlog 线程、I/O 线程和 SQL 线程。</p>
<ul>
<li><strong>binlog 线程</strong> ：负责将主服务器上的数据更改<strong>写入二进制日志</strong>（Binary log）中。</li>
<li><strong>I/O 线程</strong> ：负责从主服务器上读取二进制日志，并<strong>写入从服务器的中继日志</strong>（Relay log）。</li>
<li><strong>SQL 线程</strong> ：负责<strong>读取中继日志</strong>，解析出主服务器已经执行的数据更改并在从服务器中重放（Replay）。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200822133613.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200822133613.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>在Linux下实施</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs markdown"><span class="hljs-section"># 0.架构规划</span>
<span class="hljs-code">	192.168.202.201    master  主节点</span>
<span class="hljs-code">	192.168.202.202    slave   从节点</span>
<span class="hljs-code"></span>
<span class="hljs-code"># 1.修改mysql的配置文件</span>
<span class="hljs-code">  vim /etc/my.cnf</span>
<span class="hljs-code"></span>
<span class="hljs-code"># 2.分别在配置文件中加入如下配置</span>
<span class="hljs-code">	mysql(master):</span>
<span class="hljs-code">		server-id=1</span>
<span class="hljs-code">		log-bin=mysql-bin</span>
<span class="hljs-code">		log-slave-updates</span>
<span class="hljs-code">		slave-skip-errors=all</span>
<span class="hljs-code">	</span>
<span class="hljs-code">	msyql(slave):</span>
<span class="hljs-code">		server-id=2</span>
<span class="hljs-code">		log-bin=mysql-bin</span>
<span class="hljs-code">		log-slave-updates</span>
<span class="hljs-code">		slave-skip-errors=all</span>
<span class="hljs-code">		</span>
<span class="hljs-code">注意:两个机器的server-id不能一致</span></code></pre></div>

<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20191013201349444.png" srcset="/img/loading.gif" lazyload alt="image-20191013201349444"></p>
<div class="hljs code-wrapper"><pre><code class="hljs markdown"><span class="hljs-section"># 3.重启mysql服务</span>
<span class="hljs-code">	systemctl restart mysqld</span>
<span class="hljs-code"></span>
<span class="hljs-code"># 4.登录mysql执行如下命令检测配置是否生效</span>
<span class="hljs-code">	SHOW VARIABLES like &#x27;server_id&#x27;;</span></code></pre></div>

<img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20191013201523812.png" srcset="/img/loading.gif" lazyload alt="image-20191013201523812"  />

<div class="hljs code-wrapper"><pre><code class="hljs markdown"><span class="hljs-section"># 5.登录master节点执行如下命令</span>
<span class="hljs-code">		show master status;</span>
<span class="hljs-code">		从图中可以发现从120行后同步</span></code></pre></div>

<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20191013203543728.png" srcset="/img/loading.gif" lazyload alt="image-20191013203543728"></p>
<div class="hljs code-wrapper"><pre><code class="hljs markdown"><span class="hljs-section"># 6.登录slave节点执行如下命令:</span>
<span class="hljs-code">		change master to </span>
<span class="hljs-code">		master_host=&#x27;192.168.202.201&#x27;,</span>
<span class="hljs-code">		master_user=&#x27;root&#x27;,</span>
<span class="hljs-code">		master_password=&#x27;root&#x27;,</span>
<span class="hljs-code">		master_log_file=&#x27;mysql-bin.000001&#x27;,</span>
<span class="hljs-code">		master_log_pos=120;</span></code></pre></div>

<div class="hljs code-wrapper"><pre><code class="hljs markdown"><span class="hljs-section"># 7.开启slave节点</span>
<span class="hljs-code">		start slave; </span>
<span class="hljs-code">		stop  slave;</span></code></pre></div>

<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20191013204413766.png" srcset="/img/loading.gif" lazyload alt="image-20191013204413766"></p>
<div class="hljs code-wrapper"><pre><code class="hljs markdown"><span class="hljs-section"># 8.查看从节点状态</span>
<span class="hljs-code">		show slave status\G;</span>
<span class="hljs-code"></span>
<span class="hljs-code">		************************** 1. row ***************************</span>
<span class="hljs-code">               Slave_IO_State: Waiting for master to send event</span>
<span class="hljs-code">                  Master_Host: 10.15.0.9</span>
<span class="hljs-code">                  Master_User: root</span>
<span class="hljs-code">                  Master_Port: 3306</span>
<span class="hljs-code">                Connect_Retry: 60</span>
<span class="hljs-code">              Master_Log_File: mysql-bin.000001</span>
<span class="hljs-code">          Read_Master_Log_Pos: 120</span>
<span class="hljs-code">               Relay_Log_File: mysqld-relay-bin.000002</span>
<span class="hljs-code">                Relay_Log_Pos: 283</span>
<span class="hljs-code">        Relay_Master_Log_File: mysql-bin.000001</span>
<span class="hljs-code">             Slave_IO_Running: Yes</span>
<span class="hljs-code">            Slave_SQL_Running: Yes</span>
<span class="hljs-code">   	</span>
<span class="hljs-code">    注意:</span>
<span class="hljs-code">    		1.出现 Slave_IO_Running: Yes`和 Slave_SQL_Running: Yes 说明成功</span>
<span class="hljs-code">    		2.如果在搭建过程出现错误,可以查看查看错误日志文件 cat /var/log/mysqld.log</span>
<span class="hljs-code"># 9.通过客户端工具进行测试</span>
<span class="hljs-code">	自行选择客户端，在master节点新建，可以发现slave节点也会同步</span>
<span class="hljs-code"># 10.关闭主从复制(在从节点执行)</span>
<span class="hljs-code">	stop slave;</span></code></pre></div>

<ul>
<li>注意:如果出现<code>Slave I/O: Fatal error: The slave I/O thread stops because master and slave have equal MySQL server UUIDs; these UUIDs must be different for replication to work. Error_code: 1593</code>错误</li>
<li>关闭<code>systemctl stop mysqld</code>后执行如下命令<code>rm -rf /var/lib/mysql/auto.cnf</code>删除这个文件,之所以出现会出现这样的问题，是因为我的从库主机是克隆的主库所在的主机，所以<code>auto.cnf</code>文件中保存的UUID会出现重复.</li>
</ul>
<h2 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h2><p><strong>主服务器处理写操作</strong>以及实时性要求比较高的读操作，而<strong>从服务器处理读操作</strong></p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/13.mysql%E4%B8%AD%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%9E%B6%E6%9E%84-0377396.jpg" srcset="/img/loading.gif" lazyload alt="13.mysql中读写分离架构"></p>
<p>读写分离能提高性能的原因在于：</p>
<ul>
<li>主从服务器负责各自的读和写，极大程度<strong>缓解了锁的争用</strong></li>
<li><strong>从服务器</strong>可以使用 <a href="#%E5%BC%95%E6%93%8E%E5%B1%82">MyISAM</a>，提升查询性能以及节约系统开销</li>
<li>增加冗余，提高可用性</li>
</ul>
<p>读写分离常用代理方式来实现，代理服务器接收应用层传来的读写请求，然后决定转发到哪个服务器</p>
<p><a target="_blank" rel="noopener" href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200822133739.png"><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/20200822133739.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/SQL/">SQL</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/08/01/Redis/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Redis</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/07/25/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86/">
                        <span class="hidden-mobile">Java开发网络相关知识</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function () {
        new Valine({
          el: "#valine",
          app_id: "Q8utolFFXQsi71pQY6bCltkI-gzGzoHsz",
          app_key: "x4RAlPOpmFX9HdGyI6MLoCGn",
          placeholder: "说点什么....",
          path: window.location.pathname,
          avatar: "monsterid",
          meta: ["nick","mail","link"],
          pageSize: "12",
          lang: "zh-CN",
          highlight: true,
          recordIP: true,
          serverURLs: "",
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.2/dist/tocbot.min.js" ></script>





  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>




  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>












  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
