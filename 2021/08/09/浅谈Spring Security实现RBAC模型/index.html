

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/bat.png">
  <link rel="icon" href="/img/bat.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Lucifer">
  <meta name="keywords" content="">
  
  <title>æµ…è°ˆSpring Securityå®ç°RBACæ¨¡å‹ - Lucifer&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.6.0/styles/monokai.min.css" />
    
  

  



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"lucifer2u.github.io","root":"/","version":"1.8.10","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":false,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"Q8utolFFXQsi71pQY6bCltkI-gzGzoHsz","app_key":"x4RAlPOpmFX9HdGyI6MLoCGn","server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 80vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Lucifer</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                ä¸»é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äºæˆ‘
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/Flower.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="æµ…è°ˆSpring Securityå®ç°RBACæ¨¡å‹">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-08-09 22:12" pubdate>
        2021å¹´8æœˆ9æ—¥ æ™šä¸Š
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      18.3k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      228
       åˆ†é’Ÿ
    </span>
  

  
  
    
      <!-- LeanCloud ç»Ÿè®¡æ–‡ç« PV -->
      <span id="leancloud-page-views-container" class="post-meta" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="leancloud-page-views"></span> æ¬¡
      </span>
    
  
</div>

            
          </div>

          
            <div class="scroll-down-bar">
              <i class="iconfont icon-arrowdown"></i>
            </div>
          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">æµ…è°ˆSpring Securityå®ç°RBACæ¨¡å‹</h1>
            
            <div class="markdown-body">
              <h1 id="æµ…è°ˆSpring-Securityå®ç°RBACæ¨¡å‹"><a href="#æµ…è°ˆSpring-Securityå®ç°RBACæ¨¡å‹" class="headerlink" title="æµ…è°ˆSpring Securityå®ç°RBACæ¨¡å‹"></a>æµ…è°ˆSpring Securityå®ç°RBACæ¨¡å‹</h1><blockquote>
<p>æœ¬æ–‡å°†ç»“åˆæˆ‘æ‰€åšçš„é¡¹ç›®æ¥æ¢è®¨ä¸€ä¸‹åˆ©ç”¨Spring Securityå®ç°RBACæ¨¡å‹çš„ç®€è¦æ­¥éª¤ä»¥åŠåˆ©ç”¨Spring Securityåšé¡¹ç›®æ—¶å€™å‘ç°ä¸æ”¹è¿›</p>
</blockquote>
<h2 id="ğŸ¤”ï¸ä»€ä¹ˆæ˜¯RBAC"><a href="#ğŸ¤”ï¸ä»€ä¹ˆæ˜¯RBAC" class="headerlink" title="ğŸ¤”ï¸ä»€ä¹ˆæ˜¯RBAC"></a>ğŸ¤”ï¸ä»€ä¹ˆæ˜¯RBAC</h2><p><strong>RBACæƒé™æ¨¡å‹ï¼ˆRole-Based Access Controlï¼‰</strong>å³ï¼šåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ã€‚æ¨¡å‹ä¸­æœ‰å‡ ä¸ªå…³é”®çš„æœ¯è¯­ï¼š</p>
<ul>
<li>ç”¨æˆ·ï¼šç³»ç»Ÿæ¥å£åŠåŠŸèƒ½è®¿é—®çš„æ“ä½œè€…</li>
<li>æƒé™ï¼šèƒ½å¤Ÿè®¿é—®æŸæ¥å£æˆ–è€…åšæŸæ“ä½œçš„æˆæƒèµ„æ ¼</li>
<li>è§’è‰²ï¼šå…·æœ‰ä¸€ç±»ç›¸åŒæ“ä½œæƒé™çš„ç”¨æˆ·çš„æ€»ç§°</li>
</ul>
<p><strong>RBACæƒé™æ¨¡å‹æ ¸å¿ƒæˆæƒé€»è¾‘å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li>æŸç”¨æˆ·æ˜¯ä»€ä¹ˆè§’è‰²ï¼Ÿ</li>
<li>æŸè§’è‰²å…·æœ‰ä»€ä¹ˆæƒé™ï¼Ÿ</li>
<li>é€šè¿‡è§’è‰²çš„æƒé™æ¨å¯¼ç”¨æˆ·çš„æƒé™</li>
</ul>
<p>å¯¹äºä¸€ä¸ªç”¨æˆ·æ¥è¯´ï¼Œå¦‚æœç›´æ¥å°†ç”¨æˆ·ä¸æƒé™å…³è”ï¼Œä¼šæœ‰ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>ç°åœ¨ç”¨æˆ·æ˜¯Luciferã€Melroseï¼Œä»¥åéšç€äººå‘˜å¢åŠ ï¼Œæ¯ä¸€ä¸ªç”¨æˆ·éƒ½éœ€è¦é‡æ–°æˆæƒ</li>
<li>æˆ–è€…Luciferã€Melroseç¦»èŒï¼Œéœ€è¦é’ˆå¯¹æ¯ä¸€ä¸ªç”¨æˆ·è¿›è¡Œå¤šç§æƒé™çš„å›æ”¶</li>
</ul>
<p><strong>å¦‚æœç»™æ¯ä¸ªç”¨æˆ·åˆ†é…ä¸€ä¸ªè§’è‰²å‘¢ï¼Ÿ</strong></p>
<ul>
<li>ä¸€ä¸ªç”¨æˆ·æœ‰ä¸€ä¸ªè§’è‰²</li>
<li>ä¸€ä¸ªè§’è‰²æœ‰å¤šä¸ªæ“ä½œï¼ˆèœå•ï¼‰æƒé™</li>
<li>ä¸€ä¸ªæ“ä½œæƒé™å¯ä»¥èµ‹äºˆå¤šä¸ªè§’è‰²</li>
</ul>
<p>ä½†æ˜¯åœ¨å®é™…çš„åº”ç”¨ç³»ç»Ÿä¸­ï¼Œ<strong>ä¸€ä¸ªç”¨æˆ·ä¸€ä¸ªè§’è‰²è¿œè¿œæ»¡è¶³ä¸äº†éœ€æ±‚</strong>ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›ä¸€ä¸ªç”¨æˆ·æ—¢æ‹…ä»»é”€å”®è§’è‰²ã€åˆæš‚æ—¶æ‹…ä»»å‰¯æ€»è§’è‰²ã€‚è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿä¸ºäº†å¢åŠ ç³»ç»Ÿè®¾è®¡çš„é€‚ç”¨æ€§ï¼Œæˆ‘ä»¬é€šå¸¸è®¾è®¡ï¼š</p>
<ul>
<li>ä¸€ä¸ªç”¨æˆ·æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªè§’è‰²</li>
<li>ä¸€ä¸ªè§’è‰²åŒ…å«å¤šä¸ªç”¨æˆ·</li>
<li>ä¸€ä¸ªè§’è‰²æœ‰å¤šç§æƒé™</li>
<li>ä¸€ä¸ªæƒé™å¯ä»¥èµ‹äºˆå¤šä¸ªè§’è‰²</li>
</ul>
<p>æ‰€ä»¥ï¼Œæ¯ä¸ªè§’è‰²çš„æƒé™å¯ä»¥å¯¹åº”ä¸ºè®¿é—®æŸä¸ªURLçš„æƒåˆ©ï¼Œå³æ‰€æœ‰ç³»ç»Ÿéƒ½æ˜¯ç”±ä¸€ä¸ªä¸ªçš„é¡µé¢ç»„æˆï¼Œé¡µé¢å†ç»„æˆæ¨¡å—ï¼Œç”¨æˆ·æ˜¯å¦èƒ½çœ‹åˆ°è¿™ä¸ªé¡µé¢çš„èœå•ã€æ˜¯å¦èƒ½è¿›å…¥è¿™ä¸ªé¡µé¢å°±ç§°ä¸ºé¡µé¢è®¿é—®æƒé™ã€‚</p>
<h2 id="âœï¸æƒé™è¡¨çš„è®¾è®¡"><a href="#âœï¸æƒé™è¡¨çš„è®¾è®¡" class="headerlink" title="âœï¸æƒé™è¡¨çš„è®¾è®¡"></a>âœï¸æƒé™è¡¨çš„è®¾è®¡</h2><p>åœ¨è®¾è®¡è¡¨çš„æ—¶å€™ï¼Œå¯ä»¥å¼•å…¥RBACæ¨¡å‹çš„æ€æƒ³</p>
<blockquote>
<p>ä¸‹é¢æ˜¯æˆ‘åšçš„ä¸€ä¸ªé¡¹ç›®ä¸­æ‰€è®¾è®¡çš„è¡¨ï¼Œé¡¹ç›®é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://github.com/Lucifer2u/xm-luciferpro">https://github.com/Lucifer2u/xm-luciferpro</a></p>
</blockquote>
<p><strong>æƒé™æ•°æ®åº“</strong>ä¸»è¦åŒ…å«äº†äº”å¼ è¡¨ï¼Œåˆ†åˆ«æ˜¯<strong>èµ„æºè¡¨ã€è§’è‰²è¡¨ã€ç”¨æˆ·è¡¨ã€èµ„æºè§’è‰²è¡¨ã€ç”¨æˆ·è§’è‰²è¡¨</strong>ï¼Œæ•°æ®åº“å…³ç³»æ¨¡å‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/p274.png" srcset="/img/loading.gif" lazyload alt="p274"></p>
<ul>
<li>hrè¡¨æ˜¯<strong>ç”¨æˆ·è¡¨</strong>ï¼Œå­˜æ”¾äº†ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯</li>
<li>roleæ˜¯<strong>è§’è‰²è¡¨</strong>ï¼Œnameå­—æ®µè¡¨ç¤ºè§’è‰²çš„è‹±æ–‡åç§°ï¼ŒæŒ‰ç…§SpringSecurityçš„è§„èŒƒï¼Œå°†ä»¥<code>ROLE_</code>å¼€å§‹ï¼ŒnameZhå­—æ®µè¡¨ç¤ºè§’è‰²çš„ä¸­æ–‡åç§°</li>
<li>menuè¡¨æ˜¯ä¸€ä¸ªèµ„æºè¡¨ï¼Œè¯¥è¡¨æ¶‰åŠåˆ°çš„å­—æ®µæœ‰ç‚¹å¤šï¼Œç”±äºæˆ‘çš„å‰ç«¯é‡‡ç”¨äº†Vueæ¥åšï¼Œå› æ­¤å½“ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åï¼Œç³»ç»Ÿå°†æ ¹æ®ç”¨æˆ·çš„è§’è‰²åŠ¨æ€åŠ è½½éœ€è¦çš„æ¨¡å—ï¼Œæ‰€æœ‰æ¨¡å—çš„ä¿¡æ¯å°†ä¿å­˜åœ¨menuè¡¨ä¸­ï¼Œmenuè¡¨ä¸­çš„<strong>pathã€componentã€iconClsã€keepAliveã€requireAuthç­‰å­—æ®µéƒ½æ˜¯Vue-Routerä¸­éœ€è¦çš„å­—æ®µ</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>menuä¸­çš„æ•°æ®åˆ°æ—¶å€™ä¼šä»¥jsonçš„å½¢å¼è¿”å›ç»™å‰ç«¯ï¼Œå†ç”±vueåŠ¨æ€æ›´æ–°routerï¼Œmenuä¸­è¿˜æœ‰ä¸€ä¸ªå­—æ®µurlï¼Œè¡¨ç¤ºä¸€ä¸ªurl patternï¼Œå³è·¯å¾„åŒ¹é…è§„åˆ™</strong>ï¼Œå‡è®¾æœ‰ä¸€ä¸ªè·¯å¾„åŒ¹é…è§„åˆ™ä¸º<code>/admin/**</code>,é‚£ä¹ˆå½“ç”¨æˆ·åœ¨å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ª<code>/admin/user</code>çš„è¯·æ±‚ï¼Œå°†è¢«<code>/admin/**</code>æ‹¦æˆªåˆ°ï¼Œç³»ç»Ÿå†å»æŸ¥çœ‹è¿™ä¸ªè§„åˆ™å¯¹åº”çš„è§’è‰²æ˜¯å“ªäº›ï¼Œç„¶åå†å»æŸ¥çœ‹è¯¥ç”¨æˆ·æ˜¯å¦å…·å¤‡ç›¸åº”çš„è§’è‰²ï¼Œè¿›è€Œåˆ¤æ–­è¯¥è¯·æ±‚æ˜¯å¦åˆæ³•</li>
</ul>
<p><strong>è¿™æ ·æ¯ä¸ªäººéƒ½æœ‰ç›¸åº”çš„è§’è‰²ï¼Œç„¶åéƒ½éœ€è¦æ ¹æ®å®é™…çš„è§’è‰²æƒé™å»è®¿é—®ä¸åŒçš„èœå•</strong></p>
<h2 id="ğŸ”’åŠ¨æ€å¤„ç†è§’è‰²å’Œèµ„æºçš„å…³ç³»"><a href="#ğŸ”’åŠ¨æ€å¤„ç†è§’è‰²å’Œèµ„æºçš„å…³ç³»" class="headerlink" title="ğŸ”’åŠ¨æ€å¤„ç†è§’è‰²å’Œèµ„æºçš„å…³ç³»"></a>ğŸ”’åŠ¨æ€å¤„ç†è§’è‰²å’Œèµ„æºçš„å…³ç³»</h2><p>è¦åˆ†æä»¥ä¸Šé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å›é¡¾Spring Securityçš„ç™»å½•æµç¨‹å¯¹æ•´ä½“æµç¨‹è¿›è¡Œäº†è§£æ‰èƒ½æ›´å¥½çš„æŠŠæ¡æ­¤èŠ‚çš„å†…å®¹</p>
<h3 id="Spring-Securityçš„ç™»å½•æµç¨‹"><a href="#Spring-Securityçš„ç™»å½•æµç¨‹" class="headerlink" title="Spring Securityçš„ç™»å½•æµç¨‹"></a>Spring Securityçš„ç™»å½•æµç¨‹</h3><p>Spring Securityçš„ç™»å½•éªŒè¯æµç¨‹æ ¸å¿ƒå°±æ˜¯è¿‡æ»¤å™¨é“¾ã€‚</p>
<p><img src="https://img.kancloud.cn/73/50/73506bb0f3f3834c410ba17353a8168e_1409x389.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<ul>
<li>è´¯ç©¿äºæ•´ä¸ªè¿‡æ»¤å™¨é“¾å§‹ç»ˆæœ‰ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡<code>SecurityContext</code>å’Œä¸€ä¸ª<code>Authentication</code>å¯¹è±¡ï¼ˆç™»å½•è®¤è¯çš„ä¸»ä½“ï¼‰</li>
<li>ä¸€æ—¦æŸä¸€ä¸ªè¯¥ä¸»ä½“é€šè¿‡å…¶ä¸­æŸä¸€ä¸ªè¿‡æ»¤å™¨çš„è®¤è¯ï¼Œ<code>Authentication</code>å¯¹è±¡ä¿¡æ¯è¢«å¡«å……ï¼Œæ¯”å¦‚ï¼š<code>isAuthenticated=true</code>è¡¨ç¤ºè¯¥ä¸»ä½“é€šè¿‡éªŒè¯ã€‚</li>
<li>å¦‚æœè¯¥ä¸»ä½“é€šè¿‡äº†æ‰€æœ‰çš„è¿‡æ»¤å™¨ï¼Œä»ç„¶æ²¡æœ‰è¢«è®¤è¯ï¼Œåœ¨æ•´ä¸ªè¿‡æ»¤å™¨é“¾çš„æœ€åæ–¹æœ‰ä¸€ä¸ª<code>FilterSecurityInterceptor</code>è¿‡æ»¤å™¨ï¼ˆè™½ç„¶å«Interceptorï¼Œä½†å®ƒæ˜¯åå‰¯å…¶å®çš„è¿‡æ»¤å™¨ï¼Œä¸æ˜¯æ‹¦æˆªå™¨ï¼‰ã€‚åˆ¤æ–­<code>Authentication</code>å¯¹è±¡çš„è®¤è¯çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰é€šè¿‡è®¤è¯åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œé€šè¿‡è®¤è¯åˆ™è®¿é—®åç«¯APIã€‚</li>
<li>ä¹‹åè¿›å…¥å“åº”é˜¶æ®µï¼Œ<code>FilterSecurityInterceptor</code>æŠ›å‡ºçš„å¼‚å¸¸è¢«<code>ExceptionTranslationFilter</code>å¯¹å¼‚å¸¸è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚æ¯”å¦‚ï¼šç”¨æˆ·åå¯†ç ç™»å½•å¼‚å¸¸ï¼Œä¼šè¢«å¼•å¯¼åˆ°ç™»å½•é¡µé‡æ–°ç™»é™†ã€‚</li>
<li>å¦‚æœæ˜¯ç™»é™†æˆåŠŸä¸”æ²¡æœ‰ä»»ä½•å¼‚å¸¸ï¼Œåœ¨è¯·æ±‚å“åº”ä¸­æœ€åä¸€ä¸ªè¿‡æ»¤å™¨<code>SecurityContextPersistenceFilter</code>ä¸­å°†<code>SecurityContext</code>æ”¾å…¥sessionã€‚ä¸‹æ¬¡å†è¿›è¡Œè¯·æ±‚çš„æ—¶å€™ï¼Œç›´æ¥ä»<code>SecurityContextPersistenceFilter</code>çš„sessionä¸­å–å‡ºè®¤è¯ä¿¡æ¯ã€‚ä»è€Œé¿å…å¤šæ¬¡é‡å¤è®¤è¯ã€‚ï¼ˆå¦‚æœæƒ³ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ï¼Œå¯ä»¥ä»è¿™é‡Œæ‹¿ï¼‰</li>
</ul>
<p>SpringSecurityæä¾›äº†å¤šç§ç™»å½•è®¤è¯çš„æ–¹å¼ï¼Œç”±å¤šç§Filterè¿‡æ»¤å™¨æ¥å®ç°ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li><code>BasicAuthenticationFilter</code>å®ç°çš„æ˜¯HttpBasicæ¨¡å¼çš„ç™»å½•è®¤è¯</li>
<li><code>UsernamePasswordAuthenticationFilter</code>å®ç°ç”¨æˆ·åå¯†ç çš„ç™»å½•è®¤è¯</li>
<li><code>RememberMeAuthenticationFilter</code>å®ç°ç™»å½•è®¤è¯çš„â€œè®°ä½æˆ‘â€çš„åŠŸèƒ½</li>
<li><code>SocialAuthenticationFilter</code>å®ç°ç¤¾äº¤åª’ä½“æ–¹å¼ç™»å½•è®¤è¯çš„å¤„ç†ï¼Œå¦‚ï¼šQQã€å¾®ä¿¡</li>
<li><code>Oauth2AuthenticationProcessingFilter</code>å’Œ<code>Oauth2ClientAuthenticationProcessingFilter</code>å®ç°Oauth2çš„é‰´æƒæ–¹å¼</li>
</ul>
<p>æ ¹æ®æˆ‘ä»¬ä¸åŒçš„éœ€æ±‚å®ç°åŠé…ç½®ï¼Œä¸åŒçš„Filterä¼šè¢«åŠ è½½åˆ°åº”ç”¨ä¸­ã€‚</p>
<h3 id="è¿‡æ»¤å™¨ç™»å½•éªŒè¯ç»†èŠ‚"><a href="#è¿‡æ»¤å™¨ç™»å½•éªŒè¯ç»†èŠ‚" class="headerlink" title="è¿‡æ»¤å™¨ç™»å½•éªŒè¯ç»†èŠ‚"></a>è¿‡æ»¤å™¨ç™»å½•éªŒè¯ç»†èŠ‚</h3><p><img src="https://img.kancloud.cn/ce/5e/ce5e1f7877e0155577d5511b95ea2100_660x441.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="æ„å»ºç™»å½•è®¤è¯ä¸»ä½“"><a href="#æ„å»ºç™»å½•è®¤è¯ä¸»ä½“" class="headerlink" title="æ„å»ºç™»å½•è®¤è¯ä¸»ä½“"></a><strong>æ„å»ºç™»å½•è®¤è¯ä¸»ä½“</strong></h4><p>å¦‚å›¾æ‰€ç¤ºï¼Œå½“ç”¨æˆ·ç™»é™†çš„æ—¶å€™é¦–å…ˆè¢«æŸä¸€ç§è®¤è¯æ–¹å¼çš„è¿‡æ»¤å™¨æ‹¦æˆªï¼ˆä»¥ç”¨æˆ·åå¯†ç ç™»å½•ä¸ºä¾‹ï¼‰ã€‚å¦‚ï¼š<code>UsernamePasswordAuthenticationFilter</code>ä¼šä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç åˆ›å»ºä¸€ä¸ªç™»å½•è®¤è¯å‡­è¯ï¼š<code>UsernamePasswordAuthenticationToken</code>ï¼Œè¿›è€Œè·å–ä¸€ä¸ª<code>Authentication</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä»£è¡¨èº«ä»½éªŒè¯çš„ä¸»ä½“ï¼Œè´¯ç©¿äºç”¨æˆ·è®¤è¯æµç¨‹å§‹ç»ˆã€‚</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210808215018034.png" srcset="/img/loading.gif" lazyload alt="image-20210808215018034"></p>
<h4 id="å¤šç§è®¤è¯æ–¹å¼çš„ç®¡ç†-ProviderManager"><a href="#å¤šç§è®¤è¯æ–¹å¼çš„ç®¡ç†-ProviderManager" class="headerlink" title="å¤šç§è®¤è¯æ–¹å¼çš„ç®¡ç† ProviderManager"></a><strong>å¤šç§è®¤è¯æ–¹å¼çš„ç®¡ç† ProviderManager</strong></h4><p>éšåä½¿ç”¨<code>AuthenticationManager</code> æ¥å£å¯¹ç™»å½•è®¤è¯ä¸»ä½“è¿›è¡Œauthenticateè®¤è¯ã€‚</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AuthenticationManager</span> </span>&#123;
    <span class="hljs-function">Authentication <span class="hljs-title">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException</span>;
&#125;</code></pre></div>

<p><code>ProviderManager</code>ç»§æ‰¿äº<code>AuthenticationManager</code>æ˜¯ç™»å½•éªŒè¯çš„æ ¸å¿ƒç±»ã€‚</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProviderManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthenticationManager</span>, <span class="hljs-title">MessageSourceAware</span>, <span class="hljs-title">InitializingBean</span> </span>&#123;
    â€¦â€¦
    <span class="hljs-keyword">private</span> List&lt;AuthenticationProvider&gt; providers;
    â€¦â€¦</code></pre></div>

<p><code>ProviderManager</code>ä¿ç®¡äº†å¤šä¸ª<code>AuthenticationProvider</code>ï¼Œæ¯ä¸€ç§ç™»å½•è®¤è¯æ–¹å¼éƒ½å¯ä»¥å°è¯•å¯¹ç™»å½•è®¤è¯ä¸»ä½“è¿›è¡Œè®¤è¯ã€‚åªè¦æœ‰ä¸€ç§æ–¹å¼è¢«è®¤è¯æˆåŠŸï¼Œ<code>Authentication</code>å¯¹è±¡å°±æˆä¸ºè¢«è®¤å¯çš„ä¸»ä½“ã€‚</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AuthenticationProvider</span> </span>&#123;
    <span class="hljs-function">Authentication <span class="hljs-title">authenticate</span><span class="hljs-params">(Authentication var1)</span> <span class="hljs-keyword">throws</span> AuthenticationException</span>;
    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">supports</span><span class="hljs-params">(Class&lt;?&gt; var1)</span></span>;
&#125;</code></pre></div>

<blockquote>
<p><code>RememberMeAuthenticationProvider</code>å®šä¹‰äº†â€œè®°ä½æˆ‘â€åŠŸèƒ½çš„ç™»å½•éªŒè¯é€»è¾‘</p>
<p><code>DaoAuthenticationProvider</code>åŠ è½½æ•°æ®åº“ç”¨æˆ·ä¿¡æ¯ï¼Œè¿›è¡Œç”¨æˆ·å¯†ç çš„ç™»å½•éªŒè¯</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210808220226118.png" srcset="/img/loading.gif" lazyload alt="image-20210808220226118"></p>
</blockquote>
<p>è€Œ<code>DaoAuthenticationProvider</code>å°±æ˜¯æˆ‘ä»¬å®ç°ç™»å½•çš„å…³é”®ï¼Œä¸‹é¢è¯¦ç»†åˆ†æ</p>
<h4 id="æ•°æ®åº“åŠ è½½ç”¨æˆ·ä¿¡æ¯-DaoAuthenticationProvider"><a href="#æ•°æ®åº“åŠ è½½ç”¨æˆ·ä¿¡æ¯-DaoAuthenticationProvider" class="headerlink" title="æ•°æ®åº“åŠ è½½ç”¨æˆ·ä¿¡æ¯ DaoAuthenticationProvider"></a><strong>æ•°æ®åº“åŠ è½½ç”¨æˆ·ä¿¡æ¯ DaoAuthenticationProvider</strong></h4><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DaoAuthenticationProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractUserDetailsAuthenticationProvider</span> </span></code></pre></div>

<p>ä»æºç ä¸­å‘ç°ï¼Œéœ€è¦ä»æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯çš„æ—¶å€™ï¼Œå³æˆ‘ä»¬éœ€è¦åŠ è½½ç”¨æˆ·ä¿¡æ¯è¿›è¡Œç™»å½•éªŒè¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å®ç°<code>UserDetailsService</code>æ¥å£ï¼Œé‡å†™<code>loadUserByUsername</code>æ–¹æ³•ï¼Œå‚æ•°æ˜¯ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·åã€‚è¿”å›å€¼æ˜¯<code>UserDetails</code></p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210808220514527.png" srcset="/img/loading.gif" lazyload alt="image-20210808220514527"></p>
<h4 id="SecurityContext"><a href="#SecurityContext" class="headerlink" title="SecurityContext"></a><strong>SecurityContext</strong></h4><p>å®Œæˆç™»å½•è®¤è¯ä¹‹åï¼Œå°†è®¤è¯å®Œæˆçš„<code>Authentication</code>å¯¹è±¡(authenticate: true, æœ‰æˆæƒåˆ—è¡¨authority list, å’Œusernameä¿¡æ¯)æ”¾å…¥<code>SecurityContext</code>ä¸Šä¸‹æ–‡é‡Œé¢ã€‚åç»­çš„è¯·æ±‚å°±ç›´æ¥ä»<code>SecurityContextFilter</code>ä¸­è·å¾—è®¤è¯ä¸»ä½“ï¼Œä»è€Œè®¿é—®èµ„æºã€‚</p>
<h3 id="ç»“åˆæºç è®²è§£ç™»å½•éªŒè¯æµç¨‹"><a href="#ç»“åˆæºç è®²è§£ç™»å½•éªŒè¯æµç¨‹" class="headerlink" title="ç»“åˆæºç è®²è§£ç™»å½•éªŒè¯æµç¨‹"></a>ç»“åˆæºç è®²è§£ç™»å½•éªŒè¯æµç¨‹</h3><p>æˆ‘ä»¬å°±ä»¥ç”¨æˆ·åã€å¯†ç ç™»å½•æ–¹å¼ä¸ºä¾‹è®²è§£ä¸€ä¸‹Spring Securityçš„ç™»å½•è®¤è¯æµç¨‹ã€‚</p>
<p><img src="https://img.kancloud.cn/96/5b/965b390cafd239b8f33c44496a99dd64_978x674.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="UsernamePasswordAuthenticationFilter"><a href="#UsernamePasswordAuthenticationFilter" class="headerlink" title="UsernamePasswordAuthenticationFilter"></a><strong>UsernamePasswordAuthenticationFilter</strong></h4><p>è¯¥è¿‡æ»¤å™¨å°è£…ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆç”¨æˆ·åã€å¯†ç ï¼‰ï¼Œå®šä¹‰ç™»å½•è¡¨å•æ•°æ®æ¥æ”¶ç›¸å…³çš„ä¿¡æ¯ã€‚å¦‚ï¼š</p>
<ul>
<li>é»˜è®¤çš„è¡¨å•ç”¨æˆ·åå¯†ç inputæ¡†nameæ˜¯usernameã€password</li>
<li>é»˜è®¤çš„å¤„ç†ç™»å½•è¯·æ±‚è·¯å¾„æ˜¯/loginã€ä½¿ç”¨POSTæ–¹æ³•</li>
</ul>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210808222037202.png" srcset="/img/loading.gif" lazyload alt="image-20210808222037202"></p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210808222219124.png" srcset="/img/loading.gif" lazyload alt="image-20210808222219124"></p>
<h4 id="AbstractAuthenticationProcessingFilterçš„doFilteræ–¹æ³•çš„éªŒè¯è¿‡ç¨‹"><a href="#AbstractAuthenticationProcessingFilterçš„doFilteræ–¹æ³•çš„éªŒè¯è¿‡ç¨‹" class="headerlink" title="AbstractAuthenticationProcessingFilterçš„doFilteræ–¹æ³•çš„éªŒè¯è¿‡ç¨‹"></a><strong>AbstractAuthenticationProcessingFilterçš„doFilteræ–¹æ³•çš„éªŒè¯è¿‡ç¨‹</strong></h4><p><code>UsernamePasswordAuthenticationFilter</code>ç»§æ‰¿è‡ªæŠ½è±¡ç±»<code>AbstractAuthenticationProcessingFilter</code>ï¼Œè¯¥æŠ½è±¡ç±»å®šä¹‰äº†éªŒè¯æˆåŠŸä¸éªŒè¯å¤±è´¥çš„å¤„ç†æ–¹æ³•ã€‚</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractAuthenticationProcessingFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericFilterBean</span></span>
<span class="hljs-class">      <span class="hljs-keyword">implements</span> <span class="hljs-title">ApplicationEventPublisherAware</span>, <span class="hljs-title">MessageSourceAware</span> </span></code></pre></div>

<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210808222657609.png" srcset="/img/loading.gif" lazyload alt="image-20210808222657609"></p>
<h4 id="éªŒè¯æˆåŠŸä¹‹åçš„Handlerå’ŒéªŒè¯å¤±è´¥ä¹‹åçš„handler"><a href="#éªŒè¯æˆåŠŸä¹‹åçš„Handlerå’ŒéªŒè¯å¤±è´¥ä¹‹åçš„handler" class="headerlink" title="éªŒè¯æˆåŠŸä¹‹åçš„Handlerå’ŒéªŒè¯å¤±è´¥ä¹‹åçš„handler"></a><strong>éªŒè¯æˆåŠŸä¹‹åçš„Handlerå’ŒéªŒè¯å¤±è´¥ä¹‹åçš„handler</strong></h4><p><code>AbstractAuthenticationProcessingFilter</code>ä¸­å®šä¹‰äº†éªŒè¯æˆåŠŸä¸éªŒè¯å¤±è´¥çš„å¤„ç†Handlerã€‚</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">private</span> AuthenticationSuccessHandler successHandler = <span class="hljs-keyword">new</span> SavedRequestAwareAuthenticationSuccessHandler();
<span class="hljs-keyword">private</span> AuthenticationFailureHandler failureHandler = <span class="hljs-keyword">new</span> SimpleUrlAuthenticationFailureHandler();</code></pre></div>

<p>ä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰éªŒè¯æˆåŠŸæˆ–å¤±è´¥çš„å¤„ç†æ–¹æ³•æ—¶ï¼Œè¦å»å®ç°<code>AuthenticationSuccessHandler</code>æˆ–<code>AuthenticationfailureHandler</code>æ¥å£</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210808222936948.png" srcset="/img/loading.gif" lazyload alt="image-20210808222936948"></p>
<h3 id="ğŸ‘å›åˆ°æ­£é¢˜"><a href="#ğŸ‘å›åˆ°æ­£é¢˜" class="headerlink" title="ğŸ‘å›åˆ°æ­£é¢˜"></a>ğŸ‘å›åˆ°æ­£é¢˜</h3><p>æˆ‘ä»¬çŸ¥é“å¦‚æœæˆ‘ä»¬ä¸å¸Œæœ›ç”¨æˆ·ã€è§’è‰²ã€æƒé™ä¿¡æ¯å†™æ­»åœ¨é…ç½®é‡Œé¢ã€‚æˆ‘ä»¬åº”è¯¥å®ç°<code>UserDetails</code>ä¸<code>UserDetailsService</code>æ¥å£ï¼Œä»è€Œä»æ•°æ®åº“æˆ–è€…å…¶ä»–çš„å­˜å‚¨ä¸ŠåŠ¨æ€çš„åŠ è½½è¿™äº›ä¿¡æ¯ã€‚</p>
<h4 id="UserDetailsä¸UserDetailsServiceæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ"><a href="#UserDetailsä¸UserDetailsServiceæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ" class="headerlink" title="UserDetailsä¸UserDetailsServiceæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ"></a><strong>UserDetailsä¸UserDetailsServiceæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</strong></h4><p><code>UserDetailsService</code>æ¥å£è¡¨è¾¾çš„æ˜¯å¦‚ä½•åŠ¨æ€åŠ è½½<code>UserDetails</code>æ•°æ®ã€‚</p>
<ul>
<li><code>UserDetailsService</code>æ¥å£æœ‰ä¸€ä¸ªæ–¹æ³•å«åš<code>loadUserByUsername</code>ï¼Œæˆ‘ä»¬å®ç°åŠ¨æ€åŠ è½½ç”¨æˆ·ã€è§’è‰²ã€æƒé™ä¿¡æ¯å°±æ˜¯é€šè¿‡å®ç°è¯¥æ–¹æ³•ã€‚å‡½æ•°è§åçŸ¥ä¹‰ï¼šé€šè¿‡ç”¨æˆ·ååŠ è½½ç”¨æˆ·ã€‚è¯¥æ–¹æ³•çš„è¿”å›å€¼å°±æ˜¯<code>UserDetails</code></li>
<li><code>UserDetails</code>å°±æ˜¯ç”¨æˆ·ä¿¡æ¯ï¼Œå³ï¼šç”¨æˆ·åã€å¯†ç ã€è¯¥ç”¨æˆ·æ‰€å…·æœ‰çš„æƒé™ã€‚</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>UserDetails</code>æ¥å£éƒ½æœ‰å“ªäº›æ–¹æ³•ã€‚</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserDetails</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Serializable</span> </span>&#123;
    <span class="hljs-comment">//è·å–ç”¨æˆ·çš„æƒé™é›†åˆ</span>
    Collection&lt;? extends GrantedAuthority&gt; getAuthorities();

    <span class="hljs-comment">//è·å–å¯†ç </span>
    <span class="hljs-function">String <span class="hljs-title">getPassword</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">//è·å–ç”¨æˆ·å</span>
    <span class="hljs-function">String <span class="hljs-title">getUsername</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">//è´¦å·æ˜¯å¦æ²¡è¿‡æœŸ</span>
    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isAccountNonExpired</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">//è´¦å·æ˜¯å¦æ²¡è¢«é”å®š</span>
    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isAccountNonLocked</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">//å¯†ç æ˜¯å¦æ²¡è¿‡æœŸ</span>
    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isCredentialsNonExpired</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">//è´¦æˆ·æ˜¯å¦å¯ç”¨</span>
    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isEnabled</span><span class="hljs-params">()</span></span>;
&#125;</code></pre></div>

<p>ç°åœ¨æˆ‘ä»¬æ˜ç™½äº†ï¼Œåªè¦æˆ‘ä»¬æŠŠè¿™äº›ä¿¡æ¯æä¾›ç»™Spring Securityï¼ŒSpring Securityå°±çŸ¥é“æ€ä¹ˆåšç™»å½•éªŒè¯äº†ï¼Œæ ¹æœ¬ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±å†™Controllerå®ç°ç™»å½•éªŒè¯é€»è¾‘ã€‚é‚£æˆ‘ä»¬æ€ä¹ˆæŠŠè¿™äº›ä¿¡æ¯æä¾›ç»™Spring Securityï¼Œç”¨çš„å°±æ˜¯ä¸‹é¢çš„æ¥å£æ–¹æ³•ã€‚</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserDetailsService</span> </span>&#123;
   <span class="hljs-function">UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException</span>;
&#125;</code></pre></div>

<p>ç°åœ¨æˆ‘ä»¬æ˜ç™½äº†ï¼Œåªè¦æˆ‘ä»¬æŠŠè¿™äº›ä¿¡æ¯æä¾›ç»™Spring Securityï¼ŒSpring Securityå°±çŸ¥é“æ€ä¹ˆåšç™»å½•éªŒè¯äº†ï¼Œæ ¹æœ¬ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±å†™Controllerå®ç°ç™»å½•éªŒè¯é€»è¾‘ã€‚é‚£æˆ‘ä»¬æ€ä¹ˆæŠŠè¿™äº›ä¿¡æ¯æä¾›ç»™Spring Securityï¼Œç”¨çš„å°±æ˜¯ä¸‹é¢çš„æ¥å£æ–¹æ³•ã€‚</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserDetailsService</span> </span>&#123;
   <span class="hljs-function">UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException</span>;
&#125;</code></pre></div>

<h4 id="å®ç°UserDetails-æ¥å£"><a href="#å®ç°UserDetails-æ¥å£" class="headerlink" title="å®ç°UserDetails æ¥å£"></a>å®ç°UserDetails æ¥å£</h4><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hr</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetails</span> </span>&#123;

  String password;  <span class="hljs-comment">//å¯†ç </span>
  String username;  <span class="hljs-comment">//ç”¨æˆ·å</span>
  <span class="hljs-keyword">boolean</span> accountNonExpired;   <span class="hljs-comment">//æ˜¯å¦æ²¡è¿‡æœŸ</span>
  <span class="hljs-keyword">boolean</span> accountNonLocked;   <span class="hljs-comment">//æ˜¯å¦æ²¡è¢«é”å®š</span>
  <span class="hljs-keyword">boolean</span> credentialsNonExpired;  <span class="hljs-comment">//å¯†ç æ˜¯å¦æ²¡è¿‡æœŸ</span>
  <span class="hljs-keyword">boolean</span> enabled;  <span class="hljs-comment">//è´¦å·æ˜¯å¦å¯ç”¨</span>
  Collection&lt;? extends GrantedAuthority&gt; authorities;  <span class="hljs-comment">//ç”¨æˆ·çš„æƒé™é›†åˆ</span>


  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPassword</span><span class="hljs-params">(String password)</span> </span>&#123;
    <span class="hljs-keyword">this</span>.password = password;
  &#125;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUsername</span><span class="hljs-params">(String username)</span> </span>&#123;
    <span class="hljs-keyword">this</span>.username = username;
  &#125;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAccountNonExpired</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> accountNonExpired)</span> </span>&#123;
    <span class="hljs-keyword">this</span>.accountNonExpired = accountNonExpired;
  &#125;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAccountNonLocked</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> accountNonLocked)</span> </span>&#123;
    <span class="hljs-keyword">this</span>.accountNonLocked = accountNonLocked;
  &#125;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCredentialsNonExpired</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> credentialsNonExpired)</span> </span>&#123;
    <span class="hljs-keyword">this</span>.credentialsNonExpired = credentialsNonExpired;
  &#125;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setEnabled</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> enabled)</span> </span>&#123;
    <span class="hljs-keyword">this</span>.enabled = enabled;
  &#125;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAuthorities</span><span class="hljs-params">(Collection&lt;? extends GrantedAuthority&gt; authorities)</span> </span>&#123;
    <span class="hljs-keyword">this</span>.authorities = authorities;
  &#125;

  <span class="hljs-meta">@Override</span>
  <span class="hljs-keyword">public</span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;
    <span class="hljs-keyword">return</span> authorities;
  &#125;

  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPassword</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-keyword">return</span> password;
  &#125;

  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUsername</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-keyword">return</span> username;
  &#125;

  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isAccountNonExpired</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;   <span class="hljs-comment">//æš‚æ—¶æœªç”¨åˆ°ï¼Œç›´æ¥è¿”å›trueï¼Œè¡¨ç¤ºè´¦æˆ·æœªè¿‡æœŸ</span>
  &#125;

  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isAccountNonLocked</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;   <span class="hljs-comment">//æš‚æ—¶æœªç”¨åˆ°ï¼Œç›´æ¥è¿”å›trueï¼Œè¡¨ç¤ºè´¦æˆ·æœªè¢«é”å®š</span>
  &#125;

  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isCredentialsNonExpired</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;   <span class="hljs-comment">//æš‚æ—¶æœªç”¨åˆ°ï¼Œç›´æ¥è¿”å›trueï¼Œè¡¨ç¤ºè´¦æˆ·å¯†ç æœªè¿‡æœŸ</span>
  &#125;

  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isEnabled</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-keyword">return</span> enabled;
  &#125;
&#125;</code></pre></div>

<p>æˆ‘ä»¬å°±æ˜¯å†™äº†ä¸€ä¸ªé€‚åº”äº<code>UserDetails</code>çš„Beanç±»ï¼Œæ‰€è°“çš„ <code>UserDetails</code>æ¥å£å®ç°å°±æ˜¯ä¸€äº›getæ–¹æ³•ã€‚</p>
<ul>
<li>getæ–¹æ³•ç”±Spring Securityè°ƒç”¨ï¼Œè·å–è®¤è¯åŠé‰´æƒçš„æ•°æ®</li>
<li>æˆ‘ä»¬é€šè¿‡setæ–¹æ³•æˆ–æ„é€ å‡½æ•°ä¸º Spring Security æä¾›<code>UserDetails</code>æ•°æ®ï¼ˆä»æ•°æ®åº“æŸ¥è¯¢ï¼‰ã€‚</li>
<li><strong>å½“enabledçš„å€¼ä¸ºfalseçš„æ—¶å€™ï¼ŒSpring Security ä¼šè‡ªåŠ¨çš„ç¦ç”¨è¯¥ç”¨æˆ·ï¼Œç¦æ­¢è¯¥ç”¨æˆ·è¿›è¡Œç³»ç»Ÿç™»å½•ã€‚</strong></li>
<li>é€šå¸¸æ•°æ®åº“è¡¨sys_userå­—æ®µè¦å’ŒHr å±æ€§ä¸€ä¸€å¯¹åº”ï¼Œæ¯”å¦‚usernameã€passwordã€enabledã€‚</li>
</ul>
<blockquote>
<p>ç›®å‰æ•°æ®åº“è¡¨é‡Œé¢æ²¡æœ‰å®šä¹‰accountNonExpiredã€accountNonLockedã€credentialsNonExpiredè¿™ä¸‰ä¸ªå­—æ®µï¼Œæˆ‘ä¸€èˆ¬ä¸å–œæ¬¢æè¿™ä¹ˆå¤šå­—æ®µæ§åˆ¶ç”¨æˆ·çš„ç™»å½•è®¤è¯è¡Œä¸ºï¼Œç¬”è€…è§‰å¾—ç®€å•ç‚¹å¥½ï¼Œä¸€ä¸ªenabledå­—æ®µå°±å¤Ÿäº†ã€‚æ‰€ä»¥è¿™ä¸‰ä¸ªæˆå‘˜å˜é‡å¯¹åº”çš„getæ–¹æ³•ï¼Œç›´æ¥è¿”å›trueå³å¯ã€‚</p>
</blockquote>
<p>å¦å¤–ï¼Œ<strong>UserDetailsä¸­è¿˜æœ‰ä¸€ä¸ªæ–¹æ³•å«åšgetAuthoritiesï¼Œè¯¥æ–¹æ³•ç”¨æ¥è·å–å½“å‰ç”¨æˆ·æ‰€å…·æœ‰çš„è§’è‰²</strong>ï¼Œæˆ‘çš„è§’è‰²ä¸­æœ‰ä¸€ä¸ªroleså±æ€§ï¼ˆå³roleè¡¨ï¼‰ç”¨æ¥æè¿°å½“å‰ç”¨æˆ·çš„è§’è‰²ï¼Œå› æ­¤æˆ‘çš„getAuthoritiesæ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;
    List&lt;GrantedAuthority&gt; authorities = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    <span class="hljs-keyword">for</span> (Role role : roles) &#123;
        authorities.add(<span class="hljs-keyword">new</span> SimpleGrantedAuthority(role.getName()));
    &#125;
    <span class="hljs-keyword">return</span> authorities;
&#125;</code></pre></div>

<p>å³ç›´æ¥ä»<code>roles</code>ä¸­è·å–å½“å‰ç”¨æˆ·æ‰€å…·æœ‰çš„è§’è‰²ï¼Œæ„é€ <code>SimpleGrantedAuthority</code>ç„¶åè¿”å›å³å¯</p>
<p><code>SimpleGrantedAuthority</code>ç®€å•æ¥è¯´å°±æ˜¯å­˜å‚¨æˆäºˆ<code>Authentication</code>å¯¹è±¡çš„æƒé™çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚</p>
<h4 id="SimpleGrantedAuthority"><a href="#SimpleGrantedAuthority" class="headerlink" title="SimpleGrantedAuthority"></a><strong>SimpleGrantedAuthority</strong></h4><p>åœ¨Securityä¸­ï¼Œè§’è‰²å’Œæƒé™å…±ç”¨<code>GrantedAuthority</code>æ¥å£ï¼Œå”¯ä¸€çš„ä¸åŒè§’è‰²å°±æ˜¯å¤šäº†ä¸ªå‰ç¼€â€ROLE_â€ï¼Œè€Œä¸”å®ƒæ²¡æœ‰Shiroçš„é‚£ç§ä»å±å…³ç³»ï¼Œå³ä¸€ä¸ªè§’è‰²åŒ…å«å“ªäº›æƒé™ç­‰ç­‰ã€‚åœ¨Securityçœ‹æ¥è§’è‰²å’Œæƒé™æ—¶ä¸€æ ·çš„ï¼Œå®ƒè®¤è¯çš„æ—¶å€™ï¼ŒæŠŠæ‰€æœ‰æƒé™ï¼ˆè§’è‰²ã€æƒé™ï¼‰éƒ½å–å‡ºæ¥ï¼Œè€Œä¸æ˜¯åˆ†å¼€éªŒè¯ã€‚</p>
<p>æ‰€ä»¥ï¼Œåœ¨Securityæä¾›çš„<code>UserDetailsService</code>é»˜è®¤å®ç°<code>JdbcDaoImpl</code>ä¸­ï¼Œè§’è‰²å’Œæƒé™éƒ½å­˜å‚¨åœ¨auhtoritiesè¡¨ä¸­ã€‚è€Œä¸æ˜¯åƒShiroé‚£æ ·ï¼Œè§’è‰²æœ‰ä¸ªrolesè¡¨ï¼Œæƒé™æœ‰ä¸ªpermissionsè¡¨ã€‚ä»¥åŠç›¸å…³çš„ç®¡ç†è¡¨ç­‰ç­‰ã€‚</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleGrantedAuthority</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">GrantedAuthority</span> </span>&#123;

   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = SpringSecurityCoreVersion.SERIAL_VERSION_UID;

   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String role;

   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SimpleGrantedAuthority</span><span class="hljs-params">(String role)</span> </span>&#123;
      Assert.hasText(role, <span class="hljs-string">&quot;A granted authority textual representation is required&quot;</span>);
      <span class="hljs-keyword">this</span>.role = role;
   &#125;

   <span class="hljs-meta">@Override</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getAuthority</span><span class="hljs-params">()</span> </span>&#123;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.role;
   &#125;

   <span class="hljs-meta">@Override</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object obj)</span> </span>&#123;
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> == obj) &#123;
         <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
      &#125;
      <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> SimpleGrantedAuthority) &#123;
         <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.role.equals(((SimpleGrantedAuthority) obj).role);
      &#125;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
   &#125;

   <span class="hljs-meta">@Override</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.role.hashCode();
   &#125;

   <span class="hljs-meta">@Override</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.role;
   &#125;

&#125;</code></pre></div>

<p>æ³¨æ„ï¼Œåœ¨æ„å»º<code>SimpleGrantedAuthority</code>å¯¹è±¡çš„æ—¶å€™ï¼Œå®ƒæ²¡æœ‰æ·»åŠ ä»»ä½•å‰ç¼€ã€‚æ‰€ä»¥è¡¨ç¤ºâ€è§’è‰²â€çš„æƒé™ï¼Œåœ¨æ•°æ®åº“ä¸­å°±å¸¦æœ‰â€ROLE_â€å‰ç¼€äº†ã€‚æ‰€ä»¥<code>authorities</code>è¡¨ä¸­çš„è§†å›¾å¯èƒ½æ˜¯è¿™æ ·çš„ã€‚</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210809220537827.png" srcset="/img/loading.gif" lazyload alt="image-20210809220537827"></p>
<p><strong>è§’è‰²å’Œæƒé™èƒ½å¦åˆ†å¼€å­˜å‚¨ï¼Ÿè§’è‰²èƒ½ä¸èƒ½ä¸å¸¦â€ROLE_â€å‰ç¼€</strong></p>
<p>å½“ç„¶å¯ä»¥åˆ†å¼€å­˜å‚¨ï¼Œä½ å¯ä»¥å®šä¹‰ä¸¤å¼ è¡¨ï¼Œä¸€å¼ å­˜è§’è‰²ï¼Œä¸€å¼ å­˜æƒé™ã€‚ä½†æ˜¯ä½ è‡ªå®šä¹‰<code>UserDetailsService</code>çš„æ—¶å€™ï¼Œéœ€è¦ä¿è¯æŠŠè¿™ä¸¤å¼ è¡¨çš„æ•°æ®éƒ½å–å‡ºæ¥ï¼Œæ”¾åˆ°<code>UserDails</code>çš„æƒé™é›†åˆä¸­ã€‚å½“ç„¶ä½ æ•°æ®åº“ä¸­å­˜å‚¨çš„è§’è‰²ä¹Ÿå¯ä»¥ä¸å¸¦â€ROLE_â€å‰ç¼€ï¼Œå°±åƒè¿™æ ·ã€‚</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210809220551920.png" srcset="/img/loading.gif" lazyload alt="image-20210809220551920"></p>
<p>ä½†æ˜¯å‰é¢è¯´åˆ°äº†ï¼ŒSecurityæ‰ä¸ç®¡ä½ æ˜¯è§’è‰²ï¼Œè¿˜æ˜¯æƒé™ã€‚å®ƒåªæ¯”å¯¹å­—ç¬¦ä¸²ã€‚</p>
<p>æ¯”å¦‚å®ƒæœ‰ä¸ªè¡¨è¾¾å¼hasRole(â€œADMINâ€)ã€‚é‚£å®ƒå®é™…ä¸ŠæŸ¥è¯¢çš„æ˜¯ç”¨æˆ·æƒé™é›†åˆä¸­æ˜¯å¦å­˜åœ¨å­—ç¬¦ä¸²â€ROLE_ADMINâ€ã€‚å¦‚æœä½ ä»è§’è‰²è¡¨ä¸­å–å‡ºç”¨æˆ·æ‰€æ‹¥æœ‰çš„è§’è‰²æ—¶ä¸åŠ ä¸Šâ€ROLE_â€å‰ç¼€ï¼Œé‚£éªŒè¯çš„æ—¶å€™å°±åŒ¹é…ä¸ä¸Šäº†ã€‚</p>
<p>æ‰€ä»¥è§’è‰²ä¿¡æ¯å­˜å‚¨çš„æ—¶å€™å¯ä»¥æ²¡æœ‰â€ROLE_â€å‰ç¼€ï¼Œä½†æ˜¯åŒ…è£…æˆ<code>GrantedAuthority</code>å¯¹è±¡çš„æ—¶å€™å¿…é¡»è¦æœ‰ã€‚</p>
<h4 id="è‡ªå®šä¹‰Service"><a href="#è‡ªå®šä¹‰Service" class="headerlink" title="è‡ªå®šä¹‰Service"></a>è‡ªå®šä¹‰Service</h4><p>åˆ›å»ºå¥½<code>Hr</code>ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åˆ›å»º<code>HrService</code>ï¼Œç”¨æ¥æ‰§è¡Œç™»å½•ç­‰æ“ä½œï¼Œ**<code>HrService</code>éœ€è¦å®ç°<code>UserDetailsService</code>æ¥å£ï¼Œå¦‚ä¸‹ï¼š**</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HrService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsService</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    HrMapper hrMapper;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;

        Hr hr = hrMapper.loadUserByUsername(username);
        <span class="hljs-keyword">if</span> (hr == <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UsernameNotFoundException(<span class="hljs-string">&quot;ç”¨æˆ·åä¸å­˜åœ¨ï¼&quot;</span>);
        &#125;

        hr.setRoles(hrMapper.getHrRolesById(hr.getId()));

        <span class="hljs-keyword">return</span> hr;
    &#125;</code></pre></div>

<p>è¿™é‡Œæœ€ä¸»è¦æ˜¯å®ç°äº†**<code>UserDetailsService</code>æ¥å£ä¸­çš„<code>loadUserByUsername</code>æ–¹æ³•**ï¼Œåœ¨æ‰§è¡Œç™»å½•çš„è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•å°†æ ¹æ®ç”¨æˆ·åå»æŸ¥æ‰¾ç”¨æˆ·ï¼Œå¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡º<code>UsernameNotFoundException</code>å¼‚å¸¸ï¼Œå¦åˆ™ç›´æ¥å°†æŸ¥åˆ°çš„<code>Hr</code>è¿”å›ã€‚<code>HrMapper</code>ç”¨æ¥æ‰§è¡Œæ•°æ®åº“çš„æŸ¥è¯¢æ“ä½œã€‚</p>
<h2 id="ğŸ”‘æ ¹æ®è¯·æ±‚åœ°å€è·å–è§’è‰²"><a href="#ğŸ”‘æ ¹æ®è¯·æ±‚åœ°å€è·å–è§’è‰²" class="headerlink" title="ğŸ”‘æ ¹æ®è¯·æ±‚åœ°å€è·å–è§’è‰²"></a>ğŸ”‘æ ¹æ®è¯·æ±‚åœ°å€è·å–è§’è‰²</h2><p>å…ˆå¼•å…¥ä¸€ä¸‹<code>SecurityMetadataSource</code>çš„æ¦‚å¿µï¼š</p>
<h3 id="SecurityMetadataSource"><a href="#SecurityMetadataSource" class="headerlink" title="SecurityMetadataSource"></a>SecurityMetadataSource</h3><p><code>SecurityMetadataSource</code>æ˜¯<code>Spring Security</code>çš„ä¸€ä¸ªæ¦‚å¿µæ¨¡å‹æ¥å£ã€‚ç”¨äºè¡¨ç¤ºå¯¹å—æƒé™ä¿æŠ¤çš„â€å®‰å…¨å¯¹è±¡â€çš„æƒé™è®¾ç½®ä¿¡æ¯ã€‚ä¸€ä¸ªè¯¥ç±»å¯¹è±¡å¯ä»¥è¢«ç†è§£æˆä¸€ä¸ªæ˜ å°„è¡¨ï¼Œæ˜ å°„è¡¨ä¸­çš„æ¯ä¸€é¡¹åŒ…å«å¦‚ä¸‹ä¿¡æ¯ :</p>
<ul>
<li>å®‰å…¨å¯¹è±¡</li>
<li>å®‰å…¨å¯¹è±¡æ‰€éœ€æƒé™ä¿¡æ¯</li>
</ul>
<p>å›´ç»•è¯¥æ˜ å°„è¡¨ï¼Œ<code>SecurityMetadataSource</code> å®šä¹‰äº†å¦‚ä¸‹æ–¹æ³• :</p>
<ul>
<li><code>Collection&lt;ConfigAttribute&gt; getAttributes(Object object) throws IllegalArgumentException;</code></li>
</ul>
<blockquote>
<p>è·å–æŸä¸ªå—ä¿æŠ¤çš„å®‰å…¨å¯¹è±¡<code>object</code>çš„æ‰€éœ€è¦çš„æƒé™ä¿¡æ¯,æ˜¯ä¸€ç»„<code>ConfigAttribute</code>å¯¹è±¡çš„é›†åˆï¼Œå¦‚æœè¯¥å®‰å…¨å¯¹è±¡<code>object</code>ä¸è¢«å½“å‰<code>SecurityMetadataSource</code>å¯¹è±¡æ”¯æŒ,åˆ™æŠ›å‡ºå¼‚å¸¸<code>IllegalArgumentException</code>ã€‚<br>è¯¥æ–¹æ³•é€šå¸¸é…åˆ<code>boolean supports(Class&lt;?&gt; clazz)</code>ä¸€èµ·ä½¿ç”¨ï¼Œå…ˆä½¿ç”¨<code>boolean supports(Class&lt;?&gt; clazz)</code>ç¡®ä¿å®‰å…¨å¯¹è±¡èƒ½è¢«å½“å‰<code>SecurityMetadataSource</code>æ”¯æŒï¼Œç„¶åå†è°ƒç”¨è¯¥æ–¹æ³•ã€‚</p>
</blockquote>
<ul>
<li><code>Collection&lt;ConfigAttribute&gt; getAllConfigAttributes()</code></li>
</ul>
<blockquote>
<p>è·å–è¯¥<code>SecurityMetadataSource</code>å¯¹è±¡ä¸­ä¿å­˜çš„é’ˆå¯¹æ‰€æœ‰å®‰å…¨å¯¹è±¡çš„æƒé™ä¿¡æ¯çš„é›†åˆã€‚è¯¥æ–¹æ³•çš„ä¸»è¦ç›®çš„æ˜¯è¢«<code>AbstractSecurityInterceptor</code>ç”¨äºå¯åŠ¨æ—¶æ ¡éªŒæ¯ä¸ª<code>ConfigAttribute</code>å¯¹è±¡ã€‚</p>
</blockquote>
<ul>
<li><code>boolean supports(Class&lt;?&gt; clazz)</code></li>
</ul>
<blockquote>
<p>è¿™é‡Œ<code>clazz</code>è¡¨ç¤ºå®‰å…¨å¯¹è±¡çš„ç±»å‹ï¼Œè¯¥æ–¹æ³•ç”¨äºå‘ŠçŸ¥è°ƒç”¨è€…å½“å‰<code>SecurityMetadataSource</code>æ˜¯å¦æ”¯æŒæ­¤ç±»å®‰å…¨å¯¹è±¡ï¼Œåªæœ‰æ”¯æŒçš„æ—¶å€™ï¼Œæ‰èƒ½å¯¹è¿™ç±»å®‰å…¨å¯¹è±¡è°ƒç”¨<code>getAttributes</code>æ–¹æ³•ã€‚</p>
</blockquote>
<p><strong>ç»§æ‰¿å…³ç³»</strong></p>
<p><img src="https://img-blog.csdnimg.cn/20190623090023883.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZHlfemhhbmcyMDA3,size_16,color_FFFFFF,t_70" srcset="/img/loading.gif" lazyload alt="SecurityMetadataSource"><br><code>Spring Security</code>å¯¹<code>SecurityMetadataSource</code>æä¾›äº†ä¸¤ä¸ªå­æ¥å£ :</p>
<ul>
<li><p>```<br>MethodSecurityMetadataSource</p>
<div class="hljs code-wrapper"><pre><code class="hljs autohotkey">
  &gt; ç”±`Spring Security Core`å®šä¹‰ï¼Œç”¨äºè¡¨ç¤ºå®‰å…¨å¯¹è±¡æ˜¯æ–¹æ³•è°ƒç”¨(`MethodInvocation`)çš„å®‰å…¨å…ƒæ•°æ®æºã€‚

- ```
  FilterInvocationSecurityMetadataSource</code></pre></div>

<blockquote>
<p>ç”±<code>Spring Security Web</code>å®šä¹‰ï¼Œç”¨äºè¡¨ç¤ºå®‰å…¨å¯¹è±¡æ˜¯<code>Web</code>è¯·æ±‚(<code>FilterInvocation</code>)çš„å®‰å…¨å…ƒæ•°æ®æºã€‚</p>
</blockquote>
</li>
</ul>
<h3 id="FilterInvocationSecurityMetadataSource"><a href="#FilterInvocationSecurityMetadataSource" class="headerlink" title="FilterInvocationSecurityMetadataSource"></a>FilterInvocationSecurityMetadataSource</h3><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¦‚æœéœ€è¦è‡ªå®šä¹‰æƒé™æ‹¦æˆªï¼Œåˆ™éœ€è¦æ¶‰åŠåˆ°<code>FilterInvocationSecurityMetadataSource</code>è¿™ä¸ªæ¥å£äº†ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸ªå‘çˆ¹çš„åœ°æ–¹ã€‚å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œä½†æ˜¯å·²ç»è®¾ç½®äº†æ‹¦æˆªç™½åå•çš„URLï¼Œä»ç„¶ä¼šè¿›å…¥åˆ°æƒé™éªŒè¯é‡Œé¢æ¥ã€‚èµ·åˆï¼Œæˆ‘ä»¥ä¸ºä¸ä¼šè¿›æ¥ï¼Œä½†åæ¥è·Ÿè¸ªæºä»£ç å‘ç°ï¼Œè¿˜æ˜¯ä¼šè¿›æ¥ã€‚åªæ˜¯æ­¤æ—¶çš„èº«ä»½æ˜¯ä¸€ä¸ªåŒ¿åç”¨æˆ·ã€‚å…¶é»˜è®¤çš„å®ç°ä¸º<code>DefaultFilterInvocationSecurityMetadataSource</code></p>
<p>spring securityçš„è®¤è¯å’Œæƒé™æµç¨‹ï¼Œå¤§æ¦‚å°±æ˜¯æœ‰å¤šä¸ªè¿‡æ»¤å™¨ï¼Œä¸€æ­¥æ­¥è°ƒç”¨filter chainã€‚å®ƒçš„èº«ä»½è®¤è¯å…¶å®æ˜¯å§‹äºè®¿é—®èµ„æºå¼€å§‹ã€‚å¦‚æœä¸€ä¸ªç”¨æˆ·å·²ç™»å½•ï¼Œé‚£ä¹ˆè®¿é—®å—ä¿æŠ¤çš„èµ„æºï¼Œåˆ™ä¼šæ ¡éªŒè¯¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®ã€‚å¦‚æœæ²¡æœ‰æƒé™ï¼Œåˆ™ä¼šè°ƒç”¨æƒé™æ‹’ç»çš„å¤„ç†å™¨è¿›è¡Œå¤„ç†ã€‚å¦‚æœæœ‰æƒé™ï¼Œåˆ™èƒ½é¡ºåˆ©è®¿é—®è¯¥èµ„æºï¼›</p>
<p>ä¸€ä¸ªç”¨æˆ·æœªç™»å½•æƒ…å†µä¸‹ï¼Œä¹Ÿå³åŒ¿åç”¨æˆ·ï¼Œè®¿é—®å—ä¿æŠ¤çš„èµ„æºæ—¶ï¼Œspring securityä¼šé¦–å…ˆæ£€æŸ¥è¯¥èµ„æºæ˜¯å¦éœ€è¦æƒé™ï¼Œå¦‚æœéœ€è¦æƒé™ï¼Œç„¶åå†æ£€æŸ¥ï¼Œè¯¥èµ„æºæ˜¯å¦æ˜¯ç™½åå•é‡Œé¢ã€‚å¦‚æœæ˜¯ç™½åå•ï¼Œä¹Ÿèƒ½æ­£å¸¸è®¿é—®ã€‚å¦‚æœæ˜¯å—ä¿æŠ¤çš„èµ„æºï¼Œåˆ™ä¼šæç¤ºè¯¥ç”¨æˆ·éœ€è¦ç™»å½•ã€‚</p>
<p>ä¹Ÿå³ï¼Œå½“ä¸€ä¸ªåŒ¿åç”¨æˆ·ï¼Œè®¿é—®å—ä¿æŠ¤çš„èµ„æºæ—¶ï¼Œå°±ä¼šæç¤ºè¯¥ç”¨æˆ·éœ€è¦ç™»å½•ã€‚</p>
<p>æ‰€ä»¥è¯´ï¼Œåœ¨<code>FilterInvocationSecurityMetadataSource</code>ä¸­é»˜è®¤çš„å®ç°ç±»<code>DefaultFilterInvocationSecurityMetadataSource</code><strong>çš„ä¸»è¦åŠŸèƒ½å°±æ˜¯é€šè¿‡å½“å‰çš„è¯·æ±‚åœ°å€ï¼Œè·å–è¯¥åœ°å€éœ€è¦çš„ç”¨æˆ·è§’è‰²</strong></p>
<p>æˆ‘ä»¬å¯ä»¥å‚è€ƒè¿™ä¸ªå®ç°ç±»ï¼Œè‡ªå·±ä¹Ÿå®šä¹‰ä¸€ä¸ª<code>FilterInvocationSecurityMetadataSource</code>ï¼Œå¦‚ä¸‹</p>
<p>ä¸»è¦å·¥ä½œä¸ºï¼š</p>
<ul>
<li>ä»æ•°æ®æºä¸­åŠ è½½<code>ConfigAttribute</code>åˆ°<code>SecurityMetadataSource</code>èµ„æºå™¨ä¸­</li>
<li>é‡å†™<code>getAttributes()</code>åŠ è½½<code>ConfigAttribute</code>ä¸º<code>AccessDecisionManager.decide()</code>æˆæƒå†³ç­–åšå‡†å¤‡ã€‚</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomFilterInvocationSecurityMetadataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FilterInvocationSecurityMetadataSource</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    MenuService menuService;
    <span class="hljs-comment">//è·¯å¾„åŒ¹é…</span>
    AntPathMatcher antPathMatcher = <span class="hljs-keyword">new</span> AntPathMatcher();
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="hljs-title">getAttributes</span><span class="hljs-params">(Object object)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException </span>&#123;
        <span class="hljs-comment">//è·å–è¯·æ±‚çš„åœ°å€</span>
        String requestUrl = ((FilterInvocation) object).getRequestUrl();
        List&lt;Menu&gt; menus = menuService.getAllMenusWithRole();
        <span class="hljs-keyword">for</span> (Menu menu : menus) &#123;
            <span class="hljs-keyword">if</span> (antPathMatcher.match(menu.getUrl(), requestUrl)) &#123;
                List&lt;Role&gt; roles = menu.getRoles();

                String[] str = <span class="hljs-keyword">new</span> String[roles.size()];
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; roles.size(); i++) &#123;
                    str[i] = roles.get(i).getName();
                &#125;
                <span class="hljs-keyword">return</span> SecurityConfig.createList(str);
            &#125;
        &#125;
        <span class="hljs-comment">//æ²¡æœ‰åŒ¹é…ä¸Šçš„èµ„æºï¼Œéƒ½æ˜¯ç™»å½•è®¿é—®</span>
        <span class="hljs-keyword">return</span> SecurityConfig.createList(<span class="hljs-string">&quot;ROLE_LOGIN&quot;</span>);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="hljs-title">getAllConfigAttributes</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">supports</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    &#125;
&#125;</code></pre></div>

<ul>
<li>ä¸€å¼€å§‹æ³¨å…¥äº†<code>MenuService</code>ï¼Œ<code>MenuService</code>çš„ä½œç”¨æ˜¯ç”¨æ¥æŸ¥è¯¢æ•°æ®åº“ä¸­url patternå’Œroleçš„å¯¹åº”å…³ç³»ï¼ˆ <code>menuService.getAllMenu()</code>åé¢å¯ç”¨ç¼“å­˜æ¥å­˜ï¼‰ï¼ŒæŸ¥è¯¢ç»“æœæ˜¯ä¸€ä¸ªListé›†åˆï¼Œé›†åˆä¸­æ˜¯Menuç±»ï¼Œ<strong>Menuç±»æœ‰ä¸¤ä¸ªæ ¸å¿ƒå±æ€§ï¼Œä¸€ä¸ªæ˜¯url patternï¼Œå³åŒ¹é…è§„åˆ™(æ¯”å¦‚<code>/admin/**</code>)ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯Listï¼Œå³è¿™ç§è§„åˆ™çš„è·¯å¾„éœ€è¦å“ªäº›è§’è‰²æ‰èƒ½è®¿é—®ã€‚</strong></li>
<li>æˆ‘ä»¬å¯ä»¥ä»<code>getAttributes(Object o)</code>æ–¹æ³•çš„å‚æ•°oä¸­æå–å‡ºå½“å‰çš„è¯·æ±‚urlï¼Œç„¶åå°†è¿™ä¸ªè¯·æ±‚urlå’Œæ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥çš„æ‰€æœ‰url patternä¸€ä¸€å¯¹ç…§ï¼Œçœ‹ç¬¦åˆå“ªä¸€ä¸ªurl patternï¼Œç„¶åå°±è·å–åˆ°è¯¥url patternæ‰€å¯¹åº”çš„è§’è‰²ï¼Œå½“ç„¶è¿™ä¸ªè§’è‰²å¯èƒ½æœ‰å¤šä¸ªï¼Œæ‰€ä»¥éå†è§’è‰²ï¼Œæœ€ååˆ©ç”¨<code>SecurityConfig.createList</code>æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªè§’è‰²é›†åˆã€‚</li>
<li>ç¬¬äºŒæ­¥çš„æ“ä½œä¸­ï¼Œæ¶‰åŠåˆ°ä¸€ä¸ªä¼˜å…ˆçº§é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘çš„åœ°å€æ˜¯<code>/employee/basic/hello</code>,è¿™ä¸ªåœ°å€æ—¢èƒ½è¢«<code>/employee/**</code>åŒ¹é…ï¼Œä¹Ÿèƒ½è¢«<code>/employee/basic/**</code>åŒ¹é…ï¼Œè¿™å°±è¦æ±‚æˆ‘ä»¬ä»æ•°æ®åº“æŸ¥è¯¢çš„æ—¶å€™å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œå°†<code>/employee/basic/**</code>ç±»å‹çš„url patternæ”¾åœ¨é›†åˆçš„å‰é¢å»æ¯”è¾ƒã€‚</li>
<li>å¦‚æœ<code>getAttributes(Object o)</code>æ–¹æ³•è¿”å›nullçš„è¯ï¼Œæ„å‘³ç€å½“å‰è¿™ä¸ªè¯·æ±‚ä¸éœ€è¦ä»»ä½•è§’è‰²å°±èƒ½è®¿é—®ï¼Œç”šè‡³ä¸éœ€è¦ç™»å½•ã€‚ä½†æ˜¯åœ¨æˆ‘çš„æ•´ä¸ªä¸šåŠ¡ä¸­ï¼Œå¹¶ä¸å­˜åœ¨è¿™æ ·çš„è¯·æ±‚ï¼Œæˆ‘è¿™é‡Œçš„è¦æ±‚æ˜¯ï¼Œ<strong>æ‰€æœ‰æœªåŒ¹é…åˆ°çš„è·¯å¾„ï¼Œéƒ½æ˜¯è®¤è¯(ç™»å½•)åå¯è®¿é—®ï¼Œå› æ­¤æˆ‘åœ¨è¿™é‡Œè¿”å›ä¸€ä¸ª<code>ROLE_LOGIN</code>çš„è§’è‰²ï¼Œè¿™ç§è§’è‰²åœ¨æˆ‘çš„è§’è‰²æ•°æ®åº“ä¸­å¹¶ä¸å­˜åœ¨ï¼Œå› æ­¤æˆ‘å°†åœ¨ä¸‹ä¸€æ­¥çš„è§’è‰²æ¯”å¯¹è¿‡ç¨‹ä¸­ç‰¹æ®Šå¤„ç†è¿™ç§è§’è‰²</strong>ã€‚</li>
<li>å¦‚æœåœ°å€æ˜¯<code>/login_p</code>ï¼Œè¿™ä¸ªæ˜¯ç™»å½•é¡µï¼Œä¸éœ€è¦ä»»ä½•è§’è‰²å³å¯è®¿é—®ï¼Œç›´æ¥è¿”å›nullã€‚</li>
<li><code>getAttributes(Object o)</code>æ–¹æ³•è¿”å›çš„é›†åˆæœ€ç»ˆä¼šæ¥åˆ°<code>AccessDecisionManager</code>ç±»ä¸­ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥çœ‹<code>AccessDecisionManager</code>ç±»</li>
</ul>
<h2 id="ğŸ”‘-æ£€æŸ¥è§’è‰²æ˜¯å¦æ»¡è¶³åŒ¹é…"><a href="#ğŸ”‘-æ£€æŸ¥è§’è‰²æ˜¯å¦æ»¡è¶³åŒ¹é…" class="headerlink" title="ğŸ”‘  æ£€æŸ¥è§’è‰²æ˜¯å¦æ»¡è¶³åŒ¹é…"></a>ğŸ”‘  æ£€æŸ¥è§’è‰²æ˜¯å¦æ»¡è¶³åŒ¹é…</h2><p>å…ˆå¼•å…¥ä¸€ä¸‹<code>AccessDecisionManager</code>çš„æ¦‚å¿µï¼š</p>
<h3 id="AccessDecisionManager"><a href="#AccessDecisionManager" class="headerlink" title="AccessDecisionManager"></a>AccessDecisionManager</h3><p><img src="https://oscimg.oschina.net/oscnet/fe299820424c5ead6a7f3bc97fa8dd957a5.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><strong>AccessDecisionManager</strong> é¡¾åæ€ä¹‰ï¼Œè®¿é—®å†³ç­–ç®¡ç†å™¨ã€‚å³åšå‡ºæœ€ç»ˆçš„è®¿é—®æ§åˆ¶ï¼ˆæˆæƒï¼‰å†³å®šã€‚</p>
<p>è€Œå¸¸ç”¨çš„ <strong>AccessDecisionManager</strong> æœ‰ä¸‰ä¸ªï¼Œè¿™é‡Œæˆ‘å°±ä½¿ç”¨æœ€ç®€å•çš„ä¸€ä¸ª<strong>AffirmativeBased</strong>ä¸­çš„æ€æƒ³ï¼Œè¿™æ˜¯<strong>Spring Security</strong> æ¡†æ¶é»˜è®¤çš„ <strong>AccessDecisionManager</strong>ï¼š<strong>åªè¦ä»»ä¸€ AccessDecisionVoter è¿”å›è‚¯å®šçš„ç»“æœï¼Œä¾¿æˆäºˆè®¿é—®æƒé™</strong>ã€‚</p>
<p>è‡ªå®šä¹‰<code>CustomUrlDecisionManager</code>ç±»å®ç°<code>AccessDecisionManager</code>æ¥å£ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomUrlDecisionManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AccessDecisionManager</span> </span>&#123;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decide</span><span class="hljs-params">(Authentication authentication, Object object, Collection&lt;ConfigAttribute&gt; configAttributes)</span> <span class="hljs-keyword">throws</span> AccessDeniedException, InsufficientAuthenticationException </span>&#123;
        <span class="hljs-keyword">for</span> (ConfigAttribute configAttribute : configAttributes) &#123;
            <span class="hljs-comment">//å½“å‰è¯·æ±‚éœ€è¦çš„æƒé™</span>
            String needRole = configAttribute.getAttribute();
            <span class="hljs-comment">//å¦‚æœæ˜¯åŒ¿åç”¨æˆ·ï¼ŒæŠ›å¼‚å¸¸</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;ROLE_LOGIN&quot;</span>.equals(needRole)) &#123;
                <span class="hljs-keyword">if</span> (authentication <span class="hljs-keyword">instanceof</span> AnonymousAuthenticationToken)&#123;
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AccessDeniedException(<span class="hljs-string">&quot;å°šæœªç™»å½•ï¼Œè¯·ç™»å½•ï¼&quot;</span>);
                &#125; <span class="hljs-keyword">else</span> &#123;
                    <span class="hljs-keyword">return</span>;
                &#125;
            &#125;
            <span class="hljs-comment">//å½“å‰ç”¨æˆ·æ‰€å…·æœ‰çš„æƒé™</span>
            Collection&lt;? extends GrantedAuthority&gt; authorities = authentication.getAuthorities();
            <span class="hljs-keyword">for</span> (GrantedAuthority authority : authorities) &#123;
                <span class="hljs-comment">//éœ€è¦çš„è§’è‰²èƒ½è¢«æ£€æµ‹åˆ°</span>
                <span class="hljs-keyword">if</span> (authority.getAuthority().equals(needRole))&#123;
                    <span class="hljs-keyword">return</span>;
                &#125;
            &#125;
        &#125;
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AccessDeniedException(<span class="hljs-string">&quot;æƒé™ä¸è¶³ï¼Œè¯·è¿”å›ï¼&quot;</span>);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">supports</span><span class="hljs-params">(ConfigAttribute attribute)</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">supports</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    &#125;
&#125;</code></pre></div>

<ul>
<li>decideæ–¹æ³•æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œ<strong>å…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°ä¸­ä¿å­˜äº†å½“å‰ç™»å½•ç”¨æˆ·çš„è§’è‰²ä¿¡æ¯ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°åˆ™æ˜¯<code>CustomFilterInvocationSecurityMetadataSource</code>ä¸­çš„<code>getAttributes</code>æ–¹æ³•ä¼ æ¥çš„ï¼Œè¡¨ç¤ºå½“å‰è¯·æ±‚éœ€è¦çš„è§’è‰²ï¼ˆå¯èƒ½æœ‰å¤šä¸ªï¼‰</strong></li>
<li>å¦‚æœå½“å‰è¯·æ±‚éœ€è¦çš„æƒé™ä¸º<code>ROLE_LOGIN</code>åˆ™è¡¨ç¤ºç™»å½•å³å¯è®¿é—®ï¼Œå’Œè§’è‰²æ²¡æœ‰å…³ç³»ï¼Œæ­¤æ—¶æˆ‘éœ€è¦åˆ¤æ–­authenticationæ˜¯ä¸æ˜¯<code>AnonymousAuthenticationToken</code>çš„ä¸€ä¸ªå®ä¾‹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¡¨ç¤ºå½“å‰ç”¨æˆ·æ²¡æœ‰ç™»å½•ï¼Œæ²¡æœ‰ç™»å½•å°±æŠ›ä¸€ä¸ª<code>BadCredentialsException</code>å¼‚å¸¸ï¼Œç™»å½•äº†å°±ç›´æ¥è¿”å›ï¼Œåˆ™è¿™ä¸ªè¯·æ±‚å°†è¢«æˆåŠŸæ‰§è¡Œã€‚</li>
<li><strong>éå†collectionï¼ŒåŒæ—¶æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„è§’è‰²åˆ—è¡¨ä¸­æ˜¯å¦å…·å¤‡éœ€è¦çš„æƒé™</strong>ï¼Œå¦‚æœå…·å¤‡å°±ç›´æ¥è¿”å›ï¼Œå¦åˆ™å°±æŠ›å¼‚å¸¸ã€‚</li>
<li>è¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ªallå’Œanyçš„é—®é¢˜ï¼šå‡è®¾å½“å‰ç”¨æˆ·å…·å¤‡è§’è‰²Aã€è§’è‰²Bï¼Œå½“å‰è¯·æ±‚éœ€è¦è§’è‰²Bã€è§’è‰²Cï¼Œé‚£ä¹ˆæ˜¯è¦å½“å‰ç”¨æˆ·è¦åŒ…å«æ‰€æœ‰è¯·æ±‚è§’è‰²æ‰ç®—æˆæƒæˆåŠŸè¿˜æ˜¯åªè¦åŒ…å«ä¸€ä¸ªå°±ç®—æˆæƒæˆåŠŸï¼Ÿæˆ‘è¿™é‡Œé‡‡ç”¨äº†ç¬¬äºŒç§æ–¹æ¡ˆï¼Œå³åªè¦åŒ…å«ä¸€ä¸ªå³å¯</li>
</ul>
<p><strong>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè·å–è§’è‰²å’Œåˆ¤æ–­è§’è‰²æ˜¯å¦æ»¡è¶³åŒ¹é…åˆ°éƒ¨åˆ†å·²ç»åˆ†æç»“æŸï¼Œä¸‹é¢å¼€å§‹åˆ†æç™»å½•çš„éªŒè¯å’Œè‡ªå®šä¹‰ç™»å½•è¿‡æ»¤å™¨çš„å…·ä½“æµç¨‹</strong></p>
<h2 id="ğŸ”ç™»å½•çš„éªŒè¯"><a href="#ğŸ”ç™»å½•çš„éªŒè¯" class="headerlink" title="ğŸ”ç™»å½•çš„éªŒè¯"></a>ğŸ”ç™»å½•çš„éªŒè¯</h2><p>ä¸‹é¢å°±è¦é’ˆå¯¹äºç™»å½•è¿›è¡Œæ›´æ·±ä¸€æ­¥çš„è¯´æ˜ï¼Œç™»å½•éªŒè¯æ¶‰åŠåˆ°è´¦å·ã€å¯†ç ã€ä¸éªŒè¯ç </p>
<h3 id="PasswordEncoder"><a href="#PasswordEncoder" class="headerlink" title="PasswordEncoder"></a>PasswordEncoder</h3><p><code>PasswordEncoder</code> æ˜¯Spring Scurityæ¡†æ¶å†…å¤„ç†å¯†ç åŠ å¯†ä¸æ ¡éªŒçš„æ¥å£ã€‚</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.security.crypto.password;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">PasswordEncoder</span> </span>&#123;
   <span class="hljs-function">String <span class="hljs-title">encode</span><span class="hljs-params">(CharSequence rawPassword)</span></span>;

   <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">matches</span><span class="hljs-params">(CharSequence rawPassword, String encodedPassword)</span></span>;

   <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">upgradeEncoding</span><span class="hljs-params">(String encodedPassword)</span> </span>&#123;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
   &#125;
&#125;</code></pre></div>

<p>è¿™ä¸ªæ¥å£æœ‰ä¸‰ä¸ªæ–¹æ³•</p>
<ul>
<li><code>encode</code>æ–¹æ³•æ¥å—çš„å‚æ•°æ˜¯åŸå§‹å¯†ç å­—ç¬¦ä¸²ï¼Œè¿”å›å€¼æ˜¯ç»è¿‡åŠ å¯†ä¹‹åçš„hashå€¼ï¼Œhashå€¼æ˜¯ä¸èƒ½è¢«é€†å‘è§£å¯†çš„ã€‚è¿™ä¸ªæ–¹æ³•é€šå¸¸åœ¨ä¸ºç³»ç»Ÿæ·»åŠ ç”¨æˆ·ï¼Œæˆ–è€…ç”¨æˆ·æ³¨å†Œçš„æ—¶å€™ä½¿ç”¨ã€‚</li>
<li><code>matches</code>æ–¹æ³•æ˜¯ç”¨æ¥æ ¡éªŒç”¨æˆ·è¾“å…¥å¯†ç rawPasswordï¼Œå’ŒåŠ å¯†åçš„hashå€¼encodedPasswordæ˜¯å¦åŒ¹é…ã€‚å¦‚æœèƒ½å¤ŸåŒ¹é…è¿”å›trueï¼Œè¡¨ç¤ºç”¨æˆ·è¾“å…¥çš„å¯†ç rawPasswordæ˜¯æ­£ç¡®çš„ï¼Œåä¹‹è¿”å›fasleã€‚ä¹Ÿå°±æ˜¯è¯´è™½ç„¶è¿™ä¸ªhashå€¼ä¸èƒ½è¢«é€†å‘è§£å¯†ï¼Œä½†æ˜¯å¯ä»¥åˆ¤æ–­æ˜¯å¦å’ŒåŸå§‹å¯†ç åŒ¹é…ã€‚<strong>è¿™ä¸ªæ–¹æ³•é€šå¸¸åœ¨ç”¨æˆ·ç™»å½•çš„æ—¶å€™è¿›è¡Œç”¨æˆ·è¾“å…¥å¯†ç çš„æ­£ç¡®æ€§æ ¡éªŒã€‚</strong></li>
<li><code>upgradeEncoding</code>è®¾è®¡çš„ç”¨æ„æ˜¯ï¼Œåˆ¤æ–­å½“å‰çš„å¯†ç æ˜¯å¦éœ€è¦å‡çº§ã€‚ä¹Ÿå°±æ˜¯æ˜¯å¦éœ€è¦é‡æ–°åŠ å¯†ï¼Ÿéœ€è¦çš„è¯è¿”å›trueï¼Œä¸éœ€è¦çš„è¯è¿”å›fasleã€‚é»˜è®¤å®ç°æ˜¯è¿”å›falseã€‚</li>
</ul>
<p> <strong><code>BCryptPasswordEncoder</code> ä½œä¸ºSpring Securityæ¨èä½¿ç”¨çš„ <code>PasswordEncoder</code>å®ç°ç±» ï¼Œå¯ä»¥å®ç°å¯¹å¯†ç çš„è‡ªåŠ¨åŠ å¯†åŠ ç›</strong>ï¼Œï¼ˆç›æ˜¯å€¼å³ä½¿ç›¸åŒçš„æ˜æ–‡ï¼Œç”Ÿæˆçš„æ–°çš„åŠ å¯†å­—ç¬¦ä¸²éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼‰ï¼Œè¿™æ ·å¯ä»¥é¿å…åƒåœ¨Shiroä¸­é‚£æ ·æˆ‘ä»¬è‡ªå·±é…ç½®å¯†ç çš„ç›ï¼Œè€Œ <code>BCryptPasswordEncoder</code> å°±æ˜¯     <code>PasswordEncoder</code> æ¥å£çš„å®ç°ç±»ï¼Œåªéœ€è¦æä¾› <code>BCryptPasswordEncoder</code> è¿™ä¸ª Bean çš„å®ä¾‹å³å¯ï¼ŒSpringSecurityä¸­ä½¿ç”¨<code>BCryptPasswordEncoder</code>çš„å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>BCryptPasswordEncoder ä½¿ç”¨ BCrypt å¼ºå“ˆå¸Œå‡½æ•°ï¼Œå¼€å‘è€…åœ¨ä½¿ç”¨æ—¶å¯ä»¥é€‰æ‹©æä¾› strength å’Œ SecureRandom å®ä¾‹ã€‚strength è¶Šå¤§ï¼Œå¯†é’¥çš„è¿­ä»£æ¬¡æ•°è¶Šå¤šï¼Œå¯†é’¥è¿­ä»£æ¬¡æ•°ä¸º 2^strengthã€‚strength å–å€¼åœ¨ 4~31 ä¹‹é—´ï¼Œé»˜è®¤ä¸º 10ã€‚</p>
</blockquote>
<p>åœ¨ç”¨æˆ·æ³¨å†Œæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å¯†ç è¿›è¡Œå¤„ç†ï¼Œå¤„ç†æ–¹å¼å¦‚ä¸‹ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hrReg</span><span class="hljs-params">(String username, String password)</span> </span>&#123;
    <span class="hljs-comment">//å¦‚æœç”¨æˆ·åå­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span>
    <span class="hljs-keyword">if</span> (hrMapper.loadUserByUsername(username) != <span class="hljs-keyword">null</span>) &#123;
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    &#125;
    BCryptPasswordEncoder encoder = <span class="hljs-keyword">new</span> BCryptPasswordEncoder();
    String encode = encoder.encode(password);
    <span class="hljs-keyword">return</span> hrMapper.hrReg(username, encode);
&#125;</code></pre></div>

<p>ç”¨æˆ·å°†å¯†ç ä»å‰ç«¯ä¼ æ¥ä¹‹åï¼Œé€šè¿‡è°ƒç”¨ <code>BCryptPasswordEncoder</code> å®ä¾‹ä¸­çš„ encode æ–¹æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†å¤„ç†ï¼ŒåŠ å¯†å®Œæˆåå°†å¯†æ–‡å­˜å…¥æ•°æ®åº“ã€‚</p>
<div class="hljs code-wrapper"><pre><code class="hljs properties"><span class="hljs-attr">$2a$10$zt6dUMTjNSyzINTGyiAgluna3mPm7qdgl26vj4tFpsFO6WlK5lXNm</span></code></pre></div>

<p>BCryptåŠ å¯†åçš„å¯†ç æœ‰ä¸‰ä¸ªéƒ¨åˆ†ï¼Œç”± $åˆ†éš”ï¼š</p>
<ol>
<li>â€œ2aâ€è¡¨ç¤º BCrypt ç®—æ³•ç‰ˆæœ¬</li>
<li>â€œ10â€è¡¨ç¤ºç®—æ³•çš„å¼ºåº¦</li>
<li>â€œzt6dUMTjNSyzINTGyiAgluâ€éƒ¨åˆ†å®é™…ä¸Šæ˜¯éšæœºç”Ÿæˆçš„ç›ã€‚é€šå¸¸æ¥è¯´å‰ 22 ä¸ªå­—ç¬¦æ˜¯ç›ï¼Œå‰©ä½™éƒ¨åˆ†æ˜¯çº¯æ–‡æœ¬çš„å®é™…å“ˆå¸Œå€¼ã€‚</li>
</ol>
<blockquote>
<p>BCryptç®—æ³•ç”Ÿæˆé•¿åº¦ä¸º 60 çš„å­—ç¬¦ä¸²ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç¡®ä¿å¯†ç å°†å­˜å‚¨åœ¨å¯ä»¥å®¹çº³å¯†ç çš„æ•°æ®åº“åˆ—ä¸­ã€‚</p>
</blockquote>
<p>å½“ç”¨æˆ·æ³¨å†ŒæˆåŠŸä¹‹åï¼Œå­˜åœ¨æ•°æ®åº“ä¸­çš„å¯†ç å°±åƒä¸‹é¢è¿™æ ·ï¼š</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/p283.png" srcset="/img/loading.gif" lazyload alt="p283"></p>
<p>å‡å¦‚æ˜æ–‡éƒ½æ˜¯ 123ã€‚é…ç½®å®Œæˆåï¼Œä½¿ç”¨ admin/123 æˆ–è€… sang/123 å°±å¯ä»¥å®ç°ç™»å½•ã€‚</p>
<p>å¯†ç åŠ å¯†å¤„ç†ä¹‹åï¼Œç™»å½•æ—¶å€™ä¹Ÿè¦å¯¹å¯†ç è¿›è¡Œå¤„ç†ï¼Œ<strong>ä¿®æ”¹SecurityConfigç±»çš„configure(AuthenticationManagerBuilder auth)æ–¹æ³•ï¼Œ</strong>æ”¹ä¸ºä¸‹é¢è¿™æ ·å³å¯ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span>
<span class="hljs-function">PasswordEncoder <span class="hljs-title">passwordEncoder</span><span class="hljs-params">()</span></span>&#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BCryptPasswordEncoder();
&#125;

<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
    auth.userDetailsService(hrService);
&#125;</code></pre></div>

<h3 id="éªŒè¯ç çš„æ ¡éªŒ"><a href="#éªŒè¯ç çš„æ ¡éªŒ" class="headerlink" title="éªŒè¯ç çš„æ ¡éªŒ"></a>éªŒè¯ç çš„æ ¡éªŒ</h3><p>éªŒè¯ç çš„ç”Ÿæˆæ¥å£ååˆ†å¤šï¼Œè¿™é‡Œä¸å†æä¾›ï¼Œè¿™ä¸ªå·¥å…·ç±»å¾ˆå¸¸è§ï¼Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šï¼Œå°±æ˜¯ç”»ä¸€ä¸ªç®€å•çš„éªŒè¯ç ï¼Œé€šè¿‡æµå°†éªŒè¯ç å†™åˆ°å‰ç«¯é¡µé¢ï¼Œæä¾›éªŒè¯ç çš„ Controller å¦‚ä¸‹ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/verifyCode&quot;)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">verifyCode</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
  	<span class="hljs-comment">//è·å–å®ä¾‹</span>
    VerificationCode code = <span class="hljs-keyword">new</span> VerificationCode();
    BufferedImage image = code.getImage();
    String text = code.getText();
    HttpSession session = request.getSession(<span class="hljs-keyword">true</span>);
    session.setAttribute(<span class="hljs-string">&quot;verify_code&quot;</span>, text);
    VerificationCode.output(image,resp.getOutputStream());
&#125;</code></pre></div>

<p>åŒæ—¶éœ€è¦åœ¨Spring Securityé…ç½®ç±»ä¸­é…ç½®ä¸æ‹¦æˆªæ­¤æ¥å£</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
    <span class="hljs-comment">//é˜²æ­¢è®¿é—®ç™»å½•é¡µé¢æ­»å¾ªç¯ï¼Œä¸ç”¨è¿›å…¥Securityæ‹¦æˆª</span>
    web.ignoring().antMatchers(<span class="hljs-string">&quot;/css/**&quot;</span>, <span class="hljs-string">&quot;/js/**&quot;</span>, <span class="hljs-string">&quot;/index.html&quot;</span>, <span class="hljs-string">&quot;/img/**&quot;</span>, <span class="hljs-string">&quot;/fonts/**&quot;</span>, <span class="hljs-string">&quot;/favicon.ico&quot;</span>, <span class="hljs-string">&quot;/verifyCode&quot;</span>);
&#125;</code></pre></div>

<p>å› ä¸ºæ¶‰åŠåˆ°è‡ªå®šä¹‰ç™»é™†é€»è¾‘ï¼Œæ‰€ä»¥éœ€è¦è‡ªå®šä¹‰ç™»é™†è¿‡æ»¤å™¨ï¼Œè¿™é‡Œå…ˆä¸è¯´æ˜å®ç°è¿‡æ»¤å™¨çš„è¯¦ç»†æµç¨‹ï¼Œç­‰åˆ°ä¸‹é¢è®²åˆ°JSONç™»é™†çš„æ—¶å€™ï¼Œç»Ÿä¸€å¤„ç†</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿‡æ»¤å™¨è‡ªå®šä¹‰å®Œæˆåï¼Œä¹Ÿéœ€è¦åœ¨é…ç½®ç±»ä¸­æ³¨å…¥ï¼Œè¿™é‡Œæ‰èƒ½èƒ½å®Œæˆæ•´ä¸ªæµç¨‹çš„é…ç½®ã€‚</p>
<h3 id="å®ç°JSONæ ¼å¼ç™»é™†"><a href="#å®ç°JSONæ ¼å¼ç™»é™†" class="headerlink" title="å®ç°JSONæ ¼å¼ç™»é™†"></a>å®ç°JSONæ ¼å¼ç™»é™†</h3><p>å‰åç«¯åˆ†ç¦»è¿™æ ·çš„å¼€å‘æ¶æ„ä¸‹ï¼Œå‰åç«¯çš„äº¤äº’éƒ½æ˜¯é€šè¿‡ JSON æ¥è¿›è¡Œï¼Œæ— è®ºç™»å½•æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½ä¸ä¼šæœ‰ä»€ä¹ˆæœåŠ¡ç«¯è·³è½¬æˆ–è€…å®¢æˆ·ç«¯è·³è½¬ä¹‹ç±»ã€‚</p>
<p>ç™»å½•æˆåŠŸäº†ï¼ŒæœåŠ¡ç«¯å°±è¿”å›ä¸€æ®µç™»å½•æˆåŠŸçš„æç¤º JSON ç»™å‰ç«¯ï¼Œå‰ç«¯æ”¶åˆ°ä¹‹åï¼Œè¯¥è·³è½¬è¯¥å±•ç¤ºï¼Œç”±å‰ç«¯è‡ªå·±å†³å®šï¼Œå°±å’Œåç«¯æ²¡æœ‰å…³ç³»äº†ã€‚</p>
<p>ç™»å½•å¤±è´¥äº†ï¼ŒæœåŠ¡ç«¯å°±è¿”å›ä¸€æ®µç™»å½•å¤±è´¥çš„æç¤º JSON ç»™å‰ç«¯ï¼Œå‰ç«¯æ”¶åˆ°ä¹‹åï¼Œè¯¥è·³è½¬è¯¥å±•ç¤ºï¼Œç”±å‰ç«¯è‡ªå·±å†³å®šï¼Œä¹Ÿå’Œåç«¯æ²¡æœ‰å…³ç³»äº†ã€‚</p>
<p>æ‰€ä»¥ä¸ºäº†ç»Ÿä¸€ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç™»å½•çš„æ—¶å€™ï¼Œä¹Ÿå®ç°JSONäº¤äº’ï¼Œä½†æ˜¯æˆ‘ä»¬é¦–å…ˆå¾—æ˜ç™½ä¸€ä¸ªå‰æï¼Œ åœ¨ä½¿ç”¨ SpringSecurity ä¸­ï¼Œé»˜è®¤çš„ç™»å½•æ•°æ®æ˜¯é€šè¿‡ <code>key/value</code> çš„å½¢å¼æ¥ä¼ é€’çš„ï¼Œ<strong>é»˜è®¤æƒ…å†µä¸‹ä¸æ”¯æŒ JSONæ ¼å¼çš„ç™»å½•æ•°æ®ï¼Œå¦‚æœæœ‰è¿™ç§éœ€æ±‚ï¼Œå°±éœ€è¦è‡ªå·±æ¥è§£å†³ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰è¿‡æ»¤å™¨</strong></p>
<p>é¦–å…ˆå¤§å®¶çŸ¥é“ï¼Œç”¨æˆ·ç™»å½•çš„ç”¨æˆ·å/å¯†ç æ˜¯åœ¨ <code>UsernamePasswordAuthenticationFilter</code> ç±»ä¸­å¤„ç†çš„ï¼Œå…·ä½“çš„å¤„ç†ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Authentication <span class="hljs-title">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest request,</span></span>
<span class="hljs-function"><span class="hljs-params">		HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;
	String username = obtainUsername(request);
	String password = obtainPassword(request);
    <span class="hljs-comment">//çœç•¥</span>
&#125;
<span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">obtainPassword</span><span class="hljs-params">(HttpServletRequest request)</span> </span>&#123;
	<span class="hljs-keyword">return</span> request.getParameter(passwordParameter);
&#125;
<span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">obtainUsername</span><span class="hljs-params">(HttpServletRequest request)</span> </span>&#123;
	<span class="hljs-keyword">return</span> request.getParameter(usernameParameter);
&#125;</code></pre></div>

<p>ä»è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºæ¥ä¸ºä»€ä¹ˆ Spring Security é»˜è®¤æ˜¯é€šè¿‡ key/value çš„å½¢å¼æ¥ä¼ é€’ç™»å½•å‚æ•°ï¼Œå› ä¸ºå®ƒå¤„ç†çš„æ–¹å¼å°±æ˜¯<code> request.getParameter</code>ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬è¦å®šä¹‰æˆ JSON çš„ï¼Œæ€è·¯å¾ˆç®€å•ï¼Œå°±æ˜¯è‡ªå®šä¹‰æ¥å®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ä»£æ›¿ <code>UsernamePasswordAuthenticationFilter</code>ï¼Œç„¶ååœ¨è·å–å‚æ•°çš„æ—¶å€™ï¼Œæ¢ä¸€ç§æ–¹å¼å°±è¡Œäº†ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ¨¡ä»¿æºä»£ç ä¸­çš„æ­¤éƒ¨åˆ†æ¥ä¸ªæ€§åŒ–å®šåˆ¶ï¼š</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210809163840081.png" srcset="/img/loading.gif" lazyload alt="image-20210809163840081"></p>
<p><strong>è¿™é‡Œæœ‰ä¸€ä¸ªé¢å¤–çš„ç‚¹éœ€è¦æ³¨æ„ï¼Œå°±æ˜¯ç°åœ¨è¿˜æœ‰éªŒè¯ç çš„åŠŸèƒ½ï¼Œæ‰€ä»¥å¦‚æœè‡ªå®šä¹‰è¿‡æ»¤å™¨ï¼Œè¦è¿åŒéªŒè¯ç ä¸€èµ·å¤„ç†æ‰ã€‚</strong></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è‡ªå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ä»£æ›¿ <code>UsernamePasswordAuthenticationFilter</code> ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">UsernamePasswordAuthenticationFilter</span> </span>&#123;
  	<span class="hljs-comment">//éœ€è¦é‡å†™çš„æ–¹æ³•</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Authentication <span class="hljs-title">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;
      	<span class="hljs-comment">//æ­¤éƒ¨åˆ†é€»è¾‘ä¸å˜</span>
        <span class="hljs-keyword">if</span> (!request.getMethod().equals(<span class="hljs-string">&quot;POST&quot;</span>)) &#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AuthenticationServiceException(
                    <span class="hljs-string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());
        &#125;
      	<span class="hljs-comment">//æ‹¿åˆ°æ­£ç¡®çš„éªŒè¯ç </span>
        String verify_code = (String) request.getSession().getAttribute(<span class="hljs-string">&quot;verify_code&quot;</span>);
      <span class="hljs-comment">//åˆ¤æ–­æ˜¯Key/Valueè¿˜æ˜¯JSONä¼ é€’</span>
        <span class="hljs-keyword">if</span> (request.getContentType().contains(MediaType.APPLICATION_JSON_VALUE) || request.getContentType().contains(MediaType.APPLICATION_JSON_UTF8_VALUE)) &#123;
          	<span class="hljs-comment">//å°è£…ä¼ æ¥çš„æ•°æ®</span>
            Map&lt;String, String&gt; loginData = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
            <span class="hljs-keyword">try</span> &#123;
                loginData = <span class="hljs-keyword">new</span> ObjectMapper().readValue(request.getInputStream(), Map.class);
            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
            &#125;<span class="hljs-keyword">finally</span> &#123;
              	<span class="hljs-comment">//æµè§ˆå™¨ä¼ è¿‡æ¥è¾“å…¥çš„</span>
                String code = loginData.get(<span class="hljs-string">&quot;code&quot;</span>);
                checkCode(response, code, verify_code);
            &#125;
            String username = loginData.get(getUsernameParameter());
            String password = loginData.get(getPasswordParameter());
            <span class="hljs-keyword">if</span> (username == <span class="hljs-keyword">null</span>) &#123;
                username = <span class="hljs-string">&quot;&quot;</span>;
            &#125;
            <span class="hljs-keyword">if</span> (password == <span class="hljs-keyword">null</span>) &#123;
                password = <span class="hljs-string">&quot;&quot;</span>;
            &#125;
            username = username.trim();
            UsernamePasswordAuthenticationToken authRequest = <span class="hljs-keyword">new</span> UsernamePasswordAuthenticationToken(
                    username, password);
            setDetails(request, authRequest);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getAuthenticationManager().authenticate(authRequest);
        &#125; 
      <span class="hljs-comment">//Key/Valueç›´æ¥ç”¨çˆ¶ç±»å¤„ç†å³å¯</span>
      <span class="hljs-keyword">else</span> &#123;
            checkCode(response, request.getParameter(<span class="hljs-string">&quot;code&quot;</span>), verify_code);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.attemptAuthentication(request, response);
        &#125;
    &#125;	
		<span class="hljs-comment">//æ ¡éªŒè¾“å…¥çš„å’Œæ­£ç¡®ç”Ÿæˆçš„æ˜¯å¦åŒ¹é…</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">checkCode</span><span class="hljs-params">(HttpServletResponse resp, String code, String verify_code)</span> </span>&#123;
        <span class="hljs-keyword">if</span> (code == <span class="hljs-keyword">null</span> || verify_code == <span class="hljs-keyword">null</span> || <span class="hljs-string">&quot;&quot;</span>.equals(code) || !verify_code.toLowerCase().equals(code.toLowerCase())) &#123;
            <span class="hljs-comment">//éªŒè¯ç ä¸æ­£ç¡®</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AuthenticationServiceException(<span class="hljs-string">&quot;éªŒè¯ç ä¸æ­£ç¡®&quot;</span>);
        &#125;
    &#125;
&#125;</code></pre></div>

<p>è¿™æ®µé€»è¾‘æˆ‘ä»¬åŸºæœ¬ä¸Šæ˜¯æ¨¡ä»¿å®˜æ–¹æä¾›çš„ <code>UsernamePasswordAuthenticationFilter</code> æ¥å†™çš„ï¼Œç¨å¾®è§£é‡Šä¸‹ï¼š</p>
<ol>
<li>é¦–å…ˆç™»å½•è¯·æ±‚è‚¯å®šæ˜¯ POSTï¼Œå¦‚æœä¸æ˜¯ POST ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œåé¢çš„ä¹Ÿä¸å¤„ç†äº†ã€‚</li>
<li>å› ä¸ºè¦åœ¨è¿™é‡Œå¤„ç†éªŒè¯ç ï¼Œæ‰€ä»¥ç¬¬äºŒæ­¥ä» session ä¸­æŠŠå·²ç»ä¸‹å‘è¿‡çš„éªŒè¯ç çš„å€¼æ‹¿å‡ºæ¥ã€‚</li>
<li>æ¥ä¸‹æ¥é€šè¿‡ contentType æ¥åˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦é€šè¿‡ JSON æ¥ä¼ é€’å‚æ•°ï¼Œå¦‚æœæ˜¯é€šè¿‡ JSON ä¼ é€’å‚æ•°ï¼Œåˆ™æŒ‰ç…§ JSON çš„æ–¹å¼è§£æï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™è°ƒç”¨ <code>super.attemptAuthentication </code>æ–¹æ³•ï¼Œè¿›å…¥çˆ¶ç±»çš„å¤„ç†é€»è¾‘ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>æˆ‘ä»¬è‡ªå®šä¹‰çš„è¿™ä¸ªç±»ï¼Œæ—¢æ”¯æŒ JSON å½¢å¼ä¼ é€’å‚æ•°ï¼Œä¹Ÿæ”¯æŒ key/value å½¢å¼ä¼ é€’å‚æ•°ã€‚</strong></li>
<li>å¦‚æœæ˜¯ JSON å½¢å¼çš„æ•°æ®ï¼Œæˆ‘ä»¬å°±é€šè¿‡è¯»å– request ä¸­çš„ I/O æµï¼Œå°† JSON æ˜ å°„åˆ°ä¸€ä¸ª Map ä¸Šã€‚</li>
<li>ä» Map ä¸­å–å‡º codeï¼Œå…ˆå»åˆ¤æ–­éªŒè¯ç æ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœéªŒè¯ç æœ‰é”™ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸</li>
<li>æ¥ä¸‹æ¥ä» Map ä¸­å–å‡º username å’Œ passwordï¼Œæ„é€  UsernamePasswordAuthenticationToken å¯¹è±¡å¹¶ä½œæ ¡éªŒã€‚</li>
</ol>
<p><strong>æ¥ä¸‹æ¥å°±æ˜¯åœ¨Spring Securityé…ç½®ç±»ä¸­é…ç½®æ­¤è¿‡æ»¤å™¨å³å¯</strong></p>
<h3 id="Spring-Securityé…ç½®ç±»"><a href="#Spring-Securityé…ç½®ç±»" class="headerlink" title="Spring Securityé…ç½®ç±»"></a>Spring Securityé…ç½®ç±»</h3><h4 id="åŸºç¡€æ³¨å…¥"><a href="#åŸºç¡€æ³¨å…¥" class="headerlink" title="åŸºç¡€æ³¨å…¥"></a>åŸºç¡€æ³¨å…¥</h4><p>ç»“åˆä»¥ä¸Šæ‰€è®²çš„ï¼Œå°±èƒ½åœ¨é…ç½®ç±»ä¸­æ•´åˆæ‰€æœ‰éœ€è¦ç”¨åˆ°çš„æ ¡éªŒç±»ï¼Œé¦–å…ˆåœ¨Spring Securityé…ç½®ç±»ä¸­é…ç½®åŸºç¡€çš„ä¿¡æ¯</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;
		<span class="hljs-comment">//UserDetialçš„æ ¡éªŒ</span>
    <span class="hljs-meta">@Autowired</span>
    HrService hrService;
  
		<span class="hljs-comment">//æ ¹æ®è¯·æ±‚åœ°å€è·å–è§’è‰²çš„æ ¡éªŒ</span>
    <span class="hljs-meta">@Autowired</span>
    CustomFilterInvocationSecurityMetadataSource customFilterInvocationSecurityMetadataSource;
		<span class="hljs-comment">//æ£€æŸ¥è§’è‰²çš„æ ¡éªŒ</span>
    <span class="hljs-meta">@Autowired</span>
    CustomUrlDecisionManager customUrlDecisionManager;
		<span class="hljs-comment">//å¯†ç çš„æ ¡éªŒ</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function">PasswordEncoder <span class="hljs-title">passwordEncoder</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BCryptPasswordEncoder();
    &#125;
		<span class="hljs-comment">//å¯†ç åŠ å¯†å¤„ç†åé…ç½®</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        auth.userDetailsService(hrService);
    &#125;</code></pre></div>

<h4 id="ç™»é™†æˆåŠŸå¤±è´¥çš„å›è°ƒ"><a href="#ç™»é™†æˆåŠŸå¤±è´¥çš„å›è°ƒ" class="headerlink" title="ç™»é™†æˆåŠŸå¤±è´¥çš„å›è°ƒ"></a>ç™»é™†æˆåŠŸå¤±è´¥çš„å›è°ƒ</h4><p>æ¥ä¸‹æ¥å°±éœ€è¦é’ˆå¯¹åˆšå®šä¹‰å¥½çš„è¿‡æ»¤å™¨è¿›ä¸€æ­¥é…ç½®</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span>
<span class="hljs-function">LoginFilter <span class="hljs-title">loginFilter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
    LoginFilter loginFilter = <span class="hljs-keyword">new</span> LoginFilter();
  	<span class="hljs-comment">//æˆåŠŸå›è°ƒ</span>
    loginFilter.setAuthenticationSuccessHandler((request, response, authentication) -&gt; &#123;
                response.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);
                PrintWriter out = response.getWriter();
                Hr hr = (Hr) authentication.getPrincipal();
                hr.setPassword(<span class="hljs-keyword">null</span>);
                RespBean ok = RespBean.ok(<span class="hljs-string">&quot;ç™»å½•æˆåŠŸ!&quot;</span>, hr);
                String s = <span class="hljs-keyword">new</span> ObjectMapper().writeValueAsString(ok);
                out.write(s);
                out.flush();
                out.close();
            &#125;
    );
  <span class="hljs-comment">//å¤±è´¥å›è°ƒ</span>
    loginFilter.setAuthenticationFailureHandler((request, response, exception) -&gt; &#123;
                response.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);
                PrintWriter out = response.getWriter();
                RespBean respBean = RespBean.error(exception.getMessage());
                <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> LockedException) &#123;
                    respBean.setMsg(<span class="hljs-string">&quot;è´¦æˆ·è¢«é”å®šï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;</span>);
                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> CredentialsExpiredException) &#123;
                    respBean.setMsg(<span class="hljs-string">&quot;å¯†ç è¿‡æœŸï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;</span>);
                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> AccountExpiredException) &#123;
                    respBean.setMsg(<span class="hljs-string">&quot;è´¦æˆ·è¿‡æœŸï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;</span>);
                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> DisabledException) &#123;
                    respBean.setMsg(<span class="hljs-string">&quot;è´¦æˆ·è¢«ç¦ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;</span>);
                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> BadCredentialsException) &#123;
                    respBean.setMsg(<span class="hljs-string">&quot;ç”¨æˆ·åæˆ–è€…å¯†ç è¾“å…¥é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥!&quot;</span>);
                &#125;
                out.write(<span class="hljs-keyword">new</span> ObjectMapper().writeValueAsString(respBean));
                out.flush();
                out.close();
            &#125;
    );</code></pre></div>

<p><code>AuthenticationSuccessHandler</code>æ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li><code>HttpServletRequest</code></li>
<li><code>HttpServletResponse</code></li>
<li><code>Authentication</code></li>
</ul>
<p>æœ‰äº†å‰ä¸¤ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨è¿™é‡Œéšå¿ƒæ‰€æ¬²çš„è¿”å›æ•°æ®äº†ã€‚åˆ©ç”¨ <code>HttpServletRequest</code> æˆ‘ä»¬å¯ä»¥åšæœåŠ¡ç«¯è·³è½¬ï¼Œåˆ©ç”¨ <code>HttpServletResponse </code>æˆ‘ä»¬å¯ä»¥åšå®¢æˆ·ç«¯è·³è½¬ï¼Œå½“ç„¶ï¼Œä¹Ÿå¯ä»¥è¿”å› JSON æ•°æ®ã€‚</p>
<p>ç¬¬ä¸‰ä¸ª <code>Authentication</code> å‚æ•°åˆ™ä¿å­˜äº†æˆ‘ä»¬åˆšåˆšç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<p>åŒç†ï¼Œå¤±è´¥çš„å›è°ƒä¹Ÿæ˜¯ä¸‰ä¸ªå‚æ•°ï¼Œå‰ä¸¤ä¸ªå°±ä¸ç”¨è¯´äº†ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ä¸€ä¸ª Exceptionï¼Œå¯¹äºç™»å½•å¤±è´¥ï¼Œä¼šæœ‰ä¸åŒçš„åŸå› ï¼ŒException ä¸­åˆ™ä¿å­˜äº†ç™»å½•å¤±è´¥çš„åŸå› ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¹‹é€šè¿‡ JSON è¿”å›åˆ°å‰ç«¯ã€‚</p>
<h4 id="å¼‚å¸¸æ•è·"><a href="#å¼‚å¸¸æ•è·" class="headerlink" title="å¼‚å¸¸æ•è·"></a>å¼‚å¸¸æ•è·</h4><p>è¿™é‡Œæˆ‘è¿˜æŒ¨ä¸ªå»è¯†åˆ«äº†ä¸€ä¸‹å¼‚å¸¸çš„ç±»å‹ï¼Œæ ¹æ®ä¸åŒçš„å¼‚å¸¸ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ç»™ç”¨æˆ·ä¸€ä¸ªæ›´åŠ æ˜ç¡®çš„æç¤ºï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ï¼š</p>
<p>å½“ç”¨æˆ·ç™»å½•æ—¶ï¼Œç”¨æˆ·åæˆ–è€…å¯†ç è¾“å…¥é”™è¯¯ï¼Œæˆ‘ä»¬ä¸€èˆ¬åªç»™ä¸€ä¸ªæ¨¡ç³Šçš„æç¤ºï¼Œå³<strong>ç”¨æˆ·åæˆ–è€…å¯†ç è¾“å…¥é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥</strong>ï¼Œè€Œä¸ä¼šç»™ä¸€ä¸ªæ˜ç¡®çš„è¯¸å¦‚â€œç”¨æˆ·åè¾“å…¥é”™è¯¯â€æˆ–â€œå¯†ç è¾“å…¥é”™è¯¯â€è¿™æ ·ç²¾ç¡®çš„æç¤ºï¼Œä½†æ˜¯å¯¹äºå¾ˆå¤šä¸æ‡‚è¡Œçš„æ–°æ‰‹å°ä¼™ä¼´ï¼Œä»–å¯èƒ½å°±ä¼šç»™ä¸€ä¸ªæ˜ç¡®çš„é”™è¯¯æç¤ºï¼Œè¿™ä¼šç»™ç³»ç»Ÿå¸¦æ¥é£é™©ã€‚</p>
<p>ä½†æ˜¯ä½¿ç”¨äº† Spring Security è¿™æ ·çš„å®‰å…¨ç®¡ç†æ¡†æ¶ä¹‹åï¼Œå³ä½¿ä½ æ˜¯ä¸€ä¸ªæ–°æ‰‹ï¼Œä¹Ÿä¸ä¼šçŠ¯è¿™æ ·çš„é”™è¯¯ã€‚</p>
<p>åœ¨ Spring Security ä¸­ï¼Œç”¨æˆ·åæŸ¥æ‰¾å¤±è´¥å¯¹åº”çš„å¼‚å¸¸æ˜¯ï¼š</p>
<ul>
<li><code>UsernameNotFoundException</code></li>
</ul>
<p>å¯†ç åŒ¹é…å¤±è´¥å¯¹åº”çš„å¼‚å¸¸æ˜¯ï¼š</p>
<ul>
<li><code>BadCredentialsException</code></li>
</ul>
<p>ä½†æ˜¯æˆ‘ä»¬åœ¨ç™»å½•å¤±è´¥çš„å›è°ƒä¸­ï¼Œå´æ€»æ˜¯çœ‹ä¸åˆ° <code>UsernameNotFoundException </code>å¼‚å¸¸ï¼Œæ— è®ºç”¨æˆ·åè¿˜æ˜¯å¯†ç è¾“å…¥é”™è¯¯ï¼ŒæŠ›å‡ºçš„å¼‚å¸¸éƒ½æ˜¯ <code>BadCredentialsException</code></p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Authentication <span class="hljs-title">authenticate</span><span class="hljs-params">(Authentication authentication)</span></span>
<span class="hljs-function">		<span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;
	<span class="hljs-keyword">try</span> &#123;
		user = retrieveUser(username,
				(UsernamePasswordAuthenticationToken) authentication);
	&#125;
	<span class="hljs-keyword">catch</span> (UsernameNotFoundException notFound) &#123;
		logger.debug(<span class="hljs-string">&quot;User &#x27;&quot;</span> + username + <span class="hljs-string">&quot;&#x27; not found&quot;</span>);
		<span class="hljs-keyword">if</span> (hideUserNotFoundExceptions) &#123;
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BadCredentialsException(messages.getMessage(
					<span class="hljs-string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span>,
					<span class="hljs-string">&quot;Bad credentials&quot;</span>));
		&#125;
		<span class="hljs-keyword">else</span> &#123;
			<span class="hljs-keyword">throw</span> notFound;
		&#125;
	&#125;
&#125;</code></pre></div>

<p>ä»è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬çœ‹å‡ºï¼Œåœ¨æŸ¥æ‰¾ç”¨æˆ·æ—¶ï¼Œå¦‚æœæŠ›å‡ºäº† <code>UsernameNotFoundException</code>ï¼Œè¿™ä¸ªå¼‚å¸¸ä¼šè¢«æ•è·ï¼Œæ•è·ä¹‹åï¼Œå¦‚æœ <code>hideUserNotFoundExceptions</code> å±æ€§çš„å€¼ä¸º trueï¼Œå°±æŠ›å‡ºä¸€ä¸ª <code>BadCredentialsException</code>ã€‚ç›¸å½“äºå°† <code>UsernameNotFoundException </code>å¼‚å¸¸éšè—äº†ï¼Œè€Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>hideUserNotFoundExceptions</code> çš„å€¼å°±ä¸º trueã€‚</p>
<h4 id="ç™»é™†æœªéªŒè¯"><a href="#ç™»é™†æœªéªŒè¯" class="headerlink" title="ç™»é™†æœªéªŒè¯"></a>ç™»é™†æœªéªŒè¯</h4><p>åœ¨å‰åç«¯åˆ†ç¦»ä¸­ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰ç™»å½•å°±è®¿é—®ä¸€ä¸ªéœ€è¦è®¤è¯åæ‰èƒ½è®¿é—®çš„é¡µé¢ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬ä¸åº”è¯¥è®©ç”¨æˆ·é‡å®šå‘åˆ°ç™»å½•é¡µé¢ï¼Œè€Œæ˜¯ç»™ç”¨æˆ·ä¸€ä¸ªå°šæœªç™»å½•çš„æç¤ºï¼Œå‰ç«¯æ”¶åˆ°æç¤ºä¹‹åï¼Œå†è‡ªè¡Œå†³å®šé¡µé¢è·³è½¬ã€‚</p>
<p>è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±æ¶‰åŠåˆ° Spring Security ä¸­çš„ä¸€ä¸ªæ¥å£ <code>AuthenticationEntryPoint</code> ï¼Œè¯¥æ¥å£æœ‰ä¸€ä¸ªå®ç°ç±»ï¼š<code>LoginUrlAuthenticationEntryPoint</code> ï¼Œè¯¥ç±»ä¸­æœ‰ä¸€ä¸ªæ–¹æ³• <code>commence</code>ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * Performs the redirect (or forward) to the login form URL.</span>
<span class="hljs-comment"> */</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commence</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,</span></span>
<span class="hljs-function"><span class="hljs-params">		AuthenticationException authException)</span> </span>&#123;
	String redirectUrl = <span class="hljs-keyword">null</span>;
	<span class="hljs-keyword">if</span> (useForward) &#123;
		<span class="hljs-keyword">if</span> (forceHttps &amp;&amp; <span class="hljs-string">&quot;http&quot;</span>.equals(request.getScheme())) &#123;
			redirectUrl = buildHttpsRedirectUrlForRequest(request);
		&#125;
		<span class="hljs-keyword">if</span> (redirectUrl == <span class="hljs-keyword">null</span>) &#123;
			String loginForm = determineUrlToUseForThisRequest(request, response,
					authException);
			<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;
				logger.debug(<span class="hljs-string">&quot;Server side forward to: &quot;</span> + loginForm);
			&#125;
			RequestDispatcher dispatcher = request.getRequestDispatcher(loginForm);
			dispatcher.forward(request, response);
			<span class="hljs-keyword">return</span>;
		&#125;
	&#125;
	<span class="hljs-keyword">else</span> &#123;
		redirectUrl = buildRedirectUrlToLoginPage(request, response, authException);
	&#125;
	redirectStrategy.sendRedirect(request, response, redirectUrl);
&#125;</code></pre></div>

<p>é¦–å…ˆæˆ‘ä»¬ä»è¿™ä¸ªæ–¹æ³•çš„æ³¨é‡Šä¸­å°±å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥å†³å®šåˆ°åº•æ˜¯è¦é‡å®šå‘è¿˜æ˜¯è¦ forwardï¼Œé€šè¿‡ Debug è¿½è¸ªï¼Œæˆ‘ä»¬å‘ç°é»˜è®¤æƒ…å†µä¸‹ useForward çš„å€¼ä¸º falseï¼Œæ‰€ä»¥è¯·æ±‚èµ°è¿›äº†é‡å®šå‘ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬è§£å†³é—®é¢˜çš„æ€è·¯å¾ˆç®€å•ï¼Œç›´æ¥é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­è¿”å› JSON å³å¯ï¼Œä¸å†åšé‡å®šå‘æ“ä½œï¼Œå…·ä½“é…ç½®å¦‚ä¸‹ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
				.csrf().disable().exceptionHandling()
				<span class="hljs-comment">//æ²¡æœ‰è®¤è¯æ—¶ï¼Œåœ¨è¿™é‡Œå¤„ç†ç»“æœï¼Œä¸è¦é‡å®šå‘</span>
				.authenticationEntryPoint((req, resp, authException) -&gt; &#123;
            resp.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);
            resp.setStatus(<span class="hljs-number">401</span>);
            PrintWriter out = resp.getWriter();
            RespBean respBean = RespBean.error(<span class="hljs-string">&quot;è®¿é—®å¤±è´¥!&quot;</span>);
            <span class="hljs-keyword">if</span> (authException <span class="hljs-keyword">instanceof</span> InsufficientAuthenticationException) &#123;
                respBean.setMsg(<span class="hljs-string">&quot;è¯·æ±‚å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;</span>);
            &#125;
            out.write(<span class="hljs-keyword">new</span> ObjectMapper().writeValueAsString(respBean));
            out.flush();
            out.close();
        &#125;
);</code></pre></div>

<p>åœ¨ Spring Security çš„é…ç½®ä¸­åŠ ä¸Šè‡ªå®šä¹‰çš„ <code>AuthenticationEntryPoint</code> å¤„ç†æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­ç›´æ¥è¿”å›ç›¸åº”çš„ JSON æç¤ºå³å¯ã€‚è¿™æ ·ï¼Œå¦‚æœç”¨æˆ·å†å»ç›´æ¥è®¿é—®ä¸€ä¸ªéœ€è¦è®¤è¯ä¹‹åæ‰å¯ä»¥è®¿é—®çš„è¯·æ±‚ï¼Œå°±ä¸ä¼šå‘ç”Ÿé‡å®šå‘æ“ä½œäº†ï¼ŒæœåŠ¡ç«¯ä¼šç›´æ¥ç»™æµè§ˆå™¨ä¸€ä¸ª JSON æç¤ºï¼Œæµè§ˆå™¨æ”¶åˆ° JSON ä¹‹åï¼Œè¯¥å¹²å˜›å¹²å˜›ã€‚</p>
<h4 id="æ³¨é”€ç™»å½•"><a href="#æ³¨é”€ç™»å½•" class="headerlink" title="æ³¨é”€ç™»å½•"></a>æ³¨é”€ç™»å½•</h4><p>æ³¨é”€ç™»å½•æˆ‘ä»¬å‰é¢è¯´è¿‡ï¼ŒæŒ‰ç…§å‰é¢çš„é…ç½®ï¼Œæ³¨é”€ç™»å½•ä¹‹åï¼Œç³»ç»Ÿè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œè¿™ä¹Ÿæ˜¯ä¸åˆé€‚çš„ï¼Œå¦‚æœæ˜¯å‰åç«¯åˆ†ç¦»é¡¹ç›®ï¼Œæ³¨é”€ç™»å½•æˆåŠŸåè¿”å› JSON å³å¯ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        .logout()
        .logoutSuccessHandler((req, resp, authentication) -&gt; &#123;
         resp.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);
         PrintWriter out = resp.getWriter();
         out.write(<span class="hljs-keyword">new</span> ObjectMapper().writeValueAsString(RespBean.ok(<span class="hljs-string">&quot;æ³¨é”€æˆåŠŸ!&quot;</span>)));
         out.flush();
         out.close();
         &#125;
         )
         .permitAll()
&#125;</code></pre></div>

<h4 id="LoginFilterçš„é…ç½®"><a href="#LoginFilterçš„é…ç½®" class="headerlink" title="LoginFilterçš„é…ç½®"></a>LoginFilterçš„é…ç½®</h4><p>åœ¨è‡ªå®šä¹‰JSONè¿‡æ»¤å™¨åï¼ŒLoginFilterä¹Ÿéœ€è¦ç›¸åº”çš„é…ç½®åˆ°å®‰å…¨é…ç½®ç±»ä¸­</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span>
<span class="hljs-function">LoginFilter <span class="hljs-title">loginFilter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
	...
loginFilter.setAuthenticationManager(authenticationManagerBean());
loginFilter.setFilterProcessesUrl(<span class="hljs-string">&quot;/doLogin&quot;</span>);
&#125;</code></pre></div>

<p>å½“æˆ‘ä»¬ä»£æ›¿äº† <code>UsernamePasswordAuthenticationFilter</code> ä¹‹åï¼ŒåŸæœ¬åœ¨ <code>SecurityConfig#configure</code>æ–¹æ³•ä¸­å…³äº form è¡¨å•çš„é…ç½®å°±ä¼šå¤±æ•ˆï¼Œé‚£äº›å¤±æ•ˆçš„å±æ€§ï¼Œéƒ½å¯ä»¥åœ¨é…ç½® <code>LoginFilter</code> å®ä¾‹çš„æ—¶å€™é…ç½®ã€‚å¦å¤–è®°å¾—é…ç½®ä¸€ä¸ª <code>AuthenticationManager</code>ï¼Œæ ¹æ® <code>WebSecurityConfigurerAdapter</code> ä¸­æä¾›çš„é…ç½®å³å¯ã€‚</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210809192541708.png" srcset="/img/loading.gif" lazyload alt="image-20210809192541708"></p>
<p><code>FilterProcessUrl</code> åˆ™å¯ä»¥æ ¹æ®å®é™…æƒ…å†µé…ç½®ï¼Œå¦‚æœä¸é…ç½®ï¼Œé»˜è®¤çš„å°±æ˜¯ <code>/login</code>ã€‚</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210809192208902.png" srcset="/img/loading.gif" lazyload alt="image-20210809192208902"></p>
<p>æœ€åï¼Œæˆ‘ä»¬ç”¨è‡ªå®šä¹‰çš„ <code>LoginFilter</code> å®ä¾‹ä»£æ›¿ <code>UsernamePasswordAuthenticationFilter</code>ï¼Œè°ƒç”¨ addFilterAt æ–¹æ³•å®Œæˆæ›¿æ¢æ“ä½œ</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
    http.authorizeRequests()
        ...
        <span class="hljs-comment">//çœç•¥</span>
    http.addFilterAt(loginFilter(), UsernamePasswordAuthenticationFilter.class);
&#125;</code></pre></div>

<p><strong>ä¸Šé¢åŸºæœ¬å°±å·²ç»å®ç°äº†åŸºäºRBACçš„ç™»é™†æµç¨‹ï¼Œè¿™é‡Œé™„ä¸Šæ•´ä½“çš„é…ç½®ç±»ä»£ç ï¼š</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs java">**
 * <span class="hljs-meta">@author</span> lucifer
 */
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    HrService hrService;

    <span class="hljs-meta">@Autowired</span>
    CustomFilterInvocationSecurityMetadataSource customFilterInvocationSecurityMetadataSource;

    <span class="hljs-meta">@Autowired</span>
    CustomUrlDecisionManager customUrlDecisionManager;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function">PasswordEncoder <span class="hljs-title">passwordEncoder</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BCryptPasswordEncoder();
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        auth.userDetailsService(hrService);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        <span class="hljs-comment">//é˜²æ­¢è®¿é—®ç™»å½•é¡µé¢æ­»å¾ªç¯ï¼Œä¸ç”¨è¿›å…¥Securityæ‹¦æˆª</span>
        web.ignoring().antMatchers(<span class="hljs-string">&quot;/css/**&quot;</span>, <span class="hljs-string">&quot;/js/**&quot;</span>, <span class="hljs-string">&quot;/index.html&quot;</span>, <span class="hljs-string">&quot;/img/**&quot;</span>, <span class="hljs-string">&quot;/fonts/**&quot;</span>, <span class="hljs-string">&quot;/favicon.ico&quot;</span>, <span class="hljs-string">&quot;/verifyCode&quot;</span>);
    &#125;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function">LoginFilter <span class="hljs-title">loginFilter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        LoginFilter loginFilter = <span class="hljs-keyword">new</span> LoginFilter();
        loginFilter.setAuthenticationSuccessHandler((request, response, authentication) -&gt; &#123;
                    response.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);
                    PrintWriter out = response.getWriter();
                    Hr hr = (Hr) authentication.getPrincipal();
                    hr.setPassword(<span class="hljs-keyword">null</span>);
                    RespBean ok = RespBean.ok(<span class="hljs-string">&quot;ç™»å½•æˆåŠŸ!&quot;</span>, hr);
                    String s = <span class="hljs-keyword">new</span> ObjectMapper().writeValueAsString(ok);
                    out.write(s);
                    out.flush();
                    out.close();
                &#125;
        );
        loginFilter.setAuthenticationFailureHandler((request, response, exception) -&gt; &#123;
                    response.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);
                    PrintWriter out = response.getWriter();
                    RespBean respBean = RespBean.error(exception.getMessage());
                    <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> LockedException) &#123;
                        respBean.setMsg(<span class="hljs-string">&quot;è´¦æˆ·è¢«é”å®šï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;</span>);
                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> CredentialsExpiredException) &#123;
                        respBean.setMsg(<span class="hljs-string">&quot;å¯†ç è¿‡æœŸï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;</span>);
                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> AccountExpiredException) &#123;
                        respBean.setMsg(<span class="hljs-string">&quot;è´¦æˆ·è¿‡æœŸï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;</span>);
                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> DisabledException) &#123;
                        respBean.setMsg(<span class="hljs-string">&quot;è´¦æˆ·è¢«ç¦ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;</span>);
                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> BadCredentialsException) &#123;
                        respBean.setMsg(<span class="hljs-string">&quot;ç”¨æˆ·åæˆ–è€…å¯†ç è¾“å…¥é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥!&quot;</span>);
                    &#125;
                    out.write(<span class="hljs-keyword">new</span> ObjectMapper().writeValueAsString(respBean));
                    out.flush();
                    out.close();
                &#125;
        );
        loginFilter.setAuthenticationManager(authenticationManagerBean());
        loginFilter.setFilterProcessesUrl(<span class="hljs-string">&quot;/doLogin&quot;</span>);
        <span class="hljs-keyword">return</span> loginFilter;
    &#125;


    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        http.authorizeRequests()
                .withObjectPostProcessor(<span class="hljs-keyword">new</span> ObjectPostProcessor&lt;FilterSecurityInterceptor&gt;() &#123;
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> &lt;O extends FilterSecurityInterceptor&gt; <span class="hljs-function">O <span class="hljs-title">postProcess</span><span class="hljs-params">(O object)</span> </span>&#123;
                        object.setAccessDecisionManager(customUrlDecisionManager);
                        object.setSecurityMetadataSource(customFilterInvocationSecurityMetadataSource);
                        <span class="hljs-keyword">return</span> object;
                    &#125;
                &#125;)
                .and()
                .logout()
                .logoutSuccessHandler((req, resp, authentication) -&gt; &#123;
                            resp.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);
                            PrintWriter out = resp.getWriter();
                            out.write(<span class="hljs-keyword">new</span> ObjectMapper().writeValueAsString(RespBean.ok(<span class="hljs-string">&quot;æ³¨é”€æˆåŠŸ!&quot;</span>)));
                            out.flush();
                            out.close();
                        &#125;
                )
                .permitAll()
                .and()
                .csrf().disable().exceptionHandling()
                <span class="hljs-comment">//æ²¡æœ‰è®¤è¯æ—¶ï¼Œåœ¨è¿™é‡Œå¤„ç†ç»“æœï¼Œä¸è¦é‡å®šå‘</span>
                .authenticationEntryPoint((req, resp, authException) -&gt; &#123;
                            resp.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);
                            resp.setStatus(<span class="hljs-number">401</span>);
                            PrintWriter out = resp.getWriter();
                            RespBean respBean = RespBean.error(<span class="hljs-string">&quot;è®¿é—®å¤±è´¥!&quot;</span>);
                            <span class="hljs-keyword">if</span> (authException <span class="hljs-keyword">instanceof</span> InsufficientAuthenticationException) &#123;
                                respBean.setMsg(<span class="hljs-string">&quot;è¯·æ±‚å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;</span>);
                            &#125;
                            out.write(<span class="hljs-keyword">new</span> ObjectMapper().writeValueAsString(respBean));
                            out.flush();
                            out.close();
                        &#125;
                );
        http.addFilterAt(loginFilter(), UsernamePasswordAuthenticationFilter.class);
    &#125;
&#125;</code></pre></div>

<h3 id="http-authorizeRequests"><a href="#http-authorizeRequests" class="headerlink" title="http.authorizeRequests()"></a>http.authorizeRequests()</h3><p>å¯ä»¥å‘ç°åœ¨é…ç½®ä¸­çš„å¼€å¤´æœ‰è¿™æ ·çš„é…ç½®ï¼Œè¿™ä¸ªæ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ</p>
<p>è¿™å°±æ¶‰åŠåˆ° Spring Security ä¸­è¿‡æ»¤å™¨é“¾çš„é…ç½®é—®é¢˜äº†</p>
<blockquote>
<p>ç»“åˆåŠ¨æ€å¤„ç†è§’è‰²å’Œèµ„æºçš„å…³ç³»ä¸€èµ·çœ‹</p>
</blockquote>
<h4 id="ä»è¿‡æ»¤å™¨å¼€å§‹"><a href="#ä»è¿‡æ»¤å™¨å¼€å§‹" class="headerlink" title="ä»è¿‡æ»¤å™¨å¼€å§‹"></a>ä»è¿‡æ»¤å™¨å¼€å§‹</h4><p>Spring Security ä¸­ä¸€å…±æä¾›äº† 32 ä¸ªè¿‡æ»¤å™¨ï¼Œå…¶ä¸­é»˜è®¤ä½¿ç”¨çš„æœ‰ 15 ä¸ªï¼Œ</p>
<p>åœ¨ä¸€ä¸ª Web é¡¹ç›®ä¸­ï¼Œè¯·æ±‚æµç¨‹å¤§æ¦‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210809220745044.png" srcset="/img/loading.gif" lazyload alt="image-20210809220745044" style="zoom:50%;" />

<p>è¯·æ±‚ä»å®¢æˆ·ç«¯å‘èµ·ï¼ˆä¾‹å¦‚æµè§ˆå™¨ï¼‰ï¼Œç„¶åç©¿è¿‡å±‚å±‚ Filterï¼Œæœ€ç»ˆæ¥åˆ° Servlet ä¸Šï¼Œè¢« Servlet æ‰€å¤„ç†ã€‚</p>
<p>é‚£ä¹ˆï¼ŒSpring Security ä¸­é»˜è®¤çš„ 15 ä¸ªè¿‡æ»¤å™¨å°±æ˜¯è¿™æ ·åµŒå¥—åœ¨ Client å’Œ Servlet ä¹‹é—´å—ï¼Ÿ</p>
<p>ä¸æ˜¯çš„ï¼</p>
<p>ä¸Šå›¾ä¸­çš„ Filter æˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸º Web Filterï¼ŒSpring Security ä¸­çš„ Filter æˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸º Security Filterï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210809220801972.png" srcset="/img/loading.gif" lazyload alt="image-20210809220801972"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒSpring Security Filter å¹¶ä¸æ˜¯ç›´æ¥åµŒå…¥åˆ° Web Filter ä¸­çš„ï¼Œè€Œæ˜¯é€šè¿‡ <code>FilterChainProxy</code> æ¥ç»Ÿä¸€ç®¡ç† Spring Security Filterï¼Œ<code>FilterChainProxy</code> æœ¬èº«åˆ™é€šè¿‡ Spring æä¾›çš„ <code>DelegatingFilterProxy </code>ä»£ç†è¿‡æ»¤å™¨åµŒå…¥åˆ° Web Filter ä¹‹ä¸­ã€‚</p>
<blockquote>
<p>DelegatingFilterProxy å¾ˆå¤šå°ä¼™ä¼´åº”è¯¥æ¯”è¾ƒç†Ÿæ‚‰ï¼Œåœ¨ Spring ä¸­æ‰‹å·¥æ•´åˆ Spring Sessionã€Shiro ç­‰å·¥å…·æ—¶éƒ½ç¦»ä¸å¼€å®ƒï¼Œç°åœ¨ç”¨äº† Spring Bootï¼Œå¾ˆå¤šäº‹æƒ… Spring Boot å¸®æˆ‘ä»¬åšäº†ï¼Œæ‰€ä»¥æœ‰æ—¶å€™ä¼šæ„Ÿè§‰ DelegatingFilterProxy çš„å­˜åœ¨æ„Ÿæœ‰æ‰€é™ä½ï¼Œå®é™…ä¸Šå®ƒä¸€ç›´éƒ½åœ¨ã€‚</p>
</blockquote>
<h4 id="å¤šä¸ªè¿‡æ»¤å™¨é“¾"><a href="#å¤šä¸ªè¿‡æ»¤å™¨é“¾" class="headerlink" title="å¤šä¸ªè¿‡æ»¤å™¨é“¾"></a>å¤šä¸ªè¿‡æ»¤å™¨é“¾</h4><p>ä¸Šé¢å’Œå¤§å®¶ä»‹ç»çš„æ˜¯å•ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œå®é™…ä¸Šï¼Œåœ¨ Spring Security ä¸­ï¼Œå¯èƒ½å­˜åœ¨å¤šä¸ªè¿‡æ»¤å™¨é“¾ã€‚</p>
<p>æœ‰äººä¼šé—®ï¼Œä¸‹é¢è¿™ç§é…ç½®æ˜¯ä¸æ˜¯å°±æ˜¯å¤šä¸ªè¿‡æ»¤å™¨é“¾ï¼Ÿ</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
    http.authorizeRequests()
            .antMatchers(<span class="hljs-string">&quot;/admin/**&quot;</span>).hasRole(<span class="hljs-string">&quot;admin&quot;</span>)
            .antMatchers(<span class="hljs-string">&quot;/user/**&quot;</span>).hasRole(<span class="hljs-string">&quot;user&quot;</span>)
            .anyRequest().authenticated()
            ...
            .csrf().disable();
&#125;</code></pre></div>

<p>è¿™æ ·çš„é…ç½®ç›¸ä¿¡å¤§å®¶éƒ½è§è¿‡ï¼Œä½†æ˜¯è¿™å¹¶ä¸æ˜¯å¤šä¸ªè¿‡æ»¤å™¨é“¾ï¼Œè¿™æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ã€‚å› ä¸ºä¸ç®¡æ˜¯ <code>/admin/**</code> è¿˜æ˜¯ <code>/user/**</code> ï¼Œèµ°è¿‡çš„è¿‡æ»¤å™¨éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯ä¸åŒçš„è·¯å¾„åˆ¤æ–­æ¡ä»¶ä¸ä¸€æ ·è€Œå·²ã€‚</p>
<p>å¦‚æœç³»ç»Ÿå­˜åœ¨å¤šä¸ªè¿‡æ»¤å™¨é“¾ï¼Œå¤šä¸ªè¿‡æ»¤å™¨é“¾ä¼šåœ¨ FilterChainProxy ä¸­è¿›è¡Œåˆ’åˆ†ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210809220817060.png" srcset="/img/loading.gif" lazyload alt="image-20210809220817060"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå½“è¯·æ±‚åˆ°è¾¾ <code>FilterChainProxy</code> ä¹‹åï¼Œ<code>FilterChainProxy</code> ä¼šæ ¹æ®è¯·æ±‚çš„è·¯å¾„ï¼Œå°†è¯·æ±‚è½¬å‘åˆ°ä¸åŒçš„ Spring Security Filters ä¸Šé¢å»ï¼Œä¸åŒçš„ Spring Security Filters å¯¹åº”äº†ä¸åŒçš„è¿‡æ»¤å™¨ï¼Œä¹Ÿå°±æ˜¯ä¸åŒçš„è¯·æ±‚å°†ç»è¿‡ä¸åŒçš„è¿‡æ»¤å™¨ã€‚</p>
<h4 id="å›åˆ°é—®é¢˜"><a href="#å›åˆ°é—®é¢˜" class="headerlink" title="å›åˆ°é—®é¢˜"></a>å›åˆ°é—®é¢˜</h4><p>æœ€åï¼Œæˆ‘ä»¬åœ¨å›åˆ°ä¸€å¼€å§‹çš„é—®é¢˜ã€‚</p>
<p>é¦–å…ˆï¼Œ<code>http.authorizeRequests()</code> é…ç½®å¹¶éæ€»åœ¨ç¬¬ä¸€è¡Œå‡ºç°ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œä»–æ€»æ˜¯åœ¨ç¬¬ä¸€è¡Œå‡ºç°ï¼Œè¡¨ç¤ºè¯¥è¿‡æ»¤å™¨é“¾çš„æ‹¦æˆªè§„åˆ™æ˜¯ <code>/**</code>ï¼ˆ<strong>è¯·æ±‚åªæœ‰å…ˆè¢«è¿‡æ»¤å™¨é“¾æ‹¦æˆªä¸‹æ¥ï¼Œæ¥ä¸‹æ¥æ‰ä¼šè¿›å…¥åˆ°ä¸åŒçš„ Security Filters ä¸­è¿›è¡Œå¤„ç†</strong>ï¼‰ï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªè¿‡æ»¤å™¨é“¾ï¼Œå°±ä¸ä¸€å®šäº†ã€‚</p>
<div class="hljs code-wrapper"><pre><code class="hljs java">    <span class="hljs-meta">@Configuration</span>
    <span class="hljs-meta">@Order(1)</span>
    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultWebSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;

        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
            http.antMatcher(<span class="hljs-string">&quot;/foo/**&quot;</span>)
                    .authorizeRequests()
                    .anyRequest().hasRole(<span class="hljs-string">&quot;admin&quot;</span>)
                    .and()
                    .csrf().disable();
        &#125;
    &#125;

    <span class="hljs-meta">@Configuration</span>
    <span class="hljs-meta">@Order(2)</span>
    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultWebSecurityConfig2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;

        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
            http.antMatcher(<span class="hljs-string">&quot;/bar/**&quot;</span>)
                    .authorizeRequests()
                    .anyRequest().hasRole(<span class="hljs-string">&quot;user&quot;</span>)
                    .and()
                    .formLogin()
                    .permitAll()
                    .and()
                    .csrf().disable();
        &#125;
    &#125;
&#125;</code></pre></div>

<ol>
<li>æ³¨æ„åœ¨é™æ€å†…éƒ¨ç±»é‡Œè¾¹ï¼Œæˆ‘æ²¡æœ‰ä½¿ç”¨ <code>http.authorizeRequests()</code> å¼€å§‹ï¼Œ<code>http.authorizeRequests()</code> é…ç½®è¡¨ç¤ºè¯¥è¿‡æ»¤å™¨é“¾è¿‡æ»¤çš„è·¯å¾„æ˜¯ <code>/**</code>ã€‚åœ¨é™æ€å†…éƒ¨ç±»é‡Œè¾¹ï¼Œæˆ‘æ˜¯ç”¨äº† <code>http.antMatcher(&quot;/bar/**&quot;)</code> å¼€å¯é…ç½®ï¼Œè¡¨ç¤ºå°†å½“å‰è¿‡æ»¤å™¨é“¾çš„æ‹¦æˆªèŒƒå›´é™å®šåœ¨ <code>/bar/**</code>ã€‚</li>
<li>å½“å­˜åœ¨å¤šä¸ªè¿‡æ»¤å™¨é“¾çš„æ—¶å€™ï¼Œå¿…ç„¶ä¼šæœ‰ä¸€ä¸ªä¼˜å…ˆçº§çš„é—®é¢˜ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªè¿‡æ»¤å™¨é“¾çš„é…ç½®ç±»ä¸Šé€šè¿‡ @Order(2) æ³¨è§£æ¥æ ‡è®°ä¼˜å…ˆçº§ã€‚</li>
</ol>
<p>ä»…ä»…ä»å­—é¢æ„æ€æ¥ç†è§£ï¼Œ<code>authorizeRequests()</code> æ–¹æ³•çš„è¿”å›å€¼æ˜¯ <code>ExpressionUrlAuthorizationConfigurer.ExpressionInterceptUrlRegistryï¼ŒExpressionUrlAuthorizationConfigurer</code> å¯ä»¥ä¸ºå¤šç»„ä¸åŒçš„ RequestMatcher é…ç½®ä¸åŒçš„æƒé™è§„åˆ™ï¼Œå°±æ˜¯å¤§å®¶çœ‹åˆ°çš„ <code>.antMatchers(&quot;/admin/**&quot;).hasRole(&quot;admin&quot;).antMatchers(&quot;/user/**&quot;).hasRole(&quot;user&quot;)</code>ã€‚</p>
<p><strong>å¯¹äºé…ç½®ä¸­çš„ä¸€äº›ç»†èŠ‚ï¼ˆä¸ºä»€ä¹ˆè¦ç”¨è¿™äº›æ¥å®ç°ï¼‰ï¼Œå°†åœ¨ä¸‹é¢ç”¨æºç æ¥è¿›è¡Œåˆ†æï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥äº†è§£ä¸‹</strong></p>
<h2 id="ğŸ”§åŠ é¤ï¼šæºç å‰–æSpring-Security"><a href="#ğŸ”§åŠ é¤ï¼šæºç å‰–æSpring-Security" class="headerlink" title="ğŸ”§åŠ é¤ï¼šæºç å‰–æSpring Security"></a>ğŸ”§åŠ é¤ï¼šæºç å‰–æSpring Security</h2><blockquote>
<p>æœ¬æ–‡åŸºæœ¬ä¸Šå‚è€ƒæ¬è¿äº†æ¾å“¥çš„æ–‡ç« ï¼Œæ¾å“¥å¯¹Spring Securityç†è§£çš„ååˆ†é€å½»ï¼Œæ¨èå»å­¦ä¹ ï¼Œé™„ä¸Šç½‘ç«™ï¼š<a target="_blank" rel="noopener" href="http://www.javaboy.org/">http://www.javaboy.org</a></p>
</blockquote>
<p>æœ¬éƒ¨åˆ†ä¸»è¦é’ˆå¯¹<code>HttpSecurityã€SecurityConfigurerã€AuthenticationManagerBuilderã€WebSecurityConfigurerAdapter</code>å››éƒ¨åˆ†è¿›è¡Œæºç åˆ†æï¼Œå…¶ä»–å…³é”®çš„ç±»å·²åœ¨å‰é¢çš„éƒ¨åˆ†åšäº†å¿…è¦çš„é˜è¿°</p>
<h3 id="ğŸ‘€HttpSecurity"><a href="#ğŸ‘€HttpSecurity" class="headerlink" title="ğŸ‘€HttpSecurity"></a>ğŸ‘€HttpSecurity</h3><blockquote>
<p>æ­¤èŠ‚å»ºè®®ç»“åˆç™»é™†çš„éªŒè¯ä¸­çš„é…ç½®ç±»æ¥çœ‹</p>
</blockquote>
<p><code>HttpSecurity</code> ä¹Ÿæ˜¯ Spring Security ä¸­çš„é‡è¦ä¸€ç¯ã€‚æˆ‘ä»¬å¹³æ—¶æ‰€åšçš„å¤§éƒ¨åˆ† Spring Security é…ç½®ä¹Ÿéƒ½æ˜¯åŸºäº <code>HttpSecurity </code>æ¥é…ç½®çš„ã€‚æ¯”å¦‚ï¼Œåˆšæ‰æˆ‘ä»¬é…ç½®ç±»ä¸­çš„<code>configure</code>å°±ä½¿ç”¨åˆ°äº†</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception</span></code></pre></div>

<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸‹ HttpSecurity çš„ç»§æ‰¿å…³ç³»å›¾ï¼š</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210809220933162.png" srcset="/img/loading.gif" lazyload alt="image-20210809220933162"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>HttpSecurity</code> ç»§æ‰¿è‡ª <code>AbstractConfiguredSecurityBuilder</code>ï¼ŒåŒæ—¶å®ç°äº† <code>SecurityBuilder </code>å’Œ <code>HttpSecurityBuilder</code> ä¸¤ä¸ªæ¥å£ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>HttpSecurity</code> çš„å®šä¹‰ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpSecurity</span> <span class="hljs-keyword">extends</span></span>
<span class="hljs-class">  <span class="hljs-title">AbstractConfiguredSecurityBuilder</span>&lt;<span class="hljs-title">DefaultSecurityFilterChain</span>, <span class="hljs-title">HttpSecurity</span>&gt;</span>
<span class="hljs-class">  <span class="hljs-keyword">implements</span> <span class="hljs-title">SecurityBuilder</span>&lt;<span class="hljs-title">DefaultSecurityFilterChain</span>&gt;,</span>
<span class="hljs-class">  <span class="hljs-title">HttpSecurityBuilder</span>&lt;<span class="hljs-title">HttpSecurity</span>&gt; </span>&#123;
        <span class="hljs-comment">//...</span>
&#125;</code></pre></div>

<p>è¿™é‡Œæ¯ä¸€ä¸ªç±»éƒ½å¸¦æœ‰æ³›å‹ï¼Œçœ‹å¾—äººæœ‰ç‚¹çœ¼èŠ±ç¼­ä¹±ã€‚</p>
<p>æˆ‘æŠŠè¿™ä¸ªæ³›å‹ç±»æ‹¿å‡ºæ¥å’Œå¤§å®¶è®²ä¸€ä¸‹ï¼Œå°ä¼™ä¼´ä»¬å°±æ˜ç™½äº†ã€‚</p>
<p>æ³›å‹ä¸»è¦æ˜¯ä¸¤ä¸ªï¼Œ<code>DefaultSecurityFilterChain</code> å’Œ <code>HttpSecurity</code>ï¼Œ<code>HttpSecurity</code> å°±ä¸ç”¨è¯´äº†ï¼Œè¿™æ˜¯æˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’ï¼Œé‚£ä¹ˆ <code>DefaultSecurityFilterChain</code> æ˜¯å¹²å˜›çš„ï¼Ÿ</p>
<p>è¿™æˆ‘ä»¬å°±å¾—ä» <code>SecurityFilterChain</code> è¯´èµ·äº†ã€‚</p>
<h4 id="SecurityFilterChain"><a href="#SecurityFilterChain" class="headerlink" title="SecurityFilterChain"></a>SecurityFilterChain</h4><p>å…ˆæ¥çœ‹å®šä¹‰ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SecurityFilterChain</span> </span>&#123;
 <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">matches</span><span class="hljs-params">(HttpServletRequest request)</span></span>;
 <span class="hljs-function">List&lt;Filter&gt; <span class="hljs-title">getFilters</span><span class="hljs-params">()</span></span>;
&#125;</code></pre></div>

<p><code>SecurityFilterChain</code> å…¶å®å°±æ˜¯æˆ‘ä»¬å¹³æ—¶æ‰€è¯´çš„ Spring Security ä¸­çš„è¿‡æ»¤å™¨é“¾ï¼Œå®ƒé‡Œè¾¹å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ matches æ–¹æ³•ç”¨æ¥åŒ¹é…è¯·æ±‚ï¼Œå¦å¤–ä¸€ä¸ª getFilters æ–¹æ³•è¿”å›ä¸€ä¸ª List é›†åˆï¼Œé›†åˆä¸­æ”¾ç€ Filter å¯¹è±¡ï¼Œå½“ä¸€ä¸ªè¯·æ±‚åˆ°æ¥æ—¶ï¼Œç”¨ matches æ–¹æ³•å»æ¯”è¾ƒè¯·æ±‚æ˜¯å¦å’Œå½“å‰é“¾å»åˆï¼Œå¦‚æœå»åˆï¼Œå°±è¿”å› getFilters æ–¹æ³•ä¸­çš„è¿‡æ»¤å™¨ï¼Œé‚£ä¹ˆå½“å‰è¯·æ±‚ä¼šé€ä¸ªç»è¿‡ List é›†åˆä¸­çš„è¿‡æ»¤å™¨ã€‚</p>
<p><code>SecurityFilterChain </code>æ¥å£åªæœ‰ä¸€ä¸ªå®ç°ç±»ï¼Œé‚£å°±æ˜¯ <code>DefaultSecurityFilterChain</code>ï¼Œ<strong>é‚£ä¹ˆä»ä¸Šé¢çš„ä»‹ç»ä¸­ï¼Œå¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œ<code>DefaultSecurityFilterChain</code> å…¶å®å°±ç›¸å½“äºæ˜¯ Spring Security ä¸­çš„è¿‡æ»¤å™¨é“¾ï¼Œä¸€ä¸ª <code>DefaultSecurityFilterChain</code> ä»£è¡¨ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œå¦‚æœç³»ç»Ÿä¸­å­˜åœ¨å¤šä¸ªè¿‡æ»¤å™¨é“¾ï¼Œåˆ™ä¼šå­˜åœ¨å¤šä¸ª <code>DefaultSecurityFilterChain</code> å¯¹è±¡ã€‚</strong></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æŠŠ <code>HttpSecurity</code> çš„è¿™å‡ ä¸ªçˆ¶ç±»æ‹ä¸€æ‹ã€‚</p>
<h4 id="âš ï¸SecurityBuilder"><a href="#âš ï¸SecurityBuilder" class="headerlink" title="âš ï¸SecurityBuilder"></a>âš ï¸SecurityBuilder</h4><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SecurityBuilder</span>&lt;<span class="hljs-title">O</span>&gt; </span>&#123;
 <span class="hljs-function">O <span class="hljs-title">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>;
&#125;</code></pre></div>

<p><code>SecurityBuilder </code>å°±æ˜¯ç”¨æ¥æ„å»ºè¿‡æ»¤å™¨é“¾çš„ï¼Œåœ¨ <code>HttpSecurity</code> å®ç° <code>SecurityBuilder</code> æ—¶ï¼Œä¼ å…¥çš„æ³›å‹å°±æ˜¯ <code>DefaultSecurityFilterChain</code>ï¼Œæ‰€ä»¥ <code>SecurityBuilder#build</code> æ–¹æ³•çš„åŠŸèƒ½å¾ˆæ˜ç¡®ï¼Œå°±æ˜¯ç”¨æ¥æ„å»ºä¸€ä¸ªè¿‡æ»¤å™¨é“¾å‡ºæ¥ã€‚</p>
<h4 id="HttpSecurityBuilder"><a href="#HttpSecurityBuilder" class="headerlink" title="HttpSecurityBuilder"></a>HttpSecurityBuilder</h4><p><code>HttpSecurityBuilder</code> çœ‹åå­—å°±æ˜¯ç”¨æ¥æ„å»º <code>HttpSecurity</code> çš„ã€‚ä¸è¿‡å®ƒä¹Ÿåªæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…·ä½“çš„å®ç°åœ¨ <code>HttpSecurity </code>ä¸­ï¼Œæ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">HttpSecurityBuilder</span>&lt;<span class="hljs-title">H</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpSecurityBuilder</span>&lt;<span class="hljs-title">H</span>&gt;&gt; <span class="hljs-keyword">extends</span></span>
<span class="hljs-class">  <span class="hljs-title">SecurityBuilder</span>&lt;<span class="hljs-title">DefaultSecurityFilterChain</span>&gt; </span>&#123;
 &lt;C extends SecurityConfigurer&lt;DefaultSecurityFilterChain, H&gt;&gt; <span class="hljs-function">C <span class="hljs-title">getConfigurer</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">   Class&lt;C&gt; clazz)</span></span>;
 &lt;C extends SecurityConfigurer&lt;DefaultSecurityFilterChain, H&gt;&gt; <span class="hljs-function">C <span class="hljs-title">removeConfigurer</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">   Class&lt;C&gt; clazz)</span></span>;
 &lt;C&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setSharedObject</span><span class="hljs-params">(Class&lt;C&gt; sharedType, C object)</span></span>;
 &lt;C&gt; <span class="hljs-function">C <span class="hljs-title">getSharedObject</span><span class="hljs-params">(Class&lt;C&gt; sharedType)</span></span>;
 <span class="hljs-function">H <span class="hljs-title">authenticationProvider</span><span class="hljs-params">(AuthenticationProvider authenticationProvider)</span></span>;
 <span class="hljs-function">H <span class="hljs-title">userDetailsService</span><span class="hljs-params">(UserDetailsService userDetailsService)</span> <span class="hljs-keyword">throws</span> Exception</span>;
 <span class="hljs-function">H <span class="hljs-title">addFilterAfter</span><span class="hljs-params">(Filter filter, Class&lt;? extends Filter&gt; afterFilter)</span></span>;
 <span class="hljs-function">H <span class="hljs-title">addFilterBefore</span><span class="hljs-params">(Filter filter, Class&lt;? extends Filter&gt; beforeFilter)</span></span>;
 <span class="hljs-function">H <span class="hljs-title">addFilter</span><span class="hljs-params">(Filter filter)</span></span>;
&#125;</code></pre></div>

<p>è¿™é‡Œçš„æ–¹æ³•æ¯”è¾ƒç®€å•ï¼š</p>
<ol>
<li><code>getConfigurer</code> è·å–ä¸€ä¸ªé…ç½®å¯¹è±¡ã€‚Spring Security è¿‡æ»¤å™¨é“¾ä¸­çš„æ‰€æœ‰è¿‡æ»¤å™¨å¯¹è±¡éƒ½æ˜¯ç”± xxxConfigure æ¥è¿›è¡Œé…ç½®çš„ï¼Œè¿™é‡Œå°±æ˜¯è·å–è¿™ä¸ª xxxConfigure å¯¹è±¡ã€‚</li>
<li><code>removeConfigurer</code> ç§»é™¤ä¸€ä¸ªé…ç½®å¯¹è±¡ã€‚</li>
<li><code>setSharedObject/getSharedObject</code> é…ç½®/è·å–ç”±å¤šä¸ª <code>SecurityConfigurer</code> å…±äº«çš„å¯¹è±¡ã€‚</li>
<li><code>authenticationProvider</code> æ–¹æ³•è¡¨ç¤ºé…ç½®éªŒè¯å™¨ã€‚</li>
<li><code>userDetailsService</code> é…ç½®æ•°æ®æºæ¥å£ã€‚</li>
<li><code>addFilterAfter</code> åœ¨æŸä¸€ä¸ªè¿‡æ»¤å™¨ä¹‹å‰æ·»åŠ è¿‡æ»¤å™¨ã€‚</li>
<li><code>addFilterBefore</code> åœ¨æŸä¸€ä¸ªè¿‡æ»¤å™¨ä¹‹åæ·»åŠ è¿‡æ»¤å™¨ã€‚</li>
<li><code>addFilter</code> æ·»åŠ ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œè¯¥è¿‡æ»¤å™¨å¿…é¡»æ˜¯ç°æœ‰è¿‡æ»¤å™¨é“¾ä¸­æŸä¸€ä¸ªè¿‡æ»¤å™¨æˆ–è€…å…¶æ‰©å±•ã€‚</li>
</ol>
<p>è¿™ä¾¿æ˜¯ <code>HttpSecurityBuilder</code> ä¸­çš„åŠŸèƒ½ï¼Œè¿™äº›æ¥å£åœ¨<code>HttpSecurity</code>ä¸­éƒ½å°†å¾—åˆ°å®ç°ã€‚</p>
<h4 id="AbstractSecurityBuilder"><a href="#AbstractSecurityBuilder" class="headerlink" title="AbstractSecurityBuilder"></a>AbstractSecurityBuilder</h4><p><code>AbstractSecurityBuilder </code>ç±»å®ç°äº† <code>SecurityBuilder</code> æ¥å£ï¼Œè¯¥ç±»ä¸­ä¸»è¦åšäº†ä¸€ä»¶äº‹ï¼Œå°±æ˜¯ç¡®ä¿æ•´ä¸ªæ„å»ºåªè¢«æ„å»ºä¸€æ¬¡ã€‚</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractSecurityBuilder</span>&lt;<span class="hljs-title">O</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">SecurityBuilder</span>&lt;<span class="hljs-title">O</span>&gt; </span>&#123;
 <span class="hljs-keyword">private</span> AtomicBoolean building = <span class="hljs-keyword">new</span> AtomicBoolean();
 <span class="hljs-keyword">private</span> O object;
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> O <span class="hljs-title">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.building.compareAndSet(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>)) &#123;
   <span class="hljs-keyword">this</span>.object = doBuild();
   <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.object;
  &#125;
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AlreadyBuiltException(<span class="hljs-string">&quot;This object has already been built&quot;</span>);
 &#125;
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> O <span class="hljs-title">getObject</span><span class="hljs-params">()</span> </span>&#123;
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.building.get()) &#123;
   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;This object has not been built&quot;</span>);
  &#125;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.object;
 &#125;
 <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> O <span class="hljs-title">doBuild</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>;
&#125;</code></pre></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œé‡æ–°å®šä¹‰äº† build æ–¹æ³•ï¼Œå¹¶è®¾ç½® build æ–¹æ³•ä¸º final ç±»å‹ï¼Œæ— æ³•è¢«é‡å†™ï¼Œåœ¨ build æ–¹æ³•ä¸­ï¼Œé€šè¿‡ <code>AtomicBoolean</code> å®ç°è¯¥æ–¹æ³•åªè¢«è°ƒç”¨ä¸€æ¬¡ã€‚å…·ä½“çš„æ„å»ºé€»è¾‘åˆ™å®šä¹‰äº†æ–°çš„æŠ½è±¡æ–¹æ³• doBuildï¼Œå°†æ¥åœ¨å®ç°ç±»ä¸­é€šè¿‡ doBuild æ–¹æ³•å®šä¹‰æ„å»ºé€»è¾‘ã€‚</p>
<h4 id="AbstractConfiguredSecurityBuilder"><a href="#AbstractConfiguredSecurityBuilder" class="headerlink" title="AbstractConfiguredSecurityBuilder"></a>AbstractConfiguredSecurityBuilder</h4><p><code>AbstractSecurityBuilder</code> æ–¹æ³•çš„å®ç°ç±»å°±æ˜¯ <code>AbstractConfiguredSecurityBuilder</code>ã€‚</p>
<p><code>AbstractConfiguredSecurityBuilder</code> ä¸­æ‰€åšçš„äº‹æƒ…å°±æ¯”è¾ƒå¤šäº†ï¼Œæˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ã€‚</p>
<p>é¦–å…ˆ <code>AbstractConfiguredSecurityBuilder</code> ä¸­å®šä¹‰äº†ä¸€ä¸ªæšä¸¾ç±»ï¼Œå°†æ•´ä¸ªæ„å»ºè¿‡ç¨‹åˆ†ä¸º 5 ç§çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºæ„å»ºè¿‡ç¨‹ç”Ÿå‘½å‘¨æœŸçš„äº”ä¸ªé˜¶æ®µï¼Œå¦‚ä¸‹ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">BuildState</span> </span>&#123;
 UNBUILT(<span class="hljs-number">0</span>),
 INITIALIZING(<span class="hljs-number">1</span>),
 CONFIGURING(<span class="hljs-number">2</span>),
 BUILDING(<span class="hljs-number">3</span>),
 BUILT(<span class="hljs-number">4</span>);
 <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> order;
 BuildState(<span class="hljs-keyword">int</span> order) &#123;
  <span class="hljs-keyword">this</span>.order = order;
 &#125;
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isInitializing</span><span class="hljs-params">()</span> </span>&#123;
  <span class="hljs-keyword">return</span> INITIALIZING.order == order;
 &#125;
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isConfigured</span><span class="hljs-params">()</span> </span>&#123;
  <span class="hljs-keyword">return</span> order &gt;= CONFIGURING.order;
 &#125;
&#125;</code></pre></div>

<p>äº”ç§çŠ¶æ€åˆ†åˆ«æ˜¯ UNBUILTã€INITIALIZINGã€CONFIGURINGã€BUILDING ä»¥åŠ BUILTã€‚å¦å¤–è¿˜æä¾›äº†ä¸¤ä¸ªåˆ¤æ–­æ–¹æ³•ï¼ŒisInitializing åˆ¤æ–­æ˜¯å¦æ­£åœ¨åˆå§‹åŒ–ï¼ŒisConfigured è¡¨ç¤ºæ˜¯å¦å·²ç»é…ç½®å®Œæ¯•ã€‚</p>
<p><code>AbstractConfiguredSecurityBuilder</code> ä¸­çš„æ–¹æ³•æ¯”è¾ƒå¤šï¼Œåœ¨è¿™é‡Œåˆ—å‡ºæ¥ä¸¤ä¸ªå…³é”®çš„æ–¹æ³•å’Œå¤§å®¶åˆ†æï¼š</p>
<ul>
<li>ç¬¬ä¸€ä¸ªå°±æ˜¯è¿™ä¸ª add æ–¹æ³•ï¼Œè¿™ç›¸å½“äºæ˜¯åœ¨æ”¶é›†æ‰€æœ‰çš„é…ç½®ç±»ã€‚å°†æ‰€æœ‰çš„ xxxConfigure æ”¶é›†èµ·æ¥å­˜å‚¨åˆ° configurers ä¸­ï¼Œå°†æ¥å†ç»Ÿä¸€åˆå§‹åŒ–å¹¶é…ç½®ï¼Œconfigurers æœ¬èº«æ˜¯ä¸€ä¸ª LinkedHashMap ï¼Œkey æ˜¯é…ç½®ç±»çš„ classï¼Œvalue æ˜¯ä¸€ä¸ªé›†åˆï¼Œé›†åˆé‡Œè¾¹æ”¾ç€ xxxConfigure é…ç½®ç±»ã€‚å½“éœ€è¦å¯¹è¿™äº›é…ç½®ç±»è¿›è¡Œé›†ä¸­é…ç½®çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ getConfigurers æ–¹æ³•è·å–é…ç½®ç±»ï¼Œè¿™ä¸ªè·å–è¿‡ç¨‹å°±æ˜¯æŠŠ LinkedHashMap ä¸­çš„ value æ‹¿å‡ºæ¥ï¼Œæ”¾åˆ°ä¸€ä¸ªé›†åˆä¸­è¿”å›ã€‚</li>
<li>åœ¨ <code>AbstractSecurityBuilder</code> ç±»ä¸­ï¼Œè¿‡æ»¤å™¨çš„æ„å»ºè¢«è½¬ç§»åˆ° doBuild æ–¹æ³•ä¸Šé¢äº†ï¼Œä¸è¿‡åœ¨ <code>AbstractSecurityBuilder</code> ä¸­åªæ˜¯å®šä¹‰äº†æŠ½è±¡çš„ doBuild æ–¹æ³•ï¼Œå…·ä½“çš„å®ç°åœ¨<code>AbstractConfiguredSecurityBuilder</code>ã€‚doBuild æ–¹æ³•å°±æ˜¯ä¸€è¾¹æ›´æ–°çŠ¶æ€ï¼Œè¿›è¡Œè¿›è¡Œåˆå§‹åŒ–ã€‚</li>
</ul>
<h4 id="å›åˆ°ä¸»é¢˜HttpSecurity"><a href="#å›åˆ°ä¸»é¢˜HttpSecurity" class="headerlink" title="å›åˆ°ä¸»é¢˜HttpSecurity"></a>å›åˆ°ä¸»é¢˜HttpSecurity</h4><p><code>HttpSecurity</code> åšçš„äº‹æƒ…ï¼Œå°±æ˜¯è¿›è¡Œå„ç§å„æ ·çš„ xxxConfigurer é…ç½®ã€‚</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> CorsConfigurer&lt;HttpSecurity&gt; <span class="hljs-title">cors</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
 <span class="hljs-keyword">return</span> getOrApply(<span class="hljs-keyword">new</span> CorsConfigurer&lt;&gt;());
&#125;
<span class="hljs-function"><span class="hljs-keyword">public</span> CsrfConfigurer&lt;HttpSecurity&gt; <span class="hljs-title">csrf</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
 ApplicationContext context = getContext();
 <span class="hljs-keyword">return</span> getOrApply(<span class="hljs-keyword">new</span> CsrfConfigurer&lt;&gt;(context));
&#125;
<span class="hljs-function"><span class="hljs-keyword">public</span> ExceptionHandlingConfigurer&lt;HttpSecurity&gt; <span class="hljs-title">exceptionHandling</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
 <span class="hljs-keyword">return</span> getOrApply(<span class="hljs-keyword">new</span> ExceptionHandlingConfigurer&lt;&gt;());
&#125;</code></pre></div>

<p><code>HttpSecurity</code> ä¸­æœ‰å¤§é‡ç±»ä¼¼çš„æ–¹æ³•ï¼Œè¿‡æ»¤å™¨é“¾ä¸­çš„è¿‡æ»¤å™¨å°±æ˜¯è¿™æ ·ä¸€ä¸ªä¸€ä¸ªé…ç½®çš„ã€‚æˆ‘å°±ä¸ä¸€ä¸€ä»‹ç»äº†ã€‚</p>
<p>æ¯ä¸ªé…ç½®æ–¹æ³•çš„ç»“å°¾éƒ½ä¼šæ¥ä¸€å¥ getOrApplyï¼Œè¿™ä¸ªæ˜¯å¹²å˜›çš„ï¼Ÿ</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">private</span> &lt;C extends SecurityConfigurerAdapter&lt;DefaultSecurityFilterChain, HttpSecurity&gt;&gt; <span class="hljs-function">C <span class="hljs-title">getOrApply</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">  C configurer)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
 C existingConfig = (C) getConfigurer(configurer.getClass());
 <span class="hljs-keyword">if</span> (existingConfig != <span class="hljs-keyword">null</span>) &#123;
  <span class="hljs-keyword">return</span> existingConfig;
 &#125;
 <span class="hljs-keyword">return</span> apply(configurer);
&#125;</code></pre></div>

<p><code>getConfigurer</code> æ–¹æ³•æ˜¯åœ¨å®ƒçš„çˆ¶ç±» <code>AbstractConfiguredSecurityBuilder</code> ä¸­å®šä¹‰çš„ï¼Œç›®çš„å°±æ˜¯å»æŸ¥çœ‹å½“å‰è¿™ä¸ª xxxConfigurer æ˜¯å¦å·²ç»é…ç½®è¿‡äº†ã€‚</p>
<p>å¦‚æœå½“å‰ xxxConfigurer å·²ç»é…ç½®è¿‡äº†ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™è°ƒç”¨ apply æ–¹æ³•ï¼Œè¿™ä¸ª apply æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>AbstractConfiguredSecurityBuilder#add</code> æ–¹æ³•ï¼Œå°†å½“å‰é…ç½® configurer æ”¶é›†èµ·æ¥ã€‚</p>
<p><code>HttpSecurity</code> ä¸­è¿˜æœ‰ä¸€ä¸ª <code>addFilter</code> æ–¹æ³•ï¼ˆä¸Šé¢ä¹Ÿç”¨åˆ°çš„ï¼‰ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> HttpSecurity <span class="hljs-title">addFilter</span><span class="hljs-params">(Filter filter)</span> </span>&#123;
 Class&lt;? extends Filter&gt; filterClass = filter.getClass();
 <span class="hljs-keyword">if</span> (!comparator.isRegistered(filterClass)) &#123;
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(
    <span class="hljs-string">&quot;The Filter class &quot;</span>
      + filterClass.getName()
      + <span class="hljs-string">&quot; does not have a registered order and cannot be added without a specified order. Consider using addFilterBefore or addFilterAfter instead.&quot;</span>);
 &#125;
 <span class="hljs-keyword">this</span>.filters.add(filter);
 <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
&#125;</code></pre></div>

<p>è¿™ä¸ª <code>addFilter</code> æ–¹æ³•çš„ä½œç”¨ï¼Œä¸»è¦æ˜¯åœ¨å„ä¸ª xxxConfigurer è¿›è¡Œé…ç½®çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œï¼ˆxxxConfigurer å°±æ˜¯ç”¨æ¥é…ç½®è¿‡æ»¤å™¨çš„ï¼‰ï¼ŒæŠŠ Filter éƒ½æ·»åŠ åˆ° fitlers å˜é‡ä¸­ã€‚</p>
<p>æœ€ç»ˆåœ¨ <code>HttpSecurity</code> çš„ <code>performBuild</code> æ–¹æ³•ä¸­ï¼Œæ„å»ºå‡ºæ¥ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> DefaultSecurityFilterChain <span class="hljs-title">performBuild</span><span class="hljs-params">()</span> </span>&#123;
 filters.sort(comparator);
 <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultSecurityFilterChain(requestMatcher, filters);
&#125;</code></pre></div>

<p>å…ˆç»™è¿‡æ»¤å™¨æ’åºï¼Œç„¶åæ„é€  <code>DefaultSecurityFilterChain</code> å¯¹è±¡ã€‚</p>
<h3 id="ğŸ‘€SecurityConfigurer"><a href="#ğŸ‘€SecurityConfigurer" class="headerlink" title="ğŸ‘€SecurityConfigurer"></a>ğŸ‘€SecurityConfigurer</h3><blockquote>
<p>æ­¤èŠ‚å»ºè®®ç»“åˆç™»é™†çš„éªŒè¯ä¸­çš„é…ç½®ç±»æ¥çœ‹</p>
</blockquote>
<p><code>SecurityConfigurer</code> åœ¨ Spring Security ä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„è§’è‰²ã€‚Spring Security è¿‡æ»¤å™¨é“¾ä¸­çš„æ¯ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œéƒ½æ˜¯é€šè¿‡ xxxConfigurer æ¥è¿›è¡Œé…ç½®çš„ï¼ˆä¸Šé¢é…ç½®ç±»ä¸­é‡å†™çš„configureå°±æ˜¯è¿™é‡Œçš„<code>SecurityConfigurer</code>ï¼‰ï¼Œè€Œè¿™äº› xxxConfigurer å®é™…ä¸Šéƒ½æ˜¯ <code>SecurityConfigurer </code>çš„å®ç°ã€‚</p>
<p><code>SecurityConfigurer</code> æœ¬èº«æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SecurityConfigurer</span>&lt;<span class="hljs-title">O</span>, <span class="hljs-title">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SecurityBuilder</span>&lt;<span class="hljs-title">O</span>&gt;&gt; </span>&#123;

 <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(B builder)</span> <span class="hljs-keyword">throws</span> Exception</span>;

 <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(B builder)</span> <span class="hljs-keyword">throws</span> Exception</span>;
&#125;</code></pre></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>SecurityConfigurer</code> ä¸­ä¸»è¦æ˜¯ä¸¤ä¸ªæ–¹æ³•ï¼Œinit å’Œ configureã€‚</p>
<p>init å°±æ˜¯ä¸€ä¸ªåˆå§‹åŒ–æ–¹æ³•ã€‚è€Œ configure åˆ™æ˜¯ä¸€ä¸ªé…ç½®æ–¹æ³•ã€‚è¿™é‡Œåªæ˜¯è§„èŒƒäº†æ–¹æ³•çš„å®šä¹‰ï¼Œå…·ä½“çš„å®ç°åˆ™åœ¨ä¸åŒçš„å®ç°ç±»ä¸­ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸¤ä¸ªæ–¹æ³•çš„å‚æ•°ç±»å‹éƒ½æ˜¯ä¸€ä¸ªæ³›å‹ Bï¼Œä¹Ÿå°±æ˜¯ <code>SecurityBuilder</code> çš„å­ç±»ï¼Œå…³äº <code>SecurityBuilder</code> ï¼Œå®ƒæ˜¯ç”¨æ¥æ„å»ºè¿‡æ»¤å™¨é“¾çš„ã€‚</p>
<p><code>SecurityConfigurer</code> æœ‰ä¸‰ä¸ªå®ç°ç±»ï¼š</p>
<ul>
<li><code>SecurityConfigurerAdapter</code></li>
<li><code>GlobalAuthenticationConfigurerAdapter</code></li>
<li><code>WebSecurityConfigurer</code></li>
</ul>
<h4 id="SecurityConfigurerAdapter"><a href="#SecurityConfigurerAdapter" class="headerlink" title="SecurityConfigurerAdapter"></a>SecurityConfigurerAdapter</h4><p><code>SecurityConfigurerAdapter</code> å®ç°äº† <code>SecurityConfigurer</code> æ¥å£ï¼Œæˆ‘ä»¬æ‰€ä½¿ç”¨çš„å¤§éƒ¨åˆ†çš„ xxxConfigurer ä¹Ÿéƒ½æ˜¯ <code>SecurityConfigurerAdapter</code> çš„å­ç±»ã€‚</p>
<p><code>SecurityConfigurerAdapter</code> åœ¨<code> SecurityConfigurer</code> çš„åŸºç¡€ä¸Šï¼Œè¿˜æ‰©å±•å‡ºæ¥äº†å‡ ä¸ªéå¸¸å¥½ç”¨çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfigurerAdapter</span>&lt;<span class="hljs-title">O</span>, <span class="hljs-title">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SecurityBuilder</span>&lt;<span class="hljs-title">O</span>&gt;&gt;</span>
<span class="hljs-class">  <span class="hljs-keyword">implements</span> <span class="hljs-title">SecurityConfigurer</span>&lt;<span class="hljs-title">O</span>, <span class="hljs-title">B</span>&gt; </span>&#123;
 <span class="hljs-keyword">private</span> B securityBuilder;

 <span class="hljs-keyword">private</span> CompositeObjectPostProcessor objectPostProcessor = <span class="hljs-keyword">new</span> CompositeObjectPostProcessor();

 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(B builder)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
 &#125;

 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(B builder)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
 &#125;

 <span class="hljs-function"><span class="hljs-keyword">public</span> B <span class="hljs-title">and</span><span class="hljs-params">()</span> </span>&#123;
  <span class="hljs-keyword">return</span> getBuilder();
 &#125;
 <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> B <span class="hljs-title">getBuilder</span><span class="hljs-params">()</span> </span>&#123;
  <span class="hljs-keyword">if</span> (securityBuilder == <span class="hljs-keyword">null</span>) &#123;
   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;securityBuilder cannot be null&quot;</span>);
  &#125;
  <span class="hljs-keyword">return</span> securityBuilder;
 &#125;
 <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span>
 <span class="hljs-keyword">protected</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">postProcess</span><span class="hljs-params">(T object)</span> </span>&#123;
  <span class="hljs-keyword">return</span> (T) <span class="hljs-keyword">this</span>.objectPostProcessor.postProcess(object);
 &#125;
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addObjectPostProcessor</span><span class="hljs-params">(ObjectPostProcessor&lt;?&gt; objectPostProcessor)</span> </span>&#123;
  <span class="hljs-keyword">this</span>.objectPostProcessor.addObjectPostProcessor(objectPostProcessor);
 &#125;
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBuilder</span><span class="hljs-params">(B builder)</span> </span>&#123;
  <span class="hljs-keyword">this</span>.securityBuilder = builder;
 &#125;
 <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CompositeObjectPostProcessor</span> <span class="hljs-keyword">implements</span></span>
<span class="hljs-class">   <span class="hljs-title">ObjectPostProcessor</span>&lt;<span class="hljs-title">Object</span>&gt; </span>&#123;
  <span class="hljs-keyword">private</span> List&lt;ObjectPostProcessor&lt;?&gt;&gt; postProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

  <span class="hljs-meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">postProcess</span><span class="hljs-params">(Object object)</span> </span>&#123;
   <span class="hljs-keyword">for</span> (ObjectPostProcessor opp : postProcessors) &#123;
    Class&lt;?&gt; oppClass = opp.getClass();
    Class&lt;?&gt; oppType = GenericTypeResolver.resolveTypeArgument(oppClass,
      ObjectPostProcessor.class);
    <span class="hljs-keyword">if</span> (oppType == <span class="hljs-keyword">null</span> || oppType.isAssignableFrom(object.getClass())) &#123;
     object = opp.postProcess(object);
    &#125;
   &#125;
   <span class="hljs-keyword">return</span> object;
  &#125;
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">addObjectPostProcessor</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">    ObjectPostProcessor&lt;?&gt; objectPostProcessor)</span> </span>&#123;
   <span class="hljs-keyword">boolean</span> result = <span class="hljs-keyword">this</span>.postProcessors.add(objectPostProcessor);
   postProcessors.sort(AnnotationAwareOrderComparator.INSTANCE);
   <span class="hljs-keyword">return</span> result;
  &#125;
 &#125;
&#125;</code></pre></div>

<ul>
<li><code>CompositeObjectPostProcessor</code> é¦–å…ˆä¸€å¼€å§‹å£°æ˜äº†ä¸€ä¸ª <code>CompositeObjectPostProcessor</code> å®ä¾‹ï¼Œ<code>CompositeObjectPostProcessor</code> æ˜¯ <code>ObjectPostProcessor</code> çš„ä¸€ä¸ªå®ç°ï¼Œ<code>ObjectPostProcessor</code> æœ¬èº«æ˜¯ä¸€ä¸ªåç½®å¤„ç†å™¨ï¼Œè¯¥åç½®å¤„ç†å™¨é»˜è®¤æœ‰ä¸¤ä¸ªå®ç°ï¼Œ<code>AutowireBeanFactoryObjectPostProcessor</code> å’Œ <code>CompositeObjectPostProcessor</code>:<ul>
<li>å…¶ä¸­ <code>AutowireBeanFactoryObjectPostProcessor </code>ä¸»è¦æ˜¯åˆ©ç”¨äº† <code>AutowireCapableBeanFactory</code> å¯¹ Bean è¿›è¡Œæ‰‹åŠ¨æ³¨å†Œï¼Œå› ä¸ºåœ¨ Spring Security ä¸­ï¼Œå¾ˆå¤šå¯¹è±¡éƒ½æ˜¯æ‰‹åŠ¨ new å‡ºæ¥çš„ï¼Œè¿™äº› new å‡ºæ¥çš„å¯¹è±¡å’Œå®¹å™¨æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œåˆ©ç”¨ AutowireCapableBeanFactory å¯ä»¥å°†è¿™äº›æ‰‹åŠ¨ new å‡ºæ¥çš„å¯¹è±¡æ³¨å…¥åˆ°å®¹å™¨ä¸­ï¼Œè€Œ <code>AutowireBeanFactoryObjectPostProcessor</code> çš„ä¸»è¦ä½œç”¨å°±æ˜¯å®Œæˆè¿™ä»¶äº‹</li>
<li><code>CompositeObjectPostProcessor</code> åˆ™æ˜¯ä¸€ä¸ªå¤åˆçš„å¯¹è±¡å¤„ç†å™¨ï¼Œé‡Œè¾¹ç»´æŠ¤äº†ä¸€ä¸ª List é›†åˆï¼Œè¿™ä¸ª List é›†åˆä¸­ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹åªå­˜å‚¨ä¸€æ¡æ•°æ®ï¼Œé‚£å°±æ˜¯ <code>AutowireBeanFactoryObjectPostProcessor</code>ï¼Œç”¨æ¥å®Œæˆå¯¹è±¡æ³¨å…¥åˆ°å®¹å™¨çš„æ“ä½œï¼Œå¦‚æœç”¨æˆ·è‡ªå·±æ‰‹åŠ¨è°ƒç”¨äº† <code>addObjectPostProcessor</code> æ–¹æ³•ï¼Œé‚£ä¹ˆ <code>CompositeObjectPostProcessor</code> é›†åˆä¸­ç»´æŠ¤çš„æ•°æ®å°±ä¼šå¤šå‡ºæ¥ä¸€æ¡ï¼Œåœ¨ <code>CompositeObjectPostProcessor#postProcess</code> æ–¹æ³•ä¸­ï¼Œä¼šéå†é›†åˆä¸­çš„æ‰€æœ‰ ObjectPostProcessorï¼ŒæŒ¨ä¸ªè°ƒç”¨å…¶ postProcess æ–¹æ³•å¯¹å¯¹è±¡è¿›è¡Œåç½®å¤„ç†ã€‚</li>
</ul>
</li>
<li>and æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›å€¼æ˜¯ä¸€ä¸ª <code>securityBuilder</code>ï¼Œ<code>securityBuilder</code> å®é™…ä¸Šå°±æ˜¯ <code>HttpSecurity</code>ï¼Œæˆ‘ä»¬åœ¨ <code>HttpSecurity</code> ä¸­å»é…ç½®ä¸åŒçš„è¿‡æ»¤å™¨æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ and æ–¹æ³•è¿›è¡Œé“¾å¼é…ç½®ï¼Œå°±æ˜¯å› ä¸ºè¿™é‡Œå®šä¹‰äº† and æ–¹æ³•å¹¶è¿”å›äº† <code>securityBuilder</code> å®ä¾‹ã€‚</li>
</ul>
<p>è¿™ä¾¿æ˜¯ <code>SecurityConfigurerAdapter</code> çš„ä¸»è¦åŠŸèƒ½ï¼Œåé¢å¤§éƒ¨åˆ†çš„ xxxConfigurer éƒ½æ˜¯åŸºäºæ­¤ç±»æ¥å®ç°çš„ã€‚</p>
<p><code>SecurityConfigurerAdapter</code> çš„å®ç°ä¸»è¦ä¹Ÿæ˜¯ä¸‰å¤§ç±»ï¼š</p>
<ul>
<li><code>UserDetailsAwareConfigurer</code></li>
<li><code>AbstractHttpConfigurer</code></li>
<li><code>LdapAuthenticationProviderConfigurer</code></li>
</ul>
<p>è€ƒè™‘åˆ° LDAP ç°åœ¨ä½¿ç”¨å¾ˆå°‘ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘æ¥å’Œå¤§å®¶é‡ç‚¹ä»‹ç»ä¸‹å‰ä¸¤ä¸ªã€‚</p>
<h5 id="UserDetailsAwareConfigurer"><a href="#UserDetailsAwareConfigurer" class="headerlink" title="UserDetailsAwareConfigurer"></a>UserDetailsAwareConfigurer</h5><p>è¿™ä¸ªé…ç½®ç±»çœ‹åå­—å¤§æ¦‚å°±çŸ¥é“è¿™æ˜¯ç”¨æ¥é…ç½®ç”¨æˆ·ç±»çš„ã€‚</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210809221022916.png" srcset="/img/loading.gif" lazyload alt="image-20210809221022916"></p>
<blockquote>
<p><strong>AbstractDaoAuthenticationConfigurer</strong></p>
<p>AbstractDaoAuthenticationConfigurer ä¸­æ‰€åšçš„äº‹æƒ…æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯æ„é€ äº†ä¸€ä¸ªé»˜è®¤çš„ DaoAuthenticationProviderï¼Œå¹¶ä¸ºå…¶é…ç½® PasswordEncoder å’Œ UserDetailsServiceã€‚</p>
<p><strong>UserDetailsServiceConfigurer</strong></p>
<p>UserDetailsServiceConfigurer é‡å†™äº† AbstractDaoAuthenticationConfigurer ä¸­çš„ configure æ–¹æ³•ï¼Œåœ¨ configure æ–¹æ³•æ‰§è¡Œä¹‹å‰åŠ å…¥äº† initUserDetailsService æ–¹æ³•ï¼Œä»¥æ–¹ä¾¿å¼€å‘å±•æŒ‰ç…§è‡ªå·±çš„æ–¹å¼å»åˆå§‹åŒ– UserDetailsServiceã€‚ä¸è¿‡è¿™é‡Œçš„ initUserDetailsService æ–¹æ³•æ˜¯ç©ºæ–¹æ³•ã€‚</p>
<p><strong>UserDetailsManagerConfigurer</strong></p>
<p>UserDetailsManagerConfigurer ä¸­å®ç°äº† UserDetailsServiceConfigurer ä¸­å®šä¹‰çš„ initUserDetailsService æ–¹æ³•ï¼Œå…·ä½“çš„å®ç°é€»è¾‘å°±æ˜¯å°† UserDetailsBuilder æ‰€æ„å»ºå‡ºæ¥çš„ UserDetails ä»¥åŠæå‰å‡†å¤‡å¥½çš„ UserDetails ä¸­çš„ç”¨æˆ·å­˜å‚¨åˆ° UserDetailsService ä¸­ã€‚</p>
<p>è¯¥ç±»åŒæ—¶æ·»åŠ äº† withUser æ–¹æ³•ç”¨æ¥æ·»åŠ ç”¨æˆ·ï¼ŒåŒæ—¶è¿˜å¢åŠ äº†ä¸€ä¸ª UserDetailsBuilder ç”¨æ¥æ„å»ºç”¨æˆ·ï¼Œè¿™äº›é€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ã€‚</p>
<p><strong>JdbcUserDetailsManagerConfigurer</strong></p>
<p>JdbcUserDetailsManagerConfigurer åœ¨çˆ¶ç±»çš„åŸºç¡€ä¸Šè¡¥å……äº† DataSource å¯¹è±¡ï¼ŒåŒæ—¶è¿˜æä¾›äº†ç›¸åº”çš„æ•°æ®åº“æŸ¥è¯¢æ–¹æ³•ã€‚</p>
<p><strong>InMemoryUserDetailsManagerConfigurer</strong></p>
<p>InMemoryUserDetailsManagerConfigurer åœ¨çˆ¶ç±»çš„åŸºç¡€ä¸Šé‡å†™äº†æ„é€ æ–¹æ³•ï¼Œå°†çˆ¶ç±»ä¸­çš„ UserDetailsService å®ä¾‹å®šä¹‰ä¸º InMemoryUserDetailsManagerã€‚</p>
<p><strong>DaoAuthenticationConfigurer</strong></p>
<p>DaoAuthenticationConfigurer ç»§æ‰¿è‡ª AbstractDaoAuthenticationConfigurerï¼Œåªæ˜¯åœ¨æ„é€ æ–¹æ³•ä¸­ä¿®æ”¹äº†ä¸€ä¸‹ userDetailsService è€Œå·²ã€‚</p>
</blockquote>
<h5 id="âš ï¸AbstractHttpConfigurer"><a href="#âš ï¸AbstractHttpConfigurer" class="headerlink" title="âš ï¸AbstractHttpConfigurer"></a>âš ï¸AbstractHttpConfigurer</h5><p><code>AbstractHttpConfigurer </code>è¿™ä¸€æ´¾ä¸­çš„ä¸œè¥¿éå¸¸å¤šï¼Œæˆ‘ä»¬æ‰€æœ‰çš„è¿‡æ»¤å™¨é…ç½®ï¼Œéƒ½æ˜¯å®ƒçš„å­ç±»ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹éƒ½æœ‰å“ªäº›ç±»ï¼Ÿ</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210809221037144.png" srcset="/img/loading.gif" lazyload alt="image-20210809221037144"></p>
<p><code>AbstractHttpConfigurer</code> ç»§æ‰¿è‡ª <code>SecurityConfigurerAdapter</code>ï¼Œå¹¶å¢åŠ äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œdisable å’Œ withObjectPostProcessorï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractHttpConfigurer</span>&lt;<span class="hljs-title">T</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractHttpConfigurer</span>&lt;<span class="hljs-title">T</span>, <span class="hljs-title">B</span>&gt;, <span class="hljs-title">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpSecurityBuilder</span>&lt;<span class="hljs-title">B</span>&gt;&gt;</span>
<span class="hljs-class">  <span class="hljs-keyword">extends</span> <span class="hljs-title">SecurityConfigurerAdapter</span>&lt;<span class="hljs-title">DefaultSecurityFilterChain</span>, <span class="hljs-title">B</span>&gt; </span>&#123;

 <span class="hljs-comment">/**</span>
<span class="hljs-comment">  * Disables the &#123;<span class="hljs-doctag">@link</span> AbstractHttpConfigurer&#125; by removing it. After doing so a fresh</span>
<span class="hljs-comment">  * version of the configuration can be applied.</span>
<span class="hljs-comment">  *</span>
<span class="hljs-comment">  * <span class="hljs-doctag">@return</span> the &#123;<span class="hljs-doctag">@link</span> HttpSecurityBuilder&#125; for additional customizations</span>
<span class="hljs-comment">  */</span>
 <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span>
 <span class="hljs-function"><span class="hljs-keyword">public</span> B <span class="hljs-title">disable</span><span class="hljs-params">()</span> </span>&#123;
  getBuilder().removeConfigurer(getClass());
  <span class="hljs-keyword">return</span> getBuilder();
 &#125;

 <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span>
 <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">withObjectPostProcessor</span><span class="hljs-params">(ObjectPostProcessor&lt;?&gt; objectPostProcessor)</span> </span>&#123;
  addObjectPostProcessor(objectPostProcessor);
  <span class="hljs-keyword">return</span> (T) <span class="hljs-keyword">this</span>;
 &#125;
&#125;</code></pre></div>

<p>è¿™ä¸¤ä¸ªæ–¹æ³•ä¹‹å‰éƒ½æœ‰ç»™å¤§å®¶ä»‹ç»è¿‡ï¼Œdisable åŸºæœ¬ä¸Šæ˜¯å¤§å®¶çš„è€ç†Ÿäººäº†ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„ <code>.csrf().disable()</code> å°±æ˜¯å‡ºè‡ªè¿™é‡Œï¼Œé‚£ä¹ˆä»è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ° disable çš„å®ç°åŸç†ï¼Œå°±æ˜¯ä» getBuilder ä¸­ç§»é™¤ç›¸å…³çš„ xxxConfigurerï¼ŒgetBuilder æ–¹æ³•è·å–åˆ°çš„å®é™…ä¸Šå°±æ˜¯ HttpSecurityï¼Œæ‰€ä»¥ç§»é™¤æ‰ xxxConfigurer å®é™…ä¸Šå°±æ˜¯ä»è¿‡æ»¤å™¨é“¾ä¸­ç§»é™¤æ‰æŸä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œä¾‹å¦‚ <code>.csrf().disable()</code> å°±æ˜¯ç§»é™¤æ‰å¤„ç† csrf çš„è¿‡æ»¤å™¨ã€‚</p>
<p>å¦ä¸€ä¸ªå¢åŠ çš„æ–¹æ³•æ˜¯ <code>withObjectPostProcessor</code>ï¼Œè¿™æ˜¯ä¸ºé…ç½®ç±»æ·»åŠ æ‰‹åŠ¨æ·»åŠ åç½®å¤„ç†å™¨çš„ã€‚åœ¨ <code>AbstractHttpConfigurer</code> çš„çˆ¶ç±»ä¸­å…¶å®æœ‰ä¸€ä¸ªç±»ä¼¼çš„æ–¹æ³•å°±æ˜¯ <code>addObjectPostProcessor</code>ï¼Œä½†æ˜¯ <code>addObjectPostProcessor</code> åªæ˜¯ä¸€ä¸ªæ·»åŠ æ–¹æ³•ï¼Œè¿”å›å€¼ä¸º voidï¼Œè€Œ withObjectPostProcessor çš„è¿”å›å€¼æ˜¯å½“å‰é…ç½®ç±»ï¼Œä¹Ÿå°±æ˜¯ xxxConfigurerï¼Œæ‰€ä»¥å¦‚æœä½¿ç”¨ withObjectPostProcessor çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨é“¾å¼é…ç½®ï¼Œäº‹å®ä¸Šï¼Œä¸Šé¢çš„é¡¹ç›®é…ç½®ä½¿ç”¨çš„ä¹Ÿéƒ½æ˜¯ <code>withObjectPostProcessor</code> æ–¹æ³•ï¼ˆå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ addObjectPostProcessorï¼Œæœ€ç»ˆæ•ˆæœæ˜¯ä¸€æ ·çš„ï¼‰ã€‚</p>
<h5 id="âš ï¸AbstractAuthenticationFilterConfigurer"><a href="#âš ï¸AbstractAuthenticationFilterConfigurer" class="headerlink" title="âš ï¸AbstractAuthenticationFilterConfigurer"></a>âš ï¸AbstractAuthenticationFilterConfigurer</h5><p><code>AbstractAuthenticationFilterConfigurer</code> ç±»çš„åŠŸèƒ½æ¯”è¾ƒå¤šï¼Œæºç ä¹Ÿæ˜¯ç›¸å½“ç›¸å½“é•¿ã€‚ä¸è¿‡æˆ‘ä»¬åªéœ€è¦æŠ“ä½ä¸¤ç‚¹å³å¯ï¼Œ<strong>init æ–¹æ³•å’Œ configure æ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯æ‰€æœ‰ xxxConfigurer çš„çµé­‚ã€‚</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(B http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
 updateAuthenticationDefaults();
 updateAccessDefaults(http);
 registerDefaultAuthenticationEntryPoint(http);
&#125;</code></pre></div>

<p>init æ–¹æ³•ä¸»è¦å¹²äº†ä¸‰ä»¶äº‹ï¼š</p>
<ol>
<li><code>updateAuthenticationDefaults</code> ä¸»è¦æ˜¯é…ç½®äº†ç™»å½•å¤„ç†åœ°å€ï¼Œå¤±è´¥è·³è½¬åœ°å€ï¼Œæ³¨é”€æˆåŠŸè·³è½¬åœ°å€ã€‚</li>
<li><code>updateAccessDefaults</code> æ–¹æ³•ä¸»è¦æ˜¯å¯¹ loginPageã€loginProcessingUrlã€failureUrl è¿›è¡Œ permitAll è®¾ç½®ï¼ˆå¦‚æœç”¨æˆ·é…ç½®äº† permitAll çš„è¯ï¼‰ã€‚</li>
<li><code>registerDefaultAuthenticationEntryPoint</code> åˆ™æ˜¯æ³¨å†Œå¼‚å¸¸çš„å¤„ç†å™¨ã€‚</li>
</ol>
<p>å†æ¥çœ‹ configure æ–¹æ³•ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(B http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
 PortMapper portMapper = http.getSharedObject(PortMapper.class);
 <span class="hljs-keyword">if</span> (portMapper != <span class="hljs-keyword">null</span>) &#123;
  authenticationEntryPoint.setPortMapper(portMapper);
 &#125;
 RequestCache requestCache = http.getSharedObject(RequestCache.class);
 <span class="hljs-keyword">if</span> (requestCache != <span class="hljs-keyword">null</span>) &#123;
  <span class="hljs-keyword">this</span>.defaultSuccessHandler.setRequestCache(requestCache);
 &#125;
 authFilter.setAuthenticationManager(http
   .getSharedObject(AuthenticationManager.class));
 authFilter.setAuthenticationSuccessHandler(successHandler);
 authFilter.setAuthenticationFailureHandler(failureHandler);
 <span class="hljs-keyword">if</span> (authenticationDetailsSource != <span class="hljs-keyword">null</span>) &#123;
  authFilter.setAuthenticationDetailsSource(authenticationDetailsSource);
 &#125;
 SessionAuthenticationStrategy sessionAuthenticationStrategy = http
   .getSharedObject(SessionAuthenticationStrategy.class);
 <span class="hljs-keyword">if</span> (sessionAuthenticationStrategy != <span class="hljs-keyword">null</span>) &#123;
  authFilter.setSessionAuthenticationStrategy(sessionAuthenticationStrategy);
 &#125;
 RememberMeServices rememberMeServices = http
   .getSharedObject(RememberMeServices.class);
 <span class="hljs-keyword">if</span> (rememberMeServices != <span class="hljs-keyword">null</span>) &#123;
  authFilter.setRememberMeServices(rememberMeServices);
 &#125;
 F filter = postProcess(authFilter);
 http.addFilter(filter);
&#125;</code></pre></div>

<p>configure ä¸­çš„é€»è¾‘å°±å¾ˆç®€ç­”äº†ï¼Œæ„å»ºå„ç§å„æ ·çš„å›è°ƒå‡½æ•°è®¾ç½®ç»™ authFilterï¼ŒauthFilter å†å» postProcess ä¸­èµ°ä¸€åœˆæ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ï¼Œæœ€åå†æŠŠ authFilter æ·»åŠ åˆ°è¿‡æ»¤å™¨é“¾ä¸­ã€‚</p>
<p>è¿™ä¾¿æ˜¯ <code>AbstractAuthenticationFilterConfigurer</code> çš„ä¸»è¦åŠŸèƒ½ã€‚éœ€è¦æé†’å¤§å®¶çš„æ˜¯ï¼Œæˆ‘ä»¬æ—¥å¸¸é…ç½®çš„ï¼Œå¦‚ï¼š</p>
<ul>
<li>loginPage</li>
<li>loginProcessingUrl</li>
<li>permitAll</li>
<li>defaultSuccessUrl</li>
<li>failureUrl</li>
</ul>
<p>ç­‰æ–¹æ³•éƒ½æ˜¯åœ¨è¿™é‡Œå®šä¹‰çš„ã€‚</p>
<h5 id="âš ï¸FormLoginConfigurer"><a href="#âš ï¸FormLoginConfigurer" class="headerlink" title="âš ï¸FormLoginConfigurer"></a>âš ï¸FormLoginConfigurer</h5><p><code>FormLoginConfigurer</code> åœ¨å®šä¹‰æ˜¯ï¼Œæ˜ç¡®äº†<code> AbstractAuthenticationFilterConfigurer</code> ä¸­çš„æ³›å‹æ˜¯ <code>UsernamePasswordAuthenticationFilter</code>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¿™é‡Œæœ€ç»ˆè¦é…ç½®çš„è¿‡æ»¤æ˜¯ <code>UsernamePasswordAuthenticationFilter</code></p>
<p>FormLoginConfigurer é‡å†™äº† init æ–¹æ³•ï¼Œé…ç½®äº†ä¸€ä¸‹é»˜è®¤çš„ç™»å½•é¡µé¢ã€‚å…¶ä»–çš„åŸºæœ¬ä¸Šéƒ½æ˜¯ä»çˆ¶ç±»æ¥çš„ï¼Œæœªåšå¤ªå¤šæ”¹å˜ã€‚</p>
<p>å¦å¤–æˆ‘ä»¬æ—¥å¸¸é…ç½®çš„å¾ˆå¤šä¸œè¥¿ä¹Ÿæ˜¯æ¥è‡ªè¿™é‡Œï¼š</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210809221049974.png" srcset="/img/loading.gif" lazyload alt="image-20210809221049974"></p>
<p>è¿™å°±æ˜¯ <code>FormLoginConfigurer</code> è¿™ä¸ªé…ç½®ç±»ï¼Œ<code>FormLoginConfigurer</code> å¯¹åº”çš„è¿‡æ»¤å™¨æ˜¯ <code>UsernamePasswordAuthenticationFilter</code>ï¼Œå¯ä»¥è‡ªè¡Œåˆ†æå…¶ä»–çš„ xxxConfigurerï¼Œæ¯ä¸€ä¸ª xxxConfigurer éƒ½å¯¹åº”äº†ä¸€ä¸ª ä¸åŒçš„ Filterã€‚</p>
<h4 id="GlobalAuthenticationConfigurerAdapter"><a href="#GlobalAuthenticationConfigurerAdapter" class="headerlink" title="GlobalAuthenticationConfigurerAdapter"></a>GlobalAuthenticationConfigurerAdapter</h4><p><code>GlobalAuthenticationConfigurerAdapter</code> çœ‹åå­—å°±çŸ¥é“æ˜¯ä¸€ä¸ªè·Ÿå…¨å±€é…ç½®æœ‰å…³çš„ä¸œè¥¿ï¼Œå®ƒæœ¬èº«å®ç°äº† <code>SecurityConfigurerAdapter</code> æ¥å£ï¼Œä½†æ˜¯å¹¶æœªå¯¹æ–¹æ³•åšå…·ä½“çš„å®ç°ï¼Œåªæ˜¯å°†æ³›å‹å…·ä½“åŒ–äº†ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Order(100)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GlobalAuthenticationConfigurerAdapter</span> <span class="hljs-keyword">implements</span></span>
<span class="hljs-class">  <span class="hljs-title">SecurityConfigurer</span>&lt;<span class="hljs-title">AuthenticationManager</span>, <span class="hljs-title">AuthenticationManagerBuilder</span>&gt; </span>&#123;

 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
 &#125;

 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
 &#125;
&#125;</code></pre></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>SecurityConfigurer</code> ä¸­çš„æ³›å‹ï¼Œç°åœ¨æ˜ç¡®æˆäº† <code>AuthenticationManager</code> å’Œ <code>AuthenticationManagerBuilder</code>ã€‚æ‰€ä»¥ <code>GlobalAuthenticationConfigurerAdapter</code> çš„å®ç°ç±»å°†æ¥ä¸»è¦æ˜¯å’Œé…ç½® <code>AuthenticationManager</code> æœ‰å…³ã€‚å½“ç„¶ä¹ŸåŒ…æ‹¬é»˜è®¤çš„ç”¨æˆ·åå¯†ç ä¹Ÿæ˜¯ç”±å®ƒçš„å®ç°ç±»æ¥è¿›è¡Œé…ç½®çš„ã€‚</p>
<p><strong>æˆ‘ä»¬åœ¨ Spring Security ä¸­ä½¿ç”¨çš„ <code>AuthenticationManager</code> å…¶å®å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯å±€éƒ¨çš„ï¼Œå¦ä¸€ç§æ˜¯å…¨å±€çš„ï¼Œè¿™é‡Œä¸»è¦æ˜¯å…¨å±€çš„é…ç½®ã€‚</strong></p>
<h4 id="WebSecurityConfigurer"><a href="#WebSecurityConfigurer" class="headerlink" title="WebSecurityConfigurer"></a>WebSecurityConfigurer</h4><p>è¿˜æœ‰ä¸€ä¸ªå®ç°ç±»å°±æ˜¯ <code>WebSecurityConfigurer</code>ï¼Œè¿™ä¸ªå¯èƒ½æœ‰çš„å°ä¼™ä¼´æ¯”è¾ƒé™Œç”Ÿï¼Œå…¶å®ä»–å°±æ˜¯æˆ‘ä»¬å¤©å¤©ç”¨çš„ <code>WebSecurityConfigurerAdapter</code> çš„çˆ¶æ¥å£ã€‚</p>
<p>æ‰€ä»¥ <code>WebSecurityConfigurer</code> çš„ä½œç”¨å°±å¾ˆæ˜ç¡®äº†ï¼Œç”¨æˆ·æ‰©å±•ç”¨æˆ·è‡ªå®šä¹‰çš„é…ç½®ã€‚</p>
<p><code>SecurityConfigurer</code> é»˜è®¤ä¸»è¦æ˜¯è¿™ä¸‰ä¸ªå®ç°ï¼Œè€ƒè™‘åˆ°å¤§å¤šæ•°çš„è¿‡æ»¤å™¨é…ç½®éƒ½æ˜¯é€šè¿‡ <code>SecurityConfigurerAdapter</code> è¿›è¡Œæ‰©å±•çš„ï¼Œå› æ­¤æˆ‘ä»¬ä»Šå¤©å°±é€šè¿‡è¿™æ¡çº¿è¿›è¡Œå±•å¼€ã€‚</p>
<h3 id="ğŸ‘€AuthenticationManagerBuilder"><a href="#ğŸ‘€AuthenticationManagerBuilder" class="headerlink" title="ğŸ‘€AuthenticationManagerBuilder"></a>ğŸ‘€AuthenticationManagerBuilder</h3><blockquote>
<p>æ­¤èŠ‚å»ºè®®ç»“åˆæ£€æŸ¥è§’è‰²æ˜¯å¦æ»¡è¶³åŒ¹é…æ¥çœ‹</p>
</blockquote>
<p>å‰é¢å’Œå¤§å®¶åˆ†äº«äº† <code>SecurityBuilder</code> ä»¥åŠå®ƒçš„ä¸€ä¸ªé‡è¦å®ç° <code>HttpSecurity</code>ï¼Œåœ¨ <code>SecurityBuilder</code> çš„å®ç°ç±»é‡Œè¾¹ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„åˆ†æ”¯ï¼Œé‚£å°±æ˜¯ <code>AuthenticationManagerBuilder</code>ï¼Œ<code>AuthenticationManagerBuilder</code> çœ‹åå­—å°±çŸ¥é“æ˜¯ç”¨æ¥æ„å»º <code>AuthenticationManager</code> çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æ¥çœ‹ä¸€çœ‹ <code>AuthenticationManager</code> åˆ°åº•æ˜¯æ€ä¹ˆæ„å»ºçš„ã€‚</p>
<h4 id="åˆæ­¥ç†è§£"><a href="#åˆæ­¥ç†è§£" class="headerlink" title="åˆæ­¥ç†è§£"></a>åˆæ­¥ç†è§£</h4><p>åœ¨ Spring Security ä¸­ï¼Œç”¨æ¥å¤„ç†èº«ä»½è®¤è¯çš„ç±»æ˜¯ <code>AuthenticationManager</code>ï¼Œæˆ‘ä»¬ä¹Ÿç§°ä¹‹ä¸ºè®¤è¯ç®¡ç†å™¨ã€‚<strong>ä¹Ÿæ˜¯æˆ‘ä»¬ä¸Šé¢æ£€æŸ¥è§’è‰²æ˜¯å¦æ»¡è¶³åŒ¹é…çš„é‡è¦ä¸€ç¯</strong></p>
<p><code>AuthenticationManager</code> ä¸­è§„èŒƒäº† Spring Security çš„è¿‡æ»¤å™¨è¦å¦‚ä½•æ‰§è¡Œèº«ä»½è®¤è¯ï¼Œå¹¶åœ¨èº«ä»½è®¤è¯æˆåŠŸåè¿”å›ä¸€ä¸ªç»è¿‡è®¤è¯çš„ <code>Authentication </code>å¯¹è±¡ã€‚<code>AuthenticationManager</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰å®ƒçš„å®ç°ï¼Œä½†æ˜¯é€šå¸¸æˆ‘ä»¬ä½¿ç”¨æ›´å¤šçš„æ˜¯ç³»ç»Ÿæä¾›çš„ <code>ProviderManager</code></p>
<h4 id="ProviderManager"><a href="#ProviderManager" class="headerlink" title="ProviderManager"></a>ProviderManager</h4><p><code>ProviderManager</code> æ˜¯çš„æœ€å¸¸ç”¨çš„<code> AuthenticationManager</code> å®ç°ç±»ã€‚</p>
<p><code>ProviderManager</code> ç®¡ç†äº†ä¸€ä¸ª <code>AuthenticationProvider</code> åˆ—è¡¨ï¼Œæ¯ä¸ª <code>AuthenticationProvider</code> éƒ½æ˜¯ä¸€ä¸ªè®¤è¯å™¨ï¼Œä¸åŒçš„ <code>AuthenticationProvider</code> ç”¨æ¥å¤„ç†ä¸åŒçš„ <code>Authentication</code> å¯¹è±¡çš„è®¤è¯ã€‚ä¸€æ¬¡å®Œæ•´çš„èº«ä»½è®¤è¯æµç¨‹å¯èƒ½ä¼šç»è¿‡å¤šä¸ª <code>AuthenticationProvider</code></p>
<p><code>ProviderManager </code>ç›¸å½“äºä»£ç†äº†å¤šä¸ª <code>AuthenticationProvider</code>ï¼Œä»–ä»¬çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210809210416369.png" srcset="/img/loading.gif" lazyload alt="image-20210809210416369"></p>
<h4 id="AuthenticationProvider"><a href="#AuthenticationProvider" class="headerlink" title="AuthenticationProvider"></a>AuthenticationProvider</h4><p><code>AuthenticationProvider</code> å®šä¹‰äº† Spring Security ä¸­çš„éªŒè¯é€»è¾‘ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ <code>AuthenticationProvider</code> çš„å®šä¹‰ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AuthenticationProvider</span> </span>&#123;
	<span class="hljs-function">Authentication <span class="hljs-title">authenticate</span><span class="hljs-params">(Authentication authentication)</span></span>
<span class="hljs-function">			<span class="hljs-keyword">throws</span> AuthenticationException</span>;
	<span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">supports</span><span class="hljs-params">(Class&lt;?&gt; authentication)</span></span>;
&#125;</code></pre></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>AuthenticationProvider</code> ä¸­å°±ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li>authenticate æ–¹æ³•ç”¨æ¥åšéªŒè¯ï¼Œå°±æ˜¯éªŒè¯ç”¨æˆ·èº«ä»½ã€‚</li>
<li>supports åˆ™ç”¨æ¥åˆ¤æ–­å½“å‰çš„ <code>AuthenticationProvider</code> æ˜¯å¦æ”¯æŒå¯¹åº”çš„ <code>Authentication</code>ã€‚</li>
</ul>
<p>åœ¨ä¸€æ¬¡å®Œæ•´çš„è®¤è¯ä¸­ï¼Œå¯èƒ½åŒ…å«å¤šä¸ª <code>AuthenticationProvider</code>ï¼Œè€Œè¿™å¤šä¸ª <code>AuthenticationProvider</code> åˆ™ç”± <code>ProviderManager </code>è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼Œå…·ä½“æˆ‘ä¼šå†å‡ºä¸€ç¯‡æ–‡ç« æ¥åˆ†æSpring Security ç™»å½•æµç¨‹ã€‚</p>
<p>æœ€å¸¸ç”¨çš„ <code>AuthenticationProvider</code> å®ç°ç±»æ˜¯ <code>DaoAuthenticationProvider</code>ã€‚</p>
<h4 id="Parent"><a href="#Parent" class="headerlink" title="Parent"></a>Parent</h4><p>æ¯ä¸€ä¸ª <code>ProviderManager</code> ç®¡ç†å¤šä¸ª <code>AuthenticationProvider</code>ï¼ŒåŒæ—¶æ¯ä¸€ä¸ª <code>ProviderManager</code> éƒ½å¯ä»¥é…ç½®ä¸€ä¸ª parentï¼Œå¦‚æœå½“å‰çš„ <code>ProviderManager</code> ä¸­è®¤è¯å¤±è´¥äº†ï¼Œè¿˜å¯ä»¥å»å®ƒçš„ parent ä¸­ç»§ç»­æ‰§è¡Œè®¤è¯ï¼Œæ‰€è°“çš„ parent å®ä¾‹ï¼Œä¸€èˆ¬ä¹Ÿæ˜¯ <code>ProviderManager</code>ï¼Œä¹Ÿå°±æ˜¯ <code>ProviderManager</code> çš„ parent è¿˜æ˜¯ <code>ProviderManager</code>ã€‚å¯ä»¥å‚è€ƒå¦‚ä¸‹æ¶æ„å›¾ï¼š</p>
<p><img src="https://luciferfigurebed.oss-cn-chengdu.aliyuncs.com/uPic/image-20210809210931119.png" srcset="/img/loading.gif" lazyload alt="image-20210809210931119"></p>
<p><strong>ä»ä¸Šé¢çš„åˆ†æä¸­å¤§å®¶å¯ä»¥çœ‹å‡ºï¼Œ<code>AuthenticationManager</code> çš„åˆå§‹åŒ–ä¼šåˆ†ä¸ºä¸¤å—ï¼Œä¸€ä¸ªå…¨å±€çš„ <code>AuthenticationManager</code>ï¼Œä¹Ÿå°±æ˜¯ parentï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯å±€éƒ¨çš„ <code>AuthenticationManager</code>ã€‚å…ˆç»™å¤§å®¶ä¸€ä¸ªç»“è®ºï¼Œä¸€ä¸ªç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®å¤šä¸ª <code>HttpSecurity</code>ï¼Œè€Œæ¯ä¸€ä¸ª<code>HttpSecurity</code>éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ <code>AuthenticationManager</code> å®ä¾‹ï¼ˆå±€éƒ¨ <code>AuthenticationManager</code>ï¼‰ï¼Œè¿™äº›å±€éƒ¨çš„ <code>AuthenticationManager</code> å®ä¾‹éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„ parentï¼Œé‚£å°±æ˜¯å…¨å±€çš„ <code>AuthenticationManager</code>ã€‚</strong></p>
<h4 id="ä¸ºä»€ä¹ˆæ¯ä¸€ä¸ª-HttpSecurity-éƒ½è¦ç»‘å®šä¸€ä¸ª-AuthenticationManagerï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæ¯ä¸€ä¸ª-HttpSecurity-éƒ½è¦ç»‘å®šä¸€ä¸ª-AuthenticationManagerï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæ¯ä¸€ä¸ª HttpSecurity éƒ½è¦ç»‘å®šä¸€ä¸ª AuthenticationManagerï¼Ÿ"></a>ä¸ºä»€ä¹ˆæ¯ä¸€ä¸ª HttpSecurity éƒ½è¦ç»‘å®šä¸€ä¸ª AuthenticationManagerï¼Ÿ</h4><p>å› ä¸ºåœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å›é…ç½®å¤šä¸ª <code>HttpSecurity</code>ï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªä¸åŒçš„è¿‡æ»¤å™¨é“¾ï¼Œæ—¢ç„¶æœ‰å¤šä¸ªè¿‡æ»¤å™¨é“¾ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚åˆ°æ¥çš„æ—¶å€™ï¼Œå®ƒéœ€è¦è¿›å…¥åˆ°æŸä¸€ä¸ªè¿‡æ»¤å™¨é“¾ä¸­å»å¤„ç†ï¼Œæ¯ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ä¸­åˆä¼šæ¶‰åŠåˆ° <code>AuthenticationProvider </code>çš„ç®¡ç†ï¼Œä¸åŒè¿‡æ»¤å™¨é“¾ä¸­çš„ <code>AuthenticationProvider</code> è‚¯å®šæ˜¯å„è‡ªç®¡ç†æœ€ä¸ºåˆé€‚ï¼Œä¹Ÿå°±æ˜¯ä¸åŒçš„è¿‡æ»¤å™¨é“¾ä¸­éƒ½æœ‰ä¸€ä¸ªç»‘å®šçš„ <code>AuthenticationManager</code>ï¼Œå³æ¯ä¸€ä¸ª <code>HttpSecurity</code> éƒ½è¦ç»‘å®šä¸€ä¸ª <code>AuthenticationManager</code></p>
<h3 id="ğŸ‘€WebSecurityConfigurerAdapter"><a href="#ğŸ‘€WebSecurityConfigurerAdapter" class="headerlink" title="ğŸ‘€WebSecurityConfigurerAdapter"></a>ğŸ‘€WebSecurityConfigurerAdapter</h3><blockquote>
<p>æˆ‘ä»¬é…ç½®ä¸­ç»§æ‰¿çš„å°±æ˜¯WebSecurityConfigurerAdapterï¼Œéœ€è¦é‡ç‚¹å…³æ³¨</p>
</blockquote>
<p>æˆ‘ä»¬çš„è‡ªå®šä¹‰çš„<code>SecurityConfig</code>éƒ½æ˜¯ç»§æ‰¿è‡ª <code>WebSecurityConfigurerAdapter</code> æ¥å®ç°çš„ï¼Œé¦–å…ˆçœ‹ä¸€å¼  <code>WebSecurityConfigurerAdapter</code> çš„ç»§æ‰¿å…³ç³»å›¾ï¼š</p>
<p><a target="_blank" rel="noopener" href="http://img.itboyhub.com/2020/07/WebSecurityConfigurerAdapter.png"><img src="http://img.itboyhub.com/2020/07/WebSecurityConfigurerAdapter.png" srcset="/img/loading.gif" lazyload alt="img" style="zoom: 67%;" /></a></p>
<p>åœ¨è¿™å±‚ç»§æ‰¿å…³ç³»ä¸­ï¼Œæœ‰ä¸¤ä¸ªéå¸¸é‡è¦çš„ç±»ï¼š</p>
<ul>
<li><p><strong>SecurityBuilder</strong></p>
</li>
<li><p><strong>SecurityConfigurer</strong></p>
</li>
</ul>
<p>ä¸Šé¢å·²ç»åˆ†æäº†è¿™ä¸¤ä¸ªç±»ï¼Œä¸‹é¢ç€é‡åˆ†æå…¶ä»–çš„</p>
<h4 id="WebSecurityConfigurer-1"><a href="#WebSecurityConfigurer-1" class="headerlink" title="WebSecurityConfigurer"></a>WebSecurityConfigurer</h4><p>WebSecurityConfigurer å…¶å®æ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œä½†æ˜¯å®ƒé‡Œè¾¹çº¦æŸäº†ä¸€äº›æ³›å‹ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">WebSecurityConfigurer</span>&lt;<span class="hljs-title">T</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SecurityBuilder</span>&lt;<span class="hljs-title">Filter</span>&gt;&gt; <span class="hljs-keyword">extends</span></span>
<span class="hljs-class">		<span class="hljs-title">SecurityConfigurer</span>&lt;<span class="hljs-title">Filter</span>, <span class="hljs-title">T</span>&gt; </span>&#123;

&#125;</code></pre></div>

<p>è¿™é‡Œè¾¹çš„æ³›å‹å¾ˆå…³é”®ï¼Œè¿™å…³ä¹åˆ° <code>WebSecurityConfigurer</code> çš„ç›®çš„æ˜¯å•¥ï¼</p>
<ol>
<li><code>SecurityBuilder</code> ä¸­çš„æ³›å‹ Filterï¼Œè¡¨ç¤º<code>SecurityBuilder</code>æœ€ç»ˆçš„ç›®çš„æ˜¯ä¸ºäº†æ„å»ºä¸€ä¸ª Filter å¯¹è±¡å‡ºæ¥ã€‚</li>
<li><code>SecurityConfigurer</code> ä¸­ä¸¤ä¸ªæ³›å‹ï¼Œç¬¬ä¸€ä¸ªè¡¨ç¤ºçš„å«ä¹‰ä¹Ÿæ˜¯ <code>SecurityBuilder</code> æœ€ç»ˆæ„å»ºçš„å¯¹è±¡ã€‚</li>
</ol>
<p>åŒæ—¶è¿™é‡Œè¿˜å®šä¹‰äº†æ–°çš„æ³›å‹ Tï¼ŒT éœ€è¦ç»§æ‰¿è‡ª <code>SecurityBuilder</code>ï¼Œæ ¹æ® <code>WebSecurityConfigurerAdapter</code> ä¸­çš„å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒT å°±æ˜¯ <code>WebSecurity</code>ï¼Œæˆ‘ä»¬ä¹Ÿå¤§æ¦‚èƒ½çŒœå‡º <code>WebSecurity</code> å°±æ˜¯ <code>SecurityBuilder</code> çš„å­ç±»ã€‚</p>
<p>æ‰€ä»¥ <code>WebSecurityConfigurer</code> çš„ç›®çš„æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºå°±æ˜¯ä¸ºäº†é…ç½® <code>WebSecurity</code></p>
<h4 id="WebSecurity"><a href="#WebSecurity" class="headerlink" title="WebSecurity"></a>WebSecurity</h4><p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>WebSecurity</code> çš„å®šä¹‰ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebSecurity</span> <span class="hljs-keyword">extends</span></span>
<span class="hljs-class">		<span class="hljs-title">AbstractConfiguredSecurityBuilder</span>&lt;<span class="hljs-title">Filter</span>, <span class="hljs-title">WebSecurity</span>&gt; <span class="hljs-keyword">implements</span></span>
<span class="hljs-class">		<span class="hljs-title">SecurityBuilder</span>&lt;<span class="hljs-title">Filter</span>&gt;, <span class="hljs-title">ApplicationContextAware</span> </span>&#123;
&#125;</code></pre></div>

<p>æ²¡é”™ï¼Œç¡®å®æ˜¯è¿™æ ·ï¼<code>WebSecurity</code> ç»§æ‰¿è‡ª <code>AbstractConfiguredSecurityBuilder&lt;Filter, WebSecurity&gt;</code> åŒæ—¶å®ç°äº† <code>SecurityBuilder</code> æ¥å£ã€‚</p>
<p><code>WebSecurity</code> çš„è¿™äº›æ¥å£å’Œç»§æ‰¿ç±»ï¼Œä¸Šé¢çš„<code>HttpSecurity</code>ä¸­æœ‰åˆ†æï¼Œè¿™é‡Œå°±ä¸é‡å¤åˆ†æäº†</p>
<p><strong>SecurityBuilder</strong></p>
<p><code>SecurityBuilder </code>å°±æ˜¯ç”¨æ¥æ„å»ºè¿‡æ»¤å™¨é“¾çš„ï¼Œåœ¨ <code>HttpSecurity</code> å®ç° <code>SecurityBuilder</code> æ—¶ï¼Œä¼ å…¥çš„æ³›å‹å°±æ˜¯ <code>DefaultSecurityFilterChain</code>ï¼Œæ‰€ä»¥ <code>SecurityBuilder#build </code>æ–¹æ³•çš„åŠŸèƒ½å¾ˆæ˜ç¡®ï¼Œå°±æ˜¯ç”¨æ¥æ„å»ºä¸€ä¸ªè¿‡æ»¤å™¨é“¾å‡ºæ¥ï¼Œä½†æ˜¯é‚£ä¸ªè¿‡æ»¤å™¨é“¾æ˜¯ Spring Security ä¸­çš„ã€‚åœ¨ <code>WebSecurityConfigurerAdapter </code>ä¸­å®šä¹‰çš„æ³›å‹æ˜¯ <code>SecurityBuilder</code>ï¼Œæ‰€ä»¥æœ€ç»ˆæ„å»ºçš„æ˜¯ä¸€ä¸ªæ™®é€š Filterï¼Œå…¶å®å°±æ˜¯ <code>FilterChainProxy</code>ï¼Œå…³äº <code>FilterChainProxy</code> ï¼Œå¯ä»¥å‚è€ƒ<code>http.authorizeRequests()</code>ä¸­çš„è¯´æ˜ã€‚</p>
<p><code>WebSecurity</code> çš„æ ¸å¿ƒé€»è¾‘é›†ä¸­åœ¨ <code>performBuild</code> æ„å»ºæ–¹æ³•ä¸Šï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> Filter <span class="hljs-title">performBuild</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
	Assert.state(
			!securityFilterChainBuilders.isEmpty(),
			() -&gt; <span class="hljs-string">&quot;At least one SecurityBuilder&lt;? extends SecurityFilterChain&gt; needs to be specified. &quot;</span>
					+ <span class="hljs-string">&quot;Typically this done by adding a @Configuration that extends WebSecurityConfigurerAdapter. &quot;</span>
					+ <span class="hljs-string">&quot;More advanced users can invoke &quot;</span>
					+ WebSecurity.class.getSimpleName()
					+ <span class="hljs-string">&quot;.addSecurityFilterChainBuilder directly&quot;</span>);
	<span class="hljs-keyword">int</span> chainSize = ignoredRequests.size() + securityFilterChainBuilders.size();
	List&lt;SecurityFilterChain&gt; securityFilterChains = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(
			chainSize);
	<span class="hljs-keyword">for</span> (RequestMatcher ignoredRequest : ignoredRequests) &#123;
		securityFilterChains.add(<span class="hljs-keyword">new</span> DefaultSecurityFilterChain(ignoredRequest));
	&#125;
	<span class="hljs-keyword">for</span> (SecurityBuilder&lt;? extends SecurityFilterChain&gt; securityFilterChainBuilder : securityFilterChainBuilders) &#123;
		securityFilterChains.add(securityFilterChainBuilder.build());
	&#125;
	FilterChainProxy filterChainProxy = <span class="hljs-keyword">new</span> FilterChainProxy(securityFilterChains);
	<span class="hljs-keyword">if</span> (httpFirewall != <span class="hljs-keyword">null</span>) &#123;
		filterChainProxy.setFirewall(httpFirewall);
	&#125;
	filterChainProxy.afterPropertiesSet();
	Filter result = filterChainProxy;
	<span class="hljs-keyword">if</span> (debugEnabled) &#123;
		logger.warn(<span class="hljs-string">&quot;\n\n&quot;</span>
				+ <span class="hljs-string">&quot;********************************************************************\n&quot;</span>
				+ <span class="hljs-string">&quot;**********        Security debugging is enabled.       *************\n&quot;</span>
				+ <span class="hljs-string">&quot;**********    This may include sensitive information.  *************\n&quot;</span>
				+ <span class="hljs-string">&quot;**********      Do not use in a production system!     *************\n&quot;</span>
				+ <span class="hljs-string">&quot;********************************************************************\n\n&quot;</span>);
		result = <span class="hljs-keyword">new</span> DebugFilter(filterChainProxy);
	&#125;
	postBuildAction.run();
	<span class="hljs-keyword">return</span> result;
&#125;</code></pre></div>

<p>å…ˆæ¥è¯´ä¸€å¥ï¼Œè¿™é‡Œçš„ performBuild æ–¹æ³•åªæœ‰ä¸€ä¸ªåŠŸèƒ½ï¼Œé‚£å°±æ˜¯æ„å»º <code>FilterChainProxy</code></p>
<p>æŠŠæ¡ä½äº†è¿™æ¡ä¸»çº¿ï¼Œæˆ‘ä»¬å†æ¥çœ‹æ–¹æ³•çš„å®ç°å°±å¾ˆå®¹æ˜“äº†ã€‚</p>
<ol>
<li><p>é¦–å…ˆç»Ÿè®¡è¿‡æ»¤å™¨é“¾çš„æ€»æ¡æ•°ï¼Œæ€»æ¡æ•°åŒ…æ‹¬ä¸¤ä¸ªæ–¹é¢ï¼Œä¸€ä¸ªæ˜¯ <code>ignoredRequests</code>ï¼Œè¿™æ˜¯å¿½ç•¥çš„è¯·æ±‚ï¼Œé€šè¿‡ WebSecurity é…ç½®çš„å¿½ç•¥è¯·æ±‚ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯ <code>securityFilterChainBuilders</code>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é€šè¿‡ <code>HttpSecurity</code> é…ç½®çš„è¿‡æ»¤å™¨é“¾ï¼Œæœ‰å‡ ä¸ªå°±ç®—å‡ ä¸ªã€‚</p>
<blockquote>
<p>å‰ç«¯é™æ€èµ„æºæ”¾è¡Œæ—¶ï¼Œå¯ä»¥ç›´æ¥ä¸èµ° Spring Security è¿‡æ»¤å™¨é“¾ï¼Œåƒä¸‹é¢è¿™æ ·ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java">&gt;<span class="hljs-meta">@Override</span>
&gt;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
 web.ignoring().antMatchers(<span class="hljs-string">&quot;/css/**&quot;</span>,<span class="hljs-string">&quot;/js/**&quot;</span>,<span class="hljs-string">&quot;/index.html&quot;</span>,<span class="hljs-string">&quot;/img/**&quot;</span>,<span class="hljs-string">&quot;/fonts/**&quot;</span>,<span class="hljs-string">&quot;/favicon.ico&quot;</span>);
&gt;&#125;</code></pre></div>

<p>åç«¯çš„æ¥å£è¦é¢å¤–æ”¾è¡Œï¼Œå°±éœ€è¦ä»”ç»†è€ƒè™‘åœºæ™¯äº†ï¼Œä¸è¿‡ä¸€èˆ¬æ¥è¯´ï¼Œä¸å»ºè®®ä½¿ç”¨ä¸Šé¢è¿™ç§æ–¹å¼ï¼Œå»ºè®®ä¸‹é¢è¿™ç§æ–¹å¼</p>
<div class="hljs code-wrapper"><pre><code class="hljs java">&gt;http.authorizeRequests()
     .antMatchers(<span class="hljs-string">&quot;/hello&quot;</span>).permitAll()
     .anyRequest().authenticated()</code></pre></div>

<p>å› ä¸ºï¼Œå¦‚æœæˆ‘ä»¬æš´éœ²ç™»å½•æ¥å£çš„æ—¶å€™ï¼Œä½¿ç”¨äº†å‰é¢æåˆ°çš„ç¬¬ä¸€ç§æ–¹å¼ï¼Œæ²¡æœ‰èµ° Spring Securityï¼Œè¿‡æ»¤å™¨é“¾ï¼Œåˆ™åœ¨ç™»å½•æˆåŠŸåï¼Œå°±ä¸ä¼šå°†ç™»å½•ç”¨æˆ·ä¿¡æ¯å­˜å…¥ session ä¸­ï¼Œè¿›è€Œå¯¼è‡´åæ¥çš„è¯·æ±‚éƒ½æ— æ³•è·å–åˆ°ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆåæ¥çš„è¯·æ±‚åœ¨ç³»ç»Ÿçœ¼é‡Œä¹Ÿéƒ½æ˜¯æœªè®¤è¯çš„è¯·æ±‚ï¼‰</p>
<p>æˆ–è€…å¦‚æœä½ çš„ç™»å½•è¯·æ±‚æ­£å¸¸ï¼Œèµ°äº† Spring Security è¿‡æ»¤å™¨é“¾ï¼Œä½†æ˜¯åæ¥çš„ A è¯·æ±‚æ²¡èµ°è¿‡æ»¤å™¨é“¾ï¼ˆé‡‡ç”¨å‰é¢æåˆ°çš„ç¬¬ä¸€ç§æ–¹å¼æ”¾è¡Œï¼‰ï¼Œé‚£ä¹ˆ A è¯·æ±‚ä¸­ï¼Œä¹Ÿæ˜¯æ— æ³•é€šè¿‡ SecurityContextHolder è·å–åˆ°ç™»å½•ç”¨æˆ·ä¿¡æ¯çš„ï¼Œå› ä¸ºå®ƒä¸€å¼€å§‹æ²¡ç»è¿‡ SecurityContextPersistenceFilter è¿‡æ»¤å™¨é“¾ã€‚</p>
</blockquote>
</li>
<li><p>åˆ›å»º <code>securityFilterChains</code> é›†åˆï¼Œå¹¶ä¸”éå†ä¸Šé¢æåˆ°çš„ä¸¤ç§ç±»å‹çš„è¿‡æ»¤å™¨é“¾ï¼Œå¹¶å°†è¿‡æ»¤å™¨é“¾æ”¾å…¥ <code>securityFilterChains</code> é›†åˆä¸­ã€‚</p>
</li>
<li><p>åœ¨<code>HttpSecurity</code>ä»‹ç»è¿‡ï¼Œ<code>HttpSecurity</code> æ„å»ºå‡ºæ¥çš„è¿‡æ»¤å™¨é“¾å¯¹è±¡å°±æ˜¯ <code>DefaultSecurityFilterChain</code>ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å°† build ç»“æœæ”¾å…¥ <code>securityFilterChains </code>ä¸­ï¼Œè€Œ <code>ignoredRequests</code> ä¸­ä¿å­˜çš„åˆ™éœ€è¦é‡æ„ä¸€ä¸‹æ‰å¯ä»¥å­˜å…¥ <code>securityFilterChains</code></p>
</li>
<li><p><code>securityFilterChains</code> ä¸­æœ‰æ•°æ®ä¹‹åï¼Œæ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ª <code>FilterChainProxy</code></p>
</li>
<li><p>ç»™æ–°å»ºçš„<code>FilterChainProxy</code>é…ç½®ä¸Šé˜²ç«å¢™</p>
</li>
<li><p>æœ€åæˆ‘ä»¬è¿”å›çš„å°±æ˜¯<code> FilterChainProxy</code> çš„å®ä¾‹ã€‚</p>
</li>
</ol>
<p><strong>ä»è¿™æ®µåˆ†æä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ <code>WebSecurity </code>å’Œ <code>HttpSecurity </code>çš„åŒºåˆ«ï¼š</strong></p>
<ol>
<li><code>HttpSecurity</code> ç›®çš„æ˜¯æ„å»ºè¿‡æ»¤å™¨é“¾ï¼Œä¸€ä¸ª <code>HttpSecurity</code> å¯¹è±¡æ„å»ºä¸€æ¡è¿‡æ»¤å™¨é“¾ï¼Œä¸€ä¸ªè¿‡æ»¤å™¨é“¾ä¸­æœ‰ N ä¸ªè¿‡æ»¤å™¨ï¼Œ<code>HttpSecurity</code>æ‰€åšçš„äº‹æƒ…å®é™…ä¸Šå°±æ˜¯åœ¨é…ç½®è¿™ N ä¸ªè¿‡æ»¤å™¨ã€‚</li>
<li><code>WebSecurity</code> ç›®çš„æ˜¯æ„å»º <code>FilterChainProxy</code>ï¼Œä¸€ä¸ª <code>FilterChainProxy</code> ä¸­åŒ…å«æœ‰å¤šä¸ªè¿‡æ»¤å™¨é“¾å’Œä¸€ä¸ª Firewallã€‚</li>
</ol>
<h4 id="å›åˆ°WebSecurityConfigurerAdapter"><a href="#å›åˆ°WebSecurityConfigurerAdapter" class="headerlink" title="å›åˆ°WebSecurityConfigurerAdapter"></a>å›åˆ°WebSecurityConfigurerAdapter</h4><p>æœ€åæˆ‘ä»¬å†æ¥çœ‹ <code>WebSecurityConfigurerAdapter</code>ï¼Œç”±äº <code>WebSecurityConfigurer </code>åªæ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œ<code>WebSecurityConfigurerAdapter</code> å°±æ˜¯é’ˆå¯¹è¿™ä¸ªç©ºæ¥å£æä¾›ä¸€ä¸ªå…·ä½“çš„å®ç°ï¼Œæœ€ç»ˆç›®çš„è¿˜æ˜¯ä¸ºäº†æ–¹ä¾¿ä½ é…ç½® <code>WebSecurity</code>ã€‚</p>
<p><code>WebSecurityConfigurerAdapter</code> ä¸­çš„æ–¹æ³•æ¯”è¾ƒå¤šï¼Œä½†æ˜¯æ ¹æ®æˆ‘ä»¬å‰é¢çš„åˆ†æï¼Œæçº²æŒˆé¢†çš„æ–¹æ³•å°±ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ initï¼Œè¿˜æœ‰ä¸€ä¸ª configure(WebSecurity web)ï¼Œå…¶ä»–æ–¹æ³•éƒ½æ˜¯ä¸ºè¿™ä¸¤ä¸ªæ–¹æ³•æœåŠ¡çš„ã€‚é‚£æˆ‘ä»¬å°±æ¥çœ‹ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå…ˆçœ‹ init æ–¹æ³•ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(<span class="hljs-keyword">final</span> WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
	<span class="hljs-keyword">final</span> HttpSecurity http = getHttp();
	web.addSecurityFilterChainBuilder(http).postBuildAction(() -&gt; &#123;
		FilterSecurityInterceptor securityInterceptor = http
				.getSharedObject(FilterSecurityInterceptor.class);
		web.securityInterceptor(securityInterceptor);
	&#125;);
&#125;
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> HttpSecurity <span class="hljs-title">getHttp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
	<span class="hljs-keyword">if</span> (http != <span class="hljs-keyword">null</span>) &#123;
		<span class="hljs-keyword">return</span> http;
	&#125;
	AuthenticationEventPublisher eventPublisher = getAuthenticationEventPublisher();
	localConfigureAuthenticationBldr.authenticationEventPublisher(eventPublisher);
	AuthenticationManager authenticationManager = authenticationManager();
	authenticationBuilder.parentAuthenticationManager(authenticationManager);
	Map&lt;Class&lt;?&gt;, Object&gt; sharedObjects = createSharedObjects();
	http = <span class="hljs-keyword">new</span> HttpSecurity(objectPostProcessor, authenticationBuilder,
			sharedObjects);
	<span class="hljs-keyword">if</span> (!disableDefaults) &#123;
		<span class="hljs-comment">// @formatter:off</span>
		http
			.csrf().and()
			.addFilter(<span class="hljs-keyword">new</span> WebAsyncManagerIntegrationFilter())
			.exceptionHandling().and()
			.headers().and()
			.sessionManagement().and()
			.securityContext().and()
			.requestCache().and()
			.anonymous().and()
			.servletApi().and()
			.apply(<span class="hljs-keyword">new</span> DefaultLoginPageConfigurer&lt;&gt;()).and()
			.logout();
		<span class="hljs-comment">// @formatter:on</span>
		ClassLoader classLoader = <span class="hljs-keyword">this</span>.context.getClassLoader();
		List&lt;AbstractHttpConfigurer&gt; defaultHttpConfigurers =
				SpringFactoriesLoader.loadFactories(AbstractHttpConfigurer.class, classLoader);
		<span class="hljs-keyword">for</span> (AbstractHttpConfigurer configurer : defaultHttpConfigurers) &#123;
			http.apply(configurer);
		&#125;
	&#125;
	configure(http);
	<span class="hljs-keyword">return</span> http;
&#125;
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
	logger.debug(<span class="hljs-string">&quot;Using default configure(HttpSecurity). If subclassed this will potentially override subclass configure(HttpSecurity).&quot;</span>);
	http
		.authorizeRequests()
			.anyRequest().authenticated()
			.and()
		.formLogin().and()
		.httpBasic();
&#125;</code></pre></div>

<p>init æ–¹æ³•å¯ä»¥ç®—æ˜¯è¿™é‡Œçš„å…¥å£æ–¹æ³•äº†ï¼šé¦–å…ˆè°ƒç”¨ getHttp æ–¹æ³•è¿›è¡Œ <code>HttpSecurity </code>çš„åˆå§‹åŒ–ã€‚<code>HttpSecurity</code> çš„åˆå§‹åŒ–ï¼Œå®é™…ä¸Šå°±æ˜¯é…ç½®äº†ä¸€å †é»˜è®¤çš„è¿‡æ»¤å™¨ï¼Œé…ç½®å®Œæˆåï¼Œæœ€ç»ˆè¿˜è°ƒç”¨äº† configure(http) æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åˆé…ç½®äº†ä¸€äº›æ‹¦æˆªå™¨ï¼Œä¸è¿‡åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡å†™ configure(http) æ–¹æ³•ï¼Œ<code>HttpSecurity</code> é…ç½®å®Œæˆåï¼Œå†å°† <code>HttpSecurity</code> æ”¾å…¥ <code>WebSecurity</code> ä¸­ï¼Œä¿å­˜åœ¨ <code>WebSecurity</code> çš„ <code>securityFilterChainBuilders</code> é›†åˆé‡Œï¼Œå…·ä½“å‚è§ä¸Šé¢çš„<code>HttpSecurity</code>éƒ¨åˆ†</p>
<p>configure(WebSecurity web) æ–¹æ³•å®é™…ä¸Šæ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨å®é™…å¼€å‘ä¸­å¯èƒ½ä¼šé‡å†™è¯¥æ–¹æ³•ï¼š</p>
<div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
    <span class="hljs-comment">//é˜²æ­¢è®¿é—®ç™»å½•é¡µé¢æ­»å¾ªç¯ï¼Œä¸ç”¨è¿›å…¥Securityæ‹¦æˆª</span>
    web.ignoring().antMatchers(<span class="hljs-string">&quot;/css/**&quot;</span>, <span class="hljs-string">&quot;/js/**&quot;</span>, <span class="hljs-string">&quot;/index.html&quot;</span>, <span class="hljs-string">&quot;/img/**&quot;</span>, <span class="hljs-string">&quot;/fonts/**&quot;</span>, <span class="hljs-string">&quot;/favicon.ico&quot;</span>, <span class="hljs-string">&quot;/verifyCode&quot;</span>);
&#125;</code></pre></div>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Spring/">Spring</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Spring-Security/">Spring Security</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/08/05/%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/">
                        <span class="hidden-mobile">åå°ç®¡ç†ç³»ç»Ÿå¼€å‘è®°å½•</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function () {
        new Valine({
          el: "#valine",
          app_id: "Q8utolFFXQsi71pQY6bCltkI-gzGzoHsz",
          app_key: "x4RAlPOpmFX9HdGyI6MLoCGn",
          placeholder: "è¯´ç‚¹ä»€ä¹ˆ....",
          path: window.location.pathname,
          avatar: "monsterid",
          meta: ["nick","mail","link"],
          pageSize: "12",
          lang: "zh-CN",
          highlight: true,
          recordIP: true,
          serverURLs: "",
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud ç»Ÿè®¡PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            æ€»è®¿é—®é‡ 
            <span id="leancloud-site-pv"></span>
             æ¬¡
          </span>
      
      
        <!-- LeanCloud ç»Ÿè®¡UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            æ€»è®¿å®¢æ•° 
            <span id="leancloud-site-uv"></span>
             äºº
          </span>
      

    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.2/dist/tocbot.min.js" ></script>





  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>




  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>












  

  

  

  

  

  





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/js/boot.js" ></script>


</body>
</html>
